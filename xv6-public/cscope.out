cscope 15 $HOME/xv6/xv6-public -q 0000002042 0000251426
	@asm.h

5 
	#SEG_NULLASM
 \

6 .
w‹d
 0, 0; \

7 .
byã
 0, 0, 0, 0

	)

11 
	#SEG_ASM
(
ty≥
,
ba£
,
lim
) \

12 .
	`w‹d
 (((
lim
Ë>> 12Ë& 0xffff), ((
ba£
) & 0xffff); \

13 .
	`byã
 (((
ba£
Ë>> 16Ë& 0xff), (0x90 | (
ty≥
)), \

14 (0xC0 | (((
lim
Ë>> 28Ë& 0xf)), (((
ba£
Ë>> 24Ë& 0xff)

	)

16 
	#STA_X
 0x8

17 
	#STA_E
 0x4

18 
	#STA_C
 0x4

19 
	#STA_W
 0x2

20 
	#STA_R
 0x2

21 
	#STA_A
 0x1

	@bio.c

21 
	~"ty≥s.h
"

22 
	~"defs.h
"

23 
	~"∑øm.h
"

24 
	~"•ölock.h
"

25 
	~"¶ì∂ock.h
"

26 
	~"fs.h
"

27 
	~"buf.h
"

30 
•ölock
 
	mlock
;

31 
buf
 
	mbuf
[
NBUF
];

35 
buf
 
	mhód
;

36 } 
	gbˇche
;

39 
	$böô
()

41 
buf
 *
b
;

43 
	`öôlock
(&
bˇche
.
lock
, "bcache");

47 
bˇche
.
hód
.
¥ev
 = &bcache.head;

48 
bˇche
.
hód
.
√xt
 = &bcache.head;

49 
b
 = 
bˇche
.
buf
; b < bˇche.buf+
NBUF
; b++){

50 
b
->
√xt
 = 
bˇche
.
hód
.next;

51 
b
->
¥ev
 = &
bˇche
.
hód
;

52 
	`öô¶ì∂ock
(&
b
->
lock
, "buffer");

53 
bˇche
.
hód
.
√xt
->
¥ev
 = 
b
;

54 
bˇche
.
hód
.
√xt
 = 
b
;

56 
	}
}

61 
buf
*

62 
	$bgë
(
uöt
 
dev
, uöà
blockno
)

64 
buf
 *
b
;

66 
	`acquúe
(&
bˇche
.
lock
);

69 
b
 = 
bˇche
.
hód
.
√xt
; b != &bcache.head; b = b->next){

70 if(
b
->
dev
 =dev && b->
blockno
 == blockno){

71 
b
->
ªf˙t
++;

72 
	`ªÀa£
(&
bˇche
.
lock
);

73 
	`acquúe¶ìp
(&
b
->
lock
);

74  
b
;

81 
b
 = 
bˇche
.
hód
.
¥ev
; b != &bcache.head; b = b->prev){

82 if(
b
->
ªf˙t
 =0 && (b->
Êags
 & 
B_DIRTY
) == 0) {

83 
b
->
dev
 = dev;

84 
b
->
blockno
 = blockno;

85 
b
->
Êags
 = 0;

86 
b
->
ªf˙t
 = 1;

87 
	`ªÀa£
(&
bˇche
.
lock
);

88 
	`acquúe¶ìp
(&
b
->
lock
);

89  
b
;

92 
	`∑nic
("bget:Ço buffers");

93 
	}
}

96 
buf
*

97 
	$bªad
(
uöt
 
dev
, uöà
blockno
)

99 
buf
 *
b
;

101 
b
 = 
	`bgë
(
dev
, 
blockno
);

102 if(!(
b
->
Êags
 & 
B_VALID
)) {

103 
	`idîw
(
b
);

105  
b
;

106 
	}
}

110 
	$bwrôe
(
buf
 *
b
)

112 if(!
	`hﬁdög¶ìp
(&
b
->
lock
))

113 
	`∑nic
("bwrite");

114 
b
->
Êags
 |
B_DIRTY
;

115 
	`idîw
(
b
);

116 
	}
}

121 
	$bªl£
(
buf
 *
b
)

123 if(!
	`hﬁdög¶ìp
(&
b
->
lock
))

124 
	`∑nic
("brelse");

126 
	`ªÀa£¶ìp
(&
b
->
lock
);

128 
	`acquúe
(&
bˇche
.
lock
);

129 
b
->
ªf˙t
--;

130 i‡(
b
->
ªf˙t
 == 0) {

132 
b
->
√xt
->
¥ev
 = b->prev;

133 
b
->
¥ev
->
√xt
 = b->next;

134 
b
->
√xt
 = 
bˇche
.
hód
.next;

135 
b
->
¥ev
 = &
bˇche
.
hód
;

136 
bˇche
.
hód
.
√xt
->
¥ev
 = 
b
;

137 
bˇche
.
hód
.
√xt
 = 
b
;

140 
	`ªÀa£
(&
bˇche
.
lock
);

141 
	}
}

	@bootasm.S

1 
	~"asm.h
"

2 
	~"memœyout.h
"

3 
	~"mmu.h
"

5 #Sèπ 
the
 
fú°
 
CPU
: 
to
 32-
bô
 
¥Ÿe˘ed
 
mode
, 
jump
 
öto
 
C
.

6 #Thê
BIOS
 
lﬂds
 
this
 
code
 
‰om
 
the
 
fú°
 
£˘‹
 
of
Åhê
h¨d
 
disk
 
öto


7 #mem‹y 
©
 
physiˇl
 
addªss
 0x7c00 
™d
 
°¨ts
 
executög
 
ö
 
ªÆ
 
mode


8 #wôh %
cs
=0 %
ù
=7c00.

10 .
	gcode16
 #As£mbÀ 16-
bô
 
	gmode


11 .
globl
 
°¨t


12 
	g°¨t
:

13 
˛i
 #BIOS 
íabÀd
 
öãºu±s
; 
	gdißbÀ


15 #Zîÿ
d©a
 
£gmít
 
ªgi°îs
 
DS
, 
ES
, 
™d
 
SS
.

16 
	gx‹w
 %
	gax
,%ax #Së %
ax
 
to
 
zîo


17 
	gmovw
 %
	gax
,%
	gds
 #-> 
D©a
 
Segmít


18 
	gmovw
 %
	gax
,%
	ges
 #-> 
Exåa
 
Segmít


19 
	gmovw
 %
	gax
,%
	gss
 #-> 
Sèck
 
	gSegmít


21 #Physiˇ»
addªss
 
löe
 
A20
 
is
 
tõd
 
to
 
zîo
 
so
 
th©
 
the
 
fú°
 
PCs


22 #wôh 2 
MB
 
would
 
run
 
so·w¨e
 
th©
 
assumed
 1 MB. 
Undo
Åhat.

23 
	g£è20
.1:

24 
öb
 
$0x64
,%
	gÆ
 #Waô 
nŸ
 
busy


25 
ã°b
 
	g$0x2
,%
Æ


26 
jnz
 
	g£è20
.1

28 
movb
 
	g$0xd1
,%
	gÆ
 #0
	gxd1
 -> 
	gp‹t
 0x64

29 
	goutb
 %
	gÆ
,
$0x64


31 
	g£è20
.2:

32 
öb
 
$0x64
,%
	gÆ
 #Waô 
nŸ
 
busy


33 
ã°b
 
	g$0x2
,%
Æ


34 
jnz
 
	g£è20
.2

36 
movb
 
	g$0xdf
,%
	gÆ
 #0
	gxdf
 -> 
	gp‹t
 0x60

37 
	goutb
 %
	gÆ
,
	g$0x60


39 #Swôch 
‰om
 
ªÆ
 
to
 
¥Ÿe˘ed
 
mode
. 
U£
 
a
 
boŸ°øp
 
GDT
 
th©
 
makes


40 #vútuÆ 
addªs£s
 
m≠
 
dúe˘ly
 
to
 
physiˇl
áddªs£†
so
 
th©
 
the


41 #ef„˘ivê
mem‹y
 
m≠
 
d€¢
't change duringÅheÅransition.

42 
lgdt
 
gdtdesc


43 
	gmovl
 %
	g¸0
, %
óx


44 
‹l
 
	g$CR0_PE
, %
óx


45 
	gmovl
 %
	góx
, %
	g¸0


48 #Com∂ëê
the
 
å™sôi⁄
 
to
 32-
bô
 
¥Ÿe˘ed
 
mode
 
by
 
usög
 
a
 
jmp


49 #tÿ
ªlﬂd
 %
cs
 
™d
 %
eù
. 
The
 
£gmít
 
des¸ùt‹s
 
¨e
 
£t
 
up
 
wôh
 
no


50 #å™¶©i⁄, 
so
 
th©
 
the
 
m≠pög
 
is
 
°ûl
Åhê
idítôy
 mapping.

51 
ljmp
 
$
(
SEG_KCODE
<<3), 
	g$°¨t32


53 .
	gcode32
 #Tñ»
as£mbÀr
 
to
 
	ggíî©e
 32-
bô
 
code
 
	gnow
.

54 
	g°¨t32
:

55 #Së 
up
 
the
 
¥Ÿe˘ed
-
mode
 
d©a
 
£gmít
 
ªgi°îs


56 
movw
 
$
(
SEG_KDATA
<<3), %
	gax
 #Ou∏
d©a
 
£gmít
 
£À˘‹


57 
	gmovw
 %
	gax
, %
	gds
 #-> 
	gDS
: 
D©a
 
Segmít


58 
movw
 %
ax
, %
	ges
 #-> 
	gES
: 
Exåa
 
Segmít


59 
movw
 %
ax
, %
	gss
 #-> 
	gSS
: 
Sèck
 
Segmít


60 
movw
 
$0
, %
	gax
 #Zîÿ
£gmíts
 
nŸ
 
ªady
 
u£


61 
	gmovw
 %
	gax
, %
	gfs
 #-> 
FS


62 
	gmovw
 %
	gax
, %
	ggs
 #-> 
	gGS


64 #Së 
up
 
the
 
°ack
 
poöãr
 
™d
 
ˇŒ
 
öto
 
C
.

65 
movl
 
	g$°¨t
, %
e•


66 
ˇŒ
 
	gboŸmaö


68 #I‡
boŸmaö
 
ªtu∫s
 (
ô
 
shouldn
't),Åriggerá Bochs

69 #bªakpoöà
ru¬ög
 
undî
 
Bochs
, 
thí
 
lo›
.

70 
movw
 
$0x8a00
, %
ax
 #0
x8a00
 -> 
p‹t
 0x8a00

71 
movw
 %
ax
, %
dx


72 
outw
 %
ax
, %
dx


73 
movw
 
$0x8´0
, %
ax
 #0
x8´0
 -> 
p‹t
 0x8a00

74 
outw
 %
ax
, %
dx


75 
•ö
:

76 
jmp
 
•ö


78 #BoŸ°ø∞
GDT


79 .
p2Æign
 2 #f‹˚ 4 
byã
 
Æignmít


80 
gdt
:

81 
SEG_NULLASM
 #nuŒ 
£g


82 
SEG_ASM
(
STA_X
|
STA_R
, 0x0, 0xffffffffË#codê
£g


83 
	$SEG_ASM
(
STA_W
, 0x0, 0xffffffffË#d©®
£g


85 
gdtdesc
:

86 .
	`w‹d
 (
gdtdesc
 - 
gdt
 - 1) #sizeof(gdt) - 1

87 .
gdt
 #address gdt

	@bootmain.c

8 
	~"ty≥s.h
"

9 
	~"ñf.h
"

10 
	~"x86.h
"

11 
	~"memœyout.h
"

13 
	#SECTSIZE
 512

	)

15 
ªad£g
(
uch¨
*, 
uöt
, uint);

18 
	$boŸmaö
()

20 
ñfhdr
 *
ñf
;

21 
¥oghdr
 *
ph
, *
ïh
;

22 (*
íåy
)();

23 
uch¨
* 
∑
;

25 
ñf
 = (
ñfhdr
*)0x10000;

28 
	`ªad£g
((
uch¨
*)
ñf
, 4096, 0);

31 if(
ñf
->
magic
 !
ELF_MAGIC
)

35 
ph
 = (
¥oghdr
*)((
uch¨
*)
ñf
 +Élf->
phoff
);

36 
ïh
 = 
ph
 + 
ñf
->
phnum
;

37 ; 
ph
 < 
ïh
;Öh++){

38 
∑
 = (
uch¨
*)
ph
->
∑ddr
;

39 
	`ªad£g
(
∑
, 
ph
->
fûesz
,Öh->
off
);

40 if(
ph
->
memsz
 >Öh->
fûesz
)

41 
	`°osb
(
∑
 + 
ph
->
fûesz
, 0,Öh->
memsz
 -Öh->filesz);

46 
íåy
 = ((*)())(
ñf
->entry);

47 
	`íåy
();

48 
	}
}

51 
	$waôdisk
()

54 (
	`öb
(0x1F7) & 0xC0) != 0x40)

56 
	}
}

60 
	$ªad£˘
(*
d°
, 
uöt
 
off£t
)

63 
	`waôdisk
();

64 
	`outb
(0x1F2, 1);

65 
	`outb
(0x1F3, 
off£t
);

66 
	`outb
(0x1F4, 
off£t
 >> 8);

67 
	`outb
(0x1F5, 
off£t
 >> 16);

68 
	`outb
(0x1F6, (
off£t
 >> 24) | 0xE0);

69 
	`outb
(0x1F7, 0x20);

72 
	`waôdisk
();

73 
	`ö¶
(0x1F0, 
d°
, 
SECTSIZE
/4);

74 
	}
}

79 
	$ªad£g
(
uch¨
* 
∑
, 
uöt
 
cou¡
, uöà
off£t
)

81 
uch¨
* 
ïa
;

83 
ïa
 = 
∑
 + 
cou¡
;

86 
∑
 -
off£t
 % 
SECTSIZE
;

89 
off£t
 = (off£à/ 
SECTSIZE
) + 1;

94 ; 
∑
 < 
ïa
;Ö®+
SECTSIZE
, 
off£t
++)

95 
	`ªad£˘
(
∑
, 
off£t
);

96 
	}
}

	@buf.h

1 
	sbuf
 {

2 
	mÊags
;

3 
uöt
 
	mdev
;

4 
uöt
 
	mblockno
;

5 
¶ì∂ock
 
	mlock
;

6 
uöt
 
	mªf˙t
;

7 
buf
 *
	m¥ev
;

8 
buf
 *
	m√xt
;

9 
buf
 *
	mq√xt
;

10 
uch¨
 
	md©a
[
BSIZE
];

12 
	#B_VALID
 0x2

13 
	#B_DIRTY
 0x4

14 

	)

	@cat.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	gbuf
[512];

8 
	$ˇt
(
fd
)

10 
n
;

12 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0) {

13 i‡(
	`wrôe
(1, 
buf
, 
n
) !=Ç) {

14 
	`¥ötf
(1, "cat: writeÉrror\n");

15 
	`exô
();

18 if(
n
 < 0){

19 
	`¥ötf
(1, "cat:ÑeadÉrror\n");

20 
	`exô
();

22 
	}
}

25 
	$maö
(
¨gc
, *
¨gv
[])

27 
fd
, 
i
;

29 if(
¨gc
 <= 1){

30 
	`ˇt
(0);

31 
	`exô
();

34 
i
 = 1; i < 
¨gc
; i++){

35 if((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0){

36 
	`¥ötf
(1, "ˇt: c™nŸ o≥¿%s\n", 
¨gv
[
i
]);

37 
	`exô
();

39 
	`ˇt
(
fd
);

40 
	`˛o£
(
fd
);

42 
	`exô
();

43 
	}
}

	@console.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"∑øm.h
"

8 
	~"å≠s.h
"

9 
	~"•ölock.h
"

10 
	~"¶ì∂ock.h
"

11 
	~"fs.h
"

12 
	~"fûe.h
"

13 
	~"memœyout.h
"

14 
	~"mmu.h
"

15 
	~"¥oc.h
"

16 
	~"x86.h
"

18 
c⁄•utc
();

20 
	g∑nicked
 = 0;

23 
•ölock
 
	mlock
;

24 
	mlockög
;

25 } 
	gc⁄s
;

28 
	$¥ötöt
(
xx
, 
ba£
, 
sign
)

30 
digôs
[] = "0123456789abcdef";

31 
buf
[16];

32 
i
;

33 
uöt
 
x
;

35 if(
sign
 && (sig¿
xx
 < 0))

36 
x
 = -
xx
;

38 
x
 = 
xx
;

40 
i
 = 0;

42 
buf
[
i
++] = 
digôs
[
x
 % 
ba£
];

43 }(
x
 /
ba£
) != 0);

45 if(
sign
)

46 
buf
[
i
++] = '-';

48 --
i
 >= 0)

49 
	`c⁄•utc
(
buf
[
i
]);

50 
	}
}

55 
	$˝rötf
(*
fmt
, ...)

57 
i
, 
c
, 
lockög
;

58 
uöt
 *
¨gp
;

59 *
s
;

61 
lockög
 = 
c⁄s
.locking;

62 if(
lockög
)

63 
	`acquúe
(&
c⁄s
.
lock
);

65 i‡(
fmt
 == 0)

66 
	`∑nic
("null fmt");

68 
¨gp
 = (
uöt
*)(*)(&
fmt
 + 1);

69 
i
 = 0; (
c
 = 
fmt
[i] & 0xff) != 0; i++){

70 if(
c
 != '%'){

71 
	`c⁄•utc
(
c
);

74 
c
 = 
fmt
[++
i
] & 0xff;

75 if(
c
 == 0)

77 
c
){

79 
	`¥ötöt
(*
¨gp
++, 10, 1);

83 
	`¥ötöt
(*
¨gp
++, 16, 0);

86 if((
s
 = (*)*
¨gp
++) == 0)

87 
s
 = "(null)";

88 ; *
s
; s++)

89 
	`c⁄•utc
(*
s
);

92 
	`c⁄•utc
('%');

96 
	`c⁄•utc
('%');

97 
	`c⁄•utc
(
c
);

102 if(
lockög
)

103 
	`ªÀa£
(&
c⁄s
.
lock
);

104 
	}
}

107 
	$∑nic
(*
s
)

109 
i
;

110 
uöt
 
pcs
[10];

112 
	`˛i
();

113 
c⁄s
.
lockög
 = 0;

114 
	`˝rötf
("˝u wôhápicid %d:Ö™ic: ", 
˝u
->
≠icid
);

115 
	`˝rötf
(
s
);

116 
	`˝rötf
("\n");

117 
	`gëˇŒîpcs
(&
s
, 
pcs
);

118 
i
=0; i<10; i++)

119 
	`˝rötf
(" %p", 
pcs
[
i
]);

120 
∑nicked
 = 1;

123 
	}
}

126 
	#BACKSPACE
 0x100

	)

127 
	#CRTPORT
 0x3d4

	)

128 
ush‹t
 *
	g¸t
 = (ush‹t*)
P2V
(0xb8000);

131 
	$cg≠utc
(
c
)

133 
pos
;

136 
	`outb
(
CRTPORT
, 14);

137 
pos
 = 
	`öb
(
CRTPORT
+1) << 8;

138 
	`outb
(
CRTPORT
, 15);

139 
pos
 |
	`öb
(
CRTPORT
+1);

141 if(
c
 == '\n')

142 
pos
 += 80 -Öos%80;

143 if(
c
 =
BACKSPACE
){

144 if(
pos
 > 0) --pos;

146 
¸t
[
pos
++] = (
c
&0xff) | 0x0700;

148 if(
pos
 < 0 ||Öos > 25*80)

149 
	`∑nic
("pos under/overflow");

151 if((
pos
/80) >= 24){

152 
	`memmove
(
¸t
, crt+80, (crt[0])*23*80);

153 
pos
 -= 80;

154 
	`mem£t
(
¸t
+
pos
, 0, (crt[0])*(24*80 -Öos));

157 
	`outb
(
CRTPORT
, 14);

158 
	`outb
(
CRTPORT
+1, 
pos
>>8);

159 
	`outb
(
CRTPORT
, 15);

160 
	`outb
(
CRTPORT
+1, 
pos
);

161 
¸t
[
pos
] = ' ' | 0x0700;

162 
	}
}

165 
	$c⁄•utc
(
c
)

167 if(
∑nicked
){

168 
	`˛i
();

173 if(
c
 =
BACKSPACE
){

174 
	`u¨çutc
('\b'); uartputc(' '); uartputc('\b');

176 
	`u¨çutc
(
c
);

177 
	`cg≠utc
(
c
);

178 
	}
}

180 
	#INPUT_BUF
 128

	)

182 
	mbuf
[
INPUT_BUF
];

183 
uöt
 
	mr
;

184 
uöt
 
	mw
;

185 
uöt
 
	me
;

186 } 
	göput
;

188 
	#C
(
x
) ((x)-'@')

189 

	)

191 
c⁄sﬁeöå
((*
gëc
)())

193 
c
, 
d›rocdump
 = 0;

195 
	`acquúe
(&
c⁄s
.
lock
);

196 (
c
 = 
	`gëc
()) >= 0){

197 
c
){

198 
	`C
('P'):

200 
d›rocdump
 = 1;

202 
	`C
('U'):

203 
öput
.
e
 !öput.
w
 &&

204 
öput
.
buf
[(öput.
e
-1Ë% 
INPUT_BUF
] != '\n'){

205 
öput
.
e
--;

206 
	`c⁄•utc
(
BACKSPACE
);

209 
	`C
('H'): '\x7f':

210 if(
öput
.
e
 !öput.
w
){

211 
öput
.
e
--;

212 
	`c⁄•utc
(
BACKSPACE
);

216 if(
c
 !0 && 
öput
.
e
-öput.
r
 < 
INPUT_BUF
){

217 
c
 = (c == '\r') ? '\n' : c;

218 
öput
.
buf
[öput.
e
++ % 
INPUT_BUF
] = 
c
;

219 
	`c⁄•utc
(
c
);

220 if(
c
 ='\n' || c =
	`C
('D'Ë|| 
öput
.
e
 =öput.
r
+
INPUT_BUF
){

221 
öput
.
w
 = i≈ut.
e
;

222 
	`wakeup
(&
öput
.
r
);

228 
	`ªÀa£
(&
c⁄s
.
lock
);

229 if(
d›rocdump
) {

230 
	`¥ocdump
();

232 
	}
}

235 
	$c⁄sﬁîód
(
öode
 *
ù
, *
d°
, 
n
)

237 
uöt
 
èrgë
;

238 
c
;

240 
	`iu∆ock
(
ù
);

241 
èrgë
 = 
n
;

242 
	`acquúe
(&
c⁄s
.
lock
);

243 
n
 > 0){

244 
öput
.
r
 =öput.
w
){

245 if(
¥oc
->
kûÀd
){

246 
	`ªÀa£
(&
c⁄s
.
lock
);

247 
	`ûock
(
ù
);

250 
	`¶ìp
(&
öput
.
r
, &
c⁄s
.
lock
);

252 
c
 = 
öput
.
buf
[öput.
r
++ % 
INPUT_BUF
];

253 if(
c
 =
	`C
('D')){

254 if(
n
 < 
èrgë
){

257 
öput
.
r
--;

261 *
d°
++ = 
c
;

262 --
n
;

263 if(
c
 == '\n')

266 
	`ªÀa£
(&
c⁄s
.
lock
);

267 
	`ûock
(
ù
);

269  
èrgë
 - 
n
;

270 
	}
}

273 
	$c⁄sﬁewrôe
(
öode
 *
ù
, *
buf
, 
n
)

275 
i
;

277 
	`iu∆ock
(
ù
);

278 
	`acquúe
(&
c⁄s
.
lock
);

279 
i
 = 0; i < 
n
; i++)

280 
	`c⁄•utc
(
buf
[
i
] & 0xff);

281 
	`ªÀa£
(&
c⁄s
.
lock
);

282 
	`ûock
(
ù
);

284  
n
;

285 
	}
}

288 
	$c⁄sﬁeöô
()

290 
	`öôlock
(&
c⁄s
.
lock
, "console");

292 
devsw
[
CONSOLE
].
wrôe
 = 
c⁄sﬁewrôe
;

293 
devsw
[
CONSOLE
].
ªad
 = 
c⁄sﬁîód
;

294 
c⁄s
.
lockög
 = 1;

296 
	`pi˚«bÀ
(
IRQ_KBD
);

297 
	`iﬂpi˚«bÀ
(
IRQ_KBD
, 0);

298 
	}
}

	@date.h

1 
	sπcd©e
 {

2 
uöt
 
	m£c⁄d
;

3 
uöt
 
	mmöuã
;

4 
uöt
 
	mhour
;

5 
uöt
 
	mday
;

6 
uöt
 
	mm⁄th
;

7 
uöt
 
	myór
;

	@defs.h

1 
	gbuf
;

2 
	gc⁄ãxt
;

3 
	gfûe
;

4 
	göode
;

5 
	gpùe
;

6 
	g¥oc
;

7 
	gπcd©e
;

8 
	g•ölock
;

9 
	g¶ì∂ock
;

10 
	g°©
;

11 
	gsu≥rblock
;

14 
böô
();

15 
buf
* 
bªad
(
uöt
, uint);

16 
bªl£
(
buf
*);

17 
bwrôe
(
buf
*);

20 
c⁄sﬁeöô
();

21 
˝rötf
(*, ...);

22 
c⁄sﬁeöå
((*)());

23 
	$∑nic
(*Ë
	`__©åibuã__
((
n‹ëu∫
));

26 
	`exec
(*, **);

29 
fûe
* 
	`fûóŒoc
();

30 
	`fûe˛o£
(
fûe
*);

31 
fûe
* 
	`fûedup
(file*);

32 
	`fûeöô
();

33 
	`fûîód
(
fûe
*, *, 
n
);

34 
	`fûe°©
(
fûe
*, 
°©
*);

35 
	`fûewrôe
(
fûe
*, *, 
n
);

38 
	`ªadsb
(
dev
, 
su≥rblock
 *
sb
);

39 
	`dúlök
(
öode
*, *, 
uöt
);

40 
öode
* 
	`dúlookup
(öode*, *, 
uöt
*);

41 
öode
* 
	`üŒoc
(
uöt
, );

42 
öode
* 
	`idup
(inode*);

43 
	`iöô
(
dev
);

44 
	`ûock
(
öode
*);

45 
	`ùut
(
öode
*);

46 
	`iu∆ock
(
öode
*);

47 
	`iu∆ockput
(
öode
*);

48 
	`iupd©e
(
öode
*);

49 
	`«mecmp
(const *, const *);

50 
öode
* 
	`«mei
(*);

51 
öode
* 
	`«meù¨ít
(*, *);

52 
	`ªadi
(
öode
*, *, 
uöt
, uint);

53 
	`°©i
(
öode
*, 
°©
*);

54 
	`wrôei
(
öode
*, *, 
uöt
, uint);

57 
	`ideöô
();

58 
	`ideöå
();

59 
	`idîw
(
buf
*);

62 
	`iﬂpi˚«bÀ
(
úq
, 
˝u
);

63 
uch¨
 
iﬂpicid
;

64 
	`iﬂpicöô
();

67 * 
	`kÆloc
();

68 
	`k‰ì
(*);

69 
	`köô1
(*, *);

70 
	`köô2
(*, *);

73 
	`kbdöå
();

76 
	`cmo°ime
(
πcd©e
 *
r
);

77 
	`˝unum
();

78 vﬁ©ûê
uöt
* 
œpic
;

79 
	`œpi˚oi
();

80 
	`œpicöô
();

81 
	`œpic°¨èp
(
uch¨
, 
uöt
);

82 
	`mi¸odñay
();

85 
	`öôlog
(
dev
);

86 
	`log_wrôe
(
buf
*);

87 
	`begö_›
();

88 
	`íd_›
();

91 
ismp
;

92 
	`mpöô
();

95 
	`pi˚«bÀ
();

96 
	`picöô
();

99 
	`pùóŒoc
(
fûe
**, file**);

100 
	`pùe˛o£
(
pùe
*, );

101 
	`pùîód
(
pùe
*, *, );

102 
	`pùewrôe
(
pùe
*, *, );

106 
	`exô
();

107 
	`f‹k
();

108 
	`grow¥oc
();

109 
	`kûl
();

110 
	`pöô
();

111 
	`¥ocdump
();

112 
	$scheduÀr
(Ë
	`__©åibuã__
((
n‹ëu∫
));

113 
	`sched
();

114 
	`¶ìp
(*, 
•ölock
*);

115 
	`u£röô
();

116 
	`waô
();

117 
	`wakeup
(*);

118 
	`yõld
();

121 
	`swtch
(
c⁄ãxt
**, context*);

124 
	`acquúe
(
•ölock
*);

125 
	`gëˇŒîpcs
(*, 
uöt
*);

126 
	`hﬁdög
(
•ölock
*);

127 
	`öôlock
(
•ölock
*, *);

128 
	`ªÀa£
(
•ölock
*);

129 
	`push˛i
();

130 
	`p›˛i
();

133 
	`acquúe¶ìp
(
¶ì∂ock
*);

134 
	`ªÀa£¶ìp
(
¶ì∂ock
*);

135 
	`hﬁdög¶ìp
(
¶ì∂ock
*);

136 
	`öô¶ì∂ock
(
¶ì∂ock
*, *);

139 
	`memcmp
(c⁄° *, c⁄° *, 
uöt
);

140 * 
	`memmove
(*, c⁄° *, 
uöt
);

141 * 
	`mem£t
(*, , 
uöt
);

142 * 
	`ß„°r˝y
(*, const *, );

143 
	`°æí
(const *);

144 
	`°∫cmp
(c⁄° *, c⁄° *, 
uöt
);

145 * 
	`°∫˝y
(*, const *, );

148 
	`¨göt
(, *);

149 
	`¨g±r
(, **, );

150 
	`¨g°r
(, **);

151 
	`„tchöt
(
uöt
, *);

152 
	`„tch°r
(
uöt
, **);

153 
	`sysˇŒ
();

156 
	`timîöô
();

159 
	`idtöô
();

160 
uöt
 
ticks
;

161 
	`tvöô
();

162 
•ölock
 
tick¶ock
;

165 
	`u¨töô
();

166 
	`u¨töå
();

167 
	`u¨çutc
();

170 
	`£göô
();

171 
	`kvmÆloc
();

172 
pde_t
* 
	`£tupkvm
();

173 * 
	`uva2ka
(
pde_t
*, *);

174 
	`Ælocuvm
(
pde_t
*, 
uöt
, uint);

175 
	`dóŒocuvm
(
pde_t
*, 
uöt
, uint);

176 
	`‰ìvm
(
pde_t
*);

177 
	`öôuvm
(
pde_t
*, *, 
uöt
);

178 
	`lﬂduvm
(
pde_t
*, *, 
öode
*, 
uöt
, uint);

179 
pde_t
* 
	`c›yuvm
’de_t*, 
uöt
);

180 
	`swôchuvm
(
¥oc
*);

181 
	`swôchkvm
();

182 
	`c›yout
(
pde_t
*, 
uöt
, *, uint);

183 
	`˛óΩãu
(
pde_t
 *
pgdú
, *
uva
);

185 
	`my_sysˇŒ
(*);

186 
	`gëµid
();

187 
	`yõld
();

188 
	`gëÀv
();

189 
	`£t_˝u_sh¨e
();

192 
	#NELEM
(
x
Ë((x)/((x)[0]))

	)

	@echo.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

6 
	$maö
(
¨gc
, *
¨gv
[])

8 
i
;

10 
i
 = 1; i < 
¨gc
; i++)

11 
	`¥ötf
(1, "%s%s", 
¨gv
[
i
], i+1 < 
¨gc
 ? " " : "\n");

12 
	`exô
();

13 
	}
}

	@elf.h

3 
	#ELF_MAGIC
 0x464C457FU

4 

	)

6 
	sñfhdr
 {

7 
uöt
 
	mmagic
;

8 
uch¨
 
	mñf
[12];

9 
ush‹t
 
	mty≥
;

10 
ush‹t
 
	mmachöe
;

11 
uöt
 
	mvîsi⁄
;

12 
uöt
 
	míåy
;

13 
uöt
 
	mphoff
;

14 
uöt
 
	mshoff
;

15 
uöt
 
	mÊags
;

16 
ush‹t
 
	mehsize
;

17 
ush‹t
 
	mphítsize
;

18 
ush‹t
 
	mphnum
;

19 
ush‹t
 
	mshítsize
;

20 
ush‹t
 
	mshnum
;

21 
ush‹t
 
	msh°∫dx
;

25 
	s¥oghdr
 {

26 
uöt
 
	mty≥
;

27 
uöt
 
	moff
;

28 
uöt
 
	mvaddr
;

29 
uöt
 
	m∑ddr
;

30 
uöt
 
	mfûesz
;

31 
uöt
 
	mmemsz
;

32 
uöt
 
	mÊags
;

33 
uöt
 
	mÆign
;

37 
	#ELF_PROG_LOAD
 1

	)

40 
	#ELF_PROG_FLAG_EXEC
 1

	)

41 
	#ELF_PROG_FLAG_WRITE
 2

	)

42 
	#ELF_PROG_FLAG_READ
 4

	)

	@entry.S

1 #Thê
xv6
 
kî√l
 
°¨ts
 
executög
 
ö
 
this
 
fûe
. 
This
 fûê
is
 
löked
 
wôh


2 #thê
kî√l
 
C
 
code
, 
so
 
ô
 
ˇn
 
ª„r
 
to
 kî√»
symbﬁs
 
such
 
as
 
maö
().

3 #Thê
boŸ
 
block
 (
boŸasm
.
S
 
™d
 
boŸmaö
.
c
Ë
jumps
 
to
 
íåy
 
bñow
.

5 #Mu…iboŸ 
hódî
, 
mu…iboŸ
 
boŸ
 
lﬂdîs
 
like
 
GNU
 
Grub
.

7 #
#Usög 
GRUB
 2, 
you
 
ˇn
 
boŸ
 
xv6
 
‰om
 
a
 
fûe
 
°‹ed
 
ö
á

9 #Löux 
fûe
 
sy°em
 
by
 
c›yög
 
kî√l
 
‹
 
kî√lmemfs
 
to
 /
boŸ


10 #™d 
thí
 
addög
 
this
 
míu
 
íåy
:

13 #ösmod 
ext2


14 #£à
roŸ
='(hd0,msdos1)'

15 #£à
kî√l
='/boot/kernel'

17 #mu…iboŸ 
$
{
kî√l
} ${kernel}

21 
	~"asm.h
"

22 
	~"memœyout.h
"

23 
	~"mmu.h
"

24 
	~"∑øm.h
"

26 #Mu…iboŸ 
hódî
. 
D©a
 
to
 
dúe˘
 
mu…iboŸ
 
lﬂdî
.

27 .
	gp2Æign
 2

28 .
	gãxt


29 .
globl
 
mu…iboŸ_hódî


30 
	gmu…iboŸ_hódî
:

31 
	#magic
 0x1badb002

	)

32 
	#Êags
 0

	)

33 .
magic


34 .
Êags


35 .(-
magic
-
Êags
)

37 #By 
c⁄víti⁄
, 
the
 
_°¨t
 
symbﬁ
 
•ecifõs
Åhê
ELF
 
íåy
 
poöt
.

38 #Sö˚ 
we
 
haví
't set up virtual memory yet, ourÉntryÖoint is

39 #thê
physiˇl
 
addªss
 
of
 'entry'.

40 .
globl
 
_°¨t


41 
	g_°¨t
 = 
V2P_WO
(
íåy
)

43 #E¡îög 
xv6
 
⁄
 
boŸ
 
¥o˚ss‹
, 
wôh
 
∑gög
 
off
.

44 .
globl
 
íåy


45 
	gíåy
:

46 #Tu∫ 
⁄
 
∑ge
 
size
 
exãnsi⁄
 4
Mbyã
 
∑ges


47 
movl
 %
¸4
, %
óx


48 
‹l
 
$
(
CR4_PSE
), %
óx


49 
	gmovl
 %
	góx
, %
	g¸4


50 #Së 
∑ge
 
dúe˘‹y


51 
movl
 
$
(
V2P_WO
(
íåypgdú
)), %
óx


52 
	gmovl
 %
	góx
, %
	g¸3


53 #Tu∫ 
⁄
 
∑gög
.

54 
	gmovl
 %
	g¸0
, %
óx


55 
‹l
 
$
(
CR0_PG
|
CR0_WP
), %
óx


56 
	gmovl
 %
	góx
, %
	g¸0


58 #Së 
up
 
the
 
°ack
 
poöãr
.

59 
movl
 
$
(
°ack
 + 
KSTACKSIZE
), %
	ge•


61 #Jum∞
to
 
maö
(), 
™d
 tÿ
executög
 
©


62 #high 
addªs£s
. 
The
 
ödúe˘
 
ˇŒ
 
is
 
√eded
 
beˇu£


63 #thê
as£mbÀr
 
¥odu˚s
 
a
 
PC
-
ªœtive
 
ö°ru˘i⁄


64 #f‹ 
a
 
dúe˘
 
jump
.

65 
mov
 
	g$maö
, %
óx


66 
	gjmp
 *%
	góx


68 .
comm
 
	g°ack
, 
	gKSTACKSIZE


	@entryother.S

1 
	~"asm.h
"

2 
	~"memœyout.h
"

3 
	~"mmu.h
"

5 #Each 
n⁄
-
boŸ
 
CPU
 ("AP"Ë
is
 
°¨ãd
 
up
 
ö
 
ª•⁄£
 
to
 
a
 
STARTUP


6 #IPI 
‰om
 
the
 
boŸ
 
CPU
. 
Se˘i⁄
 
B
.4.2 
of
Åhê
Mu…i
-
Pro˚ss‹


7 #S≥cifiˇti⁄ 
ßys
 
th©
 
the
 
AP
 
wûl
 
°¨t
 
ö
 
ªÆ
 
mode
 
wôh
 
CS
:
IP


8 #£à
to
 
XY00
:0000, 
whîe
 
XY
 
is
 
™
 8-
bô
 
vÆue
 
£¡
 
wôh
 
the


9 #STARTUP. 
Thus
 
this
 
code
 
mu°
 
°¨t
 
©
 
a
 4096-
byã
 
bound¨y
.

10 #
#Beˇu£ 
this
 
code
 
£ts
 
DS
 
to
 
zîo
, 
ô
 
mu°
 
sô


12 #© 
™
 
addªss
 
ö
 
the
 
low
 2^16 
byãs
.

13 #
#SèπŸhî†(
ö
 
maö
.
c
Ë
£nds
 
the
 
STARTUPs
 
⁄e
 
©
 
a
 
time
.

15 #Ià
c›õs
 
this
 
code
 (
°¨t
Ë
©
 0x7000. 
It
 
puts
 
the
 
addªss
 
of


16 #®
√wly
 
Æloˇãd
 
≥r
-
c‹e
 
°ack
 
ö
 
°¨t
-4,
the
 
addªss
 
of
Åhe

17 #∂a˚ 
to
 
jump
Åÿ(
m≥¡î
Ë
ö
 
°¨t
-8, 
™d
 
the
 
physiˇl
 
addªss


18 #o‡
íåypgdú
 
ö
 
°¨t
-12.

19 #
#Thi†
code
 
comböes
 
ñemíts
 
of
 
boŸasm
.
S
 
™d
 
íåy
.S.

22 .
	gcode16


23 .
globl
 
°¨t


24 
	g°¨t
:

25 
˛i


27 #Zîÿ
d©a
 
£gmít
 
ªgi°îs
 
DS
, 
ES
, 
™d
 
SS
.

28 
	gx‹w
 %
	gax
,%
ax


29 
	gmovw
 %
	gax
,%
ds


30 
	gmovw
 %
	gax
,%
es


31 
	gmovw
 %
	gax
,%
	gss


33 #Swôch 
‰om
 
ªÆ
 
to
 
¥Ÿe˘ed
 
mode
. 
U£
 
a
 
boŸ°øp
 
GDT
 
th©
 
makes


34 #vútuÆ 
addªs£s
 
m≠
 
dúe˘ly
 
to
 
physiˇl
áddªs£†
so
 
th©
 
the


35 #ef„˘ivê
mem‹y
 
m≠
 
d€¢
't change duringÅheÅransition.

36 
lgdt
 
gdtdesc


37 
	gmovl
 %
	g¸0
, %
óx


38 
‹l
 
	g$CR0_PE
, %
óx


39 
	gmovl
 %
	góx
, %
	g¸0


41 #Com∂ëê
the
 
å™sôi⁄
 
to
 32-
bô
 
¥Ÿe˘ed
 
mode
 
by
 
usög
 
a
 
jmp


42 #tÿ
ªlﬂd
 %
cs
 
™d
 %
eù
. 
The
 
£gmít
 
des¸ùt‹s
 
¨e
 
£t
 
up
 
wôh
 
no


43 #å™¶©i⁄, 
so
 
th©
 
the
 
m≠pög
 
is
 
°ûl
Åhê
idítôy
 mapping.

44 
ljm∂
 
$
(
SEG_KCODE
<<3), $(
°¨t32
)

47 .
	gcode32
 #Tñ»
as£mbÀr
 
to
 
	ggíî©e
 32-
bô
 
code
 
	gnow
.

48 
	g°¨t32
:

49 #Së 
up
 
the
 
¥Ÿe˘ed
-
mode
 
d©a
 
£gmít
 
ªgi°îs


50 
movw
 
$
(
SEG_KDATA
<<3), %
	gax
 #Ou∏
d©a
 
£gmít
 
£À˘‹


51 
	gmovw
 %
	gax
, %
	gds
 #-> 
	gDS
: 
D©a
 
Segmít


52 
movw
 %
ax
, %
	ges
 #-> 
	gES
: 
Exåa
 
Segmít


53 
movw
 %
ax
, %
	gss
 #-> 
	gSS
: 
Sèck
 
Segmít


54 
movw
 
$0
, %
	gax
 #Zîÿ
£gmíts
 
nŸ
 
ªady
 
u£


55 
	gmovw
 %
	gax
, %
	gfs
 #-> 
FS


56 
	gmovw
 %
	gax
, %
	ggs
 #-> 
	gGS


58 #Tu∫ 
⁄
 
∑ge
 
size
 
exãnsi⁄
 4
Mbyã
 
∑ges


59 
	gmovl
 %
	g¸4
, %
óx


60 
‹l
 
$
(
CR4_PSE
), %
óx


61 
	gmovl
 %
	góx
, %
	g¸4


62 #U£ 
íåypgdú
 
as
 
our
 
öôül
 
∑ge
 
èbÀ


63 
movl
 (
°¨t
-12), %
óx


64 
	gmovl
 %
	góx
, %
	g¸3


65 #Tu∫ 
⁄
 
∑gög
.

66 
	gmovl
 %
	g¸0
, %
óx


67 
‹l
 
$
(
CR0_PE
|
CR0_PG
|
CR0_WP
), %
óx


68 
	gmovl
 %
	góx
, %
	g¸0


70 #Swôch 
to
 
the
 
°ack
 
Æloˇãd
 
by
 
°¨tŸhîs
()

71 
movl
 (
°¨t
-4), %
	ge•


72 #CÆ»
m≥¡î
()

73 
	gˇŒ
 *(
	g°¨t
-8)

75 
movw
 
	g$0x8a00
, %
ax


76 
	gmovw
 %
	gax
, %
dx


77 
	goutw
 %
	gax
, %
dx


78 
movw
 
	g$0x8´0
, %
ax


79 
	goutw
 %
	gax
, %
dx


80 
	g•ö
:

81 
jmp
 
•ö


83 .
p2Æign
 2

84 
gdt
:

85 
SEG_NULLASM


86 
SEG_ASM
(
STA_X
|
STA_R
, 0, 0xffffffff)

87 
	$SEG_ASM
(
STA_W
, 0, 0xffffffff)

90 
gdtdesc
:

91 .
	`w‹d
 (
gdtdesc
 - 
gdt
 - 1)

92 .
gdt


	@exec.c

1 
	~"ty≥s.h
"

2 
	~"∑øm.h
"

3 
	~"memœyout.h
"

4 
	~"mmu.h
"

5 
	~"¥oc.h
"

6 
	~"defs.h
"

7 
	~"x86.h
"

8 
	~"ñf.h
"

10 
Æloˇã_√w_pgdú_idx
(
¥oc
*);

12 
•ölock
 
thªad_lock
;

13 
pgdú_ªf
[
NPROC
];

14 
pgdú_ªf_√xt_idx
;

18 
	$exec
(*
∑th
, **
¨gv
)

20 *
s
, *
œ°
;

21 
i
, 
off
;

22 
uöt
 
¨gc
, 
sz
, 
•
, 
u°ack
[3+
MAXARG
+1];

23 
ñfhdr
 
ñf
;

24 
öode
 *
ù
;

25 
¥oghdr
 
ph
;

26 
pde_t
 *
pgdú
, *
ﬁdpgdú
;

28 
	`begö_›
();

30 if((
ù
 = 
	`«mei
(
∑th
)) == 0){

31 
	`íd_›
();

34 
	`ûock
(
ù
);

35 
pgdú
 = 0;

38 if(
	`ªadi
(
ù
, (*)&
ñf
, 0, (elf)) != (elf))

39 
bad
;

40 if(
ñf
.
magic
 !
ELF_MAGIC
)

41 
bad
;

43 if((
pgdú
 = 
	`£tupkvm
()) == 0)

44 
bad
;

47 
sz
 = 0;

48 
i
=0, 
off
=
ñf
.
phoff
; i<ñf.
phnum
; i++, off+=(
ph
)){

49 if(
	`ªadi
(
ù
, (*)&
ph
, 
off
, (ph)) != (ph))

50 
bad
;

51 if(
ph
.
ty≥
 !
ELF_PROG_LOAD
)

53 if(
ph
.
memsz
 <Öh.
fûesz
)

54 
bad
;

55 if(
ph
.
vaddr
 +Öh.
memsz
 <Öh.vaddr)

56 
bad
;

57 if((
sz
 = 
	`Ælocuvm
(
pgdú
, sz, 
ph
.
vaddr
 +Öh.
memsz
)) == 0)

58 
bad
;

59 if(
ph
.
vaddr
 % 
PGSIZE
 != 0)

60 
bad
;

61 if(
	`lﬂduvm
(
pgdú
, (*)
ph
.
vaddr
, 
ù
,Öh.
off
,Öh.
fûesz
) < 0)

62 
bad
;

64 
	`iu∆ockput
(
ù
);

65 
	`íd_›
();

66 
ù
 = 0;

70 
sz
 = 
	`PGROUNDUP
(sz);

71 if((
sz
 = 
	`Ælocuvm
(
pgdú
, sz, sz + 2*
PGSIZE
)) == 0)

72 
bad
;

73 
	`˛óΩãu
(
pgdú
, (*)(
sz
 - 2*
PGSIZE
));

74 
•
 = 
sz
;

77 
¨gc
 = 0; 
¨gv
[argc];árgc++) {

78 if(
¨gc
 >
MAXARG
)

79 
bad
;

80 
•
 = (• - (
	`°æí
(
¨gv
[
¨gc
]) + 1)) & ~3;

81 if(
	`c›yout
(
pgdú
, 
•
, 
¨gv
[
¨gc
], 
	`°æí
(argv[argc]) + 1) < 0)

82 
bad
;

83 
u°ack
[3+
¨gc
] = 
•
;

85 
u°ack
[3+
¨gc
] = 0;

87 
u°ack
[0] = 0xffffffff;

88 
u°ack
[1] = 
¨gc
;

89 
u°ack
[2] = 
•
 - (
¨gc
+1)*4;

91 
•
 -(3+
¨gc
+1) * 4;

92 if(
	`c›yout
(
pgdú
, 
•
, 
u°ack
, (3+
¨gc
+1)*4) < 0)

93 
bad
;

96 
œ°
=
s
=
∑th
; *s; s++)

97 if(*
s
 == '/')

98 
œ°
 = 
s
+1;

99 
	`ß„°r˝y
(
¥oc
->
«me
, 
œ°
, (proc->name));

102 
ﬁdpgdú
 = 
¥oc
->
pgdú
;

103 
¥oc
->
pgdú
 =Ögdir;

104 
¥oc
->
sz
 = sz;

105 
¥oc
->
tf
->
eù
 = 
ñf
.
íåy
;

106 
¥oc
->
tf
->
e•
 = 
•
;

107 
	`swôchuvm
(
¥oc
);

109 i‡(
¥oc
->
pgdú_ªf_idx
 == -1) {

111 
	`‰ìvm
(
ﬁdpgdú
);

112 } i‡(
pgdú_ªf
[
¥oc
->
pgdú_ªf_idx
] <= 1) {

115 
	`acquúe
(&
thªad_lock
);

116 
pgdú_ªf
[
¥oc
->
pgdú_ªf_idx
] = 0;

117 
	`ªÀa£
(&
thªad_lock
);

118 
	`‰ìvm
(
ﬁdpgdú
);

124 
	`Æloˇã_√w_pgdú_idx
(
¥oc
);

128 
bad
:

129 if(
pgdú
)

130 
	`‰ìvm
(
pgdú
);

131 if(
ù
){

132 
	`iu∆ockput
(
ù
);

133 
	`íd_›
();

136 
	}
}

	@fcntl.h

1 
	#O_RDONLY
 0x000

	)

2 
	#O_WRONLY
 0x001

	)

3 
	#O_RDWR
 0x002

	)

4 
	#O_CREATE
 0x200

	)

	@file.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"∑øm.h
"

8 
	~"fs.h
"

9 
	~"•ölock.h
"

10 
	~"¶ì∂ock.h
"

11 
	~"fûe.h
"

13 
devsw
 
	gdevsw
[
NDEV
];

15 
•ölock
 
	mlock
;

16 
fûe
 
	mfûe
[
NFILE
];

17 } 
	g·abÀ
;

20 
	$fûeöô
()

22 
	`öôlock
(&
·abÀ
.
lock
, "ftable");

23 
	}
}

26 
fûe
*

27 
	$fûóŒoc
()

29 
fûe
 *
f
;

31 
	`acquúe
(&
·abÀ
.
lock
);

32 
f
 = 
·abÀ
.
fûe
; f < fèbÀ.fûê+ 
NFILE
; f++){

33 if(
f
->
ªf
 == 0){

34 
f
->
ªf
 = 1;

35 
	`ªÀa£
(&
·abÀ
.
lock
);

36  
f
;

39 
	`ªÀa£
(&
·abÀ
.
lock
);

41 
	}
}

44 
fûe
*

45 
	$fûedup
(
fûe
 *
f
)

47 
	`acquúe
(&
·abÀ
.
lock
);

48 if(
f
->
ªf
 < 1)

49 
	`∑nic
("filedup");

50 
f
->
ªf
++;

51 
	`ªÀa£
(&
·abÀ
.
lock
);

52  
f
;

53 
	}
}

57 
	$fûe˛o£
(
fûe
 *
f
)

59 
fûe
 
ff
;

61 
	`acquúe
(&
·abÀ
.
lock
);

62 if(
f
->
ªf
 < 1)

63 
	`∑nic
("fileclose");

64 if(--
f
->
ªf
 > 0){

65 
	`ªÀa£
(&
·abÀ
.
lock
);

68 
ff
 = *
f
;

69 
f
->
ªf
 = 0;

70 
f
->
ty≥
 = 
FD_NONE
;

71 
	`ªÀa£
(&
·abÀ
.
lock
);

73 if(
ff
.
ty≥
 =
FD_PIPE
)

74 
	`pùe˛o£
(
ff
.
pùe
, ff.
wrôabÀ
);

75 if(
ff
.
ty≥
 =
FD_INODE
){

76 
	`begö_›
();

77 
	`ùut
(
ff
.
ù
);

78 
	`íd_›
();

80 
	}
}

84 
	$fûe°©
(
fûe
 *
f
, 
°©
 *
°
)

86 if(
f
->
ty≥
 =
FD_INODE
){

87 
	`ûock
(
f
->
ù
);

88 
	`°©i
(
f
->
ù
, 
°
);

89 
	`iu∆ock
(
f
->
ù
);

93 
	}
}

97 
	$fûîód
(
fûe
 *
f
, *
addr
, 
n
)

99 
r
;

101 if(
f
->
ªadabÀ
 == 0)

103 if(
f
->
ty≥
 =
FD_PIPE
)

104  
	`pùîód
(
f
->
pùe
, 
addr
, 
n
);

105 if(
f
->
ty≥
 =
FD_INODE
){

106 
	`ûock
(
f
->
ù
);

107 if((
r
 = 
	`ªadi
(
f
->
ù
, 
addr
, f->
off
, 
n
)) > 0)

108 
f
->
off
 +
r
;

109 
	`iu∆ock
(
f
->
ù
);

110  
r
;

112 
	`∑nic
("fileread");

113 
	}
}

118 
	$fûewrôe
(
fûe
 *
f
, *
addr
, 
n
)

120 
r
;

122 if(
f
->
wrôabÀ
 == 0)

124 if(
f
->
ty≥
 =
FD_PIPE
)

125  
	`pùewrôe
(
f
->
pùe
, 
addr
, 
n
);

126 if(
f
->
ty≥
 =
FD_INODE
){

133 
max
 = ((
LOGSIZE
-1-1-2) / 2) * 512;

134 
i
 = 0;

135 
i
 < 
n
){

136 
n1
 = 
n
 - 
i
;

137 if(
n1
 > 
max
)

138 
n1
 = 
max
;

140 
	`begö_›
();

141 
	`ûock
(
f
->
ù
);

142 i‡((
r
 = 
	`wrôei
(
f
->
ù
, 
addr
 + 
i
, f->
off
, 
n1
)) > 0)

143 
f
->
off
 +
r
;

144 
	`iu∆ock
(
f
->
ù
);

145 
	`íd_›
();

147 if(
r
 < 0)

149 if(
r
 !
n1
)

150 
	`∑nic
("short filewrite");

151 
i
 +
r
;

153  
i
 =
n
 ?Ç : -1;

155 
	`∑nic
("filewrite");

156 
	}
}

	@file.h

1 
	sfûe
 {

2 íum { 
	mFD_NONE
, 
	mFD_PIPE
, 
	mFD_INODE
 } 
	mty≥
;

3 
	mªf
;

4 
	mªadabÀ
;

5 
	mwrôabÀ
;

6 
pùe
 *
	mpùe
;

7 
öode
 *
	mù
;

8 
uöt
 
	moff
;

13 
	söode
 {

14 
uöt
 
	mdev
;

15 
uöt
 
	möum
;

16 
	mªf
;

17 
¶ì∂ock
 
	mlock
;

18 
	mÊags
;

20 
	mty≥
;

21 
	mmaj‹
;

22 
	mmö‹
;

23 
	m∆ök
;

24 
uöt
 
	msize
;

25 
uöt
 
	maddrs
[
NDIRECT
+1];

27 
	#I_VALID
 0x2

	)

31 
	sdevsw
 {

32 (*
	mªad
)(
	möode
*, *, );

33 (*
	mwrôe
)(
	möode
*, *, );

36 
devsw
 devsw[];

38 
	#CONSOLE
 1

	)

	@forktest.c

4 
	~"ty≥s.h
"

5 
	~"°©.h
"

6 
	~"u£r.h
"

8 
	#N
 1000

	)

11 
	$¥ötf
(
fd
, *
s
, ...)

13 
	`wrôe
(
fd
, 
s
, 
	`°æí
(s));

14 
	}
}

17 
	$f‹kã°
()

19 
n
, 
pid
;

21 
	`¥ötf
(1, "forkÅest\n");

23 
n
=0;Ç<
N
;Ç++){

24 
pid
 = 
	`f‹k
();

25 if(
pid
 < 0)

27 if(
pid
 == 0)

28 
	`exô
();

31 if(
n
 =
N
){

32 
	`¥ötf
(1, "f‹k cœimedÅÿw‹k NÅimes!\n", 
N
);

33 
	`exô
();

36 ; 
n
 > 0;Ç--){

37 if(
	`waô
() < 0){

38 
	`¥ötf
(1, "wait stoppedÉarly\n");

39 
	`exô
();

43 if(
	`waô
() != -1){

44 
	`¥ötf
(1, "wait gotÅoo many\n");

45 
	`exô
();

48 
	`¥ötf
(1, "forkÅest OK\n");

49 
	}
}

52 
	$maö
()

54 
	`f‹kã°
();

55 
	`exô
();

56 
	}
}

	@fs.c

12 
	~"ty≥s.h
"

13 
	~"defs.h
"

14 
	~"∑øm.h
"

15 
	~"°©.h
"

16 
	~"mmu.h
"

17 
	~"¥oc.h
"

18 
	~"•ölock.h
"

19 
	~"¶ì∂ock.h
"

20 
	~"fs.h
"

21 
	~"buf.h
"

22 
	~"fûe.h
"

24 
	#mö
(
a
, 
b
Ë(◊Ë< (bË? (aË: (b))

	)

25 
ôrunc
(
öode
*);

28 
su≥rblock
 
	gsb
;

32 
	$ªadsb
(
dev
, 
su≥rblock
 *
sb
)

34 
buf
 *
bp
;

36 
bp
 = 
	`bªad
(
dev
, 1);

37 
	`memmove
(
sb
, 
bp
->
d©a
, (*sb));

38 
	`bªl£
(
bp
);

39 
	}
}

43 
	$bzîo
(
dev
, 
bno
)

45 
buf
 *
bp
;

47 
bp
 = 
	`bªad
(
dev
, 
bno
);

48 
	`mem£t
(
bp
->
d©a
, 0, 
BSIZE
);

49 
	`log_wrôe
(
bp
);

50 
	`bªl£
(
bp
);

51 
	}
}

56 
uöt


57 
	$bÆloc
(
uöt
 
dev
)

59 
b
, 
bi
, 
m
;

60 
buf
 *
bp
;

62 
bp
 = 0;

63 
b
 = 0; b < 
sb
.
size
; b +
BPB
){

64 
bp
 = 
	`bªad
(
dev
, 
	`BBLOCK
(
b
, 
sb
));

65 
bi
 = 0; bò< 
BPB
 && 
b
 + bò< 
sb
.
size
; bi++){

66 
m
 = 1 << (
bi
 % 8);

67 if((
bp
->
d©a
[
bi
/8] & 
m
) == 0){

68 
bp
->
d©a
[
bi
/8] |
m
;

69 
	`log_wrôe
(
bp
);

70 
	`bªl£
(
bp
);

71 
	`bzîo
(
dev
, 
b
 + 
bi
);

72  
b
 + 
bi
;

75 
	`bªl£
(
bp
);

77 
	`∑nic
("balloc: out of blocks");

78 
	}
}

82 
	$b‰ì
(
dev
, 
uöt
 
b
)

84 
buf
 *
bp
;

85 
bi
, 
m
;

87 
	`ªadsb
(
dev
, &
sb
);

88 
bp
 = 
	`bªad
(
dev
, 
	`BBLOCK
(
b
, 
sb
));

89 
bi
 = 
b
 % 
BPB
;

90 
m
 = 1 << (
bi
 % 8);

91 if((
bp
->
d©a
[
bi
/8] & 
m
) == 0)

92 
	`∑nic
("freeing free block");

93 
bp
->
d©a
[
bi
/8] &~
m
;

94 
	`log_wrôe
(
bp
);

95 
	`bªl£
(
bp
);

96 
	}
}

159 
•ölock
 
	mlock
;

160 
öode
 
	möode
[
NINODE
];

161 } 
	giˇche
;

164 
	$iöô
(
dev
)

166 
i
 = 0;

168 
	`öôlock
(&
iˇche
.
lock
, "icache");

169 
i
 = 0; i < 
NINODE
; i++) {

170 
	`öô¶ì∂ock
(&
iˇche
.
öode
[
i
].
lock
, "inode");

173 
	`ªadsb
(
dev
, &
sb
);

174 
	`˝rötf
("sb: sizê%dÇblock†%dÇöode†%dÇlog %dÜog°¨à%d\
 %d bm≠ sèπ %d\n", 
sb
.
size
, sb.
nblocks
,

176 
sb
.
nöodes
, sb.
∆og
, sb.
log°¨t
, sb.
öode°¨t
,

177 
sb
.
bm≠°¨t
);

178 
	}
}

180 
öode
* 
igë
(
uöt
 
dev
, uöà
öum
);

185 
öode
*

186 
	$üŒoc
(
uöt
 
dev
, 
ty≥
)

188 
öum
;

189 
buf
 *
bp
;

190 
döode
 *
dù
;

192 
öum
 = 1; inum < 
sb
.
nöodes
; inum++){

193 
bp
 = 
	`bªad
(
dev
, 
	`IBLOCK
(
öum
, 
sb
));

194 
dù
 = (
döode
*)
bp
->
d©a
 + 
öum
%
IPB
;

195 if(
dù
->
ty≥
 == 0){

196 
	`mem£t
(
dù
, 0, (*dip));

197 
dù
->
ty≥
 =Åype;

198 
	`log_wrôe
(
bp
);

199 
	`bªl£
(
bp
);

200  
	`igë
(
dev
, 
öum
);

202 
	`bªl£
(
bp
);

204 
	`∑nic
("ialloc:Ço inodes");

205 
	}
}

209 
	$iupd©e
(
öode
 *
ù
)

211 
buf
 *
bp
;

212 
döode
 *
dù
;

214 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`IBLOCK
(ù->
öum
, 
sb
));

215 
dù
 = (
döode
*)
bp
->
d©a
 + 
ù
->
öum
%
IPB
;

216 
dù
->
ty≥
 = 
ù
->type;

217 
dù
->
maj‹
 = 
ù
->major;

218 
dù
->
mö‹
 = 
ù
->minor;

219 
dù
->
∆ök
 = 
ù
->nlink;

220 
dù
->
size
 = 
ù
->size;

221 
	`memmove
(
dù
->
addrs
, 
ù
->addrs, (ip->addrs));

222 
	`log_wrôe
(
bp
);

223 
	`bªl£
(
bp
);

224 
	}
}

229 
öode
*

230 
	$igë
(
uöt
 
dev
, uöà
öum
)

232 
öode
 *
ù
, *
em±y
;

234 
	`acquúe
(&
iˇche
.
lock
);

237 
em±y
 = 0;

238 
ù
 = &
iˇche
.
öode
[0]; i∞< &iˇche.öode[
NINODE
]; ip++){

239 if(
ù
->
ªf
 > 0 && ip->
dev
 =dev && ip->
öum
 == inum){

240 
ù
->
ªf
++;

241 
	`ªÀa£
(&
iˇche
.
lock
);

242  
ù
;

244 if(
em±y
 =0 && 
ù
->
ªf
 == 0)

245 
em±y
 = 
ù
;

249 if(
em±y
 == 0)

250 
	`∑nic
("iget:Ço inodes");

252 
ù
 = 
em±y
;

253 
ù
->
dev
 = dev;

254 
ù
->
öum
 = inum;

255 
ù
->
ªf
 = 1;

256 
ù
->
Êags
 = 0;

257 
	`ªÀa£
(&
iˇche
.
lock
);

259  
ù
;

260 
	}
}

264 
öode
*

265 
	$idup
(
öode
 *
ù
)

267 
	`acquúe
(&
iˇche
.
lock
);

268 
ù
->
ªf
++;

269 
	`ªÀa£
(&
iˇche
.
lock
);

270  
ù
;

271 
	}
}

276 
	$ûock
(
öode
 *
ù
)

278 
buf
 *
bp
;

279 
döode
 *
dù
;

281 if(
ù
 =0 || ip->
ªf
 < 1)

282 
	`∑nic
("ilock");

284 
	`acquúe¶ìp
(&
ù
->
lock
);

286 if(!(
ù
->
Êags
 & 
I_VALID
)){

287 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`IBLOCK
(ù->
öum
, 
sb
));

288 
dù
 = (
döode
*)
bp
->
d©a
 + 
ù
->
öum
%
IPB
;

289 
ù
->
ty≥
 = 
dù
->type;

290 
ù
->
maj‹
 = 
dù
->major;

291 
ù
->
mö‹
 = 
dù
->minor;

292 
ù
->
∆ök
 = 
dù
->nlink;

293 
ù
->
size
 = 
dù
->size;

294 
	`memmove
(
ù
->
addrs
, 
dù
->addrs, (ip->addrs));

295 
	`bªl£
(
bp
);

296 
ù
->
Êags
 |
I_VALID
;

297 if(
ù
->
ty≥
 == 0)

298 
	`∑nic
("ilock:ÇoÅype");

300 
	}
}

304 
	$iu∆ock
(
öode
 *
ù
)

306 if(
ù
 =0 || !
	`hﬁdög¶ìp
(&ù->
lock
Ë|| ip->
ªf
 < 1)

307 
	`∑nic
("iunlock");

309 
	`ªÀa£¶ìp
(&
ù
->
lock
);

310 
	}
}

320 
	$ùut
(
öode
 *
ù
)

322 
	`acquúe
(&
iˇche
.
lock
);

323 if(
ù
->
ªf
 =1 && (ù->
Êags
 & 
I_VALID
Ë&& ip->
∆ök
 == 0){

325 
	`ªÀa£
(&
iˇche
.
lock
);

326 
	`ôrunc
(
ù
);

327 
ù
->
ty≥
 = 0;

328 
	`iupd©e
(
ù
);

329 
	`acquúe
(&
iˇche
.
lock
);

330 
ù
->
Êags
 = 0;

332 
ù
->
ªf
--;

333 
	`ªÀa£
(&
iˇche
.
lock
);

334 
	}
}

338 
	$iu∆ockput
(
öode
 *
ù
)

340 
	`iu∆ock
(
ù
);

341 
	`ùut
(
ù
);

342 
	}
}

354 
uöt


355 
	$bm≠
(
öode
 *
ù
, 
uöt
 
bn
)

357 
uöt
 
addr
, *
a
;

358 
buf
 *
bp
;

360 if(
bn
 < 
NDIRECT
){

361 if((
addr
 = 
ù
->
addrs
[
bn
]) == 0)

362 
ù
->
addrs
[
bn
] = 
addr
 = 
	`bÆloc
(ù->
dev
);

363  
addr
;

365 
bn
 -
NDIRECT
;

367 if(
bn
 < 
NINDIRECT
){

369 if((
addr
 = 
ù
->
addrs
[
NDIRECT
]) == 0)

370 
ù
->
addrs
[
NDIRECT
] = 
addr
 = 
	`bÆloc
(ù->
dev
);

371 
bp
 = 
	`bªad
(
ù
->
dev
, 
addr
);

372 
a
 = (
uöt
*)
bp
->
d©a
;

373 if((
addr
 = 
a
[
bn
]) == 0){

374 
a
[
bn
] = 
addr
 = 
	`bÆloc
(
ù
->
dev
);

375 
	`log_wrôe
(
bp
);

377 
	`bªl£
(
bp
);

378  
addr
;

381 
	`∑nic
("bmap: out ofÑange");

382 
	}
}

390 
	$ôrunc
(
öode
 *
ù
)

392 
i
, 
j
;

393 
buf
 *
bp
;

394 
uöt
 *
a
;

396 
i
 = 0; i < 
NDIRECT
; i++){

397 if(
ù
->
addrs
[
i
]){

398 
	`b‰ì
(
ù
->
dev
, ip->
addrs
[
i
]);

399 
ù
->
addrs
[
i
] = 0;

403 if(
ù
->
addrs
[
NDIRECT
]){

404 
bp
 = 
	`bªad
(
ù
->
dev
, ip->
addrs
[
NDIRECT
]);

405 
a
 = (
uöt
*)
bp
->
d©a
;

406 
j
 = 0; j < 
NINDIRECT
; j++){

407 if(
a
[
j
])

408 
	`b‰ì
(
ù
->
dev
, 
a
[
j
]);

410 
	`bªl£
(
bp
);

411 
	`b‰ì
(
ù
->
dev
, ip->
addrs
[
NDIRECT
]);

412 
ù
->
addrs
[
NDIRECT
] = 0;

415 
ù
->
size
 = 0;

416 
	`iupd©e
(
ù
);

417 
	}
}

421 
	$°©i
(
öode
 *
ù
, 
°©
 *
°
)

423 
°
->
dev
 = 
ù
->dev;

424 
°
->
öo
 = 
ù
->
öum
;

425 
°
->
ty≥
 = 
ù
->type;

426 
°
->
∆ök
 = 
ù
->nlink;

427 
°
->
size
 = 
ù
->size;

428 
	}
}

433 
	$ªadi
(
öode
 *
ù
, *
d°
, 
uöt
 
off
, uöà
n
)

435 
uöt
 
tŸ
, 
m
;

436 
buf
 *
bp
;

438 if(
ù
->
ty≥
 =
T_DEV
){

439 if(
ù
->
maj‹
 < 0 || ip->maj‹ >
NDEV
 || !
devsw
[ù->maj‹].
ªad
)

441  
devsw
[
ù
->
maj‹
].
	`ªad
(ù, 
d°
, 
n
);

444 if(
off
 > 
ù
->
size
 || of‡+ 
n
 < off)

446 if(
off
 + 
n
 > 
ù
->
size
)

447 
n
 = 
ù
->
size
 - 
off
;

449 
tŸ
=0;ÅŸ<
n
;ÅŸ+=
m
, 
off
+=m, 
d°
+=m){

450 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`bm≠
(ù, 
off
/
BSIZE
));

451 
m
 = 
	`mö
(
n
 - 
tŸ
, 
BSIZE
 - 
off
%BSIZE);

459 
	`memmove
(
d°
, 
bp
->
d©a
 + 
off
%
BSIZE
, 
m
);

460 
	`bªl£
(
bp
);

462  
n
;

463 
	}
}

468 
	$wrôei
(
öode
 *
ù
, *
§c
, 
uöt
 
off
, uöà
n
)

470 
uöt
 
tŸ
, 
m
;

471 
buf
 *
bp
;

473 if(
ù
->
ty≥
 =
T_DEV
){

474 if(
ù
->
maj‹
 < 0 || ip->maj‹ >
NDEV
 || !
devsw
[ù->maj‹].
wrôe
)

476  
devsw
[
ù
->
maj‹
].
	`wrôe
(ù, 
§c
, 
n
);

479 if(
off
 > 
ù
->
size
 || of‡+ 
n
 < off)

481 if(
off
 + 
n
 > 
MAXFILE
*
BSIZE
)

484 
tŸ
=0;ÅŸ<
n
;ÅŸ+=
m
, 
off
+=m, 
§c
+=m){

485 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`bm≠
(ù, 
off
/
BSIZE
));

486 
m
 = 
	`mö
(
n
 - 
tŸ
, 
BSIZE
 - 
off
%BSIZE);

487 
	`memmove
(
bp
->
d©a
 + 
off
%
BSIZE
, 
§c
, 
m
);

488 
	`log_wrôe
(
bp
);

489 
	`bªl£
(
bp
);

492 if(
n
 > 0 && 
off
 > 
ù
->
size
){

493 
ù
->
size
 = 
off
;

494 
	`iupd©e
(
ù
);

496  
n
;

497 
	}
}

503 
	$«mecmp
(c⁄° *
s
, c⁄° *
t
)

505  
	`°∫cmp
(
s
, 
t
, 
DIRSIZ
);

506 
	}
}

510 
öode
*

511 
	$dúlookup
(
öode
 *
dp
, *
«me
, 
uöt
 *
poff
)

513 
uöt
 
off
, 
öum
;

514 
dúít
 
de
;

516 if(
dp
->
ty≥
 !
T_DIR
)

517 
	`∑nic
("dirlookupÇot DIR");

519 
off
 = 0; of‡< 
dp
->
size
; of‡+(
de
)){

520 if(
	`ªadi
(
dp
, (*)&
de
, 
off
, (de)) != (de))

521 
	`∑nic
("dirlinkÑead");

522 if(
de
.
öum
 == 0)

524 if(
	`«mecmp
(
«me
, 
de
.name) == 0){

526 if(
poff
)

527 *
poff
 = 
off
;

528 
öum
 = 
de
.inum;

529  
	`igë
(
dp
->
dev
, 
öum
);

534 
	}
}

538 
	$dúlök
(
öode
 *
dp
, *
«me
, 
uöt
 
öum
)

540 
off
;

541 
dúít
 
de
;

542 
öode
 *
ù
;

545 if((
ù
 = 
	`dúlookup
(
dp
, 
«me
, 0)) != 0){

546 
	`ùut
(
ù
);

551 
off
 = 0; of‡< 
dp
->
size
; of‡+(
de
)){

552 if(
	`ªadi
(
dp
, (*)&
de
, 
off
, (de)) != (de))

553 
	`∑nic
("dirlinkÑead");

554 if(
de
.
öum
 == 0)

558 
	`°∫˝y
(
de
.
«me
,Çame, 
DIRSIZ
);

559 
de
.
öum
 = inum;

560 if(
	`wrôei
(
dp
, (*)&
de
, 
off
, (de)) != (de))

561 
	`∑nic
("dirlink");

564 
	}
}

582 
	$skùñem
(*
∑th
, *
«me
)

584 *
s
;

585 
Àn
;

587 *
∑th
 == '/')

588 
∑th
++;

589 if(*
∑th
 == 0)

591 
s
 = 
∑th
;

592 *
∑th
 != '/' && *path != 0)

593 
∑th
++;

594 
Àn
 = 
∑th
 - 
s
;

595 if(
Àn
 >
DIRSIZ
)

596 
	`memmove
(
«me
, 
s
, 
DIRSIZ
);

598 
	`memmove
(
«me
, 
s
, 
Àn
);

599 
«me
[
Àn
] = 0;

601 *
∑th
 == '/')

602 
∑th
++;

603  
∑th
;

604 
	}
}

610 
öode
*

611 
	$«mex
(*
∑th
, 
«meù¨ít
, *
«me
)

613 
öode
 *
ù
, *
√xt
;

615 if(*
∑th
 == '/')

616 
ù
 = 
	`igë
(
ROOTDEV
, 
ROOTINO
);

618 
ù
 = 
	`idup
(
¥oc
->
cwd
);

620 (
∑th
 = 
	`skùñem
’©h, 
«me
)) != 0){

621 
	`ûock
(
ù
);

622 if(
ù
->
ty≥
 !
T_DIR
){

623 
	`iu∆ockput
(
ù
);

626 if(
«meù¨ít
 && *
∑th
 == '\0'){

628 
	`iu∆ock
(
ù
);

629  
ù
;

631 if((
√xt
 = 
	`dúlookup
(
ù
, 
«me
, 0)) == 0){

632 
	`iu∆ockput
(
ù
);

635 
	`iu∆ockput
(
ù
);

636 
ù
 = 
√xt
;

638 if(
«meù¨ít
){

639 
	`ùut
(
ù
);

642  
ù
;

643 
	}
}

645 
öode
*

646 
	$«mei
(*
∑th
)

648 
«me
[
DIRSIZ
];

649  
	`«mex
(
∑th
, 0, 
«me
);

650 
	}
}

652 
öode
*

653 
	$«meù¨ít
(*
∑th
, *
«me
)

655  
	`«mex
(
∑th
, 1, 
«me
);

656 
	}
}

	@fs.h

5 
	#ROOTINO
 1

6 
	#BSIZE
 512

7 

	)

14 
	ssu≥rblock
 {

15 
uöt
 
	msize
;

16 
uöt
 
	mnblocks
;

17 
uöt
 
	mnöodes
;

18 
uöt
 
	m∆og
;

19 
uöt
 
	mlog°¨t
;

20 
uöt
 
	möode°¨t
;

21 
uöt
 
	mbm≠°¨t
;

24 
	#NDIRECT
 12

	)

25 
	#NINDIRECT
 (
BSIZE
 / (
uöt
))

	)

26 
	#MAXFILE
 (
NDIRECT
 + 
NINDIRECT
)

	)

29 
	sdöode
 {

30 
	mty≥
;

31 
	mmaj‹
;

32 
	mmö‹
;

33 
	m∆ök
;

34 
uöt
 
	msize
;

35 
uöt
 
	maddrs
[
NDIRECT
+1];

39 
	#IPB
 (
BSIZE
 / (
döode
))

	)

42 
	#IBLOCK
(
i
, 
sb
Ë((iË/ 
IPB
 + sb.
öode°¨t
)

	)

45 
	#BPB
 (
BSIZE
*8)

	)

48 
	#BBLOCK
(
b
, 
sb
Ë(b/
BPB
 + sb.
bm≠°¨t
)

	)

51 
	#DIRSIZ
 14

	)

53 
	sdúít
 {

54 
ush‹t
 
	möum
;

55 
	m«me
[
DIRSIZ
];

	@grep.c

3 
	~"ty≥s.h
"

4 
	~"°©.h
"

5 
	~"u£r.h
"

7 
	gbuf
[1024];

8 
m©ch
(*, *);

11 
	$gªp
(*
∑âîn
, 
fd
)

13 
n
, 
m
;

14 *
p
, *
q
;

16 
m
 = 0;

17 (
n
 = 
	`ªad
(
fd
, 
buf
+
m
, (buf)-m-1)) > 0){

18 
m
 +
n
;

19 
buf
[
m
] = '\0';

20 
p
 = 
buf
;

21 (
q
 = 
	`°rchr
(
p
, '\n')) != 0){

22 *
q
 = 0;

23 if(
	`m©ch
(
∑âîn
, 
p
)){

24 *
q
 = '\n';

25 
	`wrôe
(1, 
p
, 
q
+1 -Ö);

27 
p
 = 
q
+1;

29 if(
p
 =
buf
)

30 
m
 = 0;

31 if(
m
 > 0){

32 
m
 -
p
 - 
buf
;

33 
	`memmove
(
buf
, 
p
, 
m
);

36 
	}
}

39 
	$maö
(
¨gc
, *
¨gv
[])

41 
fd
, 
i
;

42 *
∑âîn
;

44 if(
¨gc
 <= 1){

45 
	`¥ötf
(2, "usage: grepÖattern [file ...]\n");

46 
	`exô
();

48 
∑âîn
 = 
¨gv
[1];

50 if(
¨gc
 <= 2){

51 
	`gªp
(
∑âîn
, 0);

52 
	`exô
();

55 
i
 = 2; i < 
¨gc
; i++){

56 if((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0){

57 
	`¥ötf
(1, "gªp: c™nŸ o≥¿%s\n", 
¨gv
[
i
]);

58 
	`exô
();

60 
	`gªp
(
∑âîn
, 
fd
);

61 
	`˛o£
(
fd
);

63 
	`exô
();

64 
	}
}

69 
m©chhîe
(*, *);

70 
m©ch°¨
(, *, *);

73 
	$m©ch
(*
ª
, *
ãxt
)

75 if(
ª
[0] == '^')

76  
	`m©chhîe
(
ª
+1, 
ãxt
);

78 if(
	`m©chhîe
(
ª
, 
ãxt
))

80 }*
ãxt
++ != '\0');

82 
	}
}

85 
	$m©chhîe
(*
ª
, *
ãxt
)

87 if(
ª
[0] == '\0')

89 if(
ª
[1] == '*')

90  
	`m©ch°¨
(
ª
[0],Ñe+2, 
ãxt
);

91 if(
ª
[0] == '$' &&Ñe[1] == '\0')

92  *
ãxt
 == '\0';

93 if(*
ãxt
!='\0' && (
ª
[0]=='.' ||Ñe[0]==*text))

94  
	`m©chhîe
(
ª
+1, 
ãxt
+1);

96 
	}
}

99 
	$m©ch°¨
(
c
, *
ª
, *
ãxt
)

102 if(
	`m©chhîe
(
ª
, 
ãxt
))

104 }*
ãxt
!='\0' && (*ãxt++==
c
 || c=='.'));

106 
	}
}

	@ide.c

3 
	~"ty≥s.h
"

4 
	~"defs.h
"

5 
	~"∑øm.h
"

6 
	~"memœyout.h
"

7 
	~"mmu.h
"

8 
	~"¥oc.h
"

9 
	~"x86.h
"

10 
	~"å≠s.h
"

11 
	~"•ölock.h
"

12 
	~"¶ì∂ock.h
"

13 
	~"fs.h
"

14 
	~"buf.h
"

16 
	#SECTOR_SIZE
 512

	)

17 
	#IDE_BSY
 0x80

	)

18 
	#IDE_DRDY
 0x40

	)

19 
	#IDE_DF
 0x20

	)

20 
	#IDE_ERR
 0x01

	)

22 
	#IDE_CMD_READ
 0x20

	)

23 
	#IDE_CMD_WRITE
 0x30

	)

24 
	#IDE_CMD_RDMUL
 0xc4

	)

25 
	#IDE_CMD_WRMUL
 0xc5

	)

31 
•ölock
 
	gidñock
;

32 
buf
 *
	gidequeue
;

34 
	ghavedisk1
;

35 
ide°¨t
(
buf
*);

39 
	$idewaô
(
checkîr
)

41 
r
;

43 ((
r
 = 
	`öb
(0x1f7)Ë& (
IDE_BSY
|
IDE_DRDY
)) != IDE_DRDY)

45 if(
checkîr
 && (
r
 & (
IDE_DF
|
IDE_ERR
)) != 0)

48 
	}
}

51 
	$ideöô
()

53 
i
;

55 
	`öôlock
(&
idñock
, "ide");

56 
	`pi˚«bÀ
(
IRQ_IDE
);

57 
	`iﬂpi˚«bÀ
(
IRQ_IDE
, 
n˝u
 - 1);

58 
	`idewaô
(0);

61 
	`outb
(0x1f6, 0xe0 | (1<<4));

62 
i
=0; i<1000; i++){

63 if(
	`öb
(0x1f7) != 0){

64 
havedisk1
 = 1;

70 
	`outb
(0x1f6, 0xe0 | (0<<4));

71 
	}
}

75 
	$ide°¨t
(
buf
 *
b
)

77 if(
b
 == 0)

78 
	`∑nic
("idestart");

79 if(
b
->
blockno
 >
FSSIZE
)

80 
	`∑nic
("incorrect blockno");

81 
£˘‹_≥r_block
 = 
BSIZE
/
SECTOR_SIZE
;

82 
£˘‹
 = 
b
->
blockno
 * 
£˘‹_≥r_block
;

83 
ªad_cmd
 = (
£˘‹_≥r_block
 =1Ë? 
IDE_CMD_READ
 : 
IDE_CMD_RDMUL
;

84 
wrôe_cmd
 = (
£˘‹_≥r_block
 =1Ë? 
IDE_CMD_WRITE
 : 
IDE_CMD_WRMUL
;

86 i‡(
£˘‹_≥r_block
 > 7Ë
	`∑nic
("idestart");

88 
	`idewaô
(0);

89 
	`outb
(0x3f6, 0);

90 
	`outb
(0x1f2, 
£˘‹_≥r_block
);

91 
	`outb
(0x1f3, 
£˘‹
 & 0xff);

92 
	`outb
(0x1f4, (
£˘‹
 >> 8) & 0xff);

93 
	`outb
(0x1f5, (
£˘‹
 >> 16) & 0xff);

94 
	`outb
(0x1f6, 0xe0 | ((
b
->
dev
&1)<<4Ë| ((
£˘‹
>>24)&0x0f));

95 if(
b
->
Êags
 & 
B_DIRTY
){

96 
	`outb
(0x1f7, 
wrôe_cmd
);

97 
	`out¶
(0x1f0, 
b
->
d©a
, 
BSIZE
/4);

99 
	`outb
(0x1f7, 
ªad_cmd
);

101 
	}
}

105 
	$ideöå
()

107 
buf
 *
b
;

110 
	`acquúe
(&
idñock
);

111 if((
b
 = 
idequeue
) == 0){

112 
	`ªÀa£
(&
idñock
);

116 
idequeue
 = 
b
->
q√xt
;

119 if(!(
b
->
Êags
 & 
B_DIRTY
Ë&& 
	`idewaô
(1) >= 0)

120 
	`ö¶
(0x1f0, 
b
->
d©a
, 
BSIZE
/4);

123 
b
->
Êags
 |
B_VALID
;

124 
b
->
Êags
 &~
B_DIRTY
;

125 
	`wakeup
(
b
);

128 if(
idequeue
 != 0)

129 
	`ide°¨t
(
idequeue
);

131 
	`ªÀa£
(&
idñock
);

132 
	}
}

139 
	$idîw
(
buf
 *
b
)

141 
buf
 **
µ
;

143 if(!
	`hﬁdög¶ìp
(&
b
->
lock
))

144 
	`∑nic
("iderw: bufÇotÜocked");

145 if((
b
->
Êags
 & (
B_VALID
|
B_DIRTY
)) == B_VALID)

146 
	`∑nic
("iderw:ÇothingÅo do");

147 if(
b
->
dev
 !0 && !
havedisk1
)

148 
	`∑nic
("iderw: ide disk 1ÇotÖresent");

150 
	`acquúe
(&
idñock
);

153 
b
->
q√xt
 = 0;

154 
µ
=&
idequeue
; *µ;Öp=&(*µ)->
q√xt
)

156 *
µ
 = 
b
;

159 if(
idequeue
 =
b
)

160 
	`ide°¨t
(
b
);

163 (
b
->
Êags
 & (
B_VALID
|
B_DIRTY
)) != B_VALID){

164 
	`¶ìp
(
b
, &
idñock
);

167 
	`ªÀa£
(&
idñock
);

168 
	}
}

	@init.c

3 
	~"ty≥s.h
"

4 
	~"°©.h
"

5 
	~"u£r.h
"

6 
	~"f˙é.h
"

8 *
	g¨gv
[] = { "sh", 0 };

11 
	$maö
()

13 
pid
, 
wpid
;

15 if(
	`›í
("c⁄sﬁe", 
O_RDWR
) < 0){

16 
	`mknod
("console", 1, 1);

17 
	`›í
("c⁄sﬁe", 
O_RDWR
);

19 
	`dup
(0);

20 
	`dup
(0);

23 
	`¥ötf
(1, "init: starting sh\n");

24 
pid
 = 
	`f‹k
();

25 if(
pid
 < 0){

26 
	`¥ötf
(1, "init: fork failed\n");

27 
	`exô
();

29 if(
pid
 == 0){

30 
	`exec
("sh", 
¨gv
);

31 
	`¥ötf
(1, "init:Éxec sh failed\n");

32 
	`exô
();

34 (
wpid
=
	`waô
()Ë>0 && wpid !
pid
)

35 
	`¥ötf
(1, "zombie!\n");

37 
	}
}

	@initcode.S

1 #Inôü»
¥o˚ss
 
execs
 /
öô
.

2 #Thi†
code
 
runs
 
ö
 
u£r
 
•a˚
.

4 
	~"sysˇŒ.h
"

5 
	~"å≠s.h
"

8 #exec(
öô
, 
¨gv
)

9 .
globl
 
°¨t


10 
	g°¨t
:

11 
pushl
 
$¨gv


12 
pushl
 
$öô


13 
pushl
 
$0


14 
movl
 
$SYS_exec
, %
óx


15 
	g$T_SYSCALL


17 #f‹(;;Ë
exô
();

18 
	gexô
:

19 
movl
 
$SYS_exô
, %
óx


20 
$T_SYSCALL


21 
jmp
 
	gexô


23 #ch¨ 
öô
[] = "/init\0";

24 
	göô
:

25 .
°rög
 "/init\0"

27 #ch¨ *
¨gv
[] = { 
öô
, 0 };

28 .
	gp2Æign
 2

29 
	g¨gv
:

30 .
öô


	@ioapic.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"å≠s.h
"

9 
	#IOAPIC
 0xFEC00000

10 

	)

11 
	#REG_ID
 0x00

12 
	#REG_VER
 0x01

13 
	#REG_TABLE
 0x10

14 

	)

20 
	#INT_DISABLED
 0x00010000

21 
	#INT_LEVEL
 0x00008000

22 
	#INT_ACTIVELOW
 0x00002000

23 
	#INT_LOGICAL
 0x00000800

24 

	)

25 vﬁ©ûê
iﬂpic
 *
	giﬂpic
;

28 
	siﬂpic
 {

29 
uöt
 
	mªg
;

30 
uöt
 
	m∑d
[3];

31 
uöt
 
	md©a
;

34 
uöt


35 
	$iﬂpi¸ód
(
ªg
)

37 
iﬂpic
->
ªg
 =Ñeg;

38  
iﬂpic
->
d©a
;

39 
	}
}

42 
	$iﬂpicwrôe
(
ªg
, 
uöt
 
d©a
)

44 
iﬂpic
->
ªg
 =Ñeg;

45 
iﬂpic
->
d©a
 = data;

46 
	}
}

49 
	$iﬂpicöô
()

51 
i
, 
id
, 
maxöå
;

53 if(!
ismp
)

56 
iﬂpic
 = (vﬁ©ûêiﬂpic*)
IOAPIC
;

57 
maxöå
 = (
	`iﬂpi¸ód
(
REG_VER
) >> 16) & 0xFF;

58 
id
 = 
	`iﬂpi¸ód
(
REG_ID
) >> 24;

59 if(
id
 !
iﬂpicid
)

60 
	`˝rötf
("ioapicinit: id isn'tÉqualÅo ioapicid;Çotá MP\n");

64 
i
 = 0; i <
maxöå
; i++){

65 
	`iﬂpicwrôe
(
REG_TABLE
+2*
i
, 
INT_DISABLED
 | (
T_IRQ0
 + i));

66 
	`iﬂpicwrôe
(
REG_TABLE
+2*
i
+1, 0);

68 
	}
}

71 
	$iﬂpi˚«bÀ
(
úq
, 
˝unum
)

73 if(!
ismp
)

79 
	`iﬂpicwrôe
(
REG_TABLE
+2*
úq
, 
T_IRQ0
 + irq);

80 
	`iﬂpicwrôe
(
REG_TABLE
+2*
úq
+1, 
˝unum
 << 24);

81 
	}
}

	@kalloc.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"∑øm.h
"

8 
	~"memœyout.h
"

9 
	~"mmu.h
"

10 
	~"•ölock.h
"

12 
‰ìønge
(*
v°¨t
, *
víd
);

13 
íd
[];

15 
	srun
 {

16 
run
 *
	m√xt
;

20 
•ölock
 
	mlock
;

21 
	mu£_lock
;

22 
run
 *
	m‰ìli°
;

23 } 
	gkmem
;

31 
	$köô1
(*
v°¨t
, *
víd
)

33 
	`öôlock
(&
kmem
.
lock
, "kmem");

34 
kmem
.
u£_lock
 = 0;

35 
	`‰ìønge
(
v°¨t
, 
víd
);

36 
	}
}

39 
	$köô2
(*
v°¨t
, *
víd
)

41 
	`‰ìønge
(
v°¨t
, 
víd
);

42 
kmem
.
u£_lock
 = 1;

43 
	}
}

46 
	$‰ìønge
(*
v°¨t
, *
víd
)

48 *
p
;

49 
p
 = (*)
	`PGROUNDUP
((
uöt
)
v°¨t
);

50 ; 
p
 + 
PGSIZE
 <(*)
víd
;Ö += PGSIZE)

51 
	`k‰ì
(
p
);

52 
	}
}

60 
	$k‰ì
(*
v
)

62 
run
 *
r
;

64 if((
uöt
)
v
 % 
PGSIZE
 || v < 
íd
 || 
	`V2P
(vË>
PHYSTOP
)

65 
	`∑nic
("kfree");

68 
	`mem£t
(
v
, 1, 
PGSIZE
);

70 if(
kmem
.
u£_lock
)

71 
	`acquúe
(&
kmem
.
lock
);

72 
r
 = (
run
*)
v
;

73 
r
->
√xt
 = 
kmem
.
‰ìli°
;

74 
kmem
.
‰ìli°
 = 
r
;

75 if(
kmem
.
u£_lock
)

76 
	`ªÀa£
(&
kmem
.
lock
);

77 
	}
}

83 
	$kÆloc
()

85 
run
 *
r
;

87 if(
kmem
.
u£_lock
)

88 
	`acquúe
(&
kmem
.
lock
);

89 
r
 = 
kmem
.
‰ìli°
;

90 if(
r
)

91 
kmem
.
‰ìli°
 = 
r
->
√xt
;

92 if(
kmem
.
u£_lock
)

93 
	`ªÀa£
(&
kmem
.
lock
);

95 #ifde‡
THREAD_DEBUGGING


96 if(
r
 == 0) {

97 
	`˝rötf
("(kalloc)Érror: kernel memory is full.\n");

101  (*)
r
;

102 
	}
}

	@kbd.c

1 
	~"ty≥s.h
"

2 
	~"x86.h
"

3 
	~"defs.h
"

4 
	~"kbd.h
"

7 
	$kbdgëc
()

9 
uöt
 
shi·
;

10 
uch¨
 *
ch¨code
[4] = {

11 
n‹mÆm≠
, 
shi·m≠
, 
˘lm≠
, ctlmap

13 
uöt
 
°
, 
d©a
, 
c
;

15 
°
 = 
	`öb
(
KBSTATP
);

16 if((
°
 & 
KBS_DIB
) == 0)

18 
d©a
 = 
	`öb
(
KBDATAP
);

20 if(
d©a
 == 0xE0){

21 
shi·
 |
E0ESC
;

23 } if(
d©a
 & 0x80){

25 
d©a
 = (
shi·
 & 
E0ESC
 ? data : data & 0x7F);

26 
shi·
 &~(
shi·code
[
d©a
] | 
E0ESC
);

28 } if(
shi·
 & 
E0ESC
){

30 
d©a
 |= 0x80;

31 
shi·
 &~
E0ESC
;

34 
shi·
 |
shi·code
[
d©a
];

35 
shi·
 ^
toggÀcode
[
d©a
];

36 
c
 = 
ch¨code
[
shi·
 & (
CTL
 | 
SHIFT
)][
d©a
];

37 if(
shi·
 & 
CAPSLOCK
){

38 if('a' <
c
 && c <= 'z')

39 
c
 += 'A' - 'a';

40 if('A' <
c
 && c <= 'Z')

41 
c
 += 'a' - 'A';

43  
c
;

44 
	}
}

47 
	$kbdöå
()

49 
	`c⁄sﬁeöå
(
kbdgëc
);

50 
	}
}

	@kbd.h

3 
	#KBSTATP
 0x64

4 
	#KBS_DIB
 0x01

5 
	#KBDATAP
 0x60

6 

	)

7 
	#NO
 0

	)

9 
	#SHIFT
 (1<<0)

	)

10 
	#CTL
 (1<<1)

	)

11 
	#ALT
 (1<<2)

	)

13 
	#CAPSLOCK
 (1<<3)

	)

14 
	#NUMLOCK
 (1<<4)

	)

15 
	#SCROLLLOCK
 (1<<5)

	)

17 
	#E0ESC
 (1<<6)

	)

20 
	#KEY_HOME
 0xE0

	)

21 
	#KEY_END
 0xE1

	)

22 
	#KEY_UP
 0xE2

	)

23 
	#KEY_DN
 0xE3

	)

24 
	#KEY_LF
 0xE4

	)

25 
	#KEY_RT
 0xE5

	)

26 
	#KEY_PGUP
 0xE6

	)

27 
	#KEY_PGDN
 0xE7

	)

28 
	#KEY_INS
 0xE8

	)

29 
	#KEY_DEL
 0xE9

	)

32 
	#C
(
x
Ë(x - '@')

	)

34 
uch¨
 
	gshi·code
[256] =

36 [0x1D] 
CTL
,

37 [0x2A] 
SHIFT
,

38 [0x36] 
SHIFT
,

39 [0x38] 
ALT
,

40 [0x9D] 
CTL
,

41 [0xB8] 
ALT


44 
uch¨
 
	gtoggÀcode
[256] =

46 [0x3A] 
CAPSLOCK
,

47 [0x45] 
NUMLOCK
,

48 [0x46] 
SCROLLLOCK


51 
uch¨
 
	gn‹mÆm≠
[256] =

53 
NO
, 0x1B, '1', '2', '3', '4', '5', '6',

56 'o', 'p', '[', ']', '\n', 
NO
, 'a', 's',

58 '\'', '`', 
NO
, '\\', 'z', 'x', 'c', 'v',

59 'b', 'n', 'm', ',', '.', '/', 
NO
, '*',

60 
NO
, ' ', NO, NO, NO, NO, NO, NO,

61 
NO
, NO, NO, NO, NO, NO, NO, '7',

63 '2', '3', '0', '.', 
NO
, NO, NO, NO,

66 [0xC8] 
KEY_UP
, [0xD0] 
KEY_DN
,

67 [0xC9] 
KEY_PGUP
, [0xD1] 
KEY_PGDN
,

68 [0xCB] 
KEY_LF
, [0xCD] 
KEY_RT
,

69 [0x97] 
KEY_HOME
, [0xCF] 
KEY_END
,

70 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL


73 
uch¨
 
	gshi·m≠
[256] =

75 
NO
, 033, '!', '@', '#', '$', '%', '^',

78 'O', 'P', '{', '}', '\n', 
NO
, 'A', 'S',

80 '"', '~', 
NO
, '|', 'Z', 'X', 'C', 'V',

81 'B', 'N', 'M', '<', '>', '?', 
NO
, '*',

82 
NO
, ' ', NO, NO, NO, NO, NO, NO,

83 
NO
, NO, NO, NO, NO, NO, NO, '7',

85 '2', '3', '0', '.', 
NO
, NO, NO, NO,

88 [0xC8] 
KEY_UP
, [0xD0] 
KEY_DN
,

89 [0xC9] 
KEY_PGUP
, [0xD1] 
KEY_PGDN
,

90 [0xCB] 
KEY_LF
, [0xCD] 
KEY_RT
,

91 [0x97] 
KEY_HOME
, [0xCF] 
KEY_END
,

92 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL


95 
uch¨
 
	g˘lm≠
[256] =

97 
NO
, NO, NO, NO, NO, NO, NO, NO,

98 
NO
, NO, NO, NO, NO, NO, NO, NO,

99 
C
('Q'), C('W'), C('E'), C('R'), C('T'), C('Y'), C('U'), C('I'),

100 
C
('O'), C('P'), 
NO
, NO, '\r', NO, C('A'), C('S'),

101 
C
('D'), C('F'), C('G'), C('H'), C('J'), C('K'), C('L'), 
NO
,

102 
NO
, NO, NO, 
C
('\\'), C('Z'), C('X'), C('C'), C('V'),

103 
C
('B'), C('N'), C('M'), 
NO
, NO, C('/'), NO, NO,

105 [0xB5] 
C
('/'),

106 [0xC8] 
KEY_UP
, [0xD0] 
KEY_DN
,

107 [0xC9] 
KEY_PGUP
, [0xD1] 
KEY_PGDN
,

108 [0xCB] 
KEY_LF
, [0xCD] 
KEY_RT
,

109 [0x97] 
KEY_HOME
, [0xCF] 
KEY_END
,

110 [0xD2] 
KEY_INS
, [0xD3] 
KEY_DEL


	@kill.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

6 
	$maö
(
¨gc
, **
¨gv
)

8 
i
;

10 if(
¨gc
 < 2){

11 
	`¥ötf
(2, "usage: killÖid...\n");

12 
	`exô
();

14 
i
=1; i<
¨gc
; i++)

15 
	`kûl
(
	`©oi
(
¨gv
[
i
]));

16 
	`exô
();

17 
	}
}

	@lapic.c

4 
	~"∑øm.h
"

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"d©e.h
"

8 
	~"memœyout.h
"

9 
	~"å≠s.h
"

10 
	~"mmu.h
"

11 
	~"x86.h
"

12 
	~"¥oc.h
"

15 
	#ID
 (0x0020/4)

16 
	#VER
 (0x0030/4)

17 
	#TPR
 (0x0080/4)

18 
	#EOI
 (0x00B0/4)

19 
	#SVR
 (0x00F0/4)

20 
	#ENABLE
 0x00000100

21 
	#ESR
 (0x0280/4)

22 
	#ICRLO
 (0x0300/4)

23 
	#INIT
 0x00000500

24 
	#STARTUP
 0x00000600

25 
	#DELIVS
 0x00001000

26 
	#ASSERT
 0x00004000

27 
	#DEASSERT
 0x00000000

	)

28 
	#LEVEL
 0x00008000

29 
	#BCAST
 0x00080000

30 
	#BUSY
 0x00001000

	)

31 
	#FIXED
 0x00000000

	)

32 
	#ICRHI
 (0x0310/4)

33 
	#TIMER
 (0x0320/4)

34 
	#X1
 0x0000000B

35 
	#PERIODIC
 0x00020000

36 
	#PCINT
 (0x0340/4)

37 
	#LINT0
 (0x0350/4)

38 
	#LINT1
 (0x0360/4)

39 
	#ERROR
 (0x0370/4)

40 
	#MASKED
 0x00010000

41 
	#TICR
 (0x0380/4)

42 
	#TCCR
 (0x0390/4)

43 
	#TDCR
 (0x03E0/4)

44 

	)

45 vﬁ©ûê
uöt
 *
	gœpic
;

48 
	$œpicw
(
ödex
, 
vÆue
)

50 
œpic
[
ödex
] = 
vÆue
;

51 
œpic
[
ID
];

52 
	}
}

56 
	$œpicöô
()

58 if(!
œpic
)

62 
	`œpicw
(
SVR
, 
ENABLE
 | (
T_IRQ0
 + 
IRQ_SPURIOUS
));

68 
	`œpicw
(
TDCR
, 
X1
);

69 
	`œpicw
(
TIMER
, 
PERIODIC
 | (
T_IRQ0
 + 
IRQ_TIMER
));

70 
	`œpicw
(
TICR
, 10000000);

73 
	`œpicw
(
LINT0
, 
MASKED
);

74 
	`œpicw
(
LINT1
, 
MASKED
);

78 if(((
œpic
[
VER
]>>16) & 0xFF) >= 4)

79 
	`œpicw
(
PCINT
, 
MASKED
);

82 
	`œpicw
(
ERROR
, 
T_IRQ0
 + 
IRQ_ERROR
);

85 
	`œpicw
(
ESR
, 0);

86 
	`œpicw
(
ESR
, 0);

89 
	`œpicw
(
EOI
, 0);

92 
	`œpicw
(
ICRHI
, 0);

93 
	`œpicw
(
ICRLO
, 
BCAST
 | 
INIT
 | 
LEVEL
);

94 
œpic
[
ICRLO
] & 
DELIVS
)

98 
	`œpicw
(
TPR
, 0);

99 
	}
}

102 
	$˝unum
()

104 
≠icid
, 
i
;

111 if(
	`ªadeÊags
()&
FL_IF
){

112 
n
;

113 if(
n
++ == 0)

114 
	`˝rötf
("cpu called from %x with interruptsÉnabled\n",

115 
	`__buûtö_ªtu∫_addªss
(0));

118 i‡(!
œpic
)

121 
≠icid
 = 
œpic
[
ID
] >> 24;

122 
i
 = 0; i < 
n˝u
; ++i) {

123 i‡(
˝us
[
i
].
≠icid
 ==ápicid)

124  
i
;

126 
	`∑nic
("unknownápicid\n");

127 
	}
}

131 
	$œpi˚oi
()

133 if(
œpic
)

134 
	`œpicw
(
EOI
, 0);

135 
	}
}

140 
	$mi¸odñay
(
us
)

142 
	}
}

144 
	#CMOS_PORT
 0x70

	)

145 
	#CMOS_RETURN
 0x71

	)

150 
	$œpic°¨èp
(
uch¨
 
≠icid
, 
uöt
 
addr
)

152 
i
;

153 
ush‹t
 *
wrv
;

158 
	`outb
(
CMOS_PORT
, 0xF);

159 
	`outb
(
CMOS_PORT
+1, 0x0A);

160 
wrv
 = (
ush‹t
*)
	`P2V
((0x40<<4 | 0x67));

161 
wrv
[0] = 0;

162 
wrv
[1] = 
addr
 >> 4;

166 
	`œpicw
(
ICRHI
, 
≠icid
<<24);

167 
	`œpicw
(
ICRLO
, 
INIT
 | 
LEVEL
 | 
ASSERT
);

168 
	`mi¸odñay
(200);

169 
	`œpicw
(
ICRLO
, 
INIT
 | 
LEVEL
);

170 
	`mi¸odñay
(100);

177 
i
 = 0; i < 2; i++){

178 
	`œpicw
(
ICRHI
, 
≠icid
<<24);

179 
	`œpicw
(
ICRLO
, 
STARTUP
 | (
addr
>>12));

180 
	`mi¸odñay
(200);

182 
	}
}

184 
	#CMOS_STATA
 0x0a

	)

185 
	#CMOS_STATB
 0x0b

	)

186 
	#CMOS_UIP
 (1 << 7)

187 

	)

188 
	#SECS
 0x00

	)

189 
	#MINS
 0x02

	)

190 
	#HOURS
 0x04

	)

191 
	#DAY
 0x07

	)

192 
	#MONTH
 0x08

	)

193 
	#YEAR
 0x09

	)

195 
uöt
 
	$cmos_ªad
(
uöt
 
ªg
)

197 
	`outb
(
CMOS_PORT
, 
ªg
);

198 
	`mi¸odñay
(200);

200  
	`öb
(
CMOS_RETURN
);

201 
	}
}

203 
	$fûl_πcd©e
(
πcd©e
 *
r
)

205 
r
->
£c⁄d
 = 
	`cmos_ªad
(
SECS
);

206 
r
->
möuã
 = 
	`cmos_ªad
(
MINS
);

207 
r
->
hour
 = 
	`cmos_ªad
(
HOURS
);

208 
r
->
day
 = 
	`cmos_ªad
(
DAY
);

209 
r
->
m⁄th
 = 
	`cmos_ªad
(
MONTH
);

210 
r
->
yór
 = 
	`cmos_ªad
(
YEAR
);

211 
	}
}

214 
	$cmo°ime
(
πcd©e
 *
r
)

216 
πcd©e
 
t1
, 
t2
;

217 
sb
, 
bcd
;

219 
sb
 = 
	`cmos_ªad
(
CMOS_STATB
);

221 
bcd
 = (
sb
 & (1 << 2)) == 0;

225 
	`fûl_πcd©e
(&
t1
);

226 if(
	`cmos_ªad
(
CMOS_STATA
Ë& 
CMOS_UIP
)

228 
	`fûl_πcd©e
(&
t2
);

229 if(
	`memcmp
(&
t1
, &
t2
, (t1)) == 0)

234 if(
bcd
) {

235 
	#CONV
(
x
Ë(
t1
.x = (—1.x >> 4Ë* 10Ë+ (t1.x & 0xf))

	)

236 
	`CONV
(
£c⁄d
);

237 
	`CONV
(
möuã
);

238 
	`CONV
(
hour
 );

239 
	`CONV
(
day
 );

240 
	`CONV
(
m⁄th
 );

241 
	`CONV
(
yór
 );

242 #unde‡
CONV


245 *
r
 = 
t1
;

246 
r
->
yór
 += 2000;

247 
	}
}

	@ln.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

6 
	$maö
(
¨gc
, *
¨gv
[])

8 if(
¨gc
 != 3){

9 
	`¥ötf
(2, "Usage:Ün oldÇew\n");

10 
	`exô
();

12 if(
	`lök
(
¨gv
[1],árgv[2]) < 0)

13 
	`¥ötf
(2, "lök %†%s: faûed\n", 
¨gv
[1],árgv[2]);

14 
	`exô
();

15 
	}
}

	@log.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"•ölock.h
"

5 
	~"¶ì∂ock.h
"

6 
	~"fs.h
"

7 
	~"buf.h
"

34 
	sloghódî
 {

35 
	mn
;

36 
	mblock
[
LOGSIZE
];

39 
	slog
 {

40 
•ölock
 
	mlock
;

41 
	m°¨t
;

42 
	msize
;

43 
	mout°™dög
;

44 
	mcommôtög
;

45 
	mdev
;

46 
loghódî
 
	mlh
;

48 
log
 
	glog
;

50 
ªcovî_‰om_log
();

51 
commô
();

54 
	$öôlog
(
dev
)

56 i‡((
loghódî
Ë>
BSIZE
)

57 
	`∑nic
("initlog:Åoo bigÜogheader");

59 
su≥rblock
 
sb
;

60 
	`öôlock
(&
log
.
lock
, "log");

61 
	`ªadsb
(
dev
, &
sb
);

62 
log
.
°¨t
 = 
sb
.
log°¨t
;

63 
log
.
size
 = 
sb
.
∆og
;

64 
log
.
dev
 = dev;

65 
	`ªcovî_‰om_log
();

66 
	}
}

70 
	$ö°Æl_å™s
()

72 
èû
;

74 
èû
 = 0;Åaû < 
log
.
lh
.
n
;Åail++) {

75 
buf
 *
lbuf
 = 
	`bªad
(
log
.
dev
,Üog.
°¨t
+
èû
+1);

76 
buf
 *
dbuf
 = 
	`bªad
(
log
.
dev
,Üog.
lh
.
block
[
èû
]);

77 
	`memmove
(
dbuf
->
d©a
, 
lbuf
->d©a, 
BSIZE
);

78 
	`bwrôe
(
dbuf
);

79 
	`bªl£
(
lbuf
);

80 
	`bªl£
(
dbuf
);

82 
	}
}

86 
	$ªad_hód
()

88 
buf
 *bu‡
	`bªad
(
log
.
dev
,Üog.
°¨t
);

89 
loghódî
 *
lh
 = (loghódî *Ë(
buf
->
d©a
);

90 
i
;

91 
log
.
lh
.
n
 =Üh->n;

92 
i
 = 0; i < 
log
.
lh
.
n
; i++) {

93 
log
.
lh
.
block
[
i
] =Üh->block[i];

95 
	`bªl£
(
buf
);

96 
	}
}

102 
	$wrôe_hód
()

104 
buf
 *bu‡
	`bªad
(
log
.
dev
,Üog.
°¨t
);

105 
loghódî
 *
hb
 = (loghódî *Ë(
buf
->
d©a
);

106 
i
;

107 
hb
->
n
 = 
log
.
lh
.n;

108 
i
 = 0; i < 
log
.
lh
.
n
; i++) {

109 
hb
->
block
[
i
] = 
log
.
lh
.block[i];

111 
	`bwrôe
(
buf
);

112 
	`bªl£
(
buf
);

113 
	}
}

116 
	$ªcovî_‰om_log
()

118 
	`ªad_hód
();

119 
	`ö°Æl_å™s
();

120 
log
.
lh
.
n
 = 0;

121 
	`wrôe_hód
();

122 
	}
}

126 
	$begö_›
()

128 
	`acquúe
(&
log
.
lock
);

130 if(
log
.
commôtög
){

131 
	`¶ìp
(&
log
, &log.
lock
);

132 } if(
log
.
lh
.
n
 + (log.
out°™dög
+1)*
MAXOPBLOCKS
 > 
LOGSIZE
){

134 
	`¶ìp
(&
log
, &log.
lock
);

136 
log
.
out°™dög
 += 1;

137 
	`ªÀa£
(&
log
.
lock
);

141 
	}
}

146 
	$íd_›
()

148 
do_commô
 = 0;

150 
	`acquúe
(&
log
.
lock
);

151 
log
.
out°™dög
 -= 1;

152 if(
log
.
commôtög
)

153 
	`∑nic
("log.committing");

154 if(
log
.
out°™dög
 == 0){

155 
do_commô
 = 1;

156 
log
.
commôtög
 = 1;

159 
	`wakeup
(&
log
);

161 
	`ªÀa£
(&
log
.
lock
);

163 if(
do_commô
){

166 
	`commô
();

167 
	`acquúe
(&
log
.
lock
);

168 
log
.
commôtög
 = 0;

169 
	`wakeup
(&
log
);

170 
	`ªÀa£
(&
log
.
lock
);

172 
	}
}

176 
	$wrôe_log
()

178 
èû
;

180 
èû
 = 0;Åaû < 
log
.
lh
.
n
;Åail++) {

181 
buf
 *
to
 = 
	`bªad
(
log
.
dev
,Üog.
°¨t
+
èû
+1);

182 
buf
 *
‰om
 = 
	`bªad
(
log
.
dev
,Üog.
lh
.
block
[
èû
]);

183 
	`memmove
(
to
->
d©a
, 
‰om
->d©a, 
BSIZE
);

184 
	`bwrôe
(
to
);

185 
	`bªl£
(
‰om
);

186 
	`bªl£
(
to
);

188 
	}
}

191 
	$commô
()

193 i‡(
log
.
lh
.
n
 > 0) {

194 
	`wrôe_log
();

195 
	`wrôe_hód
();

196 
	`ö°Æl_å™s
();

197 
log
.
lh
.
n
 = 0;

198 
	`wrôe_hód
();

200 
	}
}

212 
	$log_wrôe
(
buf
 *
b
)

214 
i
;

216 i‡(
log
.
lh
.
n
 >
LOGSIZE
 ||Üog.lh.¿>log.
size
 - 1)

217 
	`∑nic
("too bigáÅransaction");

218 i‡(
log
.
out°™dög
 < 1)

219 
	`∑nic
("log_write outside ofÅrans");

221 
	`acquúe
(&
log
.
lock
);

222 
i
 = 0; i < 
log
.
lh
.
n
; i++) {

223 i‡(
log
.
lh
.
block
[
i
] =
b
->
blockno
)

226 
log
.
lh
.
block
[
i
] = 
b
->
blockno
;

227 i‡(
i
 =
log
.
lh
.
n
)

228 
log
.
lh
.
n
++;

229 
b
->
Êags
 |
B_DIRTY
;

230 
	`ªÀa£
(&
log
.
lock
);

231 
	}
}

	@ls.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

4 
	~"fs.h
"

7 
	$fmäame
(*
∑th
)

9 
buf
[
DIRSIZ
+1];

10 *
p
;

13 
p
=
∑th
+
	`°æí
(path);Ö >=Öath && *p != '/';Ö--)

15 
p
++;

18 if(
	`°æí
(
p
Ë>
DIRSIZ
)

19  
p
;

20 
	`memmove
(
buf
, 
p
, 
	`°æí
(p));

21 
	`mem£t
(
buf
+
	`°æí
(
p
), ' ', 
DIRSIZ
-strlen(p));

22  
buf
;

23 
	}
}

26 
	$ls
(*
∑th
)

28 
buf
[512], *
p
;

29 
fd
;

30 
dúít
 
de
;

31 
°©
 
°
;

33 if((
fd
 = 
	`›í
(
∑th
, 0)) < 0){

34 
	`¥ötf
(2, "ls: c™nŸ o≥¿%s\n", 
∑th
);

38 if(
	`f°©
(
fd
, &
°
) < 0){

39 
	`¥ötf
(2, "ls: c™nŸ sèà%s\n", 
∑th
);

40 
	`˛o£
(
fd
);

44 
°
.
ty≥
){

45 
T_FILE
:

46 
	`¥ötf
(1, "%†%d %d %d\n", 
	`fmäame
(
∑th
), 
°
.
ty≥
, st.
öo
, st.
size
);

49 
T_DIR
:

50 if(
	`°æí
(
∑th
Ë+ 1 + 
DIRSIZ
 + 1 >  
buf
){

51 
	`¥ötf
(1, "ls:ÖathÅooÜong\n");

54 
	`°r˝y
(
buf
, 
∑th
);

55 
p
 = 
buf
+
	`°æí
(buf);

56 *
p
++ = '/';

57 
	`ªad
(
fd
, &
de
, (de)) == (de)){

58 if(
de
.
öum
 == 0)

60 
	`memmove
(
p
, 
de
.
«me
, 
DIRSIZ
);

61 
p
[
DIRSIZ
] = 0;

62 if(
	`°©
(
buf
, &
°
) < 0){

63 
	`¥ötf
(1, "ls: c™nŸ sèà%s\n", 
buf
);

66 
	`¥ötf
(1, "%†%d %d %d\n", 
	`fmäame
(
buf
), 
°
.
ty≥
, st.
öo
, st.
size
);

70 
	`˛o£
(
fd
);

71 
	}
}

74 
	$maö
(
¨gc
, *
¨gv
[])

76 
i
;

78 if(
¨gc
 < 2){

79 
	`ls
(".");

80 
	`exô
();

82 
i
=1; i<
¨gc
; i++)

83 
	`ls
(
¨gv
[
i
]);

84 
	`exô
();

85 
	}
}

	@main.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"¥oc.h
"

7 
	~"x86.h
"

9 
°¨tŸhîs
();

10 
	$mpmaö
(Ë
	`__©åibuã__
((
n‹ëu∫
));

11 
pde_t
 *
kpgdú
;

12 
íd
[];

18 
	$maö
()

20 
	`köô1
(
íd
, 
	`P2V
(4*1024*1024));

21 
	`kvmÆloc
();

22 
	`mpöô
();

23 
	`œpicöô
();

24 
	`£göô
();

25 
	`˝rötf
("\n˝u%d: sèπög xv6\n\n", 
	`˝unum
());

26 
	`picöô
();

27 
	`iﬂpicöô
();

28 
	`c⁄sﬁeöô
();

29 
	`u¨töô
();

30 
	`pöô
();

31 
	`tvöô
();

32 
	`böô
();

33 
	`fûeöô
();

34 
	`ideöô
();

35 if(!
ismp
)

36 
	`timîöô
();

37 
	`°¨tŸhîs
();

38 
	`köô2
(
	`P2V
(4*1024*1024), P2V(
PHYSTOP
));

39 
	`u£röô
();

40 
	`mpmaö
();

41 
	}
}

45 
	$m≥¡î
()

47 
	`swôchkvm
();

48 
	`£göô
();

49 
	`œpicöô
();

50 
	`mpmaö
();

51 
	}
}

55 
	$mpmaö
()

57 
	`˝rötf
("˝u%d: sèπög\n", 
	`˝unum
());

58 
	`idtöô
();

59 
	`xchg
(&
˝u
->
°¨ãd
, 1);

60 
	`scheduÀr
();

61 
	}
}

63 
pde_t
 
	gíåypgdú
[];

67 
	$°¨tŸhîs
()

69 
uch¨
 
_bö¨y_íåyŸhî_°¨t
[], 
_bö¨y_íåyŸhî_size
[];

70 
uch¨
 *
code
;

71 
˝u
 *
c
;

72 *
°ack
;

77 
code
 = 
	`P2V
(0x7000);

78 
	`memmove
(
code
, 
_bö¨y_íåyŸhî_°¨t
, (
uöt
)
_bö¨y_íåyŸhî_size
);

80 
c
 = 
˝us
; c < cpus+
n˝u
; c++){

81 if(
c
 =
˝us
+
	`˝unum
())

87 
°ack
 = 
	`kÆloc
();

88 *(**)(
code
-4Ë
°ack
 + 
KSTACKSIZE
;

89 *(**)(
code
-8Ë
m≥¡î
;

90 *(**)(
code
-12Ë(*Ë
	`V2P
(
íåypgdú
);

92 
	`œpic°¨èp
(
c
->
≠icid
, 
	`V2P
(
code
));

95 
c
->
°¨ãd
 == 0)

98 
	}
}

105 
__©åibuã__
((
	$__Æig√d__
(
PGSIZE
)))

106 
pde_t
 
íåypgdú
[
NPDENTRIES
] = {

108 [0] = (0Ë| 
PTE_P
 | 
PTE_W
 | 
PTE_PS
,

110 [
KERNBASE
>>
PDXSHIFT
] = (0Ë| 
PTE_P
 | 
PTE_W
 | 
PTE_PS
,

111 
	}
};

	@memide.c

4 
	~"ty≥s.h
"

5 
	~"defs.h
"

6 
	~"∑øm.h
"

7 
	~"mmu.h
"

8 
	~"¥oc.h
"

9 
	~"x86.h
"

10 
	~"å≠s.h
"

11 
	~"•ölock.h
"

12 
	~"¶ì∂ock.h
"

13 
	~"fs.h
"

14 
	~"buf.h
"

16 
uch¨
 
_bö¨y_fs_img_°¨t
[], 
_bö¨y_fs_img_size
[];

18 
	gdisksize
;

19 
uch¨
 *
	gmemdisk
;

22 
	$ideöô
()

24 
memdisk
 = 
_bö¨y_fs_img_°¨t
;

25 
disksize
 = (
uöt
)
_bö¨y_fs_img_size
/
BSIZE
;

26 
	}
}

30 
	$ideöå
()

33 
	}
}

39 
	$idîw
(
buf
 *
b
)

41 
uch¨
 *
p
;

43 if(!
	`hﬁdög¶ìp
(&
b
->
lock
))

44 
	`∑nic
("iderw: bufÇotÜocked");

45 if((
b
->
Êags
 & (
B_VALID
|
B_DIRTY
)) == B_VALID)

46 
	`∑nic
("iderw:ÇothingÅo do");

47 if(
b
->
dev
 != 1)

48 
	`∑nic
("iderw:ÑequestÇot for disk 1");

49 if(
b
->
blockno
 >
disksize
)

50 
	`∑nic
("iderw: block out ofÑange");

52 
p
 = 
memdisk
 + 
b
->
blockno
*
BSIZE
;

54 if(
b
->
Êags
 & 
B_DIRTY
){

55 
b
->
Êags
 &~
B_DIRTY
;

56 
	`memmove
(
p
, 
b
->
d©a
, 
BSIZE
);

58 
	`memmove
(
b
->
d©a
, 
p
, 
BSIZE
);

59 
b
->
Êags
 |
B_VALID
;

60 
	}
}

	@memlayout.h

3 
	#EXTMEM
 0x100000

4 
	#PHYSTOP
 0xE000000

5 
	#DEVSPACE
 0xFE000000

6 

	)

8 
	#KERNBASE
 0x80000000

9 
	#KERNLINK
 (
KERNBASE
+
EXTMEM
)

10 

	)

11 
	#V2P
(
a
Ë(((
uöt
Ë◊)Ë- 
KERNBASE
)

	)

12 
	#P2V
(
a
Ë(((*Ë◊)Ë+ 
KERNBASE
)

	)

14 
	#V2P_WO
(
x
Ë((xË- 
KERNBASE
)

15 
	#P2V_WO
(
x
Ë((xË+ 
KERNBASE
)

	@mkdir.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

6 
	$maö
(
¨gc
, *
¨gv
[])

8 
i
;

10 if(
¨gc
 < 2){

11 
	`¥ötf
(2, "Usage: mkdir files...\n");

12 
	`exô
();

15 
i
 = 1; i < 
¨gc
; i++){

16 if(
	`mkdú
(
¨gv
[
i
]) < 0){

17 
	`¥ötf
(2, "mkdú: %†ÁûedÅÿ¸óã\n", 
¨gv
[
i
]);

22 
	`exô
();

23 
	}
}

	@mkfs.c

1 
	~<°dio.h
>

2 
	~<uni°d.h
>

3 
	~<°dlib.h
>

4 
	~<°rög.h
>

5 
	~<f˙é.h
>

6 
	~<as£π.h
>

8 
	#°©
 
xv6_°©


9 
	~"ty≥s.h
"

	)

10 
	~"fs.h
"

11 
	~"°©.h
"

12 
	~"∑øm.h
"

14 #i‚de‡
°©ic_as£π


15 
	#°©ic_as£π
(
a
, 
b
Ëdÿ{ 0Ë0: ◊): ; } 0)

	)

18 
	#NINODES
 200

	)

23 
	gnbôm≠
 = 
FSSIZE
/(
BSIZE
*8) + 1;

24 
	gnöodeblocks
 = 
NINODES
 / 
IPB
 + 1;

25 
	g∆og
 = 
LOGSIZE
;

26 
	gnmëa
;

27 
	gnblocks
;

29 
	gfsfd
;

30 
su≥rblock
 
	gsb
;

31 
	gzî€s
[
BSIZE
];

32 
uöt
 
	g‰ìöode
 = 1;

33 
uöt
 
	g‰ìblock
;

36 
bÆloc
();

37 
w£˘
(
uöt
, *);

38 
wöode
(
uöt
, 
döode
*);

39 
röode
(
uöt
 
öum
, 
döode
 *
ù
);

40 
r£˘
(
uöt
 
£c
, *
buf
);

41 
uöt
 
üŒoc
(
ush‹t
 
ty≥
);

42 
üµíd
(
uöt
 
öum
, *
p
, 
n
);

45 
ush‹t


46 
	$xsh‹t
(
ush‹t
 
x
)

48 
ush‹t
 
y
;

49 
uch¨
 *
a
 = (uch¨*)&
y
;

50 
a
[0] = 
x
;

51 
a
[1] = 
x
 >> 8;

52  
y
;

53 
	}
}

55 
uöt


56 
	$xöt
(
uöt
 
x
)

58 
uöt
 
y
;

59 
uch¨
 *
a
 = (uch¨*)&
y
;

60 
a
[0] = 
x
;

61 
a
[1] = 
x
 >> 8;

62 
a
[2] = 
x
 >> 16;

63 
a
[3] = 
x
 >> 24;

64  
y
;

65 
	}
}

68 
	$maö
(
¨gc
, *
¨gv
[])

70 
i
, 
cc
, 
fd
;

71 
uöt
 
roŸöo
, 
öum
, 
off
;

72 
dúít
 
de
;

73 
buf
[
BSIZE
];

74 
döode
 
dö
;

77 
	`°©ic_as£π
(() == 4, "Integers must be 4 bytes!");

79 if(
¨gc
 < 2){

80 
	`Ârötf
(
°dîr
, "Usage: mkfs fs.img files...\n");

81 
	`exô
(1);

84 
	`as£π
((
BSIZE
 % (
döode
)) == 0);

85 
	`as£π
((
BSIZE
 % (
dúít
)) == 0);

87 
fsfd
 = 
	`›í
(
¨gv
[1], 
O_RDWR
|
O_CREAT
|
O_TRUNC
, 0666);

88 if(
fsfd
 < 0){

89 
	`≥º‹
(
¨gv
[1]);

90 
	`exô
(1);

94 
nmëa
 = 2 + 
∆og
 + 
nöodeblocks
 + 
nbôm≠
;

95 
nblocks
 = 
FSSIZE
 - 
nmëa
;

97 
sb
.
size
 = 
	`xöt
(
FSSIZE
);

98 
sb
.
nblocks
 = 
	`xöt
(nblocks);

99 
sb
.
nöodes
 = 
	`xöt
(
NINODES
);

100 
sb
.
∆og
 = 
	`xöt
(nlog);

101 
sb
.
log°¨t
 = 
	`xöt
(2);

102 
sb
.
öode°¨t
 = 
	`xöt
(2+
∆og
);

103 
sb
.
bm≠°¨t
 = 
	`xöt
(2+
∆og
+
nöodeblocks
);

105 
	`¥ötf
("nmeta %d (boot, super,Üog blocks %u inode blocks %u, bitmap blocks %u) blocks %dÅotal %d\n",

106 
nmëa
, 
∆og
, 
nöodeblocks
, 
nbôm≠
, 
nblocks
, 
FSSIZE
);

108 
‰ìblock
 = 
nmëa
;

110 
i
 = 0; i < 
FSSIZE
; i++)

111 
	`w£˘
(
i
, 
zî€s
);

113 
	`mem£t
(
buf
, 0, (buf));

114 
	`memmove
(
buf
, &
sb
, (sb));

115 
	`w£˘
(1, 
buf
);

117 
roŸöo
 = 
	`üŒoc
(
T_DIR
);

118 
	`as£π
(
roŸöo
 =
ROOTINO
);

120 
	`bzîo
(&
de
, (de));

121 
de
.
öum
 = 
	`xsh‹t
(
roŸöo
);

122 
	`°r˝y
(
de
.
«me
, ".");

123 
	`üµíd
(
roŸöo
, &
de
, (de));

125 
	`bzîo
(&
de
, (de));

126 
de
.
öum
 = 
	`xsh‹t
(
roŸöo
);

127 
	`°r˝y
(
de
.
«me
, "..");

128 
	`üµíd
(
roŸöo
, &
de
, (de));

130 
i
 = 2; i < 
¨gc
; i++){

131 
	`as£π
(
	`ödex
(
¨gv
[
i
], '/') == 0);

133 if((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0){

134 
	`≥º‹
(
¨gv
[
i
]);

135 
	`exô
(1);

142 if(
¨gv
[
i
][0] == '_')

143 ++
¨gv
[
i
];

145 
öum
 = 
	`üŒoc
(
T_FILE
);

147 
	`bzîo
(&
de
, (de));

148 
de
.
öum
 = 
	`xsh‹t
(inum);

149 
	`°∫˝y
(
de
.
«me
, 
¨gv
[
i
], 
DIRSIZ
);

150 
	`üµíd
(
roŸöo
, &
de
, (de));

152 (
cc
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0)

153 
	`üµíd
(
öum
, 
buf
, 
cc
);

155 
	`˛o£
(
fd
);

159 
	`röode
(
roŸöo
, &
dö
);

160 
off
 = 
	`xöt
(
dö
.
size
);

161 
off
 = ((off/
BSIZE
) + 1) * BSIZE;

162 
dö
.
size
 = 
	`xöt
(
off
);

163 
	`wöode
(
roŸöo
, &
dö
);

165 
	`bÆloc
(
‰ìblock
);

167 
	`exô
(0);

168 
	}
}

171 
	$w£˘
(
uöt
 
£c
, *
buf
)

173 if(
	`l£ek
(
fsfd
, 
£c
 * 
BSIZE
, 0) != sec * BSIZE){

174 
	`≥º‹
("lseek");

175 
	`exô
(1);

177 if(
	`wrôe
(
fsfd
, 
buf
, 
BSIZE
) != BSIZE){

178 
	`≥º‹
("write");

179 
	`exô
(1);

181 
	}
}

184 
	$wöode
(
uöt
 
öum
, 
döode
 *
ù
)

186 
buf
[
BSIZE
];

187 
uöt
 
bn
;

188 
döode
 *
dù
;

190 
bn
 = 
	`IBLOCK
(
öum
, 
sb
);

191 
	`r£˘
(
bn
, 
buf
);

192 
dù
 = ((
döode
*)
buf
Ë+ (
öum
 % 
IPB
);

193 *
dù
 = *
ù
;

194 
	`w£˘
(
bn
, 
buf
);

195 
	}
}

198 
	$röode
(
uöt
 
öum
, 
döode
 *
ù
)

200 
buf
[
BSIZE
];

201 
uöt
 
bn
;

202 
döode
 *
dù
;

204 
bn
 = 
	`IBLOCK
(
öum
, 
sb
);

205 
	`r£˘
(
bn
, 
buf
);

206 
dù
 = ((
döode
*)
buf
Ë+ (
öum
 % 
IPB
);

207 *
ù
 = *
dù
;

208 
	}
}

211 
	$r£˘
(
uöt
 
£c
, *
buf
)

213 if(
	`l£ek
(
fsfd
, 
£c
 * 
BSIZE
, 0) != sec * BSIZE){

214 
	`≥º‹
("lseek");

215 
	`exô
(1);

217 if(
	`ªad
(
fsfd
, 
buf
, 
BSIZE
) != BSIZE){

218 
	`≥º‹
("read");

219 
	`exô
(1);

221 
	}
}

223 
uöt


224 
	$üŒoc
(
ush‹t
 
ty≥
)

226 
uöt
 
öum
 = 
‰ìöode
++;

227 
döode
 
dö
;

229 
	`bzîo
(&
dö
, (din));

230 
dö
.
ty≥
 = 
	`xsh‹t
(type);

231 
dö
.
∆ök
 = 
	`xsh‹t
(1);

232 
dö
.
size
 = 
	`xöt
(0);

233 
	`wöode
(
öum
, &
dö
);

234  
öum
;

235 
	}
}

238 
	$bÆloc
(
u£d
)

240 
uch¨
 
buf
[
BSIZE
];

241 
i
;

243 
	`¥ötf
("bÆloc: fú° %d block†havêbì¿Æloˇãd\n", 
u£d
);

244 
	`as£π
(
u£d
 < 
BSIZE
*8);

245 
	`bzîo
(
buf
, 
BSIZE
);

246 
i
 = 0; i < 
u£d
; i++){

247 
buf
[
i
/8] = buf[i/8] | (0x1 << (i%8));

249 
	`¥ötf
("bÆloc: wrôêbôm≠ blockáà£˘‹ %d\n", 
sb
.
bm≠°¨t
);

250 
	`w£˘
(
sb
.
bm≠°¨t
, 
buf
);

251 
	}
}

253 
	#mö
(
a
, 
b
Ë(◊Ë< (bË? (aË: (b))

	)

256 
	$üµíd
(
uöt
 
öum
, *
xp
, 
n
)

258 *
p
 = (*)
xp
;

259 
uöt
 
fbn
, 
off
, 
n1
;

260 
döode
 
dö
;

261 
buf
[
BSIZE
];

262 
uöt
 
ödúe˘
[
NINDIRECT
];

263 
uöt
 
x
;

265 
	`röode
(
öum
, &
dö
);

266 
off
 = 
	`xöt
(
dö
.
size
);

268 
n
 > 0){

269 
fbn
 = 
off
 / 
BSIZE
;

270 
	`as£π
(
fbn
 < 
MAXFILE
);

271 if(
fbn
 < 
NDIRECT
){

272 if(
	`xöt
(
dö
.
addrs
[
fbn
]) == 0){

273 
dö
.
addrs
[
fbn
] = 
	`xöt
(
‰ìblock
++);

275 
x
 = 
	`xöt
(
dö
.
addrs
[
fbn
]);

277 if(
	`xöt
(
dö
.
addrs
[
NDIRECT
]) == 0){

278 
dö
.
addrs
[
NDIRECT
] = 
	`xöt
(
‰ìblock
++);

280 
	`r£˘
(
	`xöt
(
dö
.
addrs
[
NDIRECT
]), (*)
ödúe˘
);

281 if(
ödúe˘
[
fbn
 - 
NDIRECT
] == 0){

282 
ödúe˘
[
fbn
 - 
NDIRECT
] = 
	`xöt
(
‰ìblock
++);

283 
	`w£˘
(
	`xöt
(
dö
.
addrs
[
NDIRECT
]), (*)
ödúe˘
);

285 
x
 = 
	`xöt
(
ödúe˘
[
fbn
-
NDIRECT
]);

287 
n1
 = 
	`mö
(
n
, (
fbn
 + 1Ë* 
BSIZE
 - 
off
);

288 
	`r£˘
(
x
, 
buf
);

289 
	`bc›y
(
p
, 
buf
 + 
off
 - (
fbn
 * 
BSIZE
), 
n1
);

290 
	`w£˘
(
x
, 
buf
);

291 
n
 -
n1
;

292 
off
 +
n1
;

293 
p
 +
n1
;

295 
dö
.
size
 = 
	`xöt
(
off
);

296 
	`wöode
(
öum
, &
dö
);

297 
	}
}

	@mmu.h

5 
	#FL_CF
 0x00000001

6 
	#FL_PF
 0x00000004

7 
	#FL_AF
 0x00000010

8 
	#FL_ZF
 0x00000040

9 
	#FL_SF
 0x00000080

10 
	#FL_TF
 0x00000100

11 
	#FL_IF
 0x00000200

12 
	#FL_DF
 0x00000400

13 
	#FL_OF
 0x00000800

14 
	#FL_IOPL_MASK
 0x00003000

15 
	#FL_IOPL_0
 0x00000000

16 
	#FL_IOPL_1
 0x00001000

17 
	#FL_IOPL_2
 0x00002000

18 
	#FL_IOPL_3
 0x00003000

19 
	#FL_NT
 0x00004000

20 
	#FL_RF
 0x00010000

21 
	#FL_VM
 0x00020000

22 
	#FL_AC
 0x00040000

23 
	#FL_VIF
 0x00080000

24 
	#FL_VIP
 0x00100000

25 
	#FL_ID
 0x00200000

26 

	)

28 
	#CR0_PE
 0x00000001

29 
	#CR0_MP
 0x00000002

30 
	#CR0_EM
 0x00000004

31 
	#CR0_TS
 0x00000008

32 
	#CR0_ET
 0x00000010

33 
	#CR0_NE
 0x00000020

34 
	#CR0_WP
 0x00010000

35 
	#CR0_AM
 0x00040000

36 
	#CR0_NW
 0x20000000

37 
	#CR0_CD
 0x40000000

38 
	#CR0_PG
 0x80000000

39 

	)

40 
	#CR4_PSE
 0x00000010

41 

	)

43 
	#SEG_KCODE
 1

44 
	#SEG_KDATA
 2

45 
	#SEG_KCPU
 3

46 
	#SEG_UCODE
 4

47 
	#SEG_UDATA
 5

48 
	#SEG_TSS
 6

49 

	)

51 
	#NSEGS
 7

	)

54 #i‚de‡
__ASSEMBLER__


56 
	s£gdesc
 {

57 
uöt
 
	mlim_15_0
 : 16;

58 
uöt
 
	mba£_15_0
 : 16;

59 
uöt
 
	mba£_23_16
 : 8;

60 
uöt
 
	mty≥
 : 4;

61 
uöt
 
	ms
 : 1;

62 
uöt
 
	md∂
 : 2;

63 
uöt
 
	mp
 : 1;

64 
uöt
 
	mlim_19_16
 : 4;

65 
uöt
 
	mavl
 : 1;

66 
uöt
 
	mrsv1
 : 1;

67 
uöt
 
	mdb
 : 1;

68 
uöt
 
	mg
 : 1;

69 
uöt
 
	mba£_31_24
 : 8;

73 
	#SEG
(
ty≥
, 
ba£
, 
lim
, 
d∂
Ë(
£gdesc
) \

74 { ((
lim
Ë>> 12Ë& 0xffff, (
uöt
)(
ba£
) & 0xffff, \

75 ((
uöt
)(
ba£
Ë>> 16Ë& 0xff, 
ty≥
, 1, 
d∂
, 1, \

76 (
uöt
)(
lim
Ë>> 28, 0, 0, 1, 1, (uöt)(
ba£
Ë>> 24 }

	)

77 
	#SEG16
(
ty≥
, 
ba£
, 
lim
, 
d∂
Ë(
£gdesc
) \

78 { (
lim
Ë& 0xffff, (
uöt
)(
ba£
) & 0xffff, \

79 ((
uöt
)(
ba£
Ë>> 16Ë& 0xff, 
ty≥
, 1, 
d∂
, 1, \

80 (
uöt
)(
lim
Ë>> 16, 0, 0, 1, 0, (uöt)(
ba£
Ë>> 24 }

	)

83 
	#DPL_USER
 0x3

84 

	)

86 
	#STA_X
 0x8

87 
	#STA_E
 0x4

88 
	#STA_C
 0x4

89 
	#STA_W
 0x2

90 
	#STA_R
 0x2

91 
	#STA_A
 0x1

92 

	)

94 
	#STS_T16A
 0x1

95 
	#STS_LDT
 0x2

96 
	#STS_T16B
 0x3

97 
	#STS_CG16
 0x4

98 
	#STS_TG
 0x5

99 
	#STS_IG16
 0x6

100 
	#STS_TG16
 0x7

101 
	#STS_T32A
 0x9

102 
	#STS_T32B
 0xB

103 
	#STS_CG32
 0xC

104 
	#STS_IG32
 0xE

105 
	#STS_TG32
 0xF

106 

	)

116 
	#PDX
(
va
Ë(((
uöt
)(vaË>> 
PDXSHIFT
Ë& 0x3FF)

	)

119 
	#PTX
(
va
Ë(((
uöt
)(vaË>> 
PTXSHIFT
Ë& 0x3FF)

	)

122 
	#PGADDR
(
d
, 
t
, 
o
Ë((
uöt
)((dË<< 
PDXSHIFT
 | (tË<< 
PTXSHIFT
 | (o)))

	)

125 
	#NPDENTRIES
 1024

126 
	#NPTENTRIES
 1024

127 
	#PGSIZE
 4096

128 

	)

129 
	#PGSHIFT
 12

130 
	#PTXSHIFT
 12

131 
	#PDXSHIFT
 22

132 

	)

133 
	#PGROUNDUP
(
sz
Ë(((sz)+
PGSIZE
-1Ë& ~(PGSIZE-1))

	)

134 
	#PGROUNDDOWN
(
a
Ë((◊)Ë& ~(
PGSIZE
-1))

	)

137 
	#PTE_P
 0x001

138 
	#PTE_W
 0x002

139 
	#PTE_U
 0x004

140 
	#PTE_PWT
 0x008

141 
	#PTE_PCD
 0x010

142 
	#PTE_A
 0x020

143 
	#PTE_D
 0x040

144 
	#PTE_PS
 0x080

145 
	#PTE_MBZ
 0x180

146 

	)

148 
	#PTE_ADDR
(
±e
Ë((
uöt
)’ãË& ~0xFFF)

	)

149 
	#PTE_FLAGS
(
±e
Ë((
uöt
)’ãË& 0xFFF)

	)

151 #i‚de‡
__ASSEMBLER__


152 
uöt
 
	t±e_t
;

155 
	sèsk°©e
 {

156 
uöt
 
	mlök
;

157 
uöt
 
	me•0
;

158 
ush‹t
 
	mss0
;

159 
ush‹t
 
	m∑ddög1
;

160 
uöt
 *
	me•1
;

161 
ush‹t
 
	mss1
;

162 
ush‹t
 
	m∑ddög2
;

163 
uöt
 *
	me•2
;

164 
ush‹t
 
	mss2
;

165 
ush‹t
 
	m∑ddög3
;

166 *
	m¸3
;

167 
uöt
 *
	meù
;

168 
uöt
 
	meÊags
;

169 
uöt
 
	móx
;

170 
uöt
 
	mecx
;

171 
uöt
 
	medx
;

172 
uöt
 
	mebx
;

173 
uöt
 *
	me•
;

174 
uöt
 *
	mebp
;

175 
uöt
 
	mesi
;

176 
uöt
 
	medi
;

177 
ush‹t
 
	mes
;

178 
ush‹t
 
	m∑ddög4
;

179 
ush‹t
 
	mcs
;

180 
ush‹t
 
	m∑ddög5
;

181 
ush‹t
 
	mss
;

182 
ush‹t
 
	m∑ddög6
;

183 
ush‹t
 
	mds
;

184 
ush‹t
 
	m∑ddög7
;

185 
ush‹t
 
	mfs
;

186 
ush‹t
 
	m∑ddög8
;

187 
ush‹t
 
	mgs
;

188 
ush‹t
 
	m∑ddög9
;

189 
ush‹t
 
	mldt
;

190 
ush‹t
 
	m∑ddög10
;

191 
ush‹t
 
	mt
;

192 
ush‹t
 
	miomb
;

197 
	sg©edesc
 {

198 
uöt
 
	moff_15_0
 : 16;

199 
uöt
 
	mcs
 : 16;

200 
uöt
 
	m¨gs
 : 5;

201 
uöt
 
	mrsv1
 : 3;

202 
uöt
 
	mty≥
 : 4;

203 
uöt
 
	ms
 : 1;

204 
uöt
 
	md∂
 : 2;

205 
uöt
 
	mp
 : 1;

206 
uöt
 
	moff_31_16
 : 16;

217 
	#SETGATE
(
g©e
, 
i°øp
, 
£l
, 
off
, 
d
) \

219 (
g©e
).
off_15_0
 = (
uöt
)(
off
) & 0xffff; \

220 (
g©e
).
cs
 = (
£l
); \

221 (
g©e
).
¨gs
 = 0; \

222 (
g©e
).
rsv1
 = 0; \

223 (
g©e
).
ty≥
 = (
i°øp
Ë? 
STS_TG32
 : 
STS_IG32
; \

224 (
g©e
).
s
 = 0; \

225 (
g©e
).
d∂
 = (
d
); \

226 (
g©e
).
p
 = 1; \

227 (
g©e
).
off_31_16
 = (
uöt
)(
off
) >> 16; \

228 }

	)

	@mp.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"∑øm.h
"

8 
	~"memœyout.h
"

9 
	~"mp.h
"

10 
	~"x86.h
"

11 
	~"mmu.h
"

12 
	~"¥oc.h
"

14 
˝u
 
	g˝us
[
NCPU
];

15 
	gismp
;

16 
	gn˝u
;

17 
uch¨
 
	giﬂpicid
;

19 
uch¨


20 
	$sum
(
uch¨
 *
addr
, 
Àn
)

22 
i
, 
sum
;

24 
sum
 = 0;

25 
i
=0; i<
Àn
; i++)

26 
sum
 +
addr
[
i
];

27  
sum
;

28 
	}
}

31 
mp
*

32 
	$mp£¨ch1
(
uöt
 
a
, 
Àn
)

34 
uch¨
 *
e
, *
p
, *
addr
;

36 
addr
 = 
	`P2V
(
a
);

37 
e
 = 
addr
+
Àn
;

38 
p
 = 
addr
;Ö < 
e
;Ö +(
mp
))

39 if(
	`memcmp
(
p
, "_MP_", 4Ë=0 && 
	`sum
’, (
mp
)) == 0)

40  (
mp
*)
p
;

42 
	}
}

49 
mp
*

50 
	$mp£¨ch
()

52 
uch¨
 *
bda
;

53 
uöt
 
p
;

54 
mp
 *mp;

56 
bda
 = (
uch¨
 *Ë
	`P2V
(0x400);

57 if((
p
 = ((
bda
[0x0F]<<8)| bda[0x0E]) << 4)){

58 if((
mp
 = 
	`mp£¨ch1
(
p
, 1024)))

59  
mp
;

61 
p
 = ((
bda
[0x14]<<8)|bda[0x13])*1024;

62 if((
mp
 = 
	`mp£¨ch1
(
p
-1024, 1024)))

63  
mp
;

65  
	`mp£¨ch1
(0xF0000, 0x10000);

66 
	}
}

73 
mpc⁄f
*

74 
	$mpc⁄fig
(
mp
 **
pmp
)

76 
mpc⁄f
 *
c⁄f
;

77 
mp
 *mp;

79 if((
mp
 = 
	`mp£¨ch
()Ë=0 || mp->
phyßddr
 == 0)

81 
c⁄f
 = (
mpc⁄f
*Ë
	`P2V
((
uöt
Ë
mp
->
phyßddr
);

82 if(
	`memcmp
(
c⁄f
, "PCMP", 4) != 0)

84 if(
c⁄f
->
vîsi⁄
 != 1 && conf->version != 4)

86 if(
	`sum
((
uch¨
*)
c⁄f
, c⁄f->
Àngth
) != 0)

88 *
pmp
 = 
mp
;

89  
c⁄f
;

90 
	}
}

93 
	$mpöô
()

95 
uch¨
 *
p
, *
e
;

96 
mp
 *mp;

97 
mpc⁄f
 *
c⁄f
;

98 
mµroc
 *
¥oc
;

99 
mpiﬂpic
 *
iﬂpic
;

101 if((
c⁄f
 = 
	`mpc⁄fig
(&
mp
)) == 0)

103 
ismp
 = 1;

104 
œpic
 = (
uöt
*)
c⁄f
->
œpiˇddr
;

105 
p
=(
uch¨
*)(
c⁄f
+1), 
e
=(uch¨*)c⁄f+c⁄f->
Àngth
;Ö<e; ){

106 *
p
){

107 
MPPROC
:

108 
¥oc
 = (
mµroc
*)
p
;

109 if(
n˝u
 < 
NCPU
) {

110 
˝us
[
n˝u
].
≠icid
 = 
¥oc
->apicid;

111 
n˝u
++;

113 
p
 +(
mµroc
);

115 
MPIOAPIC
:

116 
iﬂpic
 = (
mpiﬂpic
*)
p
;

117 
iﬂpicid
 = 
iﬂpic
->
≠i˙o
;

118 
p
 +(
mpiﬂpic
);

120 
MPBUS
:

121 
MPIOINTR
:

122 
MPLINTR
:

123 
p
 += 8;

126 
ismp
 = 0;

130 if(!
ismp
){

132 
n˝u
 = 1;

133 
œpic
 = 0;

134 
iﬂpicid
 = 0;

138 if(
mp
->
im¸p
){

141 
	`outb
(0x22, 0x70);

142 
	`outb
(0x23, 
	`öb
(0x23) | 1);

144 
	}
}

	@mp.h

3 
	smp
 {

4 
uch¨
 
	msig«tuª
[4];

5 *
	mphyßddr
;

6 
uch¨
 
	mÀngth
;

7 
uch¨
 
	m•e¸ev
;

8 
uch¨
 
	mchecksum
;

9 
uch¨
 
	mty≥
;

10 
uch¨
 
	mim¸p
;

11 
uch¨
 
	mª£rved
[3];

14 
	smpc⁄f
 {

15 
uch¨
 
	msig«tuª
[4];

16 
ush‹t
 
	mÀngth
;

17 
uch¨
 
	mvîsi⁄
;

18 
uch¨
 
	mchecksum
;

19 
uch¨
 
	m¥odu˘
[20];

20 
uöt
 *
	m€mèbÀ
;

21 
ush‹t
 
	m€mÀngth
;

22 
ush‹t
 
	míåy
;

23 
uöt
 *
	mœpiˇddr
;

24 
ush‹t
 
	mxÀngth
;

25 
uch¨
 
	mxchecksum
;

26 
uch¨
 
	mª£rved
;

29 
	smµroc
 {

30 
uch¨
 
	mty≥
;

31 
uch¨
 
	m≠icid
;

32 
uch¨
 
	mvîsi⁄
;

33 
uch¨
 
	mÊags
;

34 
	#MPBOOT
 0x02

35 
uch¨
 
sig«tuª
[4];

36 
uöt
 
„©uª
;

37 
uch¨
 
ª£rved
[8];

	)

40 
	smpiﬂpic
 {

41 
uch¨
 
	mty≥
;

42 
uch¨
 
	m≠i˙o
;

43 
uch¨
 
	mvîsi⁄
;

44 
uch¨
 
	mÊags
;

45 
uöt
 *
	maddr
;

49 
	#MPPROC
 0x00

50 
	#MPBUS
 0x01

51 
	#MPIOAPIC
 0x02

52 
	#MPIOINTR
 0x03

53 
	#MPLINTR
 0x04

54 

	)

	@my_userapp.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	$maö
(
¨gc
, *
¨gv
[])

7 *
buf
 = "Hello xv6!";

8 
ªt_vÆ
;

9 
ªt_vÆ
 = 
	`my_sysˇŒ
(
buf
);

10 
	`¥ötf
(1, "Rëu∫ vÆuê: 0x%x\n", 
ªt_vÆ
);

11 
	`exô
();

12 
	}
}

	@param.h

1 
	#NPROC
 64

2 
	#KSTACKSIZE
 4096

3 
	#NCPU
 8

4 
	#NOFILE
 16

5 
	#NFILE
 100

6 
	#NINODE
 50

7 
	#NDEV
 10

8 
	#ROOTDEV
 1

9 
	#MAXARG
 32

10 
	#MAXOPBLOCKS
 10

11 
	#LOGSIZE
 (
MAXOPBLOCKS
*3)

12 
	#NBUF
 (
MAXOPBLOCKS
*3)

13 
	#FSSIZE
 1000

14 

	)

17 
	#THREAD_DEBUGGING


18 
	#NMLFQ
 3

19 
	#NSTRIDE
 10000

20 
	#NSTRIDE_QUEUE
 ( (
NPROC
) + (1) )

	@picirq.c

3 
	~"ty≥s.h
"

4 
	~"x86.h
"

5 
	~"å≠s.h
"

8 
	#IO_PIC1
 0x20

9 
	#IO_PIC2
 0xA0

10 

	)

11 
	#IRQ_SLAVE
 2

12 

	)

15 
ush‹t
 
	gúqmask
 = 0xFFFF & ~(1<<
IRQ_SLAVE
);

18 
	$pic£tmask
(
ush‹t
 
mask
)

20 
úqmask
 = 
mask
;

21 
	`outb
(
IO_PIC1
+1, 
mask
);

22 
	`outb
(
IO_PIC2
+1, 
mask
 >> 8);

23 
	}
}

26 
	$pi˚«bÀ
(
úq
)

28 
	`pic£tmask
(
úqmask
 & ~(1<<
úq
));

29 
	}
}

33 
	$picöô
()

36 
	`outb
(
IO_PIC1
+1, 0xFF);

37 
	`outb
(
IO_PIC2
+1, 0xFF);

45 
	`outb
(
IO_PIC1
, 0x11);

48 
	`outb
(
IO_PIC1
+1, 
T_IRQ0
);

52 
	`outb
(
IO_PIC1
+1, 1<<
IRQ_SLAVE
);

62 
	`outb
(
IO_PIC1
+1, 0x3);

65 
	`outb
(
IO_PIC2
, 0x11);

66 
	`outb
(
IO_PIC2
+1, 
T_IRQ0
 + 8);

67 
	`outb
(
IO_PIC2
+1, 
IRQ_SLAVE
);

70 
	`outb
(
IO_PIC2
+1, 0x3);

76 
	`outb
(
IO_PIC1
, 0x68);

77 
	`outb
(
IO_PIC1
, 0x0a);

79 
	`outb
(
IO_PIC2
, 0x68);

80 
	`outb
(
IO_PIC2
, 0x0a);

82 if(
úqmask
 != 0xFFFF)

83 
	`pic£tmask
(
úqmask
);

84 
	}
}

	@pipe.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"mmu.h
"

5 
	~"¥oc.h
"

6 
	~"fs.h
"

7 
	~"•ölock.h
"

8 
	~"¶ì∂ock.h
"

9 
	~"fûe.h
"

11 
	#PIPESIZE
 512

	)

13 
	spùe
 {

14 
•ölock
 
	mlock
;

15 
	md©a
[
PIPESIZE
];

16 
uöt
 
	mƒód
;

17 
uöt
 
	mnwrôe
;

18 
	mªad›í
;

19 
	mwrôe›í
;

23 
	$pùóŒoc
(
fûe
 **
f0
, fûê**
f1
)

25 
pùe
 *
p
;

27 
p
 = 0;

28 *
f0
 = *
f1
 = 0;

29 if((*
f0
 = 
	`fûóŒoc
()Ë=0 || (*
f1
 = filealloc()) == 0)

30 
bad
;

31 if((
p
 = (
pùe
*)
	`kÆloc
()) == 0)

32 
bad
;

33 
p
->
ªad›í
 = 1;

34 
p
->
wrôe›í
 = 1;

35 
p
->
nwrôe
 = 0;

36 
p
->
ƒód
 = 0;

37 
	`öôlock
(&
p
->
lock
, "pipe");

38 (*
f0
)->
ty≥
 = 
FD_PIPE
;

39 (*
f0
)->
ªadabÀ
 = 1;

40 (*
f0
)->
wrôabÀ
 = 0;

41 (*
f0
)->
pùe
 = 
p
;

42 (*
f1
)->
ty≥
 = 
FD_PIPE
;

43 (*
f1
)->
ªadabÀ
 = 0;

44 (*
f1
)->
wrôabÀ
 = 1;

45 (*
f1
)->
pùe
 = 
p
;

49 
bad
:

50 if(
p
)

51 
	`k‰ì
((*)
p
);

52 if(*
f0
)

53 
	`fûe˛o£
(*
f0
);

54 if(*
f1
)

55 
	`fûe˛o£
(*
f1
);

57 
	}
}

60 
	$pùe˛o£
(
pùe
 *
p
, 
wrôabÀ
)

62 
	`acquúe
(&
p
->
lock
);

63 if(
wrôabÀ
){

64 
p
->
wrôe›í
 = 0;

65 
	`wakeup
(&
p
->
ƒód
);

67 
p
->
ªad›í
 = 0;

68 
	`wakeup
(&
p
->
nwrôe
);

70 if(
p
->
ªad›í
 =0 &&Ö->
wrôe›í
 == 0){

71 
	`ªÀa£
(&
p
->
lock
);

72 
	`k‰ì
((*)
p
);

74 
	`ªÀa£
(&
p
->
lock
);

75 
	}
}

79 
	$pùewrôe
(
pùe
 *
p
, *
addr
, 
n
)

81 
i
;

83 
	`acquúe
(&
p
->
lock
);

84 
i
 = 0; i < 
n
; i++){

85 
p
->
nwrôe
 =p->
ƒód
 + 
PIPESIZE
){

86 if(
p
->
ªad›í
 =0 || 
¥oc
->
kûÀd
){

87 
	`ªÀa£
(&
p
->
lock
);

90 
	`wakeup
(&
p
->
ƒód
);

91 
	`¶ìp
(&
p
->
nwrôe
, &p->
lock
);

93 
p
->
d©a
[p->
nwrôe
++ % 
PIPESIZE
] = 
addr
[
i
];

95 
	`wakeup
(&
p
->
ƒód
);

96 
	`ªÀa£
(&
p
->
lock
);

97  
n
;

98 
	}
}

101 
	$pùîód
(
pùe
 *
p
, *
addr
, 
n
)

103 
i
;

105 
	`acquúe
(&
p
->
lock
);

106 
p
->
ƒód
 =p->
nwrôe
 &&Ö->
wrôe›í
){

107 if(
¥oc
->
kûÀd
){

108 
	`ªÀa£
(&
p
->
lock
);

111 
	`¶ìp
(&
p
->
ƒód
, &p->
lock
);

113 
i
 = 0; i < 
n
; i++){

114 if(
p
->
ƒód
 =p->
nwrôe
)

116 
addr
[
i
] = 
p
->
d©a
[p->
ƒód
++ % 
PIPESIZE
];

118 
	`wakeup
(&
p
->
nwrôe
);

119 
	`ªÀa£
(&
p
->
lock
);

120  
i
;

121 
	}
}

	@prac_getlev.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"x86.h
"

7 
	~"¥oc.h
"

11 
	$gëÀv
()

13  
¥oc
->
Àvñ_of_MLFQ
;

14 
	}
}

18 
	$sys_gëÀv
()

20  
	`gëÀv
();

21 
	}
}

	@prac_getppid.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"¥oc.h
"

7 
	~"x86.h
"

8 
	~"sysˇŒ.h
"

11 
	$gëµid
()

13  
¥oc
->
∑ª¡
->
pid
;

14 
	}
}

18 
	$sys_gëµid
()

20  
	`gëµid
();

21 
	}
}

	@prac_syscall.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

5 
	$my_sysˇŒ
(*
°r
)

7 
	`˝rötf
("%s\n", 
°r
);

9 
	}
}

12 
	$sys_my_sysˇŒ
()

14 *
°r
;

15 i‡(
	`¨g°r
(0, &
°r
) < 0)

17  
	`my_sysˇŒ
(
°r
);

18 
	}
}

	@printf.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

6 
	$putc
(
fd
, 
c
)

8 
	`wrôe
(
fd
, &
c
, 1);

9 
	}
}

12 
	$¥ötöt
(
fd
, 
xx
, 
ba£
, 
sgn
)

14 
digôs
[] = "0123456789ABCDEF";

15 
buf
[16];

16 
i
, 
√g
;

17 
uöt
 
x
;

19 
√g
 = 0;

20 if(
sgn
 && 
xx
 < 0){

21 
√g
 = 1;

22 
x
 = -
xx
;

24 
x
 = 
xx
;

27 
i
 = 0;

29 
buf
[
i
++] = 
digôs
[
x
 % 
ba£
];

30 }(
x
 /
ba£
) != 0);

31 if(
√g
)

32 
buf
[
i
++] = '-';

34 --
i
 >= 0)

35 
	`putc
(
fd
, 
buf
[
i
]);

36 
	}
}

40 
	$¥ötf
(
fd
, *
fmt
, ...)

42 *
s
;

43 
c
, 
i
, 
°©e
;

44 
uöt
 *
≠
;

46 
°©e
 = 0;

47 
≠
 = (
uöt
*)(*)&
fmt
 + 1;

48 
i
 = 0; 
fmt
[i]; i++){

49 
c
 = 
fmt
[
i
] & 0xff;

50 if(
°©e
 == 0){

51 if(
c
 == '%'){

52 
°©e
 = '%';

54 
	`putc
(
fd
, 
c
);

56 } if(
°©e
 == '%'){

57 if(
c
 == 'd'){

58 
	`¥ötöt
(
fd
, *
≠
, 10, 1);

59 
≠
++;

60 } if(
c
 == 'x' || c == 'p'){

61 
	`¥ötöt
(
fd
, *
≠
, 16, 0);

62 
≠
++;

63 } if(
c
 == 's'){

64 
s
 = (*)*
≠
;

65 
≠
++;

66 if(
s
 == 0)

67 
s
 = "(null)";

68 *
s
 != 0){

69 
	`putc
(
fd
, *
s
);

70 
s
++;

72 } if(
c
 == 'c'){

73 
	`putc
(
fd
, *
≠
);

74 
≠
++;

75 } if(
c
 == '%'){

76 
	`putc
(
fd
, 
c
);

79 
	`putc
(
fd
, '%');

80 
	`putc
(
fd
, 
c
);

82 
°©e
 = 0;

85 
	}
}

	@proc.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"x86.h
"

7 
	~"¥oc.h
"

8 
	~"•ölock.h
"

11 
•ölock
 
	mlock
;

14 
¥oc
 
	m¥oc
[
NPROC
];

15 
	mMLFQ_time_qu™tum
[
NMLFQ
];

16 
	mMLFQ_tick_u£d
;

19 
	mqueue_Àvñ_©_mo°
;

20 
	mmö_of_run_¥oc_Àvñ
;

23 
¥oc
* 
	m°ride_queue
[
NSTRIDE_QUEUE
];

24 
	msum_˝u_sh¨e
;

25 
	m°ride_queue_size
;

26 
	m°ride_time_qu™tum
;

27 
	m°ride_tick_u£d
;

29 } 
	g±abÀ
;

31 
¥oc
 *
	göô¥oc
;

33 
	g√xçid
 = 1;

35 
f‹kªt
();

36 
å≠ªt
();

38 
wakeup1
(*
ch™
);

40 
°ride_queue_hópify_up
(
°ride_idx
);

41 
°ride_queue_hópify_down
(
°ride_idx
);

44 
	g√xt_thªad_id
 = 1;

45 
•ölock
 
	gthªad_lock
;

46 
	gpgdú_ªf
[
NPROC
];

47 
	gpgdú_ªf_√xt_idx
 = 0;

52 
	$check_pgdú_cou¡î_™d_ˇŒ_‰ìvm
(
¥oc
* 
p
) {

53 i‡(
p
->
pgdú_ªf_idx
 == -1) {

55 
	`‰ìvm
(
p
->
pgdú
);

56 } i‡(
pgdú_ªf
[
p
->
pgdú_ªf_idx
] <= 1) {

59 
	`acquúe
(&
thªad_lock
);

60 
pgdú_ªf
[
p
->
pgdú_ªf_idx
] = 0;

61 
	`ªÀa£
(&
thªad_lock
);

62 
	`‰ìvm
(
p
->
pgdú
);

67 
	`acquúe
(&
thªad_lock
);

68 
pgdú_ªf
[
p
->
pgdú_ªf_idx
]--;

69 
	`ªÀa£
(&
thªad_lock
);

71 
	}
}

74 
	$Æloˇã_√w_pgdú_idx
(
¥oc
* 
p
) {

75 
	`acquúe
(&
thªad_lock
);

76 
p
->
pgdú_ªf_idx
 = 
pgdú_ªf_√xt_idx
++;

77 
pgdú_ªf_√xt_idx
 %
NPROC
;

78 
pgdú_ªf
[
p
->
pgdú_ªf_idx
] = 1;

79 
	`ªÀa£
(&
thªad_lock
);

80 
	}
}

85 
	$gë_time_qu™tum
()

87 if(
¥oc
 &&Öroc->
˝u_sh¨e
 != 0){

88  
±abÀ
.
°ride_time_qu™tum
;

90  
±abÀ
.
MLFQ_time_qu™tum
[
¥oc
->
Àvñ_of_MLFQ
];

92 
	}
}

96 
	$gë_MLFQ_tick_u£d
()

98  
±abÀ
.
MLFQ_tick_u£d
;

99 
	}
}

102 
	$ö¸ó£_MLFQ_tick_u£d
()

104 
±abÀ
.
MLFQ_tick_u£d
++;

105 #ifde‡
STRIRDE_DEBUGGING


106 
	`˝rötf
("\rMLFQ_tick_u£d: %d", 
±abÀ
.
MLFQ_tick_u£d
);

108 
	}
}

111 
	$ö¸ó£_°ride_tick_u£d
()

113 
±abÀ
.
°ride_tick_u£d
++;

114 #ifde‡
STRIRDE_DEBUGGING


115 
	`˝rötf
("\r°ride_tick_u£d: %d", 
±abÀ
.
°ride_tick_u£d
);

117 
	}
}

121 
	$pöô
()

124 
queue_Àvñ
;

125 
deÁu…_ticks
 = 5;

126 
	`öôlock
(&
±abÀ
.
lock
, "ptable");

131 
queue_Àvñ
 = 0; queue_Àvñ < 
NMLFQ
; ++queue_level){

132 
±abÀ
.
MLFQ_time_qu™tum
[
queue_Àvñ
] = 
deÁu…_ticks
;

133 
deÁu…_ticks
 *= 2;

135 
±abÀ
.
MLFQ_tick_u£d
 = 0;

137 
±abÀ
.
queue_Àvñ_©_mo°
 = 
NMLFQ
 - 1;

138 
±abÀ
.
mö_of_run_¥oc_Àvñ
 = 
NMLFQ
 - 1;

140 
	`mem£t
(
±abÀ
.
°ride_queue
, 0, (ptable.stride_queue));

141 
±abÀ
.
sum_˝u_sh¨e
 = 0;

142 
±abÀ
.
°ride_queue_size
 = 0;

143 
±abÀ
.
°ride_time_qu™tum
 = 1;

144 
±abÀ
.
°ride_tick_u£d
 = 0;

146 
	}
}

153 
¥oc
*

154 
	$Ælo˝roc
()

156 
¥oc
 *
p
;

157 *
•
;

159 
	`acquúe
(&
±abÀ
.
lock
);

161 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

162 if(
p
->
°©e
 =
UNUSED
)

163 
found
;

165 
	`ªÀa£
(&
±abÀ
.
lock
);

167 #ifde‡
THREAD_DEBUGGING


168 
	`˝rötf
("(allocproc)Érror: Proc queue is full!\n");

174 
found
:

175 
p
->
°©e
 = 
EMBRYO
;

176 
p
->
pid
 = 
√xçid
++;

180 
p
->
tick_u£d
 = 0;

181 
p
->
Àvñ_of_MLFQ
 = 0;

182 
p
->
time_qu™tum_u£d
 = 0;

186 
p
->
˝u_sh¨e
 = 0;

187 
p
->
°ride
 = 0;

188 
p
->
°ride_cou¡
 = 0;

192 
p
->
tid
 = 0;

193 
p
->
pgdú_ªf_idx
 = -1;

194 
p
->
thªad_ªtu∫
 = 0;

196 
	`ªÀa£
(&
±abÀ
.
lock
);

199 if((
p
->
k°ack
 = 
	`kÆloc
()) == 0){

200 
p
->
°©e
 = 
UNUSED
;

202 #ifde‡
THREAD_DEBUGGING


203 
	`˝rötf
("(allocproc)Érror: kalloc() is failed.\n");

207 
•
 = 
p
->
k°ack
 + 
KSTACKSIZE
;

210 
•
 - *
p
->
tf
;

211 
p
->
tf
 = (
å≠‰ame
*)
•
;

215 
•
 -= 4;

216 *(
uöt
*)
•
 = (uöt)
å≠ªt
;

218 
•
 - *
p
->
c⁄ãxt
;

219 
p
->
c⁄ãxt
 = (c⁄ãxt*)
•
;

220 
	`mem£t
(
p
->
c⁄ãxt
, 0,  *p->context);

221 
p
->
c⁄ãxt
->
eù
 = (
uöt
)
f‹kªt
;

223  
p
;

224 
	}
}

229 
	$u£röô
()

231 
¥oc
 *
p
;

232 
_bö¨y_öôcode_°¨t
[], 
_bö¨y_öôcode_size
[];

234 
p
 = 
	`Ælo˝roc
();

236 
öô¥oc
 = 
p
;

237 if((
p
->
pgdú
 = 
	`£tupkvm
()) == 0)

238 
	`∑nic
("userinit: out of memory?");

239 
	`öôuvm
(
p
->
pgdú
, 
_bö¨y_öôcode_°¨t
, ()
_bö¨y_öôcode_size
);

240 
p
->
sz
 = 
PGSIZE
;

241 
	`mem£t
(
p
->
tf
, 0, (*p->tf));

242 
p
->
tf
->
cs
 = (
SEG_UCODE
 << 3Ë| 
DPL_USER
;

243 
p
->
tf
->
ds
 = (
SEG_UDATA
 << 3Ë| 
DPL_USER
;

244 
p
->
tf
->
es
 =Ö->tf->
ds
;

245 
p
->
tf
->
ss
 =Ö->tf->
ds
;

246 
p
->
tf
->
eÊags
 = 
FL_IF
;

247 
p
->
tf
->
e•
 = 
PGSIZE
;

248 
p
->
tf
->
eù
 = 0;

250 
	`ß„°r˝y
(
p
->
«me
, "initcode", (p->name));

251 
p
->
cwd
 = 
	`«mei
("/");

257 
	`acquúe
(&
±abÀ
.
lock
);

259 
p
->
°©e
 = 
RUNNABLE
;

261 
	`ªÀa£
(&
±abÀ
.
lock
);

262 
	}
}

267 
	$grow¥oc
(
n
)

269 
uöt
 
sz
;

271 
sz
 = 
¥oc
->sz;

272 if(
n
 > 0){

273 if((
sz
 = 
	`Ælocuvm
(
¥oc
->
pgdú
, sz, sz + 
n
)) == 0)

275 }if(
n
 < 0){

276 if((
sz
 = 
	`dóŒocuvm
(
¥oc
->
pgdú
, sz, sz + 
n
)) == 0)

279 
¥oc
->
sz
 = sz;

280 
	`swôchuvm
(
¥oc
);

282 
	}
}

288 
	$f‹k
()

290 
i
, 
pid
;

291 
¥oc
 *
≈
;

294 if((
≈
 = 
	`Ælo˝roc
()) == 0){

299 if((
≈
->
pgdú
 = 
	`c›yuvm
(
¥oc
->pgdú,Öroc->
sz
)) == 0){

300 
	`k‰ì
(
≈
->
k°ack
);

301 
≈
->
k°ack
 = 0;

302 
≈
->
°©e
 = 
UNUSED
;

305 
≈
->
sz
 = 
¥oc
->sz;

306 
≈
->
∑ª¡
 = 
¥oc
;

307 *
≈
->
tf
 = *
¥oc
->tf;

310 
	`Æloˇã_√w_pgdú_idx
(
≈
);

313 
≈
->
tf
->
óx
 = 0;

315 
i
 = 0; i < 
NOFILE
; i++)

316 if(
¥oc
->
ofûe
[
i
])

317 
≈
->
ofûe
[
i
] = 
	`fûedup
(
¥oc
->ofile[i]);

318 
≈
->
cwd
 = 
	`idup
(
¥oc
->cwd);

320 
	`ß„°r˝y
(
≈
->
«me
, 
¥oc
->name, (proc->name));

322 
pid
 = 
≈
->pid;

324 
	`acquúe
(&
±abÀ
.
lock
);

326 
≈
->
°©e
 = 
RUNNABLE
;

330 
	`ªÀa£
(&
±abÀ
.
lock
);

332  
pid
;

333 
	}
}

335 
	$°ride_queue_dñëe
() {

336 
°ride_idx
;

337 
hópify_up
;

339 #ifde‡
MJ_DEBUGGING


340 
	`˝rötf
("stirde_queueÖrocessÉxit()\n");

344 
±abÀ
.
sum_˝u_sh¨e
 -
¥oc
->
˝u_sh¨e
;

347 
°ride_idx
 = 1; såide_idx < 
NSTRIDE_QUEUE
; ++stride_idx){

348 if(
±abÀ
.
°ride_queue
[
°ride_idx
] =
¥oc
){

353 if(
°ride_idx
 =
NSTRIDE_QUEUE
){

354 
	`∑nic
("exit():áÖrocess isÇot inÅhe stride scheduler");

358 
±abÀ
.
°ride_queue
[
°ride_idx
] =ÖèbÀ.°ride_queue[±abÀ.
°ride_queue_size
];

359 
±abÀ
.
°ride_queue
[±abÀ.
°ride_queue_size
--] = 0;

362 if(
°ride_idx
 == 1){

364 
hópify_up
 = 0;

367 
hópify_up
 = 
±abÀ
.
°ride_queue
[
°ride_idx
]->
°ride_cou¡


368 < 
±abÀ
.
°ride_queue
[
°ride_idx
 / 2]->
°ride_cou¡


372 if(
±abÀ
.
°ride_queue_size
 == 0 ||Ötable.stride_queue_size == 1){

376 if(
hópify_up
){

377 
	`°ride_queue_hópify_down
(
°ride_idx
);

379 
	`°ride_queue_hópify_up
(
°ride_idx
);

383 
	}
}

390 
	$exô
()

392 
¥oc
 *
p
;

393 
fd
;

395 if(
¥oc
 =
öô¥oc
)

396 
	`∑nic
("initÉxiting");

399 
fd
 = 0; fd < 
NOFILE
; fd++){

400 if(
¥oc
->
ofûe
[
fd
]){

401 
	`fûe˛o£
(
¥oc
->
ofûe
[
fd
]);

402 
¥oc
->
ofûe
[
fd
] = 0;

406 
	`begö_›
();

407 
	`ùut
(
¥oc
->
cwd
);

408 
	`íd_›
();

409 
¥oc
->
cwd
 = 0;

411 
	`acquúe
(&
±abÀ
.
lock
);

414 if(
¥oc
->
˝u_sh¨e
 != 0){

415 
	`°ride_queue_dñëe
();

419 
	`wakeup1
(
¥oc
->
∑ª¡
);

422 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

423 if(
p
->
∑ª¡
 =
¥oc
){

424 
p
->
∑ª¡
 = 
öô¥oc
;

425 if(
p
->
°©e
 =
ZOMBIE
)

426 
	`wakeup1
(
öô¥oc
);

431 
¥oc
->
°©e
 = 
ZOMBIE
;

432 
	`sched
();

433 
	`∑nic
("zombieÉxit");

434 
	}
}

437 
	$˛ór_¥oc
(
¥oc
 *
p
) {

438 
pid
;

440 
pid
 = 
p
->pid;

441 
	`k‰ì
(
p
->
k°ack
);

442 
p
->
k°ack
 = 0;

445 
	`check_pgdú_cou¡î_™d_ˇŒ_‰ìvm
(
p
);

447 
p
->
pid
 = 0;

448 
p
->
∑ª¡
 = 0;

449 
p
->
«me
[0] = 0;

450 
p
->
kûÀd
 = 0;

453 
p
->
tick_u£d
 = 0;

454 
p
->
time_qu™tum_u£d
= 0;

455 
p
->
Àvñ_of_MLFQ
 = 0;

456 
p
->
˝u_sh¨e
 = 0;

457 
p
->
°ride
 = 0;

458 
p
->
°ride_cou¡
= 0;

461 
p
->
tid
 = 0;

462 
p
->
pgdú_ªf_idx
 = -1;

463 
p
->
thªad_ªtu∫
 = 0;

465 
p
->
°©e
 = 
UNUSED
;

466  
pid
;

467 
	}
}

472 
	$waô
()

474 
¥oc
 *
p
;

475 
havekids
, 
pid
;

477 
	`acquúe
(&
±abÀ
.
lock
);

480 
havekids
 = 0;

481 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

482 if(
p
->
∑ª¡
 !
¥oc
)

484 
havekids
 = 1;

485 if(
p
->
°©e
 =
ZOMBIE
){

486 
pid
 = 
	`˛ór_¥oc
(
p
);

487 
	`ªÀa£
(&
±abÀ
.
lock
);

488  
pid
;

493 if(!
havekids
 || 
¥oc
->
kûÀd
){

494 
	`ªÀa£
(&
±abÀ
.
lock
);

499 
	`¶ìp
(
¥oc
, &
±abÀ
.
lock
);

501 
	}
}

503 
	$°ride_queue_hópify_up
(
°ride_idx
)

505 
¥oc
* 
èrgë_¥oc
 = 
±abÀ
.
°ride_queue
[
°ride_idx
];

506 
°ride_idx
 != 1){

508 if(
±abÀ
.
°ride_queue
[
°ride_idx
] <Ötable.stride_queue[stride_idx / 2]){

509 
±abÀ
.
°ride_queue
[
°ride_idx
] =Ötable.stride_queue[stride_idx / 2];

510 
°ride_idx
 /= 2;

518 
±abÀ
.
°ride_queue
[
°ride_idx
] = 
èrgë_¥oc
;

520 
	}
}

523 
	$°ride_queue_hópify_down
(
°ride_idx
)

525 
¥oc
* 
p
 = 
±abÀ
.
°ride_queue
[
°ride_idx
];

527 
°ride_idx
 * 2 < 
NPROC


528 && 
°ride_idx
 <
±abÀ
.
°ride_queue_size
){

529 if(
±abÀ
.
°ride_queue
[
°ride_idx
 * 2]

530 && 
±abÀ
.
°ride_queue
[
°ride_idx
 * 2 + 1]){

534 
°ride_idx
 = 
±abÀ
.
°ride_queue
[°ride_idx * 2]->
°ride_cou¡


535 < 
±abÀ
.
°ride_queue
[
°ride_idx
 * 2 + 1]->
°ride_cou¡


536 ? 
°ride_idx
 * 2 : stride_idx * 2 + 1;

539 if(
±abÀ
.
°ride_queue
[
°ride_idx
]->
°ride_cou¡
 < 
p
->stride_count){

540 
±abÀ
.
°ride_queue
[
°ride_idx
 / 2] =Ötable.stride_queue[stride_idx];

542 
°ride_idx
 /= 2;

547 }if(
±abÀ
.
°ride_queue
[
°ride_idx
 * 2]){

549 
°ride_idx
 *= 2;

551 if(
±abÀ
.
°ride_queue
[
°ride_idx
]->
°ride_cou¡
 < 
p
->stride_count){

552 
±abÀ
.
°ride_queue
[
°ride_idx
 / 2] =Ötable.stride_queue[stride_idx];

554 
°ride_idx
 /= 2;

565 
±abÀ
.
°ride_queue
[
°ride_idx
] = 
p
;

567 
	}
}

570 
	$föd_idx_of_°ride_to_run
()

572 
¥oc
* 
¥oc_to_be_run
;

573 
i
;

576 
°ride_föd_idx
 = 1;

577 
°ride_föd_idx
 <
±abÀ
.
°ride_queue_size
){

578 if(
±abÀ
.
°ride_queue
[
°ride_föd_idx
]->
°©e
 =
RUNNABLE
){

581 
¥oc_to_be_run
 = 
±abÀ
.
°ride_queue
[
°ride_föd_idx
];

582 
¥oc_to_be_run
->
°ride_cou¡
 +¥oc_to_be_run->
°ride
;

583 
	`°ride_queue_hópify_down
(
°ride_föd_idx
);

590 
À·_chûd
 = 
°ride_föd_idx
 * 2;

591 
right_chûd
 = 
°ride_föd_idx
 * 2 + 1;

592 íum {
NO_CHILD
, 
LEFT_ONLY
, 
BOTH
} 
chûd_°©us
;

594 if(
right_chûd
 <
±abÀ
.
°ride_queue_size
){

595 
chûd_°©us
 = 
BOTH
;

596 }if(
À·_chûd
 > 
±abÀ
.
°ride_queue_size
){

597 
chûd_°©us
 = 
NO_CHILD
;

599 
chûd_°©us
 = 
LEFT_ONLY
;

603 
chûd_°©us
){

604 
BOTH
:

606 if(
±abÀ
.
°ride_queue
[
À·_chûd
]->
°ride_cou¡


607 < 
±abÀ
.
°ride_queue
[
right_chûd
]->
°ride_cou¡
){

609 
°ride_föd_idx
 = 
À·_chûd
;

612 
°ride_föd_idx
 = 
right_chûd
;

616 
LEFT_ONLY
:

618 
°ride_föd_idx
 = 
À·_chûd
;

621 
NO_CHILD
:

624 
°ride_föd_idx
 = 
±abÀ
.
°ride_queue_size
 + 1;

627 
	`∑nic
("error in find_idx_of_stride_to_run().");

634 if(
°ride_föd_idx
 >
±abÀ
.
°ride_queue_size
 + 1){

635 
i
 = 1; i <
±abÀ
.
°ride_queue_size
; ++i){

636 if(
±abÀ
.
°ride_queue
[
i
]->
°©e
 =
RUNNABLE
){

637 
°ride_föd_idx
 = 
i
;

647  
°ride_föd_idx
;

648 
	}
}

651 
	$£À˘_°ride_‹_MLFQ
()

653 
ønd°©e
 = 1;

654 
queue_£À˘‹
;

655 
ønd°©e
 =Ñandstate * 1664525 + 1013904223;

656 
queue_£À˘‹
 = 
ønd°©e
 % 100;

658 if(
queue_£À˘‹
 < 
±abÀ
.
sum_˝u_sh¨e
){

665 
	}
}

676 
	$scheduÀr
()

678 
¥oc
 *
p
;

681 
choosög_°ride_‹_MLFQ
;

682 
°ride_is_£À˘ed
 = 0;

686 
	`°i
();

689 
	`acquúe
(&
±abÀ
.
lock
);

692 
choosög_°ride_‹_MLFQ
 = 1;

695 
±abÀ
.
queue_Àvñ_©_mo°
 = 
NMLFQ
 - 1;

696 
±abÀ
.
queue_Àvñ_©_mo°
 < 
NMLFQ
){

699 
±abÀ
.
mö_of_run_¥oc_Àvñ
 = 
NMLFQ
 - 1;

701 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

703 if(
±abÀ
.
sum_˝u_sh¨e
 == 0){

705 
°ride_is_£À˘ed
 = 0;

706 
choosög_°ride_‹_MLFQ
 = 0;

707 }if(
choosög_°ride_‹_MLFQ
){

710 
°ride_is_£À˘ed
 = 
	`£À˘_°ride_‹_MLFQ
();

717 if(
°ride_is_£À˘ed
){

720 
°ride_idx_to_be_run
;

722 
°ride_idx_to_be_run
 = 
	`föd_idx_of_°ride_to_run
();

725 if(
°ride_idx_to_be_run
 <
±abÀ
.
°ride_queue_size
){

727 
p
 = 
±abÀ
.
°ride_queue
[
°ride_idx_to_be_run
];

730 
°ride_is_£À˘ed
 = 0;

731 
choosög_°ride_‹_MLFQ
 = 0;

740 if(
p
->
°©e
 =
RUNNABLE


741 && 
p
->
˝u_sh¨e
 == 0

742 && 
p
->
Àvñ_of_MLFQ
 <
±abÀ
.
queue_Àvñ_©_mo°
){

745 
±abÀ
.
queue_Àvñ_©_mo°
 = 
p
->
Àvñ_of_MLFQ
 <Ötable.queue_level_at_most ?Ö->level_of_MLFQ :Ötable.queue_level_at_most;

746 
±abÀ
.
mö_of_run_¥oc_Àvñ
 =ÖèbÀ.
queue_Àvñ_©_mo°
;

750 
choosög_°ride_‹_MLFQ
 = 0;

758 
¥oc
* 
p_mlfq
 = 
p
;

761 
bef‹e_MLFQ_u£d_tick
;

767 #ifde‡
STRIDE_DEBUGGING


769 
	`˝rötf
("ContChange. ");

770 
	`˝rötf
("°ride_is_£À˘ed:%d, ", 
°ride_is_£À˘ed
);

771 
	`˝rötf
("¥oc_«me:%s, ", 
p
->
«me
);

772 
	`˝rötf
("¥oc_id:%d, ", 
p
->
pid
);

773 
	`˝rötf
("MLFQ_tick:%d, ", 
±abÀ
.
MLFQ_tick_u£d
,
p
->
Àvñ_of_MLFQ
);

774 
	`˝rötf
("Àvñ:%d, ", 
p
->
Àvñ_of_MLFQ
);

775 
	`˝rötf
("°ride_tick:%d, ", 
±abÀ
.
°ride_tick_u£d
);

776 
	`˝rötf
("˝u_sh¨e:%d, ", 
p
->
˝u_sh¨e
);

777 
	`˝rötf
("sum_˝u_sh¨e: %d, ", 
±abÀ
.
sum_˝u_sh¨e
);

778 
	`˝rötf
("°ride:%d, ", 
p
->
°ride
);

779 
	`˝rötf
("°ride_cou¡:%d\n", 
p
->
°ride_cou¡
);

782 #ifde‡
THREAD_DEBUGGING


793 
¥oc
 = 
p
;

794 
	`swôchuvm
(
p
);

795 
p
->
°©e
 = 
RUNNING
;

799 
bef‹e_MLFQ_u£d_tick
 = 
±abÀ
.
MLFQ_tick_u£d
;

801 
	`swtch
(&
˝u
->
scheduÀr
, 
p
->
c⁄ãxt
);

802 
	`swôchkvm
();

811 if(
°ride_is_£À˘ed
 == 0

812 && 
±abÀ
.
sum_˝u_sh¨e
 != 0

813 && 
p
->
°©e
 =
RUNNABLE


814 && 
p
->
˝u_sh¨e
 == 0

815 && 
±abÀ
.
MLFQ_tick_u£d
 =
bef‹e_MLFQ_u£d_tick
)

822 
choosög_°ride_‹_MLFQ
 = 0;

826 
p
--;

828 
choosög_°ride_‹_MLFQ
 = 1;

831 
¥oc
 = 0;

833 if(
°ride_is_£À˘ed
){

836 
p
 = 
p_mlfq
;

837 
p
--;

841 if(
±abÀ
.
mö_of_run_¥oc_Àvñ
 =
NMLFQ
 - 1) {

844 
±abÀ
.
queue_Àvñ_©_mo°
++;

849 
	`ªÀa£
(&
±abÀ
.
lock
);

851 
	}
}

861 
	$sched
()

863 
öã«
;

865 if(!
	`hﬁdög
(&
±abÀ
.
lock
))

866 
	`∑nic
("schedÖtable.lock");

867 if(
˝u
->
n˛i
 != 1)

868 
	`∑nic
("schedÜocks");

869 if(
¥oc
->
°©e
 =
RUNNING
)

870 
	`∑nic
("schedÑunning");

871 if(
	`ªadeÊags
()&
FL_IF
)

872 
	`∑nic
("sched interruptible");

874 
öã«
 = 
˝u
->intena;

875 
	`swtch
(&
¥oc
->
c⁄ãxt
, 
˝u
->
scheduÀr
);

879 if(
¥oc
){

880 
¥oc
->
time_qu™tum_u£d
 = 0;

883 
˝u
->
öã«
 = intena;

884 
	}
}

888 
	$yõld
()

890 
	`acquúe
(&
±abÀ
.
lock
);

891 
¥oc
->
°©e
 = 
RUNNABLE
;

892 
	`sched
();

893 
	`ªÀa£
(&
±abÀ
.
lock
);

894 
	}
}

897 
	$sys_yõld
(){

898 
	`yõld
();

900 
	}
}

905 
	$f‹kªt
()

907 
fú°
 = 1;

909 
	`ªÀa£
(&
±abÀ
.
lock
);

911 if(
fú°
){

915 
fú°
 = 0;

916 
	`iöô
(
ROOTDEV
);

917 
	`öôlog
(
ROOTDEV
);

921 
	}
}

926 
	$¶ìp
(*
ch™
, 
•ölock
 *
lk
)

928 if(
¥oc
 == 0)

929 
	`∑nic
("sleep");

931 if(
lk
 == 0)

932 
	`∑nic
("sleep withoutÜk");

940 if(
lk
 !&
±abÀ
.
lock
){

941 
	`acquúe
(&
±abÀ
.
lock
);

942 
	`ªÀa£
(
lk
);

946 
¥oc
->
ch™
 = chan;

947 
¥oc
->
°©e
 = 
SLEEPING
;

948 
	`sched
();

951 
¥oc
->
ch™
 = 0;

954 if(
lk
 !&
±abÀ
.
lock
){

955 
	`ªÀa£
(&
±abÀ
.
lock
);

956 
	`acquúe
(
lk
);

958 
	}
}

964 
	$wakeup1
(*
ch™
)

966 
¥oc
 *
p
;

968 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

969 if(
p
->
°©e
 =
SLEEPING
 &&Ö->
ch™
 == chan)

970 
p
->
°©e
 = 
RUNNABLE
;

971 
	}
}

975 
	$wakeup
(*
ch™
)

977 
	`acquúe
(&
±abÀ
.
lock
);

978 
	`wakeup1
(
ch™
);

979 
	`ªÀa£
(&
±abÀ
.
lock
);

980 
	}
}

986 
	$kûl
(
pid
)

988 
¥oc
 *
p
;

990 
	`acquúe
(&
±abÀ
.
lock
);

991 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

992 if(
p
->
pid
 ==Öid){

993 
p
->
kûÀd
 = 1;

995 if(
p
->
°©e
 =
SLEEPING
)

996 
p
->
°©e
 = 
RUNNABLE
;

997 
	`ªÀa£
(&
±abÀ
.
lock
);

1001 
	`ªÀa£
(&
±abÀ
.
lock
);

1003 
	}
}

1010 
	$¥ocdump
()

1012 *
°©es
[] = {

1013 [
UNUSED
] "unused",

1014 [
EMBRYO
] "embryo",

1015 [
SLEEPING
] "sleep ",

1016 [
RUNNABLE
] "runble",

1017 [
RUNNING
] "run ",

1018 [
ZOMBIE
] "zombie"

1020 
i
;

1021 
¥oc
 *
p
;

1022 *
°©e
;

1023 
uöt
 
pc
[10];

1025 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

1026 if(
p
->
°©e
 =
UNUSED
)

1028 if(
p
->
°©e
 >0 &&Ö->°©ê< 
	`NELEM
(
°©es
) && states[p->state])

1029 
°©e
 = 
°©es
[
p
->state];

1031 
°©e
 = "???";

1032 
	`˝rötf
("%d %†%s", 
p
->
pid
, 
°©e
,Ö->
«me
);

1033 if(
p
->
°©e
 =
SLEEPING
){

1034 
	`gëˇŒîpcs
((
uöt
*)
p
->
c⁄ãxt
->
ebp
+2, 
pc
);

1035 
i
=0; i<10 && 
pc
[i] != 0; i++)

1036 
	`˝rötf
(" %p", 
pc
[
i
]);

1038 
	`˝rötf
("\n");

1040 
	}
}

1044 
	$¥i‹ôy_boo°
(){

1045 
¥oc
 *
p
;

1047 
	`˝rötf
("[do boosting!]\n");

1049 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

1050 
p
->
Àvñ_of_MLFQ
 = 0;

1051 
p
->
tick_u£d
 = 0;

1054 
p
->
time_qu™tum_u£d
 = 0;

1057 
±abÀ
.
MLFQ_tick_u£d
 = 0;

1059 
	}
}

1063 
	$£t_˝u_sh¨e
(
ªquúed
)

1065 
˝u_sh¨e_Æªady_£t
;

1066 
desúed_sum_˝u_sh¨e
;

1067 c⁄° 
MIN_CPU_SHARE
 = 1;

1068 c⁄° 
MAX_CPU_SHARE
 = 80;

1069 
is_√w
;

1070 
idx
;

1073 if–! (
MIN_CPU_SHARE
 <
ªquúed
 &&Ñequúed <
MAX_CPU_SHARE
) )

1074 
ex˚±i⁄
;

1077 
˝u_sh¨e_Æªady_£t
 = 
¥oc
->
˝u_sh¨e
;

1078 if(
˝u_sh¨e_Æªady_£t
 == 0){

1079 
is_√w
 = 1;

1081 
is_√w
 = 0;

1084 
desúed_sum_˝u_sh¨e
 = 
±abÀ
.
sum_˝u_sh¨e
 - 
˝u_sh¨e_Æªady_£t
 + 
ªquúed
;

1086 if(
desúed_sum_˝u_sh¨e
 > 
MAX_CPU_SHARE
 )

1087 
ex˚±i⁄
;

1090 
±abÀ
.
sum_˝u_sh¨e
 = 
desúed_sum_˝u_sh¨e
;

1091 
¥oc
->
˝u_sh¨e
 = 
ªquúed
;

1092 
¥oc
->
°ride
 = 
NSTRIDE
 / 
ªquúed
;

1094 if(
is_√w
){

1099 if(
±abÀ
.
°ride_queue
[1]){

1100 
¥oc
->
°ride_cou¡
 = 
±abÀ
.
°ride_queue
[1]->stride_count;

1104 
idx
 = ++
±abÀ
.
°ride_queue_size
;

1105 
idx
 != 1){

1106 
±abÀ
.
°ride_queue
[
idx
] =Ötable.stride_queue[idx/2];

1107 
idx
 /= 2;

1109 
±abÀ
.
°ride_queue
[
idx
] = 
¥oc
;

1116 
ex˚±i⁄
:

1118 
	}
}

1121 
	$sys_£t_˝u_sh¨e
()

1123 
ªquúed
;

1125 if(
	`¨göt
(0, &
ªquúed
) < 0){

1129  
	`£t_˝u_sh¨e
(
ªquúed
);

1130 
	}
}

1133 
thªad_¸óã
(
thªad_t
 * 
thªad
, * (*
°¨t_routöe
)(*), *
¨g
)

1136 
	gi
;

1137 
¥oc
 *
	g≈
;

1138 ** 
	g¨g_±r
;

1142 if((
	g≈
 = 
Ælo˝roc
()) == 0){

1143 #ifde‡
THREAD_DEBUGGING


1144 
˝rötf
("(thread_create)Érror:állocproc()\n");

1150 
	g≈
->
	gpid
 = 
¥oc
->
pid
;

1151 
	g≈
->
	gtid
 = 
√xt_thªad_id
++;

1152 *
	gthªad
 = 
≈
->
tid
;

1155 
	g≈
->
	gpgdú
 = 
¥oc
->
pgdú
;

1156 
	g≈
->
	gsz
 = 
¥oc
->
sz
;

1157 
	g≈
->
	g∑ª¡
 = 
¥oc
;

1158 *
	g≈
->
	gtf
 = *
¥oc
->
tf
;

1161 
	g≈
->
	gpgdú_ªf_idx

¥oc
->
pgdú_ªf_idx
;

1162 
acquúe
(&
thªad_lock
);

1163 
	gpgdú_ªf
[
≈
->
pgdú_ªf_idx
]++;

1164 
ªÀa£
(&
thªad_lock
);

1167 
	g≈
->
	gtf
->
	góx
 = 0;

1169 
	gi
 = 0; i < 
	gNOFILE
; i++)

1170 if(
	g¥oc
->
	gofûe
[
i
])

1171 
	g≈
->
	gofûe
[
i
] = 
fûedup
(
¥oc
->
ofûe
[i]);

1172 
	g≈
->
	gcwd
 = 
idup
(
¥oc
->
cwd
);

1174 
ß„°r˝y
(
≈
->
«me
, 
¥oc
->name, (proc->name));

1177 
	g≈
->
	gsz
 = 
PGROUNDUP
(
≈
->
sz
);

1178 if((
	g≈
->
	gsz
 = 
Ælocuvm
(
≈
->
pgdú
,Çp->
sz
,Çp->sz + 2*
PGSIZE
)) == 0) {

1179 #ifde‡
THREAD_DEBUGGING


1180 
˝rötf
("(thread_create)Érror:állocuvm()\n");

1184 
˛óΩãu
(
≈
->
pgdú
, (*)“p->
sz
 - 2*
PGSIZE
));

1186 
acquúe
(&
thªad_lock
);

1187 
	g¥oc
->
	gsz
 = 
≈
->
sz
;

1188 
ªÀa£
(&
thªad_lock
);

1191 
	g≈
->
	gtf
->
	geù
 = (
uöt
)
°¨t_routöe
;

1192 
	g≈
->
	gtf
->
	ge•
 = 
≈
->
sz
 - 8;

1194 
	g¨g_±r
 = (**)(
≈
->
tf
->
e•
);

1195 *
	g¨g_±r
 = (*)0xDEADDEAD;

1197 
	g¨g_±r
 = (**)(
≈
->
tf
->
e•
 + 4);

1198 *
	g¨g_±r
 = 
¨g
;

1200 
acquúe
(&
±abÀ
.
lock
);

1202 
	g≈
->
	g°©e
 = 
RUNNABLE
;

1206 
ªÀa£
(&
±abÀ
.
lock
);

1213 
	$sys_thªad_¸óã
()

1215 
thªad_t
 * 
thªad
;

1216 * (*
°¨t_routöe
)(*);

1217 * 
¨g
;

1219 if(
	`¨g±r
(0, (**)&
thªad
, (thread)) < 0){

1222 if(
	`¨g±r
(1, (**)&
°¨t_routöe
, (start_routine)) < 0){

1225 if(
	`¨g±r
(2, (**)&
¨g
, (arg)) < 0){

1229  
	`thªad_¸óã
(
thªad
, 
°¨t_routöe
, 
¨g
);

1230 
	}
}

1233 
	$thªad_exô
(*
ªtvÆ
)

1235 
¥oc
 *
p
;

1236 
fd
;

1238 if(
¥oc
 =
öô¥oc
)

1239 
	`∑nic
("initÉxiting");

1242 
fd
 = 0; fd < 
NOFILE
; fd++){

1243 if(
¥oc
->
ofûe
[
fd
]){

1244 
	`fûe˛o£
(
¥oc
->
ofûe
[
fd
]);

1245 
¥oc
->
ofûe
[
fd
] = 0;

1249 
	`begö_›
();

1250 
	`ùut
(
¥oc
->
cwd
);

1251 
	`íd_›
();

1252 
¥oc
->
cwd
 = 0;

1254 
	`acquúe
(&
±abÀ
.
lock
);

1256 
¥oc
->
thªad_ªtu∫
 = 
ªtvÆ
;

1259 if(
¥oc
->
˝u_sh¨e
 != 0){

1260 
	`°ride_queue_dñëe
();

1264 
	`wakeup1
(
¥oc
->
∑ª¡
);

1267 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

1268 if(
p
->
∑ª¡
 =
¥oc
){

1269 
p
->
∑ª¡
 = 
öô¥oc
;

1270 if(
p
->
°©e
 =
ZOMBIE
)

1271 
	`wakeup1
(
öô¥oc
);

1276 
¥oc
->
°©e
 = 
ZOMBIE
;

1277 
	`sched
();

1278 
	`∑nic
("zombieÉxit");

1281 
	}
}

1284 
	$sys_thªad_exô
()

1286 *
ªtvÆ
;

1287 if(
	`¨g±r
(0, (**)&
ªtvÆ
, (retval)) < 0){

1291 
	`thªad_exô
(
ªtvÆ
);

1293 
	}
}

1296 
	$thªad_joö
(
thªad_t
 
thªad
, **
ªtvÆ
)

1299 
¥oc
 *
p
;

1300 
havekids
;

1302 
	`acquúe
(&
±abÀ
.
lock
);

1305 
havekids
 = 0;

1306 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

1307 if(
p
->
∑ª¡
 !
¥oc
 ||Ö->
tid
 !
thªad
)

1309 
havekids
 = 1;

1310 if(
p
->
°©e
 =
ZOMBIE
){

1311 *
ªtvÆ
 = 
p
->
thªad_ªtu∫
;

1312 
	`˛ór_¥oc
(
p
);

1313 
	`ªÀa£
(&
±abÀ
.
lock
);

1319 if(!
havekids
 || 
¥oc
->
kûÀd
){

1320 
	`ªÀa£
(&
±abÀ
.
lock
);

1325 
	`¶ìp
(
¥oc
, &
±abÀ
.
lock
);

1329 
	}
}

1332 
	$sys_thªad_joö
()

1334 
thªad_t
 
thªad
;

1335 **
ªtvÆ
;

1337 if(
	`¨göt
(0, (*)&
thªad
) < 0){

1340 if(
	`¨g±r
(1, (**)&
ªtvÆ
, (retval)) < 0){

1344  
	`thªad_joö
(
thªad
, 
ªtvÆ
);

1345 
	}
}

	@proc.h

2 
	s˝u
 {

3 
uch¨
 
	m≠icid
;

4 
c⁄ãxt
 *
	mscheduÀr
;

5 
èsk°©e
 
	mts
;

6 
£gdesc
 
	mgdt
[
NSEGS
];

7 vﬁ©ûê
uöt
 
	m°¨ãd
;

8 
	mn˛i
;

9 
	möã«
;

12 
˝u
 *
	m˝u
;

13 
¥oc
 *
	m¥oc
;

16 
˝u
 
˝us
[
NCPU
];

17 
n˝u
;

27 
˝u
 *˝u 
asm
("%gs:0");

28 
¥oc
 *¥o¯
asm
("%gs:4");

41 
	sc⁄ãxt
 {

42 
uöt
 
	medi
;

43 
uöt
 
	mesi
;

44 
uöt
 
	mebx
;

45 
uöt
 
	mebp
;

46 
uöt
 
	meù
;

49 
	e¥oc°©e
 { 
	mUNUSED
, 
	mEMBRYO
, 
	mSLEEPING
, 
	mRUNNABLE
, 
	mRUNNING
, 
	mZOMBIE
 };

52 
	s¥oc
 {

53 
uöt
 
	msz
;

54 
pde_t
* 
	mpgdú
;

55 *
	mk°ack
;

56 
¥oc°©e
 
	m°©e
;

57 
	mpid
;

58 
¥oc
 *
	m∑ª¡
;

59 
å≠‰ame
 *
	mtf
;

60 
c⁄ãxt
 *
	mc⁄ãxt
;

61 *
	mch™
;

62 
	mkûÀd
;

63 
fûe
 *
	mofûe
[
NOFILE
];

64 
öode
 *
	mcwd
;

65 
	m«me
[16];

68 
	mtick_u£d
;

69 
	mtime_qu™tum_u£d
;

70 
	mÀvñ_of_MLFQ
;

73 
	m˝u_sh¨e
;

74 
	m°ride
;

75 
	m°ride_cou¡
;

78 
thªad_t
 
	mtid
;

79 
	mpgdú_ªf_idx
;

80 * 
	mthªad_ªtu∫
;

	@proc_temp.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"x86.h
"

7 
	~"¥oc.h
"

8 
	~"•ölock.h
"

11 
•ölock
 
	mlock
;

14 
¥oc
 
	m¥oc
[
NPROC
];

15 
	mMLFQ_time_qu™tum
[
NMLFQ
];

16 
	mMLFQ_tick_u£d
;

19 
	mqueue_Àvñ_©_mo°
;

20 
	mmö_of_run_¥oc_Àvñ
;

23 
¥oc
* 
	m°ride_queue
[
NSTRIDE_QUEUE
];

24 
	msum_˝u_sh¨e
;

25 
	m°ride_queue_size
;

26 
	m°ride_time_qu™tum
;

27 
	m°ride_tick_u£d
;

30 } 
	g±abÀ
;

34 
•ölock
 
	gthªad_lock
;

35 
	gpgdú_cou¡
[
NPROC
];

36 
	gpgdú_cou¡_idx
;

39 
¥oc
 *
	göô¥oc
;

41 
	g√xçid
 = 1;

42 
f‹kªt
();

43 
å≠ªt
();

45 
wakeup1
(*
ch™
);

47 
°ride_queue_hópify_up
(
°ride_idx
);

48 
°ride_queue_hópify_down
(
°ride_idx
);

50 
	g√xt_thªad_id
 = 1;

54 
	$gë_time_qu™tum
()

56 if(
¥oc
 &&Öroc->
˝u_sh¨e
 != 0){

57  
±abÀ
.
°ride_time_qu™tum
;

59  
±abÀ
.
MLFQ_time_qu™tum
[
¥oc
->
Àvñ_of_MLFQ
];

61 
	}
}

65 
	$gë_MLFQ_tick_u£d
()

67  
±abÀ
.
MLFQ_tick_u£d
;

68 
	}
}

71 
	$ö¸ó£_MLFQ_tick_u£d
()

73 
±abÀ
.
MLFQ_tick_u£d
++;

74 #ifde‡
STRIRDE_DEBUGGING


75 
	`˝rötf
("\rMLFQ_tick_u£d: %d", 
±abÀ
.
MLFQ_tick_u£d
);

77 
	}
}

80 
	$ö¸ó£_°ride_tick_u£d
()

82 
±abÀ
.
°ride_tick_u£d
++;

83 #ifde‡
STRIRDE_DEBUGGING


84 
	`˝rötf
("\r°ride_tick_u£d: %d", 
±abÀ
.
°ride_tick_u£d
);

86 
	}
}

90 
	$pöô
()

93 
queue_Àvñ
;

94 
deÁu…_ticks
 = 5;

95 
	`öôlock
(&
±abÀ
.
lock
, "ptable");

96 
	`öôlock
(&
thªad_lock
, "thread");

101 
queue_Àvñ
 = 0; queue_Àvñ < 
NMLFQ
; ++queue_level){

102 
±abÀ
.
MLFQ_time_qu™tum
[
queue_Àvñ
] = 
deÁu…_ticks
;

103 
deÁu…_ticks
 *= 2;

105 
±abÀ
.
MLFQ_tick_u£d
 = 0;

107 
±abÀ
.
queue_Àvñ_©_mo°
 = 
NMLFQ
 - 1;

108 
±abÀ
.
mö_of_run_¥oc_Àvñ
 = 
NMLFQ
 - 1;

110 
	`mem£t
(
±abÀ
.
°ride_queue
, 0, (ptable.stride_queue));

111 
±abÀ
.
sum_˝u_sh¨e
 = 0;

112 
±abÀ
.
°ride_queue_size
 = 0;

113 
±abÀ
.
°ride_time_qu™tum
 = 1;

114 
±abÀ
.
°ride_tick_u£d
 = 0;

116 
pgdú_cou¡_idx
 = -1;

117 
	`mem£t
(
pgdú_cou¡
, 0, (pgdir_count));

119 
	}
}

126 
¥oc
*

127 
	$Ælo˝roc
()

129 
¥oc
 *
p
;

130 *
•
;

132 
	`acquúe
(&
±abÀ
.
lock
);

134 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

135 if(
p
->
°©e
 =
UNUSED
)

136 
found
;

138 
	`ªÀa£
(&
±abÀ
.
lock
);

141 
found
:

142 
p
->
°©e
 = 
EMBRYO
;

143 
p
->
pid
 = 
√xçid
++;

147 
p
->
tick_u£d
 = 0;

148 
p
->
Àvñ_of_MLFQ
 = 0;

149 
p
->
time_qu™tum_u£d
 = 0;

153 
p
->
˝u_sh¨e
 = 0;

154 
p
->
°ride
 = 0;

155 
p
->
°ride_cou¡
 = 0;

158 
p
->
tid
 = 0;

159 
p
->
thªad_cou¡
 = 0;

160 
p
->
pgdú_cou¡_idx
 = -1;

163 
	`ªÀa£
(&
±abÀ
.
lock
);

166 if((
p
->
k°ack
 = 
	`kÆloc
()) == 0){

167 
p
->
°©e
 = 
UNUSED
;

170 
•
 = 
p
->
k°ack
 + 
KSTACKSIZE
;

173 
•
 - *
p
->
tf
;

174 
p
->
tf
 = (
å≠‰ame
*)
•
;

178 
•
 -= 4;

179 *(
uöt
*)
•
 = (uöt)
å≠ªt
;

181 
•
 - *
p
->
c⁄ãxt
;

182 
p
->
c⁄ãxt
 = (c⁄ãxt*)
•
;

183 
	`mem£t
(
p
->
c⁄ãxt
, 0,  *p->context);

184 
p
->
c⁄ãxt
->
eù
 = (
uöt
)
f‹kªt
;

186  
p
;

187 
	}
}

192 
	$u£röô
()

194 
¥oc
 *
p
;

195 
_bö¨y_öôcode_°¨t
[], 
_bö¨y_öôcode_size
[];

197 
p
 = 
	`Ælo˝roc
();

199 
öô¥oc
 = 
p
;

200 if((
p
->
pgdú
 = 
	`£tupkvm
()) == 0)

201 
	`∑nic
("userinit: out of memory?");

202 
	`öôuvm
(
p
->
pgdú
, 
_bö¨y_öôcode_°¨t
, ()
_bö¨y_öôcode_size
);

203 
p
->
sz
 = 
PGSIZE
;

204 
	`mem£t
(
p
->
tf
, 0, (*p->tf));

205 
p
->
tf
->
cs
 = (
SEG_UCODE
 << 3Ë| 
DPL_USER
;

206 
p
->
tf
->
ds
 = (
SEG_UDATA
 << 3Ë| 
DPL_USER
;

207 
p
->
tf
->
es
 =Ö->tf->
ds
;

208 
p
->
tf
->
ss
 =Ö->tf->
ds
;

209 
p
->
tf
->
eÊags
 = 
FL_IF
;

210 
p
->
tf
->
e•
 = 
PGSIZE
;

211 
p
->
tf
->
eù
 = 0;

213 
	`ß„°r˝y
(
p
->
«me
, "initcode", (p->name));

214 
p
->
cwd
 = 
	`«mei
("/");

220 
	`acquúe
(&
±abÀ
.
lock
);

222 
p
->
°©e
 = 
RUNNABLE
;

224 
	`ªÀa£
(&
±abÀ
.
lock
);

225 
	}
}

230 
	$grow¥oc
(
n
)

232 
uöt
 
sz
;

234 
sz
 = 
¥oc
->sz;

235 if(
n
 > 0){

236 if((
sz
 = 
	`Ælocuvm
(
¥oc
->
pgdú
, sz, sz + 
n
)) == 0)

238 }if(
n
 < 0){

239 if((
sz
 = 
	`dóŒocuvm
(
¥oc
->
pgdú
, sz, sz + 
n
)) == 0)

242 
¥oc
->
sz
 = sz;

243 
	`swôchuvm
(
¥oc
);

245 
	}
}

251 
	$f‹k
()

253 
i
, 
pid
;

254 
¥oc
 *
≈
;

257 if((
≈
 = 
	`Ælo˝roc
()) == 0){

262 if((
≈
->
pgdú
 = 
	`c›yuvm
(
¥oc
->pgdú,Öroc->
sz
)) == 0){

263 
	`k‰ì
(
≈
->
k°ack
);

264 
≈
->
k°ack
 = 0;

265 
≈
->
°©e
 = 
UNUSED
;

268 
≈
->
sz
 = 
¥oc
->sz;

269 
≈
->
∑ª¡
 = 
¥oc
;

270 *
≈
->
tf
 = *
¥oc
->tf;

273 
i
 = 0; i < 
NPROC
; ++i) {

274 
pgdú_cou¡_idx
++;

275 
pgdú_cou¡_idx
 %
NPROC
;

277 i‡(
pgdú_cou¡
[
pgdú_cou¡_idx
] == 0) {

278 
≈
->
pgdú_cou¡_idx
 =Ögdir_count_idx;

280 
	`acquúe
(&
thªad_lock
);

281 
pgdú_cou¡
[
≈
->
pgdú_cou¡_idx
]++;

282 
	`ªÀa£
(&
thªad_lock
);

288 
≈
->
tf
->
óx
 = 0;

290 
i
 = 0; i < 
NOFILE
; i++)

291 if(
¥oc
->
ofûe
[
i
])

292 
≈
->
ofûe
[
i
] = 
	`fûedup
(
¥oc
->ofile[i]);

293 
≈
->
cwd
 = 
	`idup
(
¥oc
->cwd);

295 
	`ß„°r˝y
(
≈
->
«me
, 
¥oc
->name, (proc->name));

297 
pid
 = 
≈
->pid;

299 
	`acquúe
(&
±abÀ
.
lock
);

301 
≈
->
°©e
 = 
RUNNABLE
;

305 
	`ªÀa£
(&
±abÀ
.
lock
);

307  
pid
;

308 
	}
}

314 
	$exô
()

316 
¥oc
 *
p
;

317 
fd
;

318 
°ride_idx
;

320 if(
¥oc
 =
öô¥oc
)

321 
	`∑nic
("initÉxiting");

324 
fd
 = 0; fd < 
NOFILE
; fd++){

325 if(
¥oc
->
ofûe
[
fd
]){

326 
	`fûe˛o£
(
¥oc
->
ofûe
[
fd
]);

327 
¥oc
->
ofûe
[
fd
] = 0;

331 
	`begö_›
();

332 
	`ùut
(
¥oc
->
cwd
);

333 
	`íd_›
();

334 
¥oc
->
cwd
 = 0;

336 
	`acquúe
(&
±abÀ
.
lock
);

339 if(
¥oc
->
˝u_sh¨e
 != 0){

340 
hópify_up
;

342 #ifde‡
MJ_DEBUGGING


343 
	`˝rötf
("stirde_queueÖrocessÉxit()\n");

347 
±abÀ
.
sum_˝u_sh¨e
 -
¥oc
->
˝u_sh¨e
;

350 
°ride_idx
 = 1; såide_idx < 
NSTRIDE_QUEUE
; ++stride_idx){

351 if(
±abÀ
.
°ride_queue
[
°ride_idx
] =
¥oc
){

356 if(
°ride_idx
 =
NSTRIDE_QUEUE
){

357 
	`∑nic
("exit():áÖrocess isÇot inÅhe stride scheduler");

361 
±abÀ
.
°ride_queue
[
°ride_idx
] =ÖèbÀ.°ride_queue[±abÀ.
°ride_queue_size
];

362 
±abÀ
.
°ride_queue
[±abÀ.
°ride_queue_size
--] = 0;

365 if(
°ride_idx
 == 1){

367 
hópify_up
 = 0;

370 
hópify_up
 = 
±abÀ
.
°ride_queue
[
°ride_idx
]->
°ride_cou¡


371 < 
±abÀ
.
°ride_queue
[
°ride_idx
 / 2]->
°ride_cou¡


375 if(
±abÀ
.
°ride_queue_size
 == 0 ||Ötable.stride_queue_size == 1){

379 if(
hópify_up
){

380 
	`°ride_queue_hópify_down
(
°ride_idx
);

382 
	`°ride_queue_hópify_up
(
°ride_idx
);

388 
	`wakeup1
(
¥oc
->
∑ª¡
);

391 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

392 if(
p
->
∑ª¡
 =
¥oc
){

393 
p
->
∑ª¡
 = 
öô¥oc
;

394 if(
p
->
°©e
 =
ZOMBIE
) {

395 
	`wakeup1
(
öô¥oc
);

401 
¥oc
->
°©e
 = 
ZOMBIE
;

402 
	`sched
();

403 
	`∑nic
("zombieÉxit");

404 
	}
}

409 
	$waô
()

411 
¥oc
 *
p
;

412 
havekids
, 
pid
;

414 
	`acquúe
(&
±abÀ
.
lock
);

417 
havekids
 = 0;

418 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

419 if(
p
->
∑ª¡
 !
¥oc
)

421 
havekids
 = 1;

422 if(
p
->
°©e
 =
ZOMBIE
){

424 
pid
 = 
p
->pid;

425 
	`k‰ì
(
p
->
k°ack
);

426 
p
->
k°ack
 = 0;

428 i‡(
p
->
thªad_cou¡
 == 0) {

429 
	`‰ìvm
(
p
->
pgdú
);

432 
p
->
pid
 = 0;

433 
p
->
∑ª¡
 = 0;

434 
p
->
«me
[0] = 0;

435 
p
->
kûÀd
 = 0;

438 
p
->
tick_u£d
 = 0;

439 
p
->
time_qu™tum_u£d
= 0;

440 
p
->
Àvñ_of_MLFQ
 = 0;

441 
p
->
˝u_sh¨e
 = 0;

442 
p
->
°ride
 = 0;

443 
p
->
°ride_cou¡
= 0;

445 i‡(
p
->
pgdú_cou¡_idx
 !-1 && 
pgdú_cou¡
[p->pgdir_count_idx] != 0) {

446 
	`acquúe
(&
thªad_lock
);

447 
pgdú_cou¡
[
p
->
pgdú_cou¡_idx
]--;

448 
	`ªÀa£
(&
thªad_lock
);

451 
p
->
tid
 = 0;

452 
p
->
thªad_cou¡
 = 0;

453 
p
->
pgdú_cou¡_idx
 = -1;

455 
p
->
°©e
 = 
UNUSED
;

456 
	`ªÀa£
(&
±abÀ
.
lock
);

457  
pid
;

462 if(!
havekids
 || 
¥oc
->
kûÀd
){

463 
	`ªÀa£
(&
±abÀ
.
lock
);

468 
	`¶ìp
(
¥oc
, &
±abÀ
.
lock
);

470 
	}
}

472 
	$°ride_queue_hópify_up
(
°ride_idx
)

474 
¥oc
* 
èrgë_¥oc
 = 
±abÀ
.
°ride_queue
[
°ride_idx
];

475 
°ride_idx
 != 1){

477 if(
±abÀ
.
°ride_queue
[
°ride_idx
] <Ötable.stride_queue[stride_idx / 2]){

478 
±abÀ
.
°ride_queue
[
°ride_idx
] =Ötable.stride_queue[stride_idx / 2];

479 
°ride_idx
 /= 2;

487 
±abÀ
.
°ride_queue
[
°ride_idx
] = 
èrgë_¥oc
;

489 
	}
}

492 
	$°ride_queue_hópify_down
(
°ride_idx
)

494 
¥oc
* 
p
 = 
±abÀ
.
°ride_queue
[
°ride_idx
];

496 
°ride_idx
 * 2 < 
NPROC


497 && 
°ride_idx
 <
±abÀ
.
°ride_queue_size
){

498 if(
±abÀ
.
°ride_queue
[
°ride_idx
 * 2]

499 && 
±abÀ
.
°ride_queue
[
°ride_idx
 * 2 + 1]){

503 
°ride_idx
 = 
±abÀ
.
°ride_queue
[°ride_idx * 2]->
°ride_cou¡


504 < 
±abÀ
.
°ride_queue
[
°ride_idx
 * 2 + 1]->
°ride_cou¡


505 ? 
°ride_idx
 * 2 : stride_idx * 2 + 1;

508 if(
±abÀ
.
°ride_queue
[
°ride_idx
]->
°ride_cou¡
 < 
p
->stride_count){

509 
±abÀ
.
°ride_queue
[
°ride_idx
 / 2] =Ötable.stride_queue[stride_idx];

511 
°ride_idx
 /= 2;

516 }if(
±abÀ
.
°ride_queue
[
°ride_idx
 * 2]){

518 
°ride_idx
 *= 2;

520 if(
±abÀ
.
°ride_queue
[
°ride_idx
]->
°ride_cou¡
 < 
p
->stride_count){

521 
±abÀ
.
°ride_queue
[
°ride_idx
 / 2] =Ötable.stride_queue[stride_idx];

523 
°ride_idx
 /= 2;

534 
±abÀ
.
°ride_queue
[
°ride_idx
] = 
p
;

536 
	}
}

539 
	$föd_idx_of_°ride_to_run
()

541 
¥oc
* 
¥oc_to_be_run
;

542 
i
;

545 
°ride_föd_idx
 = 1;

546 
°ride_föd_idx
 <
±abÀ
.
°ride_queue_size
){

547 if(
±abÀ
.
°ride_queue
[
°ride_föd_idx
]->
°©e
 =
RUNNABLE
){

550 
¥oc_to_be_run
 = 
±abÀ
.
°ride_queue
[
°ride_föd_idx
];

551 
¥oc_to_be_run
->
°ride_cou¡
 +¥oc_to_be_run->
°ride
;

552 
	`°ride_queue_hópify_down
(
°ride_föd_idx
);

559 
À·_chûd
 = 
°ride_föd_idx
 * 2;

560 
right_chûd
 = 
°ride_föd_idx
 * 2 + 1;

561 íum {
NO_CHILD
, 
LEFT_ONLY
, 
BOTH
} 
chûd_°©us
;

563 if(
right_chûd
 <
±abÀ
.
°ride_queue_size
){

564 
chûd_°©us
 = 
BOTH
;

565 }if(
À·_chûd
 > 
±abÀ
.
°ride_queue_size
){

566 
chûd_°©us
 = 
NO_CHILD
;

568 
chûd_°©us
 = 
LEFT_ONLY
;

572 
chûd_°©us
){

573 
BOTH
:

575 if(
±abÀ
.
°ride_queue
[
À·_chûd
]->
°ride_cou¡


576 < 
±abÀ
.
°ride_queue
[
right_chûd
]->
°ride_cou¡
){

578 
°ride_föd_idx
 = 
À·_chûd
;

581 
°ride_föd_idx
 = 
right_chûd
;

585 
LEFT_ONLY
:

587 
°ride_föd_idx
 = 
À·_chûd
;

590 
NO_CHILD
:

593 
°ride_föd_idx
 = 
±abÀ
.
°ride_queue_size
 + 1;

596 
	`∑nic
("error in find_idx_of_stride_to_run().");

603 if(
°ride_föd_idx
 >
±abÀ
.
°ride_queue_size
 + 1){

604 
i
 = 1; i <
±abÀ
.
°ride_queue_size
; ++i){

605 if(
±abÀ
.
°ride_queue
[
i
]->
°©e
 =
RUNNABLE
){

606 
°ride_föd_idx
 = 
i
;

616  
°ride_föd_idx
;

617 
	}
}

620 
	$£À˘_°ride_‹_MLFQ
()

622 
ønd°©e
 = 1;

623 
queue_£À˘‹
;

624 
ønd°©e
 =Ñandstate * 1664525 + 1013904223;

625 
queue_£À˘‹
 = 
ønd°©e
 % 100;

627 if(
queue_£À˘‹
 < 
±abÀ
.
sum_˝u_sh¨e
){

634 
	}
}

645 
	$scheduÀr
()

647 
¥oc
 *
p
;

650 
choosög_°ride_‹_MLFQ
;

651 
°ride_is_£À˘ed
 = 0;

655 
	`°i
();

658 
	`acquúe
(&
±abÀ
.
lock
);

661 
choosög_°ride_‹_MLFQ
 = 1;

664 
±abÀ
.
queue_Àvñ_©_mo°
 = 
NMLFQ
 - 1;

665 
±abÀ
.
queue_Àvñ_©_mo°
 < 
NMLFQ
){

668 
±abÀ
.
mö_of_run_¥oc_Àvñ
 = 
NMLFQ
 - 1;

670 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

672 if(
±abÀ
.
sum_˝u_sh¨e
 == 0){

674 
°ride_is_£À˘ed
 = 0;

675 
choosög_°ride_‹_MLFQ
 = 0;

676 }if(
choosög_°ride_‹_MLFQ
){

679 
°ride_is_£À˘ed
 = 
	`£À˘_°ride_‹_MLFQ
();

686 if(
°ride_is_£À˘ed
){

689 
°ride_idx_to_be_run
;

691 
°ride_idx_to_be_run
 = 
	`föd_idx_of_°ride_to_run
();

694 if(
°ride_idx_to_be_run
 <
±abÀ
.
°ride_queue_size
){

696 
p
 = 
±abÀ
.
°ride_queue
[
°ride_idx_to_be_run
];

699 
°ride_is_£À˘ed
 = 0;

700 
choosög_°ride_‹_MLFQ
 = 0;

709 if(
p
->
°©e
 =
RUNNABLE


710 && 
p
->
˝u_sh¨e
 == 0

711 && 
p
->
Àvñ_of_MLFQ
 <
±abÀ
.
queue_Àvñ_©_mo°
){

714 
±abÀ
.
queue_Àvñ_©_mo°
 = 
p
->
Àvñ_of_MLFQ
 <Ötable.queue_level_at_most ?Ö->level_of_MLFQ :Ötable.queue_level_at_most;

715 
±abÀ
.
mö_of_run_¥oc_Àvñ
 =ÖèbÀ.
queue_Àvñ_©_mo°
;

719 
choosög_°ride_‹_MLFQ
 = 0;

727 
¥oc
* 
p_mlfq
 = 
p
;

730 
bef‹e_MLFQ_u£d_tick
;

736 #ifde‡
STRIDE_DEBUGGING


738 
	`˝rötf
("ContChange. ");

739 
	`˝rötf
("°ride_is_£À˘ed:%d, ", 
°ride_is_£À˘ed
);

740 
	`˝rötf
("¥oc_«me:%s, ", 
p
->
«me
);

741 
	`˝rötf
("¥oc_id:%d, ", 
p
->
pid
);

742 
	`˝rötf
("thªad_id:%d, ", 
p
->
tid
);

743 
	`˝rötf
("MLFQ_tick:%d, ", 
±abÀ
.
MLFQ_tick_u£d
,
p
->
Àvñ_of_MLFQ
);

744 
	`˝rötf
("Àvñ:%d, ", 
p
->
Àvñ_of_MLFQ
);

745 
	`˝rötf
("°ride_tick:%d, ", 
±abÀ
.
°ride_tick_u£d
);

746 
	`˝rötf
("˝u_sh¨e:%d, ", 
p
->
˝u_sh¨e
);

747 
	`˝rötf
("sum_˝u_sh¨e: %d, ", 
±abÀ
.
sum_˝u_sh¨e
);

748 
	`˝rötf
("°ride:%d, ", 
p
->
°ride
);

749 
	`˝rötf
("°ride_cou¡:%d\n", 
p
->
°ride_cou¡
);

752 
¥oc
 = 
p
;

753 
	`swôchuvm
(
p
);

754 
p
->
°©e
 = 
RUNNING
;

758 
bef‹e_MLFQ_u£d_tick
 = 
±abÀ
.
MLFQ_tick_u£d
;

760 
	`swtch
(&
˝u
->
scheduÀr
, 
p
->
c⁄ãxt
);

761 
	`swôchkvm
();

770 if(
°ride_is_£À˘ed
 == 0

771 && 
±abÀ
.
sum_˝u_sh¨e
 != 0

772 && 
p
->
°©e
 =
RUNNABLE


773 && 
p
->
˝u_sh¨e
 == 0

774 && 
±abÀ
.
MLFQ_tick_u£d
 =
bef‹e_MLFQ_u£d_tick
)

781 
choosög_°ride_‹_MLFQ
 = 0;

785 
p
--;

787 
choosög_°ride_‹_MLFQ
 = 1;

791 i‡(
¥oc
->
tid
 &&Öroc->
°©e
 =
ZOMBIE
) {

792 
	`k‰ì
(
¥oc
->
k°ack
);

793 
¥oc
->
k°ack
 = 0;

795 
¥oc
->
pid
 = 0;

796 
¥oc
->
∑ª¡
 = 0;

797 
¥oc
->
«me
[0] = 0;

798 
¥oc
->
kûÀd
 = 0;

801 
¥oc
->
tick_u£d
 = 0;

802 
¥oc
->
time_qu™tum_u£d
= 0;

803 
¥oc
->
Àvñ_of_MLFQ
 = 0;

804 
¥oc
->
˝u_sh¨e
 = 0;

805 
¥oc
->
°ride
 = 0;

806 
¥oc
->
°ride_cou¡
= 0;

808 i‡(
¥oc
->
pgdú_cou¡_idx
 !-1 && 
pgdú_cou¡
[proc->pgdir_count_idx] != 0) {

809 
	`acquúe
(&
thªad_lock
);

810 
pgdú_cou¡
[
¥oc
->
pgdú_cou¡_idx
]--;

811 
	`ªÀa£
(&
thªad_lock
);

814 
¥oc
->
tid
 = 0;

815 
¥oc
->
thªad_cou¡
 = 0;

816 
¥oc
->
pgdú_cou¡_idx
 = -1;

818 
¥oc
->
°©e
 = 
UNUSED
;

820 
¥oc
 = 0;

822 if(
°ride_is_£À˘ed
){

825 
p
 = 
p_mlfq
;

826 
p
--;

830 if(
±abÀ
.
mö_of_run_¥oc_Àvñ
 =
NMLFQ
 - 1) {

833 
±abÀ
.
queue_Àvñ_©_mo°
++;

838 
	`ªÀa£
(&
±abÀ
.
lock
);

840 
	}
}

850 
	$sched
()

852 
öã«
;

854 if(!
	`hﬁdög
(&
±abÀ
.
lock
))

855 
	`∑nic
("schedÖtable.lock");

856 if(
˝u
->
n˛i
 != 1)

857 
	`∑nic
("schedÜocks");

858 if(
¥oc
->
°©e
 =
RUNNING
)

859 
	`∑nic
("schedÑunning");

860 if(
	`ªadeÊags
()&
FL_IF
)

861 
	`∑nic
("sched interruptible");

863 
öã«
 = 
˝u
->intena;

864 
	`swtch
(&
¥oc
->
c⁄ãxt
, 
˝u
->
scheduÀr
);

868 if(
¥oc
){

869 
¥oc
->
time_qu™tum_u£d
 = 0;

872 
˝u
->
öã«
 = intena;

873 
	}
}

877 
	$yõld
()

879 
	`acquúe
(&
±abÀ
.
lock
);

880 
¥oc
->
°©e
 = 
RUNNABLE
;

881 
	`sched
();

882 
	`ªÀa£
(&
±abÀ
.
lock
);

883 
	}
}

886 
	$sys_yõld
(){

887 
	`yõld
();

889 
	}
}

894 
	$f‹kªt
()

896 
fú°
 = 1;

898 
	`ªÀa£
(&
±abÀ
.
lock
);

900 if(
fú°
){

904 
fú°
 = 0;

905 
	`iöô
(
ROOTDEV
);

906 
	`öôlog
(
ROOTDEV
);

910 
	}
}

915 
	$¶ìp
(*
ch™
, 
•ölock
 *
lk
)

917 if(
¥oc
 == 0)

918 
	`∑nic
("sleep");

920 if(
lk
 == 0)

921 
	`∑nic
("sleep withoutÜk");

929 if(
lk
 !&
±abÀ
.
lock
){

930 
	`acquúe
(&
±abÀ
.
lock
);

931 
	`ªÀa£
(
lk
);

935 
¥oc
->
ch™
 = chan;

936 
¥oc
->
°©e
 = 
SLEEPING
;

937 
	`sched
();

940 
¥oc
->
ch™
 = 0;

943 if(
lk
 !&
±abÀ
.
lock
){

944 
	`ªÀa£
(&
±abÀ
.
lock
);

945 
	`acquúe
(
lk
);

947 
	}
}

953 
	$wakeup1
(*
ch™
)

955 
¥oc
 *
p
;

957 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++)

958 if(
p
->
°©e
 =
SLEEPING
 &&Ö->
ch™
 == chan)

959 
p
->
°©e
 = 
RUNNABLE
;

960 
	}
}

964 
	$wakeup
(*
ch™
)

966 
	`acquúe
(&
±abÀ
.
lock
);

967 
	`wakeup1
(
ch™
);

968 
	`ªÀa£
(&
±abÀ
.
lock
);

969 
	}
}

975 
	$kûl
(
pid
)

977 
¥oc
 *
p
;

979 
	`acquúe
(&
±abÀ
.
lock
);

980 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

981 if(
p
->
pid
 ==Öid){

982 
p
->
kûÀd
 = 1;

984 if(
p
->
°©e
 =
SLEEPING
)

985 
p
->
°©e
 = 
RUNNABLE
;

986 
	`ªÀa£
(&
±abÀ
.
lock
);

990 
	`ªÀa£
(&
±abÀ
.
lock
);

992 
	}
}

999 
	$¥ocdump
()

1001 *
°©es
[] = {

1002 [
UNUSED
] "unused",

1003 [
EMBRYO
] "embryo",

1004 [
SLEEPING
] "sleep ",

1005 [
RUNNABLE
] "runble",

1006 [
RUNNING
] "run ",

1007 [
ZOMBIE
] "zombie"

1009 
i
;

1010 
¥oc
 *
p
;

1011 *
°©e
;

1012 
uöt
 
pc
[10];

1014 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

1015 if(
p
->
°©e
 =
UNUSED
)

1017 if(
p
->
°©e
 >0 &&Ö->°©ê< 
	`NELEM
(
°©es
) && states[p->state])

1018 
°©e
 = 
°©es
[
p
->state];

1020 
°©e
 = "???";

1021 
	`˝rötf
("%d %†%s", 
p
->
pid
, 
°©e
,Ö->
«me
);

1022 if(
p
->
°©e
 =
SLEEPING
){

1023 
	`gëˇŒîpcs
((
uöt
*)
p
->
c⁄ãxt
->
ebp
+2, 
pc
);

1024 
i
=0; i<10 && 
pc
[i] != 0; i++)

1025 
	`˝rötf
(" %p", 
pc
[
i
]);

1027 
	`˝rötf
("\n");

1029 
	}
}

1033 
	$¥i‹ôy_boo°
(){

1034 
¥oc
 *
p
;

1036 
	`˝rötf
("[do boosting!]\n");

1038 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

1039 
p
->
Àvñ_of_MLFQ
 = 0;

1040 
p
->
tick_u£d
 = 0;

1043 
p
->
time_qu™tum_u£d
 = 0;

1046 
±abÀ
.
MLFQ_tick_u£d
 = 0;

1048 
	}
}

1052 
	$£t_˝u_sh¨e
(
ªquúed
)

1054 
˝u_sh¨e_Æªady_£t
;

1055 
desúed_sum_˝u_sh¨e
;

1056 c⁄° 
MIN_CPU_SHARE
 = 1;

1057 c⁄° 
MAX_CPU_SHARE
 = 80;

1058 
is_√w
;

1059 
idx
;

1062 if–! (
MIN_CPU_SHARE
 <
ªquúed
 &&Ñequúed <
MAX_CPU_SHARE
) )

1063 
ex˚±i⁄
;

1066 
˝u_sh¨e_Æªady_£t
 = 
¥oc
->
˝u_sh¨e
;

1067 if(
˝u_sh¨e_Æªady_£t
 == 0){

1068 
is_√w
 = 1;

1070 
is_√w
 = 0;

1073 
desúed_sum_˝u_sh¨e
 = 
±abÀ
.
sum_˝u_sh¨e
 - 
˝u_sh¨e_Æªady_£t
 + 
ªquúed
;

1075 if(
desúed_sum_˝u_sh¨e
 > 
MAX_CPU_SHARE
 )

1076 
ex˚±i⁄
;

1079 
±abÀ
.
sum_˝u_sh¨e
 = 
desúed_sum_˝u_sh¨e
;

1080 
¥oc
->
˝u_sh¨e
 = 
ªquúed
;

1081 
¥oc
->
°ride
 = 
NSTRIDE
 / 
ªquúed
;

1083 if(
is_√w
){

1088 if(
±abÀ
.
°ride_queue
[1]){

1089 
¥oc
->
°ride_cou¡
 = 
±abÀ
.
°ride_queue
[1]->stride_count;

1093 
idx
 = ++
±abÀ
.
°ride_queue_size
;

1094 
idx
 != 1){

1095 
±abÀ
.
°ride_queue
[
idx
] =Ötable.stride_queue[idx/2];

1096 
idx
 /= 2;

1098 
±abÀ
.
°ride_queue
[
idx
] = 
¥oc
;

1105 
ex˚±i⁄
:

1107 
	}
}

1110 
	$sys_£t_˝u_sh¨e
()

1112 
ªquúed
;

1115 if(
	`¨göt
(0, &
ªquúed
) < 0){

1119  
	`£t_˝u_sh¨e
(
ªquúed
);

1120 
	}
}

1123 
thªad_¸óã
(
thªad_t
 * 
thªad
, * (*
°¨t_routöe
)(*), *
¨g
)

1125 
	gi
, 
	gpid
;

1126 
¥oc
 *
	g≈
;

1127 ** 
	g¨g_±r
;

1128 
	gsz
;

1130 
	gpid
 = 0;

1131 
	gpid
++;

1136 if((
	g≈
 = 
Ælo˝roc
()) == 0){

1141 
	g≈
->
	gpgdú
 = 
¥oc
->
pgdú
;

1142 
	g≈
->
	gpgdú_cou¡_idx
 = 
¥oc
->
pgdú_cou¡_idx
;

1143 
acquúe
(&
thªad_lock
);

1144 
	gpgdú_cou¡
[
≈
->
pgdú_cou¡_idx
]++;

1145 
ªÀa£
(&
thªad_lock
);

1148 
	g≈
->
	gsz
 = 
¥oc
->
sz
;

1149 
	g≈
->
	g∑ª¡
 = 
¥oc
;

1150 *
	g≈
->
	gtf
 = *
¥oc
->
tf
;

1151 
	g≈
->
	gtf
->
	geù
 = (
uöt
)
°¨t_routöe
;

1154 #ifde‡
THREAD_DEBUGGING


1155 
˝rötf
("k°ackádr: %x\n", 
≈
->
k°ack
);

1162 
	gsz
 = 
≈
->
sz
;

1163 
	gsz
 = 
PGROUNDUP
(
sz
);

1164 if((
	gsz
 = 
Ælocuvm
(
≈
->
pgdú
, 
sz
, sz + 2*
PGSIZE
)) == 0) {

1167 
˛óΩãu
(
≈
->
pgdú
, (*)(
sz
 - 2*
PGSIZE
));

1170 
	g≈
->
	gsz
 = 
sz
;

1171 
acquúe
(&
thªad_lock
);

1172 
	g¥oc
->
	gsz
 = 
sz
;

1173 
ªÀa£
(&
thªad_lock
);

1180 
	g≈
->
	gtf
->
	ge•
 = 
sz
 - 8;

1182 
	g¨g_±r
 = (**)(
≈
->
tf
->
e•
);

1183 *
	g¨g_±r
 = (*)0xFFFFFFFF;

1185 
	g¨g_±r
 = (**)(
≈
->
tf
->
e•
 + 4);

1186 *
	g¨g_±r
 = 
¨g
;

1190 
	g≈
->
	gtf
->
	góx
 = 0;

1192 
	gi
 = 0; i < 
	gNOFILE
; i++)

1193 if(
	g¥oc
->
	gofûe
[
i
])

1194 
	g≈
->
	gofûe
[
i
] = 
fûedup
(
¥oc
->
ofûe
[i]);

1195 
	g≈
->
	gcwd
 = 
idup
(
¥oc
->
cwd
);

1197 
ß„°r˝y
(
≈
->
«me
, 
¥oc
->name, (proc->name));

1199 
	g≈
->
	gpid
 = 
¥oc
->
pid
;

1200 
	gpid
 = 
≈
->
pid
;

1202 
	g≈
->
	gtid
 = 
√xt_thªad_id
++;

1203 *
	gthªad
 = 
≈
->
tid
;

1205 
acquúe
(&
±abÀ
.
lock
);

1207 
	g¥oc
->
	gthªad_cou¡
++;

1208 
	g≈
->
	g°©e
 = 
RUNNABLE
;

1212 
ªÀa£
(&
±abÀ
.
lock
);

1214 #ifde‡
THREAD_DEBUGGING


1215 
˝rötf
("pgdú_cou¡_idx: %d,Ögdú_cou¡[]: %d,Åhªad_cou¡:%d\n", 
≈
->
pgdú_cou¡_idx
, 
pgdú_cou¡
[≈->pgdú_cou¡_idx], 
¥oc
->
thªad_cou¡
);

1223 
	$sys_thªad_¸óã
()

1225 
thªad_t
 * 
thªad
;

1226 * (*
°¨t_routöe
)(*);

1227 * 
¨g
;

1229 if(
	`¨g±r
(0, (**)&
thªad
, (thread)) < 0){

1232 if(
	`¨g±r
(1, (**)&
°¨t_routöe
, (start_routine)) < 0){

1235 if(
	`¨g±r
(2, (**)&
¨g
, (arg)) < 0){

1239  
	`thªad_¸óã
(
thªad
, 
°¨t_routöe
, 
¨g
);

1240 
	}
}

1245 
	$thªad_exô
(*
ªtvÆ
)

1248 
°ride_idx
;

1250 if(
¥oc
 =
öô¥oc
)

1251 
	`∑nic
("initÅhread_exiting");

1253 
¥oc
->
cwd
 = 0;

1255 
	`acquúe
(&
±abÀ
.
lock
);

1258 if(
¥oc
->
˝u_sh¨e
 != 0){

1259 
hópify_up
;

1261 #ifde‡
MJ_DEBUGGING


1262 
	`˝rötf
("stirde_queueÖrocessÅhread_exit()\n");

1266 
±abÀ
.
sum_˝u_sh¨e
 -
¥oc
->
˝u_sh¨e
;

1269 
°ride_idx
 = 1; såide_idx < 
NSTRIDE_QUEUE
; ++stride_idx){

1270 if(
±abÀ
.
°ride_queue
[
°ride_idx
] =
¥oc
){

1275 if(
°ride_idx
 =
NSTRIDE_QUEUE
){

1276 
	`∑nic
("thread_exit():áÖrocess isÇot inÅhe stride scheduler");

1280 
±abÀ
.
°ride_queue
[
°ride_idx
] =ÖèbÀ.°ride_queue[±abÀ.
°ride_queue_size
];

1281 
±abÀ
.
°ride_queue
[±abÀ.
°ride_queue_size
--] = 0;

1284 if(
°ride_idx
 == 1){

1286 
hópify_up
 = 0;

1289 
hópify_up
 = 
±abÀ
.
°ride_queue
[
°ride_idx
]->
°ride_cou¡


1290 < 
±abÀ
.
°ride_queue
[
°ride_idx
 / 2]->
°ride_cou¡


1294 if(
±abÀ
.
°ride_queue_size
 == 0 ||Ötable.stride_queue_size == 1){

1298 if(
hópify_up
){

1299 
	`°ride_queue_hópify_down
(
°ride_idx
);

1301 
	`°ride_queue_hópify_up
(
°ride_idx
);

1307 
	`wakeup1
(
¥oc
->
∑ª¡
);

1320 
¥oc
->
°©e
 = 
ZOMBIE
;

1325 
¥oc
->
thªad_ªtu∫
 = ()
ªtvÆ
;

1327 
	`sched
();

1328 
	`∑nic
("zombieÉxit");

1329 
	}
}

1332 
	$sys_thªad_exô
()

1334 *
ªtvÆ
;

1335 if(
	`¨g±r
(0, (**)&
ªtvÆ
, (retval)) < 0){

1339 
	`thªad_exô
(
ªtvÆ
);

1341 
	}
}

1344 
	$thªad_joö
(
thªad_t
 
thªad
, **
ªtvÆ
)

1346 
⁄e_is_îr‹
 = 1;

1347 
¥oc
 *
p
;

1348 
¥oc
 *
¥oc_found
;

1349 
¥oc_found
 = 0;

1351 #ifde‡
THREAD_DEBUGGING


1352 
	`˝rötf
("—hªad_joöÈid:%d\n", 
thªad
);

1355 
p
 = 
±abÀ
.
¥oc
;Ö < &±abÀ.¥oc[
NPROC
];Ö++){

1356 i‡(
p
->
tid
 =
thªad
) {

1357 
¥oc_found
 = 
p
;

1358 
⁄e_is_îr‹
 = 0;

1359 
p
 = 
±abÀ
.
¥oc
;

1360 
p
--;

1365 i‡(
⁄e_is_îr‹
 == 0) {

1366 #ifde‡
THREAD_DEBUGGING


1367 
	`˝rötf
("pid:%d,Åid:%d,Åhªad_addªss:%p,Åhªad_ªtu∫:%d\n",
¥oc_found
->
pid
,Öroc_found->
tid
,Öroc_found,Öroc_found->
thªad_ªtu∫
);

1370 *
ªtvÆ
 = (*)
¥oc_found
->
thªad_ªtu∫
;

1371 
¥oc_found
->
thªad_ªtu∫
 = 0;

1373 *
ªtvÆ
 = (*)-1;

1376  
⁄e_is_îr‹
;

1377 
	}
}

1380 
	$sys_thªad_joö
()

1382 
thªad_t
 
thªad
;

1383 **
ªtvÆ
;

1385 if(
	`¨göt
(0, (*)&
thªad
) < 0){

1388 if(
	`¨g±r
(1, (**)&
ªtvÆ
, (retval)) < 0){

1392  
	`thªad_joö
(
thªad
, 
ªtvÆ
);

1393 
	}
}

	@rm.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

6 
	$maö
(
¨gc
, *
¨gv
[])

8 
i
;

10 if(
¨gc
 < 2){

11 
	`¥ötf
(2, "Usage:Ñm files...\n");

12 
	`exô
();

15 
i
 = 1; i < 
¨gc
; i++){

16 if(
	`u∆ök
(
¨gv
[
i
]) < 0){

17 
	`¥ötf
(2, "rm: %†ÁûedÅÿdñëe\n", 
¨gv
[
i
]);

22 
	`exô
();

23 
	}
}

	@sh.c

3 
	~"ty≥s.h
"

4 
	~"u£r.h
"

5 
	~"f˙é.h
"

8 
	#EXEC
 1

	)

9 
	#REDIR
 2

	)

10 
	#PIPE
 3

	)

11 
	#LIST
 4

	)

12 
	#BACK
 5

	)

14 
	#MAXARGS
 10

	)

16 
	scmd
 {

17 
	mty≥
;

20 
	sexeccmd
 {

21 
	mty≥
;

22 *
	m¨gv
[
MAXARGS
];

23 *
	mórgv
[
MAXARGS
];

26 
	sªdúcmd
 {

27 
	mty≥
;

28 
cmd
 *
	mcmd
;

29 *
	mfûe
;

30 *
	mefûe
;

31 
	mmode
;

32 
	mfd
;

35 
	spùecmd
 {

36 
	mty≥
;

37 
cmd
 *
	mÀ·
;

38 
cmd
 *
	mright
;

41 
	sli°cmd
 {

42 
	mty≥
;

43 
cmd
 *
	mÀ·
;

44 
cmd
 *
	mright
;

47 
	sbackcmd
 {

48 
	mty≥
;

49 
cmd
 *
	mcmd
;

52 
f‹k1
();

53 
∑nic
(*);

54 
cmd
 *
∑r£cmd
(*);

58 
	$runcmd
(
cmd
 *cmd)

60 
p
[2];

61 
backcmd
 *
bcmd
;

62 
execcmd
 *
ecmd
;

63 
li°cmd
 *
lcmd
;

64 
pùecmd
 *
pcmd
;

65 
ªdúcmd
 *
rcmd
;

67 if(
cmd
 == 0)

68 
	`exô
();

70 
cmd
->
ty≥
){

72 
	`∑nic
("runcmd");

74 
EXEC
:

75 
ecmd
 = (
execcmd
*)
cmd
;

76 if(
ecmd
->
¨gv
[0] == 0)

77 
	`exô
();

78 
	`exec
(
ecmd
->
¨gv
[0],Écmd->argv);

79 
	`¥ötf
(2, "exe¯%†Áûed\n", 
ecmd
->
¨gv
[0]);

82 
REDIR
:

83 
rcmd
 = (
ªdúcmd
*)
cmd
;

84 
	`˛o£
(
rcmd
->
fd
);

85 if(
	`›í
(
rcmd
->
fûe
,Ñcmd->
mode
) < 0){

86 
	`¥ötf
(2, "›í %†Áûed\n", 
rcmd
->
fûe
);

87 
	`exô
();

89 
	`runcmd
(
rcmd
->
cmd
);

92 
LIST
:

93 
lcmd
 = (
li°cmd
*)
cmd
;

94 if(
	`f‹k1
() == 0)

95 
	`runcmd
(
lcmd
->
À·
);

96 
	`waô
();

97 
	`runcmd
(
lcmd
->
right
);

100 
PIPE
:

101 
pcmd
 = (
pùecmd
*)
cmd
;

102 if(
	`pùe
(
p
) < 0)

103 
	`∑nic
("pipe");

104 if(
	`f‹k1
() == 0){

105 
	`˛o£
(1);

106 
	`dup
(
p
[1]);

107 
	`˛o£
(
p
[0]);

108 
	`˛o£
(
p
[1]);

109 
	`runcmd
(
pcmd
->
À·
);

111 if(
	`f‹k1
() == 0){

112 
	`˛o£
(0);

113 
	`dup
(
p
[0]);

114 
	`˛o£
(
p
[0]);

115 
	`˛o£
(
p
[1]);

116 
	`runcmd
(
pcmd
->
right
);

118 
	`˛o£
(
p
[0]);

119 
	`˛o£
(
p
[1]);

120 
	`waô
();

121 
	`waô
();

124 
BACK
:

125 
bcmd
 = (
backcmd
*)
cmd
;

126 if(
	`f‹k1
() == 0)

127 
	`runcmd
(
bcmd
->
cmd
);

130 
	`exô
();

131 
	}
}

134 
	$gëcmd
(*
buf
, 
nbuf
)

136 
	`¥ötf
(2, "$ ");

137 
	`mem£t
(
buf
, 0, 
nbuf
);

138 
	`gës
(
buf
, 
nbuf
);

139 if(
buf
[0] == 0)

142 
	}
}

145 
	$maö
()

147 
buf
[100];

148 
fd
;

151 (
fd
 = 
	`›í
("c⁄sﬁe", 
O_RDWR
)) >= 0){

152 if(
fd
 >= 3){

153 
	`˛o£
(
fd
);

159 
	`gëcmd
(
buf
, (buf)) >= 0){

160 if(
buf
[0] == 'c' && buf[1] == 'd' && buf[2] == ' '){

162 
buf
[
	`°æí
(buf)-1] = 0;

163 if(
	`chdú
(
buf
+3) < 0)

164 
	`¥ötf
(2, "ˇ¬Ÿ cd %s\n", 
buf
+3);

167 if(
	`f‹k1
() == 0)

168 
	`runcmd
(
	`∑r£cmd
(
buf
));

169 
	`waô
();

171 
	`exô
();

172 
	}
}

175 
	$∑nic
(*
s
)

177 
	`¥ötf
(2, "%s\n", 
s
);

178 
	`exô
();

179 
	}
}

182 
	$f‹k1
()

184 
pid
;

186 
pid
 = 
	`f‹k
();

187 if(
pid
 == -1)

188 
	`∑nic
("fork");

189  
pid
;

190 
	}
}

195 
cmd
*

196 
	$execcmd
()

198 
execcmd
 *
cmd
;

200 
cmd
 = 
	`mÆloc
((*cmd));

201 
	`mem£t
(
cmd
, 0, (*cmd));

202 
cmd
->
ty≥
 = 
EXEC
;

203  (
cmd
*)cmd;

204 
	}
}

206 
cmd
*

207 
	$ªdúcmd
(
cmd
 *
subcmd
, *
fûe
, *
efûe
, 
mode
, 
fd
)

209 
ªdúcmd
 *
cmd
;

211 
cmd
 = 
	`mÆloc
((*cmd));

212 
	`mem£t
(
cmd
, 0, (*cmd));

213 
cmd
->
ty≥
 = 
REDIR
;

214 
cmd
->cmd = 
subcmd
;

215 
cmd
->
fûe
 = file;

216 
cmd
->
efûe
 =Éfile;

217 
cmd
->
mode
 = mode;

218 
cmd
->
fd
 = fd;

219  (
cmd
*)cmd;

220 
	}
}

222 
cmd
*

223 
	$pùecmd
(
cmd
 *
À·
, cmd *
right
)

225 
pùecmd
 *
cmd
;

227 
cmd
 = 
	`mÆloc
((*cmd));

228 
	`mem£t
(
cmd
, 0, (*cmd));

229 
cmd
->
ty≥
 = 
PIPE
;

230 
cmd
->
À·
 =Üeft;

231 
cmd
->
right
 =Ñight;

232  (
cmd
*)cmd;

233 
	}
}

235 
cmd
*

236 
	$li°cmd
(
cmd
 *
À·
, cmd *
right
)

238 
li°cmd
 *
cmd
;

240 
cmd
 = 
	`mÆloc
((*cmd));

241 
	`mem£t
(
cmd
, 0, (*cmd));

242 
cmd
->
ty≥
 = 
LIST
;

243 
cmd
->
À·
 =Üeft;

244 
cmd
->
right
 =Ñight;

245  (
cmd
*)cmd;

246 
	}
}

248 
cmd
*

249 
	$backcmd
(
cmd
 *
subcmd
)

251 
backcmd
 *
cmd
;

253 
cmd
 = 
	`mÆloc
((*cmd));

254 
	`mem£t
(
cmd
, 0, (*cmd));

255 
cmd
->
ty≥
 = 
BACK
;

256 
cmd
->cmd = 
subcmd
;

257  (
cmd
*)cmd;

258 
	}
}

262 
	gwhôe•a˚
[] = " \t\r\n\v";

263 
	gsymbﬁs
[] = "<|>&;()";

266 
	$gëtokí
(**
ps
, *
es
, **
q
, **
eq
)

268 *
s
;

269 
ªt
;

271 
s
 = *
ps
;

272 
s
 < 
es
 && 
	`°rchr
(
whôe•a˚
, *s))

273 
s
++;

274 if(
q
)

275 *
q
 = 
s
;

276 
ªt
 = *
s
;

277 *
s
){

286 
s
++;

289 
s
++;

290 if(*
s
 == '>'){

291 
ªt
 = '+';

292 
s
++;

296 
ªt
 = 'a';

297 
s
 < 
es
 && !
	`°rchr
(
whôe•a˚
, *sË&& !°rchr(
symbﬁs
, *s))

298 
s
++;

301 if(
eq
)

302 *
eq
 = 
s
;

304 
s
 < 
es
 && 
	`°rchr
(
whôe•a˚
, *s))

305 
s
++;

306 *
ps
 = 
s
;

307  
ªt
;

308 
	}
}

311 
	$≥ek
(**
ps
, *
es
, *
toks
)

313 *
s
;

315 
s
 = *
ps
;

316 
s
 < 
es
 && 
	`°rchr
(
whôe•a˚
, *s))

317 
s
++;

318 *
ps
 = 
s
;

319  *
s
 && 
	`°rchr
(
toks
, *s);

320 
	}
}

322 
cmd
 *
∑r£löe
(**, *);

323 
cmd
 *
∑r£pùe
(**, *);

324 
cmd
 *
∑r£exec
(**, *);

325 
cmd
 *
nu…îmö©e
(cmd*);

327 
cmd
*

328 
	$∑r£cmd
(*
s
)

330 *
es
;

331 
cmd
 *cmd;

333 
es
 = 
s
 + 
	`°æí
(s);

334 
cmd
 = 
	`∑r£löe
(&
s
, 
es
);

335 
	`≥ek
(&
s
, 
es
, "");

336 if(
s
 !
es
){

337 
	`¥ötf
(2, "À·ovîs: %s\n", 
s
);

338 
	`∑nic
("syntax");

340 
	`nu…îmö©e
(
cmd
);

341  
cmd
;

342 
	}
}

344 
cmd
*

345 
	$∑r£löe
(**
ps
, *
es
)

347 
cmd
 *cmd;

349 
cmd
 = 
	`∑r£pùe
(
ps
, 
es
);

350 
	`≥ek
(
ps
, 
es
, "&")){

351 
	`gëtokí
(
ps
, 
es
, 0, 0);

352 
cmd
 = 
	`backcmd
(cmd);

354 if(
	`≥ek
(
ps
, 
es
, ";")){

355 
	`gëtokí
(
ps
, 
es
, 0, 0);

356 
cmd
 = 
	`li°cmd
(cmd, 
	`∑r£löe
(
ps
, 
es
));

358  
cmd
;

359 
	}
}

361 
cmd
*

362 
	$∑r£pùe
(**
ps
, *
es
)

364 
cmd
 *cmd;

366 
cmd
 = 
	`∑r£exec
(
ps
, 
es
);

367 if(
	`≥ek
(
ps
, 
es
, "|")){

368 
	`gëtokí
(
ps
, 
es
, 0, 0);

369 
cmd
 = 
	`pùecmd
(cmd, 
	`∑r£pùe
(
ps
, 
es
));

371  
cmd
;

372 
	}
}

374 
cmd
*

375 
	$∑r£ªdús
(
cmd
 *cmd, **
ps
, *
es
)

377 
tok
;

378 *
q
, *
eq
;

380 
	`≥ek
(
ps
, 
es
, "<>")){

381 
tok
 = 
	`gëtokí
(
ps
, 
es
, 0, 0);

382 if(
	`gëtokí
(
ps
, 
es
, &
q
, &
eq
) != 'a')

383 
	`∑nic
("missing file forÑedirection");

384 
tok
){

386 
cmd
 = 
	`ªdúcmd
(cmd, 
q
, 
eq
, 
O_RDONLY
, 0);

389 
cmd
 = 
	`ªdúcmd
(cmd, 
q
, 
eq
, 
O_WRONLY
|
O_CREATE
, 1);

392 
cmd
 = 
	`ªdúcmd
(cmd, 
q
, 
eq
, 
O_WRONLY
|
O_CREATE
, 1);

396  
cmd
;

397 
	}
}

399 
cmd
*

400 
	$∑r£block
(**
ps
, *
es
)

402 
cmd
 *cmd;

404 if(!
	`≥ek
(
ps
, 
es
, "("))

405 
	`∑nic
("parseblock");

406 
	`gëtokí
(
ps
, 
es
, 0, 0);

407 
cmd
 = 
	`∑r£löe
(
ps
, 
es
);

408 if(!
	`≥ek
(
ps
, 
es
, ")"))

409 
	`∑nic
("syntax - missing )");

410 
	`gëtokí
(
ps
, 
es
, 0, 0);

411 
cmd
 = 
	`∑r£ªdús
(cmd, 
ps
, 
es
);

412  
cmd
;

413 
	}
}

415 
cmd
*

416 
	$∑r£exec
(**
ps
, *
es
)

418 *
q
, *
eq
;

419 
tok
, 
¨gc
;

420 
execcmd
 *
cmd
;

421 
cmd
 *
ªt
;

423 if(
	`≥ek
(
ps
, 
es
, "("))

424  
	`∑r£block
(
ps
, 
es
);

426 
ªt
 = 
	`execcmd
();

427 
cmd
 = (
execcmd
*)
ªt
;

429 
¨gc
 = 0;

430 
ªt
 = 
	`∑r£ªdús
‘ë, 
ps
, 
es
);

431 !
	`≥ek
(
ps
, 
es
, "|)&;")){

432 if((
tok
=
	`gëtokí
(
ps
, 
es
, &
q
, &
eq
)) == 0)

434 if(
tok
 != 'a')

435 
	`∑nic
("syntax");

436 
cmd
->
¨gv
[
¨gc
] = 
q
;

437 
cmd
->
órgv
[
¨gc
] = 
eq
;

438 
¨gc
++;

439 if(
¨gc
 >
MAXARGS
)

440 
	`∑nic
("too manyárgs");

441 
ªt
 = 
	`∑r£ªdús
‘ë, 
ps
, 
es
);

443 
cmd
->
¨gv
[
¨gc
] = 0;

444 
cmd
->
órgv
[
¨gc
] = 0;

445  
ªt
;

446 
	}
}

449 
cmd
*

450 
	$nu…îmö©e
(
cmd
 *cmd)

452 
i
;

453 
backcmd
 *
bcmd
;

454 
execcmd
 *
ecmd
;

455 
li°cmd
 *
lcmd
;

456 
pùecmd
 *
pcmd
;

457 
ªdúcmd
 *
rcmd
;

459 if(
cmd
 == 0)

462 
cmd
->
ty≥
){

463 
EXEC
:

464 
ecmd
 = (
execcmd
*)
cmd
;

465 
i
=0; 
ecmd
->
¨gv
[i]; i++)

466 *
ecmd
->
órgv
[
i
] = 0;

469 
REDIR
:

470 
rcmd
 = (
ªdúcmd
*)
cmd
;

471 
	`nu…îmö©e
(
rcmd
->
cmd
);

472 *
rcmd
->
efûe
 = 0;

475 
PIPE
:

476 
pcmd
 = (
pùecmd
*)
cmd
;

477 
	`nu…îmö©e
(
pcmd
->
À·
);

478 
	`nu…îmö©e
(
pcmd
->
right
);

481 
LIST
:

482 
lcmd
 = (
li°cmd
*)
cmd
;

483 
	`nu…îmö©e
(
lcmd
->
À·
);

484 
	`nu…îmö©e
(
lcmd
->
right
);

487 
BACK
:

488 
bcmd
 = (
backcmd
*)
cmd
;

489 
	`nu…îmö©e
(
bcmd
->
cmd
);

492  
cmd
;

493 
	}
}

	@sleeplock.c

3 
	~"ty≥s.h
"

4 
	~"defs.h
"

5 
	~"∑øm.h
"

6 
	~"x86.h
"

7 
	~"memœyout.h
"

8 
	~"mmu.h
"

9 
	~"¥oc.h
"

10 
	~"•ölock.h
"

11 
	~"¶ì∂ock.h
"

14 
	$öô¶ì∂ock
(
¶ì∂ock
 *
lk
, *
«me
)

16 
	`öôlock
(&
lk
->lk, "sleepÜock");

17 
lk
->
«me
 =Çame;

18 
lk
->
locked
 = 0;

19 
lk
->
pid
 = 0;

20 
	}
}

23 
	$acquúe¶ìp
(
¶ì∂ock
 *
lk
)

25 
	`acquúe
(&
lk
->lk);

26 
lk
->
locked
) {

27 
	`¶ìp
(
lk
, &lk->lk);

29 
lk
->
locked
 = 1;

30 
lk
->
pid
 = 
¥oc
->pid;

31 
	`ªÀa£
(&
lk
->lk);

32 
	}
}

35 
	$ªÀa£¶ìp
(
¶ì∂ock
 *
lk
)

37 
	`acquúe
(&
lk
->lk);

38 
lk
->
locked
 = 0;

39 
lk
->
pid
 = 0;

40 
	`wakeup
(
lk
);

41 
	`ªÀa£
(&
lk
->lk);

42 
	}
}

45 
	$hﬁdög¶ìp
(
¶ì∂ock
 *
lk
)

47 
r
;

49 
	`acquúe
(&
lk
->lk);

50 
r
 = 
lk
->
locked
;

51 
	`ªÀa£
(&
lk
->lk);

52  
r
;

53 
	}
}

	@sleeplock.h

2 
	s¶ì∂ock
 {

3 
uöt
 
	mlocked
;

4 
•ölock
 
	mlk
;

7 *
	m«me
;

8 
	mpid
;

	@spinlock.c

3 
	~"ty≥s.h
"

4 
	~"defs.h
"

5 
	~"∑øm.h
"

6 
	~"x86.h
"

7 
	~"memœyout.h
"

8 
	~"mmu.h
"

9 
	~"¥oc.h
"

10 
	~"•ölock.h
"

13 
	$öôlock
(
•ölock
 *
lk
, *
«me
)

15 
lk
->
«me
 =Çame;

16 
lk
->
locked
 = 0;

17 
lk
->
˝u
 = 0;

18 
	}
}

25 
	$acquúe
(
•ölock
 *
lk
)

27 
	`push˛i
();

28 if(
	`hﬁdög
(
lk
))

29 
	`∑nic
("acquire");

32 
	`xchg
(&
lk
->
locked
, 1) != 0)

38 
	`__sync_synchr⁄ize
();

41 
lk
->
˝u
 = cpu;

42 
	`gëˇŒîpcs
(&
lk
,Ük->
pcs
);

43 
	}
}

47 
	$ªÀa£
(
•ölock
 *
lk
)

49 if(!
	`hﬁdög
(
lk
))

50 
	`∑nic
("release");

52 
lk
->
pcs
[0] = 0;

53 
lk
->
˝u
 = 0;

60 
	`__sync_synchr⁄ize
();

65 
asm
 vﬁ©ûe("mov»$0, %0" : "+m" (
lk
->
locked
) : );

67 
	`p›˛i
();

68 
	}
}

72 
	$gëˇŒîpcs
(*
v
, 
uöt
 
pcs
[])

74 
uöt
 *
ebp
;

75 
i
;

77 
ebp
 = (
uöt
*)
v
 - 2;

78 
i
 = 0; i < 10; i++){

79 if(
ebp
 =0 ||Éb∞< (
uöt
*)
KERNBASE
 ||Ébp == (uint*)0xffffffff)

81 
pcs
[
i
] = 
ebp
[1];

82 
ebp
 = (
uöt
*)ebp[0];

84 ; 
i
 < 10; i++)

85 
pcs
[
i
] = 0;

86 
	}
}

90 
	$hﬁdög
(
•ölock
 *
lock
)

92  
lock
->
locked
 &&Üock->
˝u
 == cpu;

93 
	}
}

101 
	$push˛i
()

103 
eÊags
;

105 
eÊags
 = 
	`ªadeÊags
();

106 
	`˛i
();

107 if(
˝u
->
n˛i
 == 0)

108 
˝u
->
öã«
 = 
eÊags
 & 
FL_IF
;

109 
˝u
->
n˛i
 += 1;

110 
	}
}

113 
	$p›˛i
()

115 if(
	`ªadeÊags
()&
FL_IF
)

116 
	`∑nic
("popcli - interruptible");

117 if(--
˝u
->
n˛i
 < 0)

118 
	`∑nic
("popcli");

119 if(
˝u
->
n˛i
 =0 && cpu->
öã«
)

120 
	`°i
();

121 
	}
}

	@spinlock.h

2 
	s•ölock
 {

3 
uöt
 
	mlocked
;

6 *
	m«me
;

7 
˝u
 *
	m˝u
;

8 
uöt
 
	mpcs
[10];

	@stat.h

1 
	#T_DIR
 1

2 
	#T_FILE
 2

3 
	#T_DEV
 3

4 

	)

5 
	s°©
 {

6 
	mty≥
;

7 
	mdev
;

8 
uöt
 
	möo
;

9 
	m∆ök
;

10 
uöt
 
	msize
;

	@stressfs.c

10 
	~"ty≥s.h
"

11 
	~"°©.h
"

12 
	~"u£r.h
"

13 
	~"fs.h
"

14 
	~"f˙é.h
"

17 
	$maö
(
¨gc
, *
¨gv
[])

19 
fd
, 
i
;

20 
∑th
[] = "stressfs0";

21 
d©a
[512];

23 
	`¥ötf
(1, "stressfs starting\n");

24 
	`mem£t
(
d©a
, 'a', (data));

26 
i
 = 0; i < 4; i++)

27 if(
	`f‹k
() > 0)

30 
	`¥ötf
(1, "wrôê%d\n", 
i
);

32 
∑th
[8] +
i
;

33 
fd
 = 
	`›í
(
∑th
, 
O_CREATE
 | 
O_RDWR
);

34 
i
 = 0; i < 20; i++)

36 
	`wrôe
(
fd
, 
d©a
, (data));

37 
	`˛o£
(
fd
);

39 
	`¥ötf
(1, "read\n");

41 
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
);

42 
i
 = 0; i < 20; i++)

43 
	`ªad
(
fd
, 
d©a
, (data));

44 
	`˛o£
(
fd
);

46 
	`waô
();

48 
	`exô
();

49 
	}
}

	@string.c

1 
	~"ty≥s.h
"

2 
	~"x86.h
"

5 
	$mem£t
(*
d°
, 
c
, 
uöt
 
n
)

7 i‡(()
d°
%4 =0 && 
n
%4 == 0){

8 
c
 &= 0xFF;

9 
	`°o¶
(
d°
, (
c
<<24)|(c<<16)|(c<<8)|c, 
n
/4);

11 
	`°osb
(
d°
, 
c
, 
n
);

12  
d°
;

13 
	}
}

16 
	$memcmp
(c⁄° *
v1
, c⁄° *
v2
, 
uöt
 
n
)

18 c⁄° 
uch¨
 *
s1
, *
s2
;

20 
s1
 = 
v1
;

21 
s2
 = 
v2
;

22 
n
-- > 0){

23 if(*
s1
 !*
s2
)

24  *
s1
 - *
s2
;

25 
s1
++, 
s2
++;

29 
	}
}

32 
	$memmove
(*
d°
, c⁄° *
§c
, 
uöt
 
n
)

34 c⁄° *
s
;

35 *
d
;

37 
s
 = 
§c
;

38 
d
 = 
d°
;

39 if(
s
 < 
d
 && s + 
n
 > d){

40 
s
 +
n
;

41 
d
 +
n
;

42 
n
-- > 0)

43 *--
d
 = *--
s
;

45 
n
-- > 0)

46 *
d
++ = *
s
++;

48  
d°
;

49 
	}
}

53 
	$mem˝y
(*
d°
, c⁄° *
§c
, 
uöt
 
n
)

55  
	`memmove
(
d°
, 
§c
, 
n
);

56 
	}
}

59 
	$°∫cmp
(c⁄° *
p
, c⁄° *
q
, 
uöt
 
n
)

61 
n
 > 0 && *
p
 && *∞=*
q
)

62 
n
--, 
p
++, 
q
++;

63 if(
n
 == 0)

65  (
uch¨
)*
p
 - (uch¨)*
q
;

66 
	}
}

69 
	$°∫˝y
(*
s
, c⁄° *
t
, 
n
)

71 *
os
;

73 
os
 = 
s
;

74 
n
-- > 0 && (*
s
++ = *
t
++) != 0)

76 
n
-- > 0)

77 *
s
++ = 0;

78  
os
;

79 
	}
}

83 
	$ß„°r˝y
(*
s
, c⁄° *
t
, 
n
)

85 *
os
;

87 
os
 = 
s
;

88 if(
n
 <= 0)

89  
os
;

90 --
n
 > 0 && (*
s
++ = *
t
++) != 0)

92 *
s
 = 0;

93  
os
;

94 
	}
}

97 
	$°æí
(c⁄° *
s
)

99 
n
;

101 
n
 = 0; 
s
[n];Ç++)

103  
n
;

104 
	}
}

	@swtch.S

2 #
#void 
swtch
(
c⁄ãxt
 **
ﬁd
, c⁄ãxà*
√w
);

4 #ﬁdÎäî 
ˇŒ
 
by
 
ª„ªn˚
. 
√w
Îäî cÆ»by 
vÆue
Îã§.

5 #
#Savê
cuºít
 
c⁄ãxt
 
ö
 
ﬁd


7 #™d 
thí
 
lﬂd
 
c⁄ãxt
 
‰om
 
√w
.

9 .
globl
 
swtch


10 
	gswtch
:

11 
movl
 4(%
e•
), %
	góx
 #e•Îäî  
	gaddªss
Î•º Í∞ÄÎ¶¨ÌÇ§Í≥† ÏûàÎã§(
	gﬁd
). ÏïÑÏßÅ Ïä§ÌÉùÏóê ÏïÑÎ¨¥Í≤ÉÎèÑ 
	gpush
Í∞Ä ÏïàÎêêÏúºÎØÄÎ°ú, áddressÎ•º Í∞ÄÎ¶¨ÌÇ®Îã§.

12 
	gmovl
 8(%
	ge•
), %
	gedx
 #new

14 #Savê
ﬁd
 
ˇŒì
-
ßve
 
ªgi°îs


15 #ÏïÑÎûò 
push
ÌïòÎäî Î†àÏßÄÏä§ÌÑ∞Îì§ÏùÄ 
c⁄víti⁄
Ïóê Îî∞Î•∏Îã§.

16 #eùÎäî 
push
ÌïòÏßÄ ÏïäÎäîÎã§. 
e•
Î•º Í∑∏ÎÉ• 
eù
Î°ú ÏÇºÍ≤†Îã§Îäî Í≤É.

17 
	gpushl
 %
ebp


18 
	gpushl
 %
ebx


19 
	gpushl
 %
esi


20 
	gpushl
 %
	gedi


22 #Swôch 
°acks


23 
	gmovl
 %
	ge•
, (%
	góx
Ë#e•Ïùò Í∞íÏùÑÉaxÍ∞Ä Í∞ÄÎ¶¨ÌÇ§Í≥† ÏûàÎäî Ï£ºÏÜåÏóê ÎÑ£ÎäîÎã§.ÉaxÎäî 
	gﬁd
. oldÍ∞Ä 
	gedi
Î•º Í∞ÄÎ¶¨ÌÇ§Í≤å ÎêúÎã§. Ï¶â oldÎäî 
ﬁd
 
	gc⁄ãxt
Î•º Í∞ÄÎ¶¨ÌÇ§Í≤å ÎêúÎã§.

24 
	gmovl
 %
	gedx
, %
	ge•
 #edxÎäî 
	g√w
Í∞Ä ÏûàÎã§.É•ÏóêÉdxÎ•º ÎÑ£ÎäîÎã§Îäî Í≤ÉÏùÄ ÏÉàÎ°úÏö¥ Ïä§ÌÉùÏùÑ Ïì∞Í≤†Îã§Îäî Í≤É. Ïó¨Í∏∞ÏÑú ÌïòÎÇòÏî© Î∫¥Î©¥ 
√w
 
	gc⁄ãxt
Ïùò Í∞íÏùÑ 
˝u
 Ïóê ÎÑ£ÎäîÎã§.

26 #Lﬂd 
√w
 
ˇŒì
-
ßve
 
ªgi°îs


27 
	gp›l
 %
edi


28 
	gp›l
 %
esi


29 
	gp›l
 %
ebx


30 
	gp›l
 %
ebp


31 
	gªt
 #eùÎ•º ÎπºÎäî Í≤É.ÑëÎäî 
	gˇŒ
Í≥º ÏåçÏù¥Îã§. cÆlÏóêÏÑú  
	gaddªss
Î•º ÎÑ£ÎäîÎã§. ÎßûÎÇò?ÑëÎ•º Ïã§ÌñâÌï®ÏúºÎ°úÏç® 
	geù
Î•º Î¶¨ÌÑ¥ÌïúÎã§? Î∫ÄÎã§?

	@syscall.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"¥oc.h
"

7 
	~"x86.h
"

8 
	~"sysˇŒ.h
"

18 
	$„tchöt
(
uöt
 
addr
, *
ù
)

20 if(
addr
 >
¥oc
->
sz
 ||áddr+4 >Öroc->sz)

22 *
ù
 = *(*)(
addr
);

24 
	}
}

30 
	$„tch°r
(
uöt
 
addr
, **
µ
)

32 *
s
, *
ï
;

34 if(
addr
 >
¥oc
->
sz
)

36 *
µ
 = (*)
addr
;

37 
ï
 = (*)
¥oc
->
sz
;

38 
s
 = *
µ
; s < 
ï
; s++)

39 if(*
s
 == 0)

40  
s
 - *
µ
;

42 
	}
}

46 
	$¨göt
(
n
, *
ù
)

48  
	`„tchöt
(
¥oc
->
tf
->
e•
 + 4 + 4*
n
, 
ù
);

49 
	}
}

55 
	$¨g±r
(
n
, **
µ
, 
size
)

57 
i
;

59 if(
	`¨göt
(
n
, &
i
) < 0)

61 if(
size
 < 0 || (
uöt
)
i
 >
¥oc
->
sz
 || (uint)i+size >Öroc->sz)

63 *
µ
 = (*)
i
;

65 
	}
}

72 
	$¨g°r
(
n
, **
µ
)

74 
addr
;

75 if(
	`¨göt
(
n
, &
addr
) < 0)

77  
	`„tch°r
(
addr
, 
µ
);

78 
	}
}

80 
sys_chdú
();

81 
sys_˛o£
();

82 
sys_dup
();

83 
sys_exec
();

84 
sys_exô
();

85 
sys_f‹k
();

86 
sys_f°©
();

87 
sys_gëpid
();

88 
sys_kûl
();

89 
sys_lök
();

90 
sys_mkdú
();

91 
sys_mknod
();

92 
sys_›í
();

93 
sys_pùe
();

94 
sys_ªad
();

95 
sys_sbrk
();

96 
sys_¶ìp
();

97 
sys_u∆ök
();

98 
sys_waô
();

99 
sys_wrôe
();

100 
sys_u±ime
();

101 
sys_my_sysˇŒ
();

102 
sys_gëµid
();

103 
sys_yõld
();

104 
sys_gëÀv
();

105 
sys_£t_˝u_sh¨e
();

106 
sys_thªad_¸óã
();

107 
sys_thªad_exô
();

108 
sys_thªad_joö
();

109 
sys_gëtid
();

111 (*
sysˇŒs
[])() = {

112 [
SYS_f‹k
] 
sys_f‹k
,

113 [
SYS_exô
] 
sys_exô
,

114 [
SYS_waô
] 
sys_waô
,

115 [
SYS_pùe
] 
sys_pùe
,

116 [
SYS_ªad
] 
sys_ªad
,

117 [
SYS_kûl
] 
sys_kûl
,

118 [
SYS_exec
] 
sys_exec
,

119 [
SYS_f°©
] 
sys_f°©
,

120 [
SYS_chdú
] 
sys_chdú
,

121 [
SYS_dup
] 
sys_dup
,

122 [
SYS_gëpid
] 
sys_gëpid
,

123 [
SYS_sbrk
] 
sys_sbrk
,

124 [
SYS_¶ìp
] 
sys_¶ìp
,

125 [
SYS_u±ime
] 
sys_u±ime
,

126 [
SYS_›í
] 
sys_›í
,

127 [
SYS_wrôe
] 
sys_wrôe
,

128 [
SYS_mknod
] 
sys_mknod
,

129 [
SYS_u∆ök
] 
sys_u∆ök
,

130 [
SYS_lök
] 
sys_lök
,

131 [
SYS_mkdú
] 
sys_mkdú
,

132 [
SYS_˛o£
] 
sys_˛o£
,

133 [
SYS_my_sysˇŒ
] 
sys_my_sysˇŒ
,

134 [
SYS_gëµid
] 
sys_gëµid
,

135 [
SYS_yõld
] 
sys_yõld
,

136 [
SYS_gëÀv
] 
sys_gëÀv
,

137 [
SYS_£t_˝u_sh¨e
] 
sys_£t_˝u_sh¨e
,

138 [
SYS_thªad_¸óã
] 
sys_thªad_¸óã
,

139 [
SYS_thªad_exô
] 
sys_thªad_exô
,

140 [
SYS_thªad_joö
] 
sys_thªad_joö
,

141 [
SYS_gëtid
] 
sys_gëtid
,

142 
	}
};

145 
	$sysˇŒ
()

147 
num
;

149 
num
 = 
¥oc
->
tf
->
óx
;

150 if(
num
 > 0 &&Çum < 
	`NELEM
(
sysˇŒs
) && syscalls[num]) {

151 
¥oc
->
tf
->
óx
 = 
sysˇŒs
[
num
]();

153 
	`˝rötf
("%d %s: unknown sys call %d\n",

154 
¥oc
->
pid
,Öroc->
«me
, 
num
);

155 
¥oc
->
tf
->
óx
 = -1;

157 
	}
}

	@syscall.h

2 
	#SYS_f‹k
 1

	)

3 
	#SYS_exô
 2

	)

4 
	#SYS_waô
 3

	)

5 
	#SYS_pùe
 4

	)

6 
	#SYS_ªad
 5

	)

7 
	#SYS_kûl
 6

	)

8 
	#SYS_exec
 7

	)

9 
	#SYS_f°©
 8

	)

10 
	#SYS_chdú
 9

	)

11 
	#SYS_dup
 10

	)

12 
	#SYS_gëpid
 11

	)

13 
	#SYS_sbrk
 12

	)

14 
	#SYS_¶ìp
 13

	)

15 
	#SYS_u±ime
 14

	)

16 
	#SYS_›í
 15

	)

17 
	#SYS_wrôe
 16

	)

18 
	#SYS_mknod
 17

	)

19 
	#SYS_u∆ök
 18

	)

20 
	#SYS_lök
 19

	)

21 
	#SYS_mkdú
 20

	)

22 
	#SYS_˛o£
 21

	)

23 
	#SYS_my_sysˇŒ
 22

	)

24 
	#SYS_gëµid
 23

	)

25 
	#SYS_yõld
 24

	)

26 
	#SYS_gëÀv
 25

	)

27 
	#SYS_£t_˝u_sh¨e
 26

	)

	@sysfile.c

7 
	~"ty≥s.h
"

8 
	~"defs.h
"

9 
	~"∑øm.h
"

10 
	~"°©.h
"

11 
	~"mmu.h
"

12 
	~"¥oc.h
"

13 
	~"fs.h
"

14 
	~"•ölock.h
"

15 
	~"¶ì∂ock.h
"

16 
	~"fûe.h
"

17 
	~"f˙é.h
"

22 
	$¨gfd
(
n
, *
pfd
, 
fûe
 **
pf
)

24 
fd
;

25 
fûe
 *
f
;

27 if(
	`¨göt
(
n
, &
fd
) < 0)

29 if(
fd
 < 0 || fd >
NOFILE
 || (
f
=
¥oc
->
ofûe
[fd]) == 0)

31 if(
pfd
)

32 *
pfd
 = 
fd
;

33 if(
pf
)

34 *
pf
 = 
f
;

36 
	}
}

41 
	$fdÆloc
(
fûe
 *
f
)

43 
fd
;

45 
fd
 = 0; fd < 
NOFILE
; fd++){

46 if(
¥oc
->
ofûe
[
fd
] == 0){

47 
¥oc
->
ofûe
[
fd
] = 
f
;

48  
fd
;

52 
	}
}

55 
	$sys_dup
()

57 
fûe
 *
f
;

58 
fd
;

60 if(
	`¨gfd
(0, 0, &
f
) < 0)

62 if((
fd
=
	`fdÆloc
(
f
)) < 0)

64 
	`fûedup
(
f
);

65  
fd
;

66 
	}
}

69 
	$sys_ªad
()

71 
fûe
 *
f
;

72 
n
;

73 *
p
;

75 if(
	`¨gfd
(0, 0, &
f
Ë< 0 || 
	`¨göt
(2, &
n
Ë< 0 || 
	`¨g±r
(1, &
p
,Ç) < 0)

77  
	`fûîód
(
f
, 
p
, 
n
);

78 
	}
}

81 
	$sys_wrôe
()

83 
fûe
 *
f
;

84 
n
;

85 *
p
;

87 if(
	`¨gfd
(0, 0, &
f
Ë< 0 || 
	`¨göt
(2, &
n
Ë< 0 || 
	`¨g±r
(1, &
p
,Ç) < 0)

89  
	`fûewrôe
(
f
, 
p
, 
n
);

90 
	}
}

93 
	$sys_˛o£
()

95 
fd
;

96 
fûe
 *
f
;

98 if(
	`¨gfd
(0, &
fd
, &
f
) < 0)

100 
¥oc
->
ofûe
[
fd
] = 0;

101 
	`fûe˛o£
(
f
);

103 
	}
}

106 
	$sys_f°©
()

108 
fûe
 *
f
;

109 
°©
 *
°
;

111 if(
	`¨gfd
(0, 0, &
f
Ë< 0 || 
	`¨g±r
(1, (*)&
°
, (*st)) < 0)

113  
	`fûe°©
(
f
, 
°
);

114 
	}
}

118 
	$sys_lök
()

120 
«me
[
DIRSIZ
], *
√w
, *
ﬁd
;

121 
öode
 *
dp
, *
ù
;

123 if(
	`¨g°r
(0, &
ﬁd
Ë< 0 ||árg°r(1, &
√w
) < 0)

126 
	`begö_›
();

127 if((
ù
 = 
	`«mei
(
ﬁd
)) == 0){

128 
	`íd_›
();

132 
	`ûock
(
ù
);

133 if(
ù
->
ty≥
 =
T_DIR
){

134 
	`iu∆ockput
(
ù
);

135 
	`íd_›
();

139 
ù
->
∆ök
++;

140 
	`iupd©e
(
ù
);

141 
	`iu∆ock
(
ù
);

143 if((
dp
 = 
	`«meù¨ít
(
√w
, 
«me
)) == 0)

144 
bad
;

145 
	`ûock
(
dp
);

146 if(
dp
->
dev
 !
ù
->dev || 
	`dúlök
(dp, 
«me
, ip->
öum
) < 0){

147 
	`iu∆ockput
(
dp
);

148 
bad
;

150 
	`iu∆ockput
(
dp
);

151 
	`ùut
(
ù
);

153 
	`íd_›
();

157 
bad
:

158 
	`ûock
(
ù
);

159 
ù
->
∆ök
--;

160 
	`iupd©e
(
ù
);

161 
	`iu∆ockput
(
ù
);

162 
	`íd_›
();

164 
	}
}

168 
	$isdúem±y
(
öode
 *
dp
)

170 
off
;

171 
dúít
 
de
;

173 
off
=2*(
de
); off<
dp
->
size
; off+=(de)){

174 if(
	`ªadi
(
dp
, (*)&
de
, 
off
, (de)) != (de))

175 
	`∑nic
("isdirempty:Ñeadi");

176 if(
de
.
öum
 != 0)

180 
	}
}

184 
	$sys_u∆ök
()

186 
öode
 *
ù
, *
dp
;

187 
dúít
 
de
;

188 
«me
[
DIRSIZ
], *
∑th
;

189 
uöt
 
off
;

191 if(
	`¨g°r
(0, &
∑th
) < 0)

194 
	`begö_›
();

195 if((
dp
 = 
	`«meù¨ít
(
∑th
, 
«me
)) == 0){

196 
	`íd_›
();

200 
	`ûock
(
dp
);

203 if(
	`«mecmp
(
«me
, ".") == 0 ||Çamecmp(name, "..") == 0)

204 
bad
;

206 if((
ù
 = 
	`dúlookup
(
dp
, 
«me
, &
off
)) == 0)

207 
bad
;

208 
	`ûock
(
ù
);

210 if(
ù
->
∆ök
 < 1)

211 
	`∑nic
("unlink:Çlink < 1");

212 if(
ù
->
ty≥
 =
T_DIR
 && !
	`isdúem±y
(ip)){

213 
	`iu∆ockput
(
ù
);

214 
bad
;

217 
	`mem£t
(&
de
, 0, (de));

218 if(
	`wrôei
(
dp
, (*)&
de
, 
off
, (de)) != (de))

219 
	`∑nic
("unlink: writei");

220 if(
ù
->
ty≥
 =
T_DIR
){

221 
dp
->
∆ök
--;

222 
	`iupd©e
(
dp
);

224 
	`iu∆ockput
(
dp
);

226 
ù
->
∆ök
--;

227 
	`iupd©e
(
ù
);

228 
	`iu∆ockput
(
ù
);

230 
	`íd_›
();

234 
bad
:

235 
	`iu∆ockput
(
dp
);

236 
	`íd_›
();

238 
	}
}

240 
öode
*

241 
	$¸óã
(*
∑th
, 
ty≥
, 
maj‹
, 
mö‹
)

243 
uöt
 
off
;

244 
öode
 *
ù
, *
dp
;

245 
«me
[
DIRSIZ
];

247 if((
dp
 = 
	`«meù¨ít
(
∑th
, 
«me
)) == 0)

249 
	`ûock
(
dp
);

251 if((
ù
 = 
	`dúlookup
(
dp
, 
«me
, &
off
)) != 0){

252 
	`iu∆ockput
(
dp
);

253 
	`ûock
(
ù
);

254 if(
ty≥
 =
T_FILE
 && 
ù
->type == T_FILE)

255  
ù
;

256 
	`iu∆ockput
(
ù
);

260 if((
ù
 = 
	`üŒoc
(
dp
->
dev
, 
ty≥
)) == 0)

261 
	`∑nic
("create: ialloc");

263 
	`ûock
(
ù
);

264 
ù
->
maj‹
 = major;

265 
ù
->
mö‹
 = minor;

266 
ù
->
∆ök
 = 1;

267 
	`iupd©e
(
ù
);

269 if(
ty≥
 =
T_DIR
){

270 
dp
->
∆ök
++;

271 
	`iupd©e
(
dp
);

273 if(
	`dúlök
(
ù
, ".", ip->
öum
Ë< 0 || dúlök(ù, "..", 
dp
->inum) < 0)

274 
	`∑nic
("create dots");

277 if(
	`dúlök
(
dp
, 
«me
, 
ù
->
öum
) < 0)

278 
	`∑nic
("create: dirlink");

280 
	`iu∆ockput
(
dp
);

282  
ù
;

283 
	}
}

286 
	$sys_›í
()

288 *
∑th
;

289 
fd
, 
omode
;

290 
fûe
 *
f
;

291 
öode
 *
ù
;

293 if(
	`¨g°r
(0, &
∑th
Ë< 0 || 
	`¨göt
(1, &
omode
) < 0)

296 
	`begö_›
();

298 if(
omode
 & 
O_CREATE
){

299 
ù
 = 
	`¸óã
(
∑th
, 
T_FILE
, 0, 0);

300 if(
ù
 == 0){

301 
	`íd_›
();

305 if((
ù
 = 
	`«mei
(
∑th
)) == 0){

306 
	`íd_›
();

309 
	`ûock
(
ù
);

310 if(
ù
->
ty≥
 =
T_DIR
 && 
omode
 !
O_RDONLY
){

311 
	`iu∆ockput
(
ù
);

312 
	`íd_›
();

317 if((
f
 = 
	`fûóŒoc
()Ë=0 || (
fd
 = 
	`fdÆloc
(f)) < 0){

318 if(
f
)

319 
	`fûe˛o£
(
f
);

320 
	`iu∆ockput
(
ù
);

321 
	`íd_›
();

324 
	`iu∆ock
(
ù
);

325 
	`íd_›
();

327 
f
->
ty≥
 = 
FD_INODE
;

328 
f
->
ù
 = ip;

329 
f
->
off
 = 0;

330 
f
->
ªadabÀ
 = !(
omode
 & 
O_WRONLY
);

331 
f
->
wrôabÀ
 = (
omode
 & 
O_WRONLY
Ë|| (omodê& 
O_RDWR
);

332  
fd
;

333 
	}
}

336 
	$sys_mkdú
()

338 *
∑th
;

339 
öode
 *
ù
;

341 
	`begö_›
();

342 if(
	`¨g°r
(0, &
∑th
Ë< 0 || (
ù
 = 
	`¸óã
’©h, 
T_DIR
, 0, 0)) == 0){

343 
	`íd_›
();

346 
	`iu∆ockput
(
ù
);

347 
	`íd_›
();

349 
	}
}

352 
	$sys_mknod
()

354 
öode
 *
ù
;

355 *
∑th
;

356 
maj‹
, 
mö‹
;

358 
	`begö_›
();

359 if((
	`¨g°r
(0, &
∑th
)) < 0 ||

360 
	`¨göt
(1, &
maj‹
) < 0 ||

361 
	`¨göt
(2, &
mö‹
) < 0 ||

362 (
ù
 = 
	`¸óã
(
∑th
, 
T_DEV
, 
maj‹
, 
mö‹
)) == 0){

363 
	`íd_›
();

366 
	`iu∆ockput
(
ù
);

367 
	`íd_›
();

369 
	}
}

372 
	$sys_chdú
()

374 *
∑th
;

375 
öode
 *
ù
;

377 
	`begö_›
();

378 if(
	`¨g°r
(0, &
∑th
Ë< 0 || (
ù
 = 
	`«mei
(path)) == 0){

379 
	`íd_›
();

382 
	`ûock
(
ù
);

383 if(
ù
->
ty≥
 !
T_DIR
){

384 
	`iu∆ockput
(
ù
);

385 
	`íd_›
();

388 
	`iu∆ock
(
ù
);

389 
	`ùut
(
¥oc
->
cwd
);

390 
	`íd_›
();

391 
¥oc
->
cwd
 = 
ù
;

393 
	}
}

396 
	$sys_exec
()

398 *
∑th
, *
¨gv
[
MAXARG
];

399 
i
;

400 
uöt
 
u¨gv
, 
u¨g
;

402 if(
	`¨g°r
(0, &
∑th
Ë< 0 || 
	`¨göt
(1, (*)&
u¨gv
) < 0){

405 
	`mem£t
(
¨gv
, 0, (argv));

406 
i
=0;; i++){

407 if(
i
 >
	`NELEM
(
¨gv
))

409 if(
	`„tchöt
(
u¨gv
+4*
i
, (*)&
u¨g
) < 0)

411 if(
u¨g
 == 0){

412 
¨gv
[
i
] = 0;

415 if(
	`„tch°r
(
u¨g
, &
¨gv
[
i
]) < 0)

418  
	`exec
(
∑th
, 
¨gv
);

419 
	}
}

422 
	$sys_pùe
()

424 *
fd
;

425 
fûe
 *
rf
, *
wf
;

426 
fd0
, 
fd1
;

428 if(
	`¨g±r
(0, (*)&
fd
, 2*(fd[0])) < 0)

430 if(
	`pùóŒoc
(&
rf
, &
wf
) < 0)

432 
fd0
 = -1;

433 if((
fd0
 = 
	`fdÆloc
(
rf
)Ë< 0 || (
fd1
 = fdÆloc(
wf
)) < 0){

434 if(
fd0
 >= 0)

435 
¥oc
->
ofûe
[
fd0
] = 0;

436 
	`fûe˛o£
(
rf
);

437 
	`fûe˛o£
(
wf
);

440 
fd
[0] = 
fd0
;

441 
fd
[1] = 
fd1
;

443 
	}
}

	@sysproc.c

1 
	~"ty≥s.h
"

2 
	~"x86.h
"

3 
	~"defs.h
"

4 
	~"d©e.h
"

5 
	~"∑øm.h
"

6 
	~"memœyout.h
"

7 
	~"mmu.h
"

8 
	~"¥oc.h
"

11 
	$sys_f‹k
()

13  
	`f‹k
();

14 
	}
}

17 
	$sys_exô
()

19 
	`exô
();

21 
	}
}

24 
	$sys_waô
()

26  
	`waô
();

27 
	}
}

30 
	$sys_kûl
()

32 
pid
;

34 if(
	`¨göt
(0, &
pid
) < 0)

36  
	`kûl
(
pid
);

37 
	}
}

40 
	$sys_gëpid
()

42  
¥oc
->
pid
;

43 
	}
}

46 
	$sys_sbrk
()

48 
addr
;

49 
n
;

51 if(
	`¨göt
(0, &
n
) < 0)

53 
addr
 = 
¥oc
->
sz
;

54 if(
	`grow¥oc
(
n
) < 0)

56  
addr
;

57 
	}
}

60 
	$sys_¶ìp
()

62 
n
;

63 
uöt
 
ticks0
;

65 if(
	`¨göt
(0, &
n
) < 0)

67 
	`acquúe
(&
tick¶ock
);

68 
ticks0
 = 
ticks
;

69 
ticks
 - 
ticks0
 < 
n
){

70 if(
¥oc
->
kûÀd
){

71 
	`ªÀa£
(&
tick¶ock
);

74 
	`¶ìp
(&
ticks
, &
tick¶ock
);

76 
	`ªÀa£
(&
tick¶ock
);

78 
	}
}

83 
	$sys_u±ime
()

85 
uöt
 
xticks
;

87 
	`acquúe
(&
tick¶ock
);

88 
xticks
 = 
ticks
;

89 
	`ªÀa£
(&
tick¶ock
);

90  
xticks
;

91 
	}
}

	@test.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

14 
	$maö
(
¨gc
, *
¨gv
[])

16 
	`__asm__
("int $128");

17 
	`exô
();

18 
	}
}

	@test_master.c

5 
	~"ty≥s.h
"

6 
	~"°©.h
"

7 
	~"u£r.h
"

10 
	#CNT_CHILD
 4

	)

13 
	#NAME_CHILD_STRIDE
 "ã°_°ride"

	)

15 
	#NAME_CHILD_MLFQ
 "ã°_mlfq"

	)

17 *
	gchûd_¨gv
[
CNT_CHILD
][3] = {

19 {
NAME_CHILD_STRIDE
, "10", 0},

21 {
NAME_CHILD_STRIDE
, "30", 0},

23 {
NAME_CHILD_MLFQ
, "0", 0},

25 {
NAME_CHILD_MLFQ
, "1", 0}

29 
	$maö
(
¨gc
, *
¨gv
[])

31 
pid
;

32 
i
;

34 
i
 = 0; i < 
CNT_CHILD
; i++) {

35 
pid
 = 
	`f‹k
();

36 i‡(
pid
 > 0) {

39 } i‡(
pid
 == 0) {

41 
	`exec
(
chûd_¨gv
[
i
][0], child_argv[i]);

42 
	`¥ötf
(1, "exec failed!!\n");

43 
	`exô
();

45 
	`¥ötf
(1, "fork failed!!\n");

46 
	`exô
();

50 
i
 = 0; i < 
CNT_CHILD
; i++) {

51 
	`waô
();

54 
	`exô
();

55 
	}
}

	@test_master_mj.c

5 
	~"ty≥s.h
"

6 
	~"°©.h
"

7 
	~"u£r.h
"

10 
	#CNT_CHILD
 4

	)

13 
	#NAME_CHILD_STRIDE
 "ã°_°ride"

	)

15 
	#NAME_CHILD_MLFQ
 "ã°_mlfq"

	)

17 *
	gchûd_¨gv
[
CNT_CHILD
][3] = {

19 {
NAME_CHILD_STRIDE
, "5", 0},

21 {
NAME_CHILD_STRIDE
, "10", 0},

22 {
NAME_CHILD_STRIDE
, "20", 0},

23 {
NAME_CHILD_STRIDE
, "40", 0},

31 
	$maö
(
¨gc
, *
¨gv
[])

33 
pid
;

34 
i
;

36 
i
 = 0; i < 
CNT_CHILD
; i++) {

37 
pid
 = 
	`f‹k
();

38 i‡(
pid
 > 0) {

41 } i‡(
pid
 == 0) {

43 
	`exec
(
chûd_¨gv
[
i
][0], child_argv[i]);

44 
	`¥ötf
(1, "exec failed!!\n");

45 
	`exô
();

47 
	`¥ötf
(1, "fork failed!!\n");

48 
	`exô
();

52 
i
 = 0; i < 
CNT_CHILD
; i++) {

53 
	`waô
();

56 
	`exô
();

57 
	}
}

	@test_mlfq.c

8 
	~"ty≥s.h
"

9 
	~"°©.h
"

10 
	~"u£r.h
"

12 
	#LIFETIME
 200000000

13 
	#YIELD_PERIOD
 10000

14 

	)

16 
	#MLFQ_LEVEL
 3

	)

19 
	$maö
(
¨gc
, *
¨gv
[])

21 
uöt
 
i
;

22 
˙t_Àvñ
[
MLFQ_LEVEL
] = {0, 0, 0};

23 
do_yõld
;

24 
cuº_mlfq_Àvñ
;

26 i‡(
¨gc
 < 2) {

27 
	`¥ötf
(1, "usage: sched_test_mlfq do_yield_or_not(0|1)\n");

28 
	`exô
();

31 
do_yõld
 = 
	`©oi
(
¨gv
[1]);

33 
i
 = 0;

35 
i
++;

38 
	`__sync_synchr⁄ize
();

40 i‡(
i
 % 
YIELD_PERIOD
 == 0) {

42 
cuº_mlfq_Àvñ
 = 
	`gëÀv
();

43 
˙t_Àvñ
[
cuº_mlfq_Àvñ
]++;

45 i‡(
i
 > 
LIFETIME
) {

46 
	`¥ötf
(1, "MLFQ(%s),Üev[0]: %d,Üev[1]: %d,Üev[2]: %d\n",

47 
do_yõld
==0 ? "compute" : "yield",

48 
˙t_Àvñ
[0], cnt_level[1], cnt_level[2]);

52 i‡(
do_yõld
) {

54 
	`yõld
();

59 
	`exô
();

60 
	}
}

	@test_mlfq_mj.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

6 
	$maö
(
¨gc
, *
¨gv
[])

8 
uöt
 
pid
, 
i
, 
j
, 
cou¡
 = 100;

9 
pid
 = 
	`f‹k
();

11 i‡(
pid
 == 0) {

13 
i
 = 0; i < 
cou¡
; ++i) {

14 
	`¥ötf
(1, "Chûd. gëÀv(): %d.\n", 
	`gëÀv
());

15 
j
 = 0; j < 50000000; ++j) {

19 
	`¥ötf
(1, "\n");

20 } i‡(
pid
 > 0) {

22 
i
 = 0; i < 
cou¡
; ++i) {

23 
	`¥ötf
(1, "P¨ít. gëÀv(): %d.\n", 
	`gëÀv
());

24 
j
 = 0; j < 50000000; ++j) {

29 
	`¥ötf
(1, "fork()Érror\nTerminateÅheÖrogram.\n");

30 
	`exô
();

33 
	`waô
();

35 
	`exô
();

36 
	}
}

	@test_stride.c

7 
	~"ty≥s.h
"

8 
	~"°©.h
"

9 
	~"u£r.h
"

11 
	#LIFETIME
 1000

12 
	#COUNT_PERIOD
 1000000

13 

	)

15 
	$maö
(
¨gc
, *
¨gv
[])

17 
uöt
 
i
;

18 
˙t
 = 0;

19 
˝u_sh¨e
;

20 
uöt
 
°¨t_tick
;

21 
uöt
 
cuº_tick
;

23 i‡(
¨gc
 < 2) {

24 
	`¥ötf
(1, "usage: sched_test_stride cpu_share(%)\n");

25 
	`exô
();

28 
˝u_sh¨e
 = 
	`©oi
(
¨gv
[1]);

31 i‡(
	`£t_˝u_sh¨e
(
˝u_sh¨e
) < 0) {

32 
	`¥ötf
(1, "cannot set cpu share\n");

33 
	`exô
();

37 
°¨t_tick
 = 
	`u±ime
();

39 
i
 = 0;

41 
i
++;

44 
	`__sync_synchr⁄ize
();

46 i‡(
i
 =
COUNT_PERIOD
) {

47 
˙t
++;

50 
cuº_tick
 = 
	`u±ime
();

52 i‡(
cuº_tick
 - 
°¨t_tick
 > 
LIFETIME
) {

54 
	`¥ötf
(1, "STRIDE(%d%%), c¡: %d\n", 
˝u_sh¨e
, 
˙t
);

57 
i
 = 0;

61 
	`exô
();

62 
	}
}

	@test_stride_mj.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	$maö
(
¨gc
, *
¨gv
[])

7 
i
;

9 
	`¥ötf
(1, "£t_˝u_sh¨e(0):Ñëu∫: %d\n", 
	`£t_˝u_sh¨e
(0));

10 
	`¥ötf
(1, "£t_˝u_sh¨e(81):Ñëu∫: %d\n", 
	`£t_˝u_sh¨e
(81));

11 
	`¥ötf
(1, "£t_˝u_sh¨e(50):Ñëu∫: %d\n", 
	`£t_˝u_sh¨e
(50));

12 
	`¥ötf
(1, "£t_˝u_sh¨e(80):Ñëu∫: %d\n", 
	`£t_˝u_sh¨e
(80));

14 
i
 = 0; i < 1000; ++i) {

15 
	`¥ötf
(0, "0");

17 
	`exô
();

18 
	}
}

	@test_t.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 vﬁ©ûê
	gcou¡î
 = 0;

8 
	$mythªad
(*
¨g
)

10 
i
;

12 
	`¥ötf
(1, "%s: begö\n", (*Ë
¨g
);

13 
i
 = 0; i < 1e7; ++i) {

14 
cou¡î
 = counter + 1;

16 
	`¥ötf
(1, "%s: d⁄e\n", (*Ë
¨g
);

18 
	`thªad_exô
(0);

22 
	}
}

25 
	$maö
(
¨gc
, *
¨gv
[])

27 
thªad_t
 
p1
;

28 
thªad_t
 
p2
;

29 
	`¥ötf
(1, "maö: begö (cou¡î = %d)\n", 
cou¡î
);

30 
	`thªad_¸óã
(&
p1
, 
mythªad
, "A");

31 
	`thªad_¸óã
(&
p2
, 
mythªad
, "B");

33 
	`thªad_joö
(
p1
, 0);

34 
	`thªad_joö
(
p2
, 0);

35 
	`¥ötf
(1, "maö: d⁄êwôh bŸh (cou¡î = %d)\n", 
cou¡î
);

36 
	`exô
();

37 
	}
}

	@test_t2.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 * 
	$°¨t_routöe
(* 
¨g
) {

6 
i
;

7 
n
 = ()
¨g
;

9 
i
 = 0; i < 2; ++i) {

10 
	`¥ötf
(0, "** Thªad. IámÑu¬ög!,árg:%d,Öid:%d,Åid:%d,Öpid:%d **\n", 
n
, 
	`gëpid
(),
	`gëtid
(), 
	`gëµid
());

13 
	`thªad_exô
((*)999);

15 
	}
}

18 
	$maö
(
¨gc
, *
¨gv
[])

20 
thªad_t
 
thªad
 = 200;

21 
thªad_t
 
thªad2
 = 200;

22 
a
 = 10000;

23 * 
ªtu∫_vÆue
 = 0;

25 
	`¥ötf
(1, "(maöÔ:%d\n", 
a
);

27 
	`thªad_¸óã
(&
thªad
, 
°¨t_routöe
, (*)
a
);

28 
	`thªad_¸óã
(&
thªad2
, 
°¨t_routöe
, (*)
a
);

29 
	`thªad_joö
(
thªad
, (**)&
ªtu∫_vÆue
);

30 
	`¥ötf
(1, "(maö)joö1Ñëu∫_vÆue: %d\n", 
ªtu∫_vÆue
);

31 
	`thªad_joö
(
thªad2
, (**)&
ªtu∫_vÆue
);

32 
	`¥ötf
(1, "(maö)joö2Ñëu∫_vÆue: %d\n", 
ªtu∫_vÆue
);

34 
	`¥ötf
(1, "(maö)°¨t_routöe: %p\n", 
°¨t_routöe
);

35 
	`¥ötf
(1, "(maöÌpid: %d,Öid: %d\n", 
	`gëµid
(), 
	`gëpid
());

37 
	`¥ötf
(1, "(maöÔ:%d\n", 
a
);

40 
i
;

41 
i
 = 0; i < 210000000; ++i) {

46 
	`exô
();

47 
	}
}

	@test_yield.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
yõld
();

8 
	$maö
(
¨gc
, *
¨gv
[])

10 
uöt
 
pid
, 
i
, 
cou¡
 = 100;

11 
pid
 = 
	`f‹k
();

13 i‡(
pid
 == 0) {

15 
i
 = 0; i < 
cou¡
; ++i) {

16 
	`¥ötf
(1, "Child\n");

17 
	`yõld
();

19 } i‡(
pid
 > 0) {

21 
i
 = 0; i < 
cou¡
; ++i) {

22 
	`¥ötf
(1, "Parent\n");

23 
	`yõld
();

26 
	`¥ötf
(1, "fork()Érror\nTerminateÅheÖrogram.\n");

27 
	`exô
();

30 
	`waô
();

32 
	`exô
();

33 
	}
}

	@threadtest.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	#NUM_THREAD
 10

	)

6 
	#NTEST
 5

	)

9 
øcögã°
();

12 
basi˘e°
();

13 
joöã°1
();

14 
joöã°2
();

17 
°ªs°e°
();

19 
	gg˙t
;

20 
	ggpùe
[2];

22 (*
ã°func
[
NTEST
])() = {

23 
øcögã°
,

24 
basi˘e°
,

25 
joöã°1
,

26 
joöã°2
,

27 
°ªs°e°
,

28 
	}
};

29 *
	gã°«me
[
NTEST
] = {

38 
	$maö
(
¨gc
, *
¨gv
[])

40 
i
;

41 
ªt
;

42 
pid
;

43 
°¨t
 = 0;

44 
íd
 = 
NTEST
-1;

45 i‡(
¨gc
 >= 2)

46 
°¨t
 = 
	`©oi
(
¨gv
[1]);

47 i‡(
¨gc
 >= 3)

48 
íd
 = 
	`©oi
(
¨gv
[2]);

50 
i
 = 
°¨t
; i <
íd
; i++){

51 
	`¥ötf
(1,"%d. %†°¨t\n", 
i
, 
ã°«me
[i]);

52 i‡(
	`pùe
(
gpùe
) < 0){

53 
	`¥ötf
(1,"pipeÖanic\n");

54 
	`exô
();

56 
ªt
 = 0;

58 i‡((
pid
 = 
	`f‹k
()) < 0){

59 
	`¥ötf
(1,"forkÖanic\n");

60 
	`exô
();

62 i‡(
pid
 == 0){

63 
	`˛o£
(
gpùe
[0]);

64 
ªt
 = 
ã°func
[
i
]();

65 
	`wrôe
(
gpùe
[1], (*)&
ªt
, (ret));

66 
	`˛o£
(
gpùe
[1]);

67 
	`exô
();

69 
	`˛o£
(
gpùe
[1]);

70 i‡(
	`waô
(Ë=-1 || 
	`ªad
(
gpùe
[0], (*)&
ªt
, (ret)) == -1 ||Ñet != 0){

71 
	`¥ötf
(1,"%d. %†∑nic\n", 
i
, 
ã°«me
[i]);

72 
	`exô
();

74 
	`˛o£
(
gpùe
[0]);

76 
	`¥ötf
(1,"%d. %†föish\n", 
i
, 
ã°«me
[i]);

77 
	`¶ìp
(100);

79 
	`exô
();

80 
	}
}

83 
	$n›
(){ 
	}
}

86 
	$øcögthªadmaö
(*
¨g
)

88 
tid
 = (Ë
¨g
;

89 
i
;

91 
tmp
;

92 
i
 = 0; i < 10000000; i++){

93 
tmp
 = 
g˙t
;

94 
tmp
++;

95 
	`n›
();

96 
g˙t
 = 
tmp
;

98 
	`thªad_exô
((*)(
tid
+1));

100 
	}
}

103 
	$øcögã°
()

105 
thªad_t
 
thªads
[
NUM_THREAD
];

106 
i
;

107 *
ªtvÆ
;

108 
g˙t
 = 0;

110 
i
 = 0; i < 
NUM_THREAD
; i++){

111 
	`¥ötf
(1, "‘acögã°):Åhªad_¸óãÇunbî: %d\n", 
i
);

112 i‡(
	`thªad_¸óã
(&
thªads
[
i
], 
øcögthªadmaö
, (*)i) != 0){

113 
	`¥ötf
(1, "panicátÅhread_create\n");

117 
i
 = 0; i < 
NUM_THREAD
; i++){

118 i‡(
	`thªad_joö
(
thªads
[
i
], &
ªtvÆ
) != 0 || ()retval != i+1){

119 
	`¥ötf
(1, "panicátÅhread_join\n");

120 
	`¥ötf
(1, "desúedÑëvÆ: %d,Ñó»ªtvÆ: %d\n", 
i
+1, ()
ªtvÆ
);

124 
	`¥ötf
(1,"%d\n", 
g˙t
);

126 
	}
}

130 
	$basi˘hªadmaö
(*
¨g
)

132 
tid
 = (Ë
¨g
;

133 
i
;

134 
i
 = 0; i < 100000000; i++){

135 i‡(
i
 % 20000000 == 0){

136 
	`¥ötf
(1, "%d", 
tid
);

139 
	`thªad_exô
((*)(
tid
+1));

141 
	}
}

144 
	$basi˘e°
()

146 
thªad_t
 
thªads
[
NUM_THREAD
];

147 
i
;

148 *
ªtvÆ
;

150 
i
 = 0; i < 
NUM_THREAD
; i++){

151 i‡(
	`thªad_¸óã
(&
thªads
[
i
], 
basi˘hªadmaö
, (*)i) != 0){

152 
	`¥ötf
(1, "panicátÅhread_create\n");

156 
i
 = 0; i < 
NUM_THREAD
; i++){

157 i‡(
	`thªad_joö
(
thªads
[
i
], &
ªtvÆ
) != 0 || ()retval != i+1){

158 
	`¥ötf
(1, "panicátÅhread_join\n");

162 
	`¥ötf
(1,"\n");

164 
	}
}

169 
	$joöthªadmaö
(*
¨g
)

171 
vÆ
 = ()
¨g
;

172 
	`¶ìp
(200);

173 
	`¥ötf
(1, "thread_exit...\n");

174 
	`thªad_exô
((*)(
vÆ
*2));

176 
	}
}

179 
	$joöã°1
()

181 
thªad_t
 
thªads
[
NUM_THREAD
];

182 
i
;

183 *
ªtvÆ
;

185 
i
 = 1; i <
NUM_THREAD
; i++){

186 i‡(
	`thªad_¸óã
(&
thªads
[
i
-1], 
joöthªadmaö
, (*)i) != 0){

187 
	`¥ötf
(1, "panicátÅhread_create\n");

191 
	`¥ötf
(1, "thread_join!!!\n");

192 
i
 = 1; i <
NUM_THREAD
; i++){

193 i‡(
	`thªad_joö
(
thªads
[
i
-1], &
ªtvÆ
) != 0 || ()retval != i * 2 ){

194 
	`¥ötf
(1, "panicátÅhread_join\n");

198 
	`¥ötf
(1,"\n");

200 
	}
}

203 
	$joöã°2
()

205 
thªad_t
 
thªads
[
NUM_THREAD
];

206 
i
;

207 *
ªtvÆ
;

209 
i
 = 1; i <
NUM_THREAD
; i++){

210 i‡(
	`thªad_¸óã
(&
thªads
[
i
-1], 
joöthªadmaö
, (*)(i)) != 0){

211 
	`¥ötf
(1, "panicátÅhread_create\n");

215 
	`¶ìp
(500);

216 
	`¥ötf
(1, "thread_join!!!\n");

217 
i
 = 1; i <
NUM_THREAD
; i++){

218 i‡(
	`thªad_joö
(
thªads
[
i
-1], &
ªtvÆ
) != 0 || ()retval != i * 2 ){

219 
	`¥ötf
(1, "panicátÅhread_join\n");

223 
	`¥ötf
(1,"\n");

225 
	}
}

230 
	$°ªs°hªadmaö
(*
¨g
)

232 
	`thªad_exô
(0);

234 
	}
}

237 
	$°ªs°e°
()

239 c⁄° 
n°ªss
 = 35000;

240 
thªad_t
 
thªads
[
NUM_THREAD
];

241 
i
, 
n
;

242 *
ªtvÆ
;

244 
n
 = 1;Ç <
n°ªss
;Ç++){

245 i‡(
n
 % 1000 == 0)

246 
	`¥ötf
(1, "%d\n", 
n
);

247 
i
 = 0; i < 
NUM_THREAD
; i++){

248 i‡(
	`thªad_¸óã
(&
thªads
[
i
], 
°ªs°hªadmaö
, (*)i) != 0){

249 
	`¥ötf
(1, "panicátÅhread_create\n");

253 
i
 = 0; i < 
NUM_THREAD
; i++){

254 i‡(
	`thªad_joö
(
thªads
[
i
], &
ªtvÆ
) != 0){

255 
	`¥ötf
(1, "panicátÅhread_join\n");

260 
	`¥ötf
(1, "\n");

262 
	}
}

	@timer.c

5 
	~"ty≥s.h
"

6 
	~"defs.h
"

7 
	~"å≠s.h
"

8 
	~"x86.h
"

10 
	#IO_TIMER1
 0x040

11 

	)

16 
	#TIMER_FREQ
 1193182

	)

17 
	#TIMER_DIV
(
x
Ë((
TIMER_FREQ
+(x)/2)/(x))

	)

19 
	#TIMER_MODE
 (
IO_TIMER1
 + 3)

20 
	#TIMER_SEL0
 0x00

21 
	#TIMER_RATEGEN
 0x04

22 
	#TIMER_16BIT
 0x30

23 

	)

25 
	$timîöô
()

28 
	`outb
(
TIMER_MODE
, 
TIMER_SEL0
 | 
TIMER_RATEGEN
 | 
TIMER_16BIT
);

29 
	`outb
(
IO_TIMER1
, 
	`TIMER_DIV
(100) % 256);

30 
	`outb
(
IO_TIMER1
, 
	`TIMER_DIV
(100) / 256);

31 
	`pi˚«bÀ
(
IRQ_TIMER
);

32 
	}
}

	@trap.c

1 
	~"ty≥s.h
"

2 
	~"defs.h
"

3 
	~"∑øm.h
"

4 
	~"memœyout.h
"

5 
	~"mmu.h
"

6 
	~"¥oc.h
"

7 
	~"x86.h
"

8 
	~"å≠s.h
"

9 
	~"•ölock.h
"

14 
g©edesc
 
	gidt
[256];

15 
uöt
 
ve˘‹s
[];

16 
•ölock
 
	gtick¶ock
;

17 
uöt
 
	gticks
;

19 
gë_time_qu™tum
();

20 
¥i‹ôy_boo°
();

22 
gë_MLFQ_tick_u£d
();

23 
ö¸ó£_MLFQ_tick_u£d
();

24 
ö¸ó£_°ride_tick_u£d
();

27 
	$tvöô
()

29 
i
;

31 
i
 = 0; i < 256; i++)

32 
	`SETGATE
(
idt
[
i
], 0, 
SEG_KCODE
<<3, 
ve˘‹s
[i], 0);

33 
	`SETGATE
(
idt
[
T_SYSCALL
], 1, 
SEG_KCODE
<<3, 
ve˘‹s
[T_SYSCALL], 
DPL_USER
);

34 
	`SETGATE
(
idt
[
T_USER_INT
], 1, 
SEG_KCODE
<<3, 
ve˘‹s
[T_USER_INT], 
DPL_USER
);

36 
	`öôlock
(&
tick¶ock
, "time");

37 
	}
}

40 
	$idtöô
()

42 
	`lidt
(
idt
, (idt));

43 
	}
}

57 
	$å≠
(
å≠‰ame
 *
tf
)

59 if(
tf
->
å≠no
 =
T_SYSCALL
){

60 if(
¥oc
->
kûÀd
)

61 
	`exô
();

62 
¥oc
->
tf
 =Åf;

63 
	`sysˇŒ
();

64 if(
¥oc
->
kûÀd
)

65 
	`exô
();

69 if(
tf
->
å≠no
 =
T_USER_INT
){

70 
	`˝rötf
("user interrupt 128 called!\n");

71 
	`exô
();

75 
tf
->
å≠no
){

76 
T_IRQ0
 + 
IRQ_TIMER
:

77 if(
	`˝unum
() == 0){

78 
	`acquúe
(&
tick¶ock
);

79 
ticks
++;

80 
	`wakeup
(&
ticks
);

81 
	`ªÀa£
(&
tick¶ock
);

83 
	`œpi˚oi
();

85 
T_IRQ0
 + 
IRQ_IDE
:

86 
	`ideöå
();

87 
	`œpi˚oi
();

89 
T_IRQ0
 + 
IRQ_IDE
+1:

92 
T_IRQ0
 + 
IRQ_KBD
:

93 
	`kbdöå
();

94 
	`œpi˚oi
();

96 
T_IRQ0
 + 
IRQ_COM1
:

97 
	`u¨töå
();

98 
	`œpi˚oi
();

100 
T_IRQ0
 + 7:

101 
T_IRQ0
 + 
IRQ_SPURIOUS
:

102 
	`˝rötf
("cpu%d: spurious interruptát %x:%x\n",

103 
	`˝unum
(), 
tf
->
cs
,Åf->
eù
);

104 
	`œpi˚oi
();

109 if(
¥oc
 =0 || (
tf
->
cs
&3) == 0){

111 
	`˝rötf
("unexpectedÅrap %d from cpu %dÉip %x (cr2=0x%x)\n",

112 
tf
->
å≠no
, 
	`˝unum
(),Åf->
eù
, 
	`r¸2
());

113 
	`∑nic
("trap");

116 
	`˝rötf
("pid %d %s:Årap %dÉrr %d on cpu %d "

118 
¥oc
->
pid
,Öroc->
«me
, 
tf
->
å≠no
,Åf->
îr
, 
	`˝unum
(),Åf->
eù
,

119 
	`r¸2
());

120 
¥oc
->
kûÀd
 = 1;

126 if(
¥oc
 &&Öroc->
kûÀd
 && (
tf
->
cs
&3Ë=
DPL_USER
)

127 
	`exô
();

135 if(
	`gë_MLFQ_tick_u£d
() >= 100){

136 #ifde‡
MJ_DEBUGGING


137 
	`˝rötf
("\n\n*** Priority Boost ***\n\n");

139 
	`¥i‹ôy_boo°
();

143 if(
¥oc
 &&Öroc->
°©e
 =
RUNNING
 && 
tf
->
å≠no
 =
T_IRQ0
+
IRQ_TIMER
){

145 
¥oc
->
tick_u£d
++;

146 
¥oc
->
time_qu™tum_u£d
++;

148 if(
¥oc
->
˝u_sh¨e
 == 0){

149 
	`ö¸ó£_MLFQ_tick_u£d
();

151 
	`ö¸ó£_°ride_tick_u£d
();

154 #ifde‡
MJ_DEBUGGING


155 
	`˝rötf
("\n\
 i¡îru± ha†bì¿occuªd. 'ticks' i†ö¸ó£d.\n\
: %d\n\
->å≠no: %d\n\
Åicks:%d\n\
_tick_u£d: %d\n\
_u£d: %d\n\
_qu™tum_u£d: %d\n",
¥oc
->
pid
, 
tf
->
å≠no
, 
ticks
,
	`gë_MLFQ_tick_u£d
(Ë,¥oc->
tick_u£d
,Öroc->
time_qu™tum_u£d
);

166 if(
¥oc
->
time_qu™tum_u£d
 >
	`gë_time_qu™tum
()){

168 #ifde‡
MJ_DEBUGGING


169 
	`˝rötf
("**********************************\n");

170 
	`˝rötf
(" Full ofÅheÅime quantum\n");

171 
	`˝rötf
(" Yield!\n");

172 
	`˝rötf
("**********************************\n");

177 if(
¥oc
->
Àvñ_of_MLFQ
 < 
NMLFQ
 - 1){

178 
¥oc
->
Àvñ_of_MLFQ
++;

182 
¥oc
->
time_qu™tum_u£d
 = 0;

183 
	`yõld
();

188 if(
¥oc
 &&Öroc->
kûÀd
 && (
tf
->
cs
&3Ë=
DPL_USER
)

189 
	`exô
();

190 
	}
}

	@trapasm.S

1 
	~"mmu.h
"

3 #ve˘‹s.
S
 
£nds
 
Æl
 
å≠s
 
hîe
.

4 .
globl
 
Æ…øps


5 
	gÆ…øps
:

6 #Buûd 
å≠
 
‰ame
.

7 
pushl
 %
ds


8 
pushl
 %
es


9 
pushl
 %
fs


10 
pushl
 %
gs


11 
pushÆ


13 #Së 
up
 
d©a
 
™d
 
≥r
-
˝u
 
£gmíts
.

14 
movw
 
$
(
SEG_KDATA
<<3), %
ax


15 
	gmovw
 %
	gax
, %
ds


16 
	gmovw
 %
	gax
, %
es


17 
movw
 
$
(
SEG_KCPU
<<3), %
ax


18 
	gmovw
 %
	gax
, %
fs


19 
	gmovw
 %
	gax
, %
	ggs


21 #CÆ»
å≠
(
tf
), 
whîe
Åf=%
e•


22 
	gpushl
 %
e•


23 
ˇŒ
 
å≠


24 
addl
 
	g$4
, %
	ge•


26 #Rëu∫ 
ÁŒs
 
through
 
to
 
å≠ªt
...

27 .
globl
 
å≠ªt


28 
	gå≠ªt
:

29 
p›Æ


30 
p›l
 %
gs


31 
p›l
 %
fs


32 
p›l
 %
es


33 
p›l
 %
ds


34 
addl
 
$0x8
, %
	ge•
 #å≠nÿ
™d
 
îrcode


35 
	gúë


	@traps.h

4 
	#T_DIVIDE
 0

5 
	#T_DEBUG
 1

6 
	#T_NMI
 2

7 
	#T_BRKPT
 3

8 
	#T_OFLOW
 4

9 
	#T_BOUND
 5

10 
	#T_ILLOP
 6

11 
	#T_DEVICE
 7

12 
	#T_DBLFLT
 8

14 
	#T_TSS
 10

15 
	#T_SEGNP
 11

16 
	#T_STACK
 12

17 
	#T_GPFLT
 13

18 
	#T_PGFLT
 14

20 
	#T_FPERR
 16

21 
	#T_ALIGN
 17

22 
	#T_MCHK
 18

23 
	#T_SIMDERR
 19

24 

	)

27 
	#T_SYSCALL
 64

28 
	#T_USER_INT
 128

29 
	#T_DEFAULT
 500

30 

	)

31 
	#T_IRQ0
 32

32 

	)

33 
	#IRQ_TIMER
 0

	)

34 
	#IRQ_KBD
 1

	)

35 
	#IRQ_COM1
 4

	)

36 
	#IRQ_IDE
 14

	)

37 
	#IRQ_ERROR
 19

	)

38 
	#IRQ_SPURIOUS
 31

	)

	@types.h

1 
	tuöt
;

2 
	tush‹t
;

3 
	tuch¨
;

4 
uöt
 
	tpde_t
;

	@uart.c

3 
	~"ty≥s.h
"

4 
	~"defs.h
"

5 
	~"∑øm.h
"

6 
	~"å≠s.h
"

7 
	~"•ölock.h
"

8 
	~"¶ì∂ock.h
"

9 
	~"fs.h
"

10 
	~"fûe.h
"

11 
	~"mmu.h
"

12 
	~"¥oc.h
"

13 
	~"x86.h
"

15 
	#COM1
 0x3f8

	)

17 
	gu¨t
;

20 
	$u¨töô
()

22 *
p
;

25 
	`outb
(
COM1
+2, 0);

28 
	`outb
(
COM1
+3, 0x80);

29 
	`outb
(
COM1
+0, 115200/9600);

30 
	`outb
(
COM1
+1, 0);

31 
	`outb
(
COM1
+3, 0x03);

32 
	`outb
(
COM1
+4, 0);

33 
	`outb
(
COM1
+1, 0x01);

36 if(
	`öb
(
COM1
+5) == 0xFF)

38 
u¨t
 = 1;

42 
	`öb
(
COM1
+2);

43 
	`öb
(
COM1
+0);

44 
	`pi˚«bÀ
(
IRQ_COM1
);

45 
	`iﬂpi˚«bÀ
(
IRQ_COM1
, 0);

48 
p
="xv6...\n"; *p;Ö++)

49 
	`u¨çutc
(*
p
);

50 
	}
}

53 
	$u¨çutc
(
c
)

55 
i
;

57 if(!
u¨t
)

59 
i
 = 0; i < 128 && !(
	`öb
(
COM1
+5) & 0x20); i++)

60 
	`mi¸odñay
(10);

61 
	`outb
(
COM1
+0, 
c
);

62 
	}
}

65 
	$u¨tgëc
()

67 if(!
u¨t
)

69 if(!(
	`öb
(
COM1
+5) & 0x01))

71  
	`öb
(
COM1
+0);

72 
	}
}

75 
	$u¨töå
()

77 
	`c⁄sﬁeöå
(
u¨tgëc
);

78 
	}
}

	@ulib.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"f˙é.h
"

4 
	~"u£r.h
"

5 
	~"x86.h
"

8 
	$°r˝y
(*
s
, *
t
)

10 *
os
;

12 
os
 = 
s
;

13 (*
s
++ = *
t
++) != 0)

15  
os
;

16 
	}
}

19 
	$°rcmp
(c⁄° *
p
, c⁄° *
q
)

21 *
p
 && *∞=*
q
)

22 
p
++, 
q
++;

23  (
uch¨
)*
p
 - (uch¨)*
q
;

24 
	}
}

26 
uöt


27 
	$°æí
(*
s
)

29 
n
;

31 
n
 = 0; 
s
[n];Ç++)

33  
n
;

34 
	}
}

37 
	$mem£t
(*
d°
, 
c
, 
uöt
 
n
)

39 
	`°osb
(
d°
, 
c
, 
n
);

40  
d°
;

41 
	}
}

44 
	$°rchr
(c⁄° *
s
, 
c
)

46 ; *
s
; s++)

47 if(*
s
 =
c
)

48  (*)
s
;

50 
	}
}

53 
	$gës
(*
buf
, 
max
)

55 
i
, 
cc
;

56 
c
;

58 
i
=0; i+1 < 
max
; ){

59 
cc
 = 
	`ªad
(0, &
c
, 1);

60 if(
cc
 < 1)

62 
buf
[
i
++] = 
c
;

63 if(
c
 == '\n' || c == '\r')

66 
buf
[
i
] = '\0';

67  
buf
;

68 
	}
}

71 
	$°©
(*
n
, 
°©
 *
°
)

73 
fd
;

74 
r
;

76 
fd
 = 
	`›í
(
n
, 
O_RDONLY
);

77 if(
fd
 < 0)

79 
r
 = 
	`f°©
(
fd
, 
°
);

80 
	`˛o£
(
fd
);

81  
r
;

82 
	}
}

85 
	$©oi
(c⁄° *
s
)

87 
n
;

89 
n
 = 0;

90 '0' <*
s
 && *s <= '9')

91 
n
 =Ç*10 + *
s
++ - '0';

92  
n
;

93 
	}
}

96 
	$memmove
(*
vd°
, *
v§c
, 
n
)

98 *
d°
, *
§c
;

100 
d°
 = 
vd°
;

101 
§c
 = 
v§c
;

102 
n
-- > 0)

103 *
d°
++ = *
§c
++;

104  
vd°
;

105 
	}
}

	@umalloc.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

4 
	~"∑øm.h
"

9 
	tAlign
;

11 
	uhódî
 {

13 
hódî
 *
	m±r
;

14 
uöt
 
	msize
;

15 } 
	ms
;

16 
Align
 
	mx
;

19 
hódî
 
	tHódî
;

21 
Hódî
 
	gba£
;

22 
Hódî
 *
	g‰ìp
;

25 
	$‰ì
(*
≠
)

27 
Hódî
 *
bp
, *
p
;

29 
bp
 = (
Hódî
*)
≠
 - 1;

30 
p
 = 
‰ìp
; !(
bp
 >Ö && b∞<Ö->
s
.
±r
);Ö =Ö->s.ptr)

31 if(
p
 >p->
s
.
±r
 && (
bp
 >Ö || bp <Ö->s.ptr))

33 if(
bp
 + bp->
s
.
size
 =
p
->s.
±r
){

34 
bp
->
s
.
size
 +
p
->s.
±r
->s.size;

35 
bp
->
s
.
±r
 = 
p
->s.ptr->s.ptr;

37 
bp
->
s
.
±r
 = 
p
->s.ptr;

38 if(
p
 +Ö->
s
.
size
 =
bp
){

39 
p
->
s
.
size
 +
bp
->s.size;

40 
p
->
s
.
±r
 = 
bp
->s.ptr;

42 
p
->
s
.
±r
 = 
bp
;

43 
‰ìp
 = 
p
;

44 
	}
}

46 
Hódî
*

47 
	$m‹ec‹e
(
uöt
 
nu
)

49 *
p
;

50 
Hódî
 *
hp
;

52 if(
nu
 < 4096)

53 
nu
 = 4096;

54 
p
 = 
	`sbrk
(
nu
 * (
Hódî
));

55 if(
p
 == (*)-1)

57 
hp
 = (
Hódî
*)
p
;

58 
hp
->
s
.
size
 = 
nu
;

59 
	`‰ì
((*)(
hp
 + 1));

60  
‰ìp
;

61 
	}
}

64 
	$mÆloc
(
uöt
 
nbyãs
)

66 
Hódî
 *
p
, *
¥evp
;

67 
uöt
 
nunôs
;

69 
nunôs
 = (
nbyãs
 + (
Hódî
) - 1)/(Header) + 1;

70 if((
¥evp
 = 
‰ìp
) == 0){

71 
ba£
.
s
.
±r
 = 
‰ìp
 = 
¥evp
 = &base;

72 
ba£
.
s
.
size
 = 0;

74 
p
 = 
¥evp
->
s
.
±r
; ;Örevp =Ö,Ö =Ö->s.ptr){

75 if(
p
->
s
.
size
 >
nunôs
){

76 if(
p
->
s
.
size
 =
nunôs
)

77 
¥evp
->
s
.
±r
 = 
p
->s.ptr;

79 
p
->
s
.
size
 -
nunôs
;

80 
p
 +p->
s
.
size
;

81 
p
->
s
.
size
 = 
nunôs
;

83 
‰ìp
 = 
¥evp
;

84  (*)(
p
 + 1);

86 if(
p
 =
‰ìp
)

87 if((
p
 = 
	`m‹ec‹e
(
nunôs
)) == 0)

90 
	}
}

	@user.h

1 
	g°©
;

2 
	gπcd©e
;

5 
f‹k
();

6 
	$exô
(Ë
	`__©åibuã__
((
n‹ëu∫
));

7 
	`waô
();

8 
	`pùe
(*);

9 
	`wrôe
(, *, );

10 
	`ªad
(, *, );

11 
	`˛o£
();

12 
	`kûl
();

13 
	`exec
(*, **);

14 
	`›í
(*, );

15 
	`mknod
(*, , );

16 
	`u∆ök
(*);

17 
	`f°©
(
fd
, 
°©
*);

18 
	`lök
(*, *);

19 
	`mkdú
(*);

20 
	`chdú
(*);

21 
	`dup
();

22 
	`gëpid
();

23 * 
	`sbrk
();

24 
	`¶ìp
();

25 
	`u±ime
();

26 
	`my_sysˇŒ
(*);

27 
	`gëµid
();

28 
	`yõld
();

29 
	`gëÀv
();

30 
	`£t_˝u_sh¨e
();

33 
	`°©
(*, 
°©
*);

34 * 
	`°r˝y
(*, *);

35 *
	`memmove
(*, *, );

36 * 
	`°rchr
(c⁄° *, 
c
);

37 
	`°rcmp
(const *, const *);

38 
	`¥ötf
(, *, ...);

39 * 
	`gës
(*, 
max
);

40 
uöt
 
	`°æí
(*);

41 * 
	`mem£t
(*, , 
uöt
);

42 * 
	`mÆloc
(
uöt
);

43 
	`‰ì
(*);

44 
	`©oi
(const *);

	@usertests.c

1 
	~"∑øm.h
"

2 
	~"ty≥s.h
"

3 
	~"°©.h
"

4 
	~"u£r.h
"

5 
	~"fs.h
"

6 
	~"f˙é.h
"

7 
	~"sysˇŒ.h
"

8 
	~"å≠s.h
"

9 
	~"memœyout.h
"

11 
	gbuf
[8192];

12 
	g«me
[3];

13 *
	gechﬂrgv
[] = { "echo", "ALL", "TESTS", "PASSED", 0 };

14 
	g°dout
 = 1;

18 
	$ùuâe°
()

20 
	`¥ötf
(
°dout
, "iputÅest\n");

22 if(
	`mkdú
("iputdir") < 0){

23 
	`¥ötf
(
°dout
, "mkdir failed\n");

24 
	`exô
();

26 if(
	`chdú
("iputdir") < 0){

27 
	`¥ötf
(
°dout
, "chdir iputdir failed\n");

28 
	`exô
();

30 if(
	`u∆ök
("../iputdir") < 0){

31 
	`¥ötf
(
°dout
, "unlink ../iputdir failed\n");

32 
	`exô
();

34 if(
	`chdú
("/") < 0){

35 
	`¥ötf
(
°dout
, "chdir / failed\n");

36 
	`exô
();

38 
	`¥ötf
(
°dout
, "iputÅest ok\n");

39 
	}
}

43 
	$exôùuâe°
()

45 
pid
;

47 
	`¥ötf
(
°dout
, "exitiputÅest\n");

49 
pid
 = 
	`f‹k
();

50 if(
pid
 < 0){

51 
	`¥ötf
(
°dout
, "fork failed\n");

52 
	`exô
();

54 if(
pid
 == 0){

55 if(
	`mkdú
("iputdir") < 0){

56 
	`¥ötf
(
°dout
, "mkdir failed\n");

57 
	`exô
();

59 if(
	`chdú
("iputdir") < 0){

60 
	`¥ötf
(
°dout
, "child chdir failed\n");

61 
	`exô
();

63 if(
	`u∆ök
("../iputdir") < 0){

64 
	`¥ötf
(
°dout
, "unlink ../iputdir failed\n");

65 
	`exô
();

67 
	`exô
();

69 
	`waô
();

70 
	`¥ötf
(
°dout
, "exitiputÅest ok\n");

71 
	}
}

85 
	$›íùuâe°
()

87 
pid
;

89 
	`¥ötf
(
°dout
, "openiputÅest\n");

90 if(
	`mkdú
("oidir") < 0){

91 
	`¥ötf
(
°dout
, "mkdir oidir failed\n");

92 
	`exô
();

94 
pid
 = 
	`f‹k
();

95 if(
pid
 < 0){

96 
	`¥ötf
(
°dout
, "fork failed\n");

97 
	`exô
();

99 if(
pid
 == 0){

100 
fd
 = 
	`›í
("oidú", 
O_RDWR
);

101 if(
fd
 >= 0){

102 
	`¥ötf
(
°dout
, "open directory for write succeeded\n");

103 
	`exô
();

105 
	`exô
();

107 
	`¶ìp
(1);

108 if(
	`u∆ök
("oidir") != 0){

109 
	`¥ötf
(
°dout
, "unlink failed\n");

110 
	`exô
();

112 
	`waô
();

113 
	`¥ötf
(
°dout
, "openiputÅest ok\n");

114 
	}
}

119 
	$›íã°
()

121 
fd
;

123 
	`¥ötf
(
°dout
, "openÅest\n");

124 
fd
 = 
	`›í
("echo", 0);

125 if(
fd
 < 0){

126 
	`¥ötf
(
°dout
, "openÉcho failed!\n");

127 
	`exô
();

129 
	`˛o£
(
fd
);

130 
fd
 = 
	`›í
("doesnotexist", 0);

131 if(
fd
 >= 0){

132 
	`¥ötf
(
°dout
, "open doesnotexist succeeded!\n");

133 
	`exô
();

135 
	`¥ötf
(
°dout
, "openÅest ok\n");

136 
	}
}

139 
	$wrôëe°
()

141 
fd
;

142 
i
;

144 
	`¥ötf
(
°dout
, "small fileÅest\n");

145 
fd
 = 
	`›í
("smÆl", 
O_CREATE
|
O_RDWR
);

146 if(
fd
 >= 0){

147 
	`¥ötf
(
°dout
, "creat small succeeded; ok\n");

149 
	`¥ötf
(
°dout
, "error: creat small failed!\n");

150 
	`exô
();

152 
i
 = 0; i < 100; i++){

153 if(
	`wrôe
(
fd
, "aaaaaaaaaa", 10) != 10){

154 
	`¥ötf
(
°dout
, "îr‹: wrôêØ %dÇew fûêÁûed\n", 
i
);

155 
	`exô
();

157 if(
	`wrôe
(
fd
, "bbbbbbbbbb", 10) != 10){

158 
	`¥ötf
(
°dout
, "îr‹: wrôêbb %dÇew fûêÁûed\n", 
i
);

159 
	`exô
();

162 
	`¥ötf
(
°dout
, "writes ok\n");

163 
	`˛o£
(
fd
);

164 
fd
 = 
	`›í
("smÆl", 
O_RDONLY
);

165 if(
fd
 >= 0){

166 
	`¥ötf
(
°dout
, "open small succeeded ok\n");

168 
	`¥ötf
(
°dout
, "error: open small failed!\n");

169 
	`exô
();

171 
i
 = 
	`ªad
(
fd
, 
buf
, 2000);

172 if(
i
 == 2000){

173 
	`¥ötf
(
°dout
, "read succeeded ok\n");

175 
	`¥ötf
(
°dout
, "read failed\n");

176 
	`exô
();

178 
	`˛o£
(
fd
);

180 if(
	`u∆ök
("small") < 0){

181 
	`¥ötf
(
°dout
, "unlink small failed\n");

182 
	`exô
();

184 
	`¥ötf
(
°dout
, "small fileÅest ok\n");

185 
	}
}

188 
	$wrôëe°1
()

190 
i
, 
fd
, 
n
;

192 
	`¥ötf
(
°dout
, "big filesÅest\n");

194 
fd
 = 
	`›í
("big", 
O_CREATE
|
O_RDWR
);

195 if(
fd
 < 0){

196 
	`¥ötf
(
°dout
, "error: creat big failed!\n");

197 
	`exô
();

200 
i
 = 0; i < 
MAXFILE
; i++){

201 ((*)
buf
)[0] = 
i
;

202 if(
	`wrôe
(
fd
, 
buf
, 512) != 512){

203 
	`¥ötf
(
°dout
, "îr‹: wrôêbig fûêÁûed\n", 
i
);

204 
	`exô
();

208 
	`˛o£
(
fd
);

210 
fd
 = 
	`›í
("big", 
O_RDONLY
);

211 if(
fd
 < 0){

212 
	`¥ötf
(
°dout
, "error: open big failed!\n");

213 
	`exô
();

216 
n
 = 0;

218 
i
 = 
	`ªad
(
fd
, 
buf
, 512);

219 if(
i
 == 0){

220 if(
n
 =
MAXFILE
 - 1){

221 
	`¥ötf
(
°dout
, "ªad o∆y %d block†‰om big", 
n
);

222 
	`exô
();

225 } if(
i
 != 512){

226 
	`¥ötf
(
°dout
, "ªad faûed %d\n", 
i
);

227 
	`exô
();

229 if(((*)
buf
)[0] !
n
){

230 
	`¥ötf
(
°dout
, "read content of block %d is %d\n",

231 
n
, ((*)
buf
)[0]);

232 
	`exô
();

234 
n
++;

236 
	`˛o£
(
fd
);

237 if(
	`u∆ök
("big") < 0){

238 
	`¥ötf
(
°dout
, "unlink big failed\n");

239 
	`exô
();

241 
	`¥ötf
(
°dout
, "big files ok\n");

242 
	}
}

245 
	$¸óãã°
()

247 
i
, 
fd
;

249 
	`¥ötf
(
°dout
, "many creates, followed by unlinkÅest\n");

251 
«me
[0] = 'a';

252 
«me
[2] = '\0';

253 
i
 = 0; i < 52; i++){

254 
«me
[1] = '0' + 
i
;

255 
fd
 = 
	`›í
(
«me
, 
O_CREATE
|
O_RDWR
);

256 
	`˛o£
(
fd
);

258 
«me
[0] = 'a';

259 
«me
[2] = '\0';

260 
i
 = 0; i < 52; i++){

261 
«me
[1] = '0' + 
i
;

262 
	`u∆ök
(
«me
);

264 
	`¥ötf
(
°dout
, "many creates, followed by unlink; ok\n");

265 
	}
}

267 
	$dúã°
()

269 
	`¥ötf
(
°dout
, "mkdirÅest\n");

271 if(
	`mkdú
("dir0") < 0){

272 
	`¥ötf
(
°dout
, "mkdir failed\n");

273 
	`exô
();

276 if(
	`chdú
("dir0") < 0){

277 
	`¥ötf
(
°dout
, "chdir dir0 failed\n");

278 
	`exô
();

281 if(
	`chdú
("..") < 0){

282 
	`¥ötf
(
°dout
, "chdir .. failed\n");

283 
	`exô
();

286 if(
	`u∆ök
("dir0") < 0){

287 
	`¥ötf
(
°dout
, "unlink dir0 failed\n");

288 
	`exô
();

290 
	`¥ötf
(
°dout
, "mkdirÅest ok\n");

291 
	}
}

294 
	$exe˘e°
()

296 
	`¥ötf
(
°dout
, "execÅest\n");

297 if(
	`exec
("echo", 
echﬂrgv
) < 0){

298 
	`¥ötf
(
°dout
, "execÉcho failed\n");

299 
	`exô
();

301 
	}
}

306 
	$pùe1
()

308 
fds
[2], 
pid
;

309 
£q
, 
i
, 
n
, 
cc
, 
tŸÆ
;

311 if(
	`pùe
(
fds
) != 0){

312 
	`¥ötf
(1, "pipe() failed\n");

313 
	`exô
();

315 
pid
 = 
	`f‹k
();

316 
£q
 = 0;

317 if(
pid
 == 0){

318 
	`˛o£
(
fds
[0]);

319 
n
 = 0;Ç < 5;Ç++){

320 
i
 = 0; i < 1033; i++)

321 
buf
[
i
] = 
£q
++;

322 if(
	`wrôe
(
fds
[1], 
buf
, 1033) != 1033){

323 
	`¥ötf
(1, "pipe1 oops 1\n");

324 
	`exô
();

327 
	`exô
();

328 } if(
pid
 > 0){

329 
	`˛o£
(
fds
[1]);

330 
tŸÆ
 = 0;

331 
cc
 = 1;

332 (
n
 = 
	`ªad
(
fds
[0], 
buf
, 
cc
)) > 0){

333 
i
 = 0; i < 
n
; i++){

334 if((
buf
[
i
] & 0xffË!(
£q
++ & 0xff)){

335 
	`¥ötf
(1, "pipe1 oops 2\n");

339 
tŸÆ
 +
n
;

340 
cc
 = cc * 2;

341 if(
cc
 > (
buf
))

342 
cc
 = (
buf
);

344 if(
tŸÆ
 != 5 * 1033){

345 
	`¥ötf
(1, "pùe1 o›†3ÅŸÆ %d\n", 
tŸÆ
);

346 
	`exô
();

348 
	`˛o£
(
fds
[0]);

349 
	`waô
();

351 
	`¥ötf
(1, "fork() failed\n");

352 
	`exô
();

354 
	`¥ötf
(1, "pipe1 ok\n");

355 
	}
}

359 
	$¥ìm±
()

361 
pid1
, 
pid2
, 
pid3
;

362 
pfds
[2];

364 
	`¥ötf
(1, "preempt: ");

365 
pid1
 = 
	`f‹k
();

366 if(
pid1
 == 0)

370 
pid2
 = 
	`f‹k
();

371 if(
pid2
 == 0)

375 
	`pùe
(
pfds
);

376 
pid3
 = 
	`f‹k
();

377 if(
pid3
 == 0){

378 
	`˛o£
(
pfds
[0]);

379 if(
	`wrôe
(
pfds
[1], "x", 1) != 1)

380 
	`¥ötf
(1, "preempt writeÉrror");

381 
	`˛o£
(
pfds
[1]);

386 
	`˛o£
(
pfds
[1]);

387 if(
	`ªad
(
pfds
[0], 
buf
, (buf)) != 1){

388 
	`¥ötf
(1, "preemptÑeadÉrror");

391 
	`˛o£
(
pfds
[0]);

392 
	`¥ötf
(1, "kill... ");

393 
	`kûl
(
pid1
);

394 
	`kûl
(
pid2
);

395 
	`kûl
(
pid3
);

396 
	`¥ötf
(1, "wait... ");

397 
	`waô
();

398 
	`waô
();

399 
	`waô
();

400 
	`¥ötf
(1, "preempt ok\n");

401 
	}
}

405 
	$exôwaô
()

407 
i
, 
pid
;

409 
i
 = 0; i < 100; i++){

410 
pid
 = 
	`f‹k
();

411 if(
pid
 < 0){

412 
	`¥ötf
(1, "fork failed\n");

415 if(
pid
){

416 if(
	`waô
(Ë!
pid
){

417 
	`¥ötf
(1, "wait wrongÖid\n");

421 
	`exô
();

424 
	`¥ötf
(1, "exitwait ok\n");

425 
	}
}

428 
	$mem
()

430 *
m1
, *
m2
;

431 
pid
, 
µid
;

433 
	`¥ötf
(1, "memÅest\n");

434 
µid
 = 
	`gëpid
();

435 if((
pid
 = 
	`f‹k
()) == 0){

436 
m1
 = 0;

437 (
m2
 = 
	`mÆloc
(10001)) != 0){

438 *(**)
m2
 = 
m1
;

439 
m1
 = 
m2
;

441 
m1
){

442 
m2
 = *(**)
m1
;

443 
	`‰ì
(
m1
);

444 
m1
 = 
m2
;

446 
m1
 = 
	`mÆloc
(1024*20);

447 if(
m1
 == 0){

448 
	`¥ötf
(1, "couldn'tállocate mem?!!\n");

449 
	`kûl
(
µid
);

450 
	`exô
();

452 
	`‰ì
(
m1
);

453 
	`¥ötf
(1, "mem ok\n");

454 
	`exô
();

456 
	`waô
();

458 
	}
}

465 
	$sh¨edfd
()

467 
fd
, 
pid
, 
i
, 
n
, 
nc
, 
≈
;

468 
buf
[10];

470 
	`¥ötf
(1, "sharedfdÅest\n");

472 
	`u∆ök
("sharedfd");

473 
fd
 = 
	`›í
("sh¨edfd", 
O_CREATE
|
O_RDWR
);

474 if(
fd
 < 0){

475 
	`¥ötf
(1, "fstests: cannot open sharedfd for writing");

478 
pid
 = 
	`f‹k
();

479 
	`mem£t
(
buf
, 
pid
==0?'c':'p', (buf));

480 
i
 = 0; i < 1000; i++){

481 if(
	`wrôe
(
fd
, 
buf
, (buf)) != (buf)){

482 
	`¥ötf
(1, "fstests: write sharedfd failed\n");

486 if(
pid
 == 0)

487 
	`exô
();

489 
	`waô
();

490 
	`˛o£
(
fd
);

491 
fd
 = 
	`›í
("sharedfd", 0);

492 if(
fd
 < 0){

493 
	`¥ötf
(1, "fstests: cannot open sharedfd forÑeading\n");

496 
nc
 = 
≈
 = 0;

497 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0){

498 
i
 = 0; i < (
buf
); i++){

499 if(
buf
[
i
] == 'c')

500 
nc
++;

501 if(
buf
[
i
] == 'p')

502 
≈
++;

505 
	`˛o£
(
fd
);

506 
	`u∆ök
("sharedfd");

507 if(
nc
 =10000 && 
≈
 == 10000){

508 
	`¥ötf
(1, "sharedfd ok\n");

510 
	`¥ötf
(1, "sh¨edfd o›†%d %d\n", 
nc
, 
≈
);

511 
	`exô
();

513 
	}
}

518 
	$fourfûes
()

520 
fd
, 
pid
, 
i
, 
j
, 
n
, 
tŸÆ
, 
pi
;

521 *
«mes
[] = { "f0", "f1", "f2", "f3" };

522 *
‚ame
;

524 
	`¥ötf
(1, "fourfilesÅest\n");

526 
pi
 = 0;Öi < 4;Öi++){

527 
‚ame
 = 
«mes
[
pi
];

528 
	`u∆ök
(
‚ame
);

530 
pid
 = 
	`f‹k
();

531 if(
pid
 < 0){

532 
	`¥ötf
(1, "fork failed\n");

533 
	`exô
();

536 if(
pid
 == 0){

537 
fd
 = 
	`›í
(
‚ame
, 
O_CREATE
 | 
O_RDWR
);

538 if(
fd
 < 0){

539 
	`¥ötf
(1, "create failed\n");

540 
	`exô
();

543 
	`mem£t
(
buf
, '0'+
pi
, 512);

544 
i
 = 0; i < 12; i++){

545 if((
n
 = 
	`wrôe
(
fd
, 
buf
, 500)) != 500){

546 
	`¥ötf
(1, "wrôêÁûed %d\n", 
n
);

547 
	`exô
();

550 
	`exô
();

554 
pi
 = 0;Öi < 4;Öi++){

555 
	`waô
();

558 
i
 = 0; i < 2; i++){

559 
‚ame
 = 
«mes
[
i
];

560 
fd
 = 
	`›í
(
‚ame
, 0);

561 
tŸÆ
 = 0;

562 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0){

563 
j
 = 0; j < 
n
; j++){

564 if(
buf
[
j
] !'0'+
i
){

565 
	`¥ötf
(1, "wrong char\n");

566 
	`exô
();

569 
tŸÆ
 +
n
;

571 
	`˛o£
(
fd
);

572 if(
tŸÆ
 != 12*500){

573 
	`¥ötf
(1, "wr⁄gÜígth %d\n", 
tŸÆ
);

574 
	`exô
();

576 
	`u∆ök
(
‚ame
);

579 
	`¥ötf
(1, "fourfiles ok\n");

580 
	}
}

584 
	$¸óãdñëe
()

586 íum { 
N
 = 20 };

587 
pid
, 
i
, 
fd
, 
pi
;

588 
«me
[32];

590 
	`¥ötf
(1, "createdeleteÅest\n");

592 
pi
 = 0;Öi < 4;Öi++){

593 
pid
 = 
	`f‹k
();

594 if(
pid
 < 0){

595 
	`¥ötf
(1, "fork failed\n");

596 
	`exô
();

599 if(
pid
 == 0){

600 
«me
[0] = 'p' + 
pi
;

601 
«me
[2] = '\0';

602 
i
 = 0; i < 
N
; i++){

603 
«me
[1] = '0' + 
i
;

604 
fd
 = 
	`›í
(
«me
, 
O_CREATE
 | 
O_RDWR
);

605 if(
fd
 < 0){

606 
	`¥ötf
(1, "create failed\n");

607 
	`exô
();

609 
	`˛o£
(
fd
);

610 if(
i
 > 0 && (i % 2 ) == 0){

611 
«me
[1] = '0' + (
i
 / 2);

612 if(
	`u∆ök
(
«me
) < 0){

613 
	`¥ötf
(1, "unlink failed\n");

614 
	`exô
();

618 
	`exô
();

622 
pi
 = 0;Öi < 4;Öi++){

623 
	`waô
();

626 
«me
[0] =Çame[1] =Çame[2] = 0;

627 
i
 = 0; i < 
N
; i++){

628 
pi
 = 0;Öi < 4;Öi++){

629 
«me
[0] = 'p' + 
pi
;

630 
«me
[1] = '0' + 
i
;

631 
fd
 = 
	`›í
(
«me
, 0);

632 if((
i
 =0 || i >
N
/2Ë&& 
fd
 < 0){

633 
	`¥ötf
(1, "o›†¸óãdñëê%†didn'àexi°\n", 
«me
);

634 
	`exô
();

635 } if((
i
 >1 && i < 
N
/2Ë&& 
fd
 >= 0){

636 
	`¥ötf
(1, "o›†¸óãdñëê%†didÉxi°\n", 
«me
);

637 
	`exô
();

639 if(
fd
 >= 0)

640 
	`˛o£
(
fd
);

644 
i
 = 0; i < 
N
; i++){

645 
pi
 = 0;Öi < 4;Öi++){

646 
«me
[0] = 'p' + 
i
;

647 
«me
[1] = '0' + 
i
;

648 
	`u∆ök
(
«me
);

652 
	`¥ötf
(1, "createdelete ok\n");

653 
	}
}

657 
	$u∆ökªad
()

659 
fd
, 
fd1
;

661 
	`¥ötf
(1, "unlinkreadÅest\n");

662 
fd
 = 
	`›í
("u∆ökªad", 
O_CREATE
 | 
O_RDWR
);

663 if(
fd
 < 0){

664 
	`¥ötf
(1, "create unlinkread failed\n");

665 
	`exô
();

667 
	`wrôe
(
fd
, "hello", 5);

668 
	`˛o£
(
fd
);

670 
fd
 = 
	`›í
("u∆ökªad", 
O_RDWR
);

671 if(
fd
 < 0){

672 
	`¥ötf
(1, "open unlinkread failed\n");

673 
	`exô
();

675 if(
	`u∆ök
("unlinkread") != 0){

676 
	`¥ötf
(1, "unlink unlinkread failed\n");

677 
	`exô
();

680 
fd1
 = 
	`›í
("u∆ökªad", 
O_CREATE
 | 
O_RDWR
);

681 
	`wrôe
(
fd1
, "yyy", 3);

682 
	`˛o£
(
fd1
);

684 if(
	`ªad
(
fd
, 
buf
, (buf)) != 5){

685 
	`¥ötf
(1, "unlinkreadÑead failed");

686 
	`exô
();

688 if(
buf
[0] != 'h'){

689 
	`¥ötf
(1, "unlinkread wrong data\n");

690 
	`exô
();

692 if(
	`wrôe
(
fd
, 
buf
, 10) != 10){

693 
	`¥ötf
(1, "unlinkread write failed\n");

694 
	`exô
();

696 
	`˛o£
(
fd
);

697 
	`u∆ök
("unlinkread");

698 
	`¥ötf
(1, "unlinkread ok\n");

699 
	}
}

702 
	$lökã°
()

704 
fd
;

706 
	`¥ötf
(1, "linktest\n");

708 
	`u∆ök
("lf1");

709 
	`u∆ök
("lf2");

711 
fd
 = 
	`›í
("lf1", 
O_CREATE
|
O_RDWR
);

712 if(
fd
 < 0){

713 
	`¥ötf
(1, "createÜf1 failed\n");

714 
	`exô
();

716 if(
	`wrôe
(
fd
, "hello", 5) != 5){

717 
	`¥ötf
(1, "writeÜf1 failed\n");

718 
	`exô
();

720 
	`˛o£
(
fd
);

722 if(
	`lök
("lf1", "lf2") < 0){

723 
	`¥ötf
(1, "linkÜf1Üf2 failed\n");

724 
	`exô
();

726 
	`u∆ök
("lf1");

728 if(
	`›í
("lf1", 0) >= 0){

729 
	`¥ötf
(1, "unlinkedÜf1 but it is stillÅhere!\n");

730 
	`exô
();

733 
fd
 = 
	`›í
("lf2", 0);

734 if(
fd
 < 0){

735 
	`¥ötf
(1, "openÜf2 failed\n");

736 
	`exô
();

738 if(
	`ªad
(
fd
, 
buf
, (buf)) != 5){

739 
	`¥ötf
(1, "readÜf2 failed\n");

740 
	`exô
();

742 
	`˛o£
(
fd
);

744 if(
	`lök
("lf2", "lf2") >= 0){

745 
	`¥ötf
(1, "linkÜf2Üf2 succeeded! oops\n");

746 
	`exô
();

749 
	`u∆ök
("lf2");

750 if(
	`lök
("lf2", "lf1") >= 0){

751 
	`¥ötf
(1, "linkÇon-existant succeeded! oops\n");

752 
	`exô
();

755 if(
	`lök
(".", "lf1") >= 0){

756 
	`¥ötf
(1, "link .Üf1 succeeded! oops\n");

757 
	`exô
();

760 
	`¥ötf
(1, "linktest ok\n");

761 
	}
}

765 
	$c⁄¸óã
()

767 
fûe
[3];

768 
i
, 
pid
, 
n
, 
fd
;

769 
Á
[40];

771 
ush‹t
 
öum
;

772 
«me
[14];

773 } 
de
;

775 
	`¥ötf
(1, "concreateÅest\n");

776 
fûe
[0] = 'C';

777 
fûe
[2] = '\0';

778 
i
 = 0; i < 40; i++){

779 
fûe
[1] = '0' + 
i
;

780 
	`u∆ök
(
fûe
);

781 
pid
 = 
	`f‹k
();

782 if(
pid
 && (
i
 % 3) == 1){

783 
	`lök
("C0", 
fûe
);

784 } if(
pid
 =0 && (
i
 % 5) == 1){

785 
	`lök
("C0", 
fûe
);

787 
fd
 = 
	`›í
(
fûe
, 
O_CREATE
 | 
O_RDWR
);

788 if(
fd
 < 0){

789 
	`¥ötf
(1, "c⁄¸óã cª©ê%†Áûed\n", 
fûe
);

790 
	`exô
();

792 
	`˛o£
(
fd
);

794 if(
pid
 == 0)

795 
	`exô
();

797 
	`waô
();

800 
	`mem£t
(
Á
, 0, (fa));

801 
fd
 = 
	`›í
(".", 0);

802 
n
 = 0;

803 
	`ªad
(
fd
, &
de
, (de)) > 0){

804 if(
de
.
öum
 == 0)

806 if(
de
.
«me
[0] == 'C' && de.name[2] == '\0'){

807 
i
 = 
de
.
«me
[1] - '0';

808 if(
i
 < 0 || i >(
Á
)){

809 
	`¥ötf
(1, "c⁄¸óã weúd fûê%s\n", 
de
.
«me
);

810 
	`exô
();

812 if(
Á
[
i
]){

813 
	`¥ötf
(1, "c⁄¸óã du∂iˇã fûê%s\n", 
de
.
«me
);

814 
	`exô
();

816 
Á
[
i
] = 1;

817 
n
++;

820 
	`˛o£
(
fd
);

822 if(
n
 != 40){

823 
	`¥ötf
(1, "concreateÇotÉnough files in directoryÜisting\n");

824 
	`exô
();

827 
i
 = 0; i < 40; i++){

828 
fûe
[1] = '0' + 
i
;

829 
pid
 = 
	`f‹k
();

830 if(
pid
 < 0){

831 
	`¥ötf
(1, "fork failed\n");

832 
	`exô
();

834 if(((
i
 % 3Ë=0 && 
pid
 == 0) ||

835 ((
i
 % 3Ë=1 && 
pid
 != 0)){

836 
	`˛o£
(
	`›í
(
fûe
, 0));

837 
	`˛o£
(
	`›í
(
fûe
, 0));

838 
	`˛o£
(
	`›í
(
fûe
, 0));

839 
	`˛o£
(
	`›í
(
fûe
, 0));

841 
	`u∆ök
(
fûe
);

842 
	`u∆ök
(
fûe
);

843 
	`u∆ök
(
fûe
);

844 
	`u∆ök
(
fûe
);

846 if(
pid
 == 0)

847 
	`exô
();

849 
	`waô
();

852 
	`¥ötf
(1, "concreate ok\n");

853 
	}
}

858 
	$löku∆ök
()

860 
pid
, 
i
;

862 
	`¥ötf
(1, "linkunlinkÅest\n");

864 
	`u∆ök
("x");

865 
pid
 = 
	`f‹k
();

866 if(
pid
 < 0){

867 
	`¥ötf
(1, "fork failed\n");

868 
	`exô
();

871 
x
 = (
pid
 ? 1 : 97);

872 
i
 = 0; i < 100; i++){

873 
x
 = x * 1103515245 + 12345;

874 if((
x
 % 3) == 0){

875 
	`˛o£
(
	`›í
("x", 
O_RDWR
 | 
O_CREATE
));

876 } if((
x
 % 3) == 1){

877 
	`lök
("cat", "x");

879 
	`u∆ök
("x");

883 if(
pid
)

884 
	`waô
();

886 
	`exô
();

888 
	`¥ötf
(1, "linkunlink ok\n");

889 
	}
}

893 
	$bigdú
()

895 
i
, 
fd
;

896 
«me
[10];

898 
	`¥ötf
(1, "bigdirÅest\n");

899 
	`u∆ök
("bd");

901 
fd
 = 
	`›í
("bd", 
O_CREATE
);

902 if(
fd
 < 0){

903 
	`¥ötf
(1, "bigdir create failed\n");

904 
	`exô
();

906 
	`˛o£
(
fd
);

908 
i
 = 0; i < 500; i++){

909 
«me
[0] = 'x';

910 
«me
[1] = '0' + (
i
 / 64);

911 
«me
[2] = '0' + (
i
 % 64);

912 
«me
[3] = '\0';

913 if(
	`lök
("bd", 
«me
) != 0){

914 
	`¥ötf
(1, "bigdirÜink failed\n");

915 
	`exô
();

919 
	`u∆ök
("bd");

920 
i
 = 0; i < 500; i++){

921 
«me
[0] = 'x';

922 
«me
[1] = '0' + (
i
 / 64);

923 
«me
[2] = '0' + (
i
 % 64);

924 
«me
[3] = '\0';

925 if(
	`u∆ök
(
«me
) != 0){

926 
	`¥ötf
(1, "bigdir unlink failed");

927 
	`exô
();

931 
	`¥ötf
(1, "bigdir ok\n");

932 
	}
}

935 
	$subdú
()

937 
fd
, 
cc
;

939 
	`¥ötf
(1, "subdirÅest\n");

941 
	`u∆ök
("ff");

942 if(
	`mkdú
("dd") != 0){

943 
	`¥ötf
(1, "subdir mkdir dd failed\n");

944 
	`exô
();

947 
fd
 = 
	`›í
("dd/ff", 
O_CREATE
 | 
O_RDWR
);

948 if(
fd
 < 0){

949 
	`¥ötf
(1, "create dd/ff failed\n");

950 
	`exô
();

952 
	`wrôe
(
fd
, "ff", 2);

953 
	`˛o£
(
fd
);

955 if(
	`u∆ök
("dd") >= 0){

956 
	`¥ötf
(1, "unlink dd (non-empty dir) succeeded!\n");

957 
	`exô
();

960 if(
	`mkdú
("/dd/dd") != 0){

961 
	`¥ötf
(1, "subdir mkdir dd/dd failed\n");

962 
	`exô
();

965 
fd
 = 
	`›í
("dd/dd/ff", 
O_CREATE
 | 
O_RDWR
);

966 if(
fd
 < 0){

967 
	`¥ötf
(1, "create dd/dd/ff failed\n");

968 
	`exô
();

970 
	`wrôe
(
fd
, "FF", 2);

971 
	`˛o£
(
fd
);

973 
fd
 = 
	`›í
("dd/dd/../ff", 0);

974 if(
fd
 < 0){

975 
	`¥ötf
(1, "open dd/dd/../ff failed\n");

976 
	`exô
();

978 
cc
 = 
	`ªad
(
fd
, 
buf
, (buf));

979 if(
cc
 !2 || 
buf
[0] != 'f'){

980 
	`¥ötf
(1, "dd/dd/../ff wrong content\n");

981 
	`exô
();

983 
	`˛o£
(
fd
);

985 if(
	`lök
("dd/dd/ff", "dd/dd/ffff") != 0){

986 
	`¥ötf
(1, "link dd/dd/ff dd/dd/ffff failed\n");

987 
	`exô
();

990 if(
	`u∆ök
("dd/dd/ff") != 0){

991 
	`¥ötf
(1, "unlink dd/dd/ff failed\n");

992 
	`exô
();

994 if(
	`›í
("dd/dd/ff", 
O_RDONLY
) >= 0){

995 
	`¥ötf
(1, "open (unlinked) dd/dd/ff succeeded\n");

996 
	`exô
();

999 if(
	`chdú
("dd") != 0){

1000 
	`¥ötf
(1, "chdir dd failed\n");

1001 
	`exô
();

1003 if(
	`chdú
("dd/../../dd") != 0){

1004 
	`¥ötf
(1, "chdir dd/../../dd failed\n");

1005 
	`exô
();

1007 if(
	`chdú
("dd/../../../dd") != 0){

1008 
	`¥ötf
(1, "chdir dd/../../dd failed\n");

1009 
	`exô
();

1011 if(
	`chdú
("./..") != 0){

1012 
	`¥ötf
(1, "chdir ./.. failed\n");

1013 
	`exô
();

1016 
fd
 = 
	`›í
("dd/dd/ffff", 0);

1017 if(
fd
 < 0){

1018 
	`¥ötf
(1, "open dd/dd/ffff failed\n");

1019 
	`exô
();

1021 if(
	`ªad
(
fd
, 
buf
, (buf)) != 2){

1022 
	`¥ötf
(1, "read dd/dd/ffff wrongÜen\n");

1023 
	`exô
();

1025 
	`˛o£
(
fd
);

1027 if(
	`›í
("dd/dd/ff", 
O_RDONLY
) >= 0){

1028 
	`¥ötf
(1, "open (unlinked) dd/dd/ff succeeded!\n");

1029 
	`exô
();

1032 if(
	`›í
("dd/ff/ff", 
O_CREATE
|
O_RDWR
) >= 0){

1033 
	`¥ötf
(1, "create dd/ff/ff succeeded!\n");

1034 
	`exô
();

1036 if(
	`›í
("dd/xx/ff", 
O_CREATE
|
O_RDWR
) >= 0){

1037 
	`¥ötf
(1, "create dd/xx/ff succeeded!\n");

1038 
	`exô
();

1040 if(
	`›í
("dd", 
O_CREATE
) >= 0){

1041 
	`¥ötf
(1, "create dd succeeded!\n");

1042 
	`exô
();

1044 if(
	`›í
("dd", 
O_RDWR
) >= 0){

1045 
	`¥ötf
(1, "open ddÑdwr succeeded!\n");

1046 
	`exô
();

1048 if(
	`›í
("dd", 
O_WRONLY
) >= 0){

1049 
	`¥ötf
(1, "open dd wronly succeeded!\n");

1050 
	`exô
();

1052 if(
	`lök
("dd/ff/ff", "dd/dd/xx") == 0){

1053 
	`¥ötf
(1, "link dd/ff/ff dd/dd/xx succeeded!\n");

1054 
	`exô
();

1056 if(
	`lök
("dd/xx/ff", "dd/dd/xx") == 0){

1057 
	`¥ötf
(1, "link dd/xx/ff dd/dd/xx succeeded!\n");

1058 
	`exô
();

1060 if(
	`lök
("dd/ff", "dd/dd/ffff") == 0){

1061 
	`¥ötf
(1, "link dd/ff dd/dd/ffff succeeded!\n");

1062 
	`exô
();

1064 if(
	`mkdú
("dd/ff/ff") == 0){

1065 
	`¥ötf
(1, "mkdir dd/ff/ff succeeded!\n");

1066 
	`exô
();

1068 if(
	`mkdú
("dd/xx/ff") == 0){

1069 
	`¥ötf
(1, "mkdir dd/xx/ff succeeded!\n");

1070 
	`exô
();

1072 if(
	`mkdú
("dd/dd/ffff") == 0){

1073 
	`¥ötf
(1, "mkdir dd/dd/ffff succeeded!\n");

1074 
	`exô
();

1076 if(
	`u∆ök
("dd/xx/ff") == 0){

1077 
	`¥ötf
(1, "unlink dd/xx/ff succeeded!\n");

1078 
	`exô
();

1080 if(
	`u∆ök
("dd/ff/ff") == 0){

1081 
	`¥ötf
(1, "unlink dd/ff/ff succeeded!\n");

1082 
	`exô
();

1084 if(
	`chdú
("dd/ff") == 0){

1085 
	`¥ötf
(1, "chdir dd/ff succeeded!\n");

1086 
	`exô
();

1088 if(
	`chdú
("dd/xx") == 0){

1089 
	`¥ötf
(1, "chdir dd/xx succeeded!\n");

1090 
	`exô
();

1093 if(
	`u∆ök
("dd/dd/ffff") != 0){

1094 
	`¥ötf
(1, "unlink dd/dd/ff failed\n");

1095 
	`exô
();

1097 if(
	`u∆ök
("dd/ff") != 0){

1098 
	`¥ötf
(1, "unlink dd/ff failed\n");

1099 
	`exô
();

1101 if(
	`u∆ök
("dd") == 0){

1102 
	`¥ötf
(1, "unlinkÇon-empty dd succeeded!\n");

1103 
	`exô
();

1105 if(
	`u∆ök
("dd/dd") < 0){

1106 
	`¥ötf
(1, "unlink dd/dd failed\n");

1107 
	`exô
();

1109 if(
	`u∆ök
("dd") < 0){

1110 
	`¥ötf
(1, "unlink dd failed\n");

1111 
	`exô
();

1114 
	`¥ötf
(1, "subdir ok\n");

1115 
	}
}

1119 
	$bigwrôe
()

1121 
fd
, 
sz
;

1123 
	`¥ötf
(1, "bigwriteÅest\n");

1125 
	`u∆ök
("bigwrite");

1126 
sz
 = 499; sz < 12*512; sz += 471){

1127 
fd
 = 
	`›í
("bigwrôe", 
O_CREATE
 | 
O_RDWR
);

1128 if(
fd
 < 0){

1129 
	`¥ötf
(1, "cannot create bigwrite\n");

1130 
	`exô
();

1132 
i
;

1133 
i
 = 0; i < 2; i++){

1134 
cc
 = 
	`wrôe
(
fd
, 
buf
, 
sz
);

1135 if(
cc
 !
sz
){

1136 
	`¥ötf
(1, "wrôe(%dËªà%d\n", 
sz
, 
cc
);

1137 
	`exô
();

1140 
	`˛o£
(
fd
);

1141 
	`u∆ök
("bigwrite");

1144 
	`¥ötf
(1, "bigwrite ok\n");

1145 
	}
}

1148 
	$bigfûe
()

1150 
fd
, 
i
, 
tŸÆ
, 
cc
;

1152 
	`¥ötf
(1, "bigfileÅest\n");

1154 
	`u∆ök
("bigfile");

1155 
fd
 = 
	`›í
("bigfûe", 
O_CREATE
 | 
O_RDWR
);

1156 if(
fd
 < 0){

1157 
	`¥ötf
(1, "cannot create bigfile");

1158 
	`exô
();

1160 
i
 = 0; i < 20; i++){

1161 
	`mem£t
(
buf
, 
i
, 600);

1162 if(
	`wrôe
(
fd
, 
buf
, 600) != 600){

1163 
	`¥ötf
(1, "write bigfile failed\n");

1164 
	`exô
();

1167 
	`˛o£
(
fd
);

1169 
fd
 = 
	`›í
("bigfile", 0);

1170 if(
fd
 < 0){

1171 
	`¥ötf
(1, "cannot open bigfile\n");

1172 
	`exô
();

1174 
tŸÆ
 = 0;

1175 
i
 = 0; ; i++){

1176 
cc
 = 
	`ªad
(
fd
, 
buf
, 300);

1177 if(
cc
 < 0){

1178 
	`¥ötf
(1, "read bigfile failed\n");

1179 
	`exô
();

1181 if(
cc
 == 0)

1183 if(
cc
 != 300){

1184 
	`¥ötf
(1, "shortÑead bigfile\n");

1185 
	`exô
();

1187 if(
buf
[0] !
i
/2 || buf[299] != i/2){

1188 
	`¥ötf
(1, "read bigfile wrong data\n");

1189 
	`exô
();

1191 
tŸÆ
 +
cc
;

1193 
	`˛o£
(
fd
);

1194 if(
tŸÆ
 != 20*600){

1195 
	`¥ötf
(1, "read bigfile wrongÅotal\n");

1196 
	`exô
();

1198 
	`u∆ök
("bigfile");

1200 
	`¥ötf
(1, "bigfileÅest ok\n");

1201 
	}
}

1204 
	$fouπìn
()

1206 
fd
;

1209 
	`¥ötf
(1, "fourteenÅest\n");

1211 if(
	`mkdú
("12345678901234") != 0){

1212 
	`¥ötf
(1, "mkdir 12345678901234 failed\n");

1213 
	`exô
();

1215 if(
	`mkdú
("12345678901234/123456789012345") != 0){

1216 
	`¥ötf
(1, "mkdir 12345678901234/123456789012345 failed\n");

1217 
	`exô
();

1219 
fd
 = 
	`›í
("123456789012345/123456789012345/123456789012345", 
O_CREATE
);

1220 if(
fd
 < 0){

1221 
	`¥ötf
(1, "create 123456789012345/123456789012345/123456789012345 failed\n");

1222 
	`exô
();

1224 
	`˛o£
(
fd
);

1225 
fd
 = 
	`›í
("12345678901234/12345678901234/12345678901234", 0);

1226 if(
fd
 < 0){

1227 
	`¥ötf
(1, "open 12345678901234/12345678901234/12345678901234 failed\n");

1228 
	`exô
();

1230 
	`˛o£
(
fd
);

1232 if(
	`mkdú
("12345678901234/12345678901234") == 0){

1233 
	`¥ötf
(1, "mkdir 12345678901234/12345678901234 succeeded!\n");

1234 
	`exô
();

1236 if(
	`mkdú
("123456789012345/12345678901234") == 0){

1237 
	`¥ötf
(1, "mkdir 12345678901234/123456789012345 succeeded!\n");

1238 
	`exô
();

1241 
	`¥ötf
(1, "fourteen ok\n");

1242 
	}
}

1245 
	$rmdŸ
()

1247 
	`¥ötf
(1, "rmdotÅest\n");

1248 if(
	`mkdú
("dots") != 0){

1249 
	`¥ötf
(1, "mkdir dots failed\n");

1250 
	`exô
();

1252 if(
	`chdú
("dots") != 0){

1253 
	`¥ötf
(1, "chdir dots failed\n");

1254 
	`exô
();

1256 if(
	`u∆ök
(".") == 0){

1257 
	`¥ötf
(1, "rm . worked!\n");

1258 
	`exô
();

1260 if(
	`u∆ök
("..") == 0){

1261 
	`¥ötf
(1, "rm .. worked!\n");

1262 
	`exô
();

1264 if(
	`chdú
("/") != 0){

1265 
	`¥ötf
(1, "chdir / failed\n");

1266 
	`exô
();

1268 if(
	`u∆ök
("dots/.") == 0){

1269 
	`¥ötf
(1, "unlink dots/. worked!\n");

1270 
	`exô
();

1272 if(
	`u∆ök
("dots/..") == 0){

1273 
	`¥ötf
(1, "unlink dots/.. worked!\n");

1274 
	`exô
();

1276 if(
	`u∆ök
("dots") != 0){

1277 
	`¥ötf
(1, "unlink dots failed!\n");

1278 
	`exô
();

1280 
	`¥ötf
(1, "rmdot ok\n");

1281 
	}
}

1284 
	$dúfûe
()

1286 
fd
;

1288 
	`¥ötf
(1, "dir vs file\n");

1290 
fd
 = 
	`›í
("dúfûe", 
O_CREATE
);

1291 if(
fd
 < 0){

1292 
	`¥ötf
(1, "create dirfile failed\n");

1293 
	`exô
();

1295 
	`˛o£
(
fd
);

1296 if(
	`chdú
("dirfile") == 0){

1297 
	`¥ötf
(1, "chdir dirfile succeeded!\n");

1298 
	`exô
();

1300 
fd
 = 
	`›í
("dirfile/xx", 0);

1301 if(
fd
 >= 0){

1302 
	`¥ötf
(1, "create dirfile/xx succeeded!\n");

1303 
	`exô
();

1305 
fd
 = 
	`›í
("dúfûe/xx", 
O_CREATE
);

1306 if(
fd
 >= 0){

1307 
	`¥ötf
(1, "create dirfile/xx succeeded!\n");

1308 
	`exô
();

1310 if(
	`mkdú
("dirfile/xx") == 0){

1311 
	`¥ötf
(1, "mkdir dirfile/xx succeeded!\n");

1312 
	`exô
();

1314 if(
	`u∆ök
("dirfile/xx") == 0){

1315 
	`¥ötf
(1, "unlink dirfile/xx succeeded!\n");

1316 
	`exô
();

1318 if(
	`lök
("README", "dirfile/xx") == 0){

1319 
	`¥ötf
(1, "linkÅo dirfile/xx succeeded!\n");

1320 
	`exô
();

1322 if(
	`u∆ök
("dirfile") != 0){

1323 
	`¥ötf
(1, "unlink dirfile failed!\n");

1324 
	`exô
();

1327 
fd
 = 
	`›í
(".", 
O_RDWR
);

1328 if(
fd
 >= 0){

1329 
	`¥ötf
(1, "open . for writing succeeded!\n");

1330 
	`exô
();

1332 
fd
 = 
	`›í
(".", 0);

1333 if(
	`wrôe
(
fd
, "x", 1) > 0){

1334 
	`¥ötf
(1, "write . succeeded!\n");

1335 
	`exô
();

1337 
	`˛o£
(
fd
);

1339 
	`¥ötf
(1, "dir vs file OK\n");

1340 
	}
}

1344 
	$úef
()

1346 
i
, 
fd
;

1348 
	`¥ötf
(1, "empty fileÇame\n");

1351 
i
 = 0; i < 50 + 1; i++){

1352 if(
	`mkdú
("irefd") != 0){

1353 
	`¥ötf
(1, "mkdir irefd failed\n");

1354 
	`exô
();

1356 if(
	`chdú
("irefd") != 0){

1357 
	`¥ötf
(1, "chdir irefd failed\n");

1358 
	`exô
();

1361 
	`mkdú
("");

1362 
	`lök
("README", "");

1363 
fd
 = 
	`›í
("", 
O_CREATE
);

1364 if(
fd
 >= 0)

1365 
	`˛o£
(
fd
);

1366 
fd
 = 
	`›í
("xx", 
O_CREATE
);

1367 if(
fd
 >= 0)

1368 
	`˛o£
(
fd
);

1369 
	`u∆ök
("xx");

1372 
	`chdú
("/");

1373 
	`¥ötf
(1, "empty fileÇame OK\n");

1374 
	}
}

1380 
	$f‹kã°
()

1382 
n
, 
pid
;

1384 
	`¥ötf
(1, "forkÅest\n");

1386 
n
=0;Ç<1000;Ç++){

1387 
pid
 = 
	`f‹k
();

1388 if(
pid
 < 0)

1390 if(
pid
 == 0)

1391 
	`exô
();

1394 if(
n
 == 1000){

1395 
	`¥ötf
(1, "fork claimedÅo work 1000Åimes!\n");

1396 
	`exô
();

1399 ; 
n
 > 0;Ç--){

1400 if(
	`waô
() < 0){

1401 
	`¥ötf
(1, "wait stoppedÉarly\n");

1402 
	`exô
();

1406 if(
	`waô
() != -1){

1407 
	`¥ötf
(1, "wait gotÅoo many\n");

1408 
	`exô
();

1411 
	`¥ötf
(1, "forkÅest OK\n");

1412 
	}
}

1415 
	$sbrkã°
()

1417 
fds
[2], 
pid
, 
pids
[10], 
µid
;

1418 *
a
, *
b
, *
c
, *
œ°addr
, *
ﬁdbrk
, *
p
, 
s¸©ch
;

1419 
uöt
 
amt
;

1421 
	`¥ötf
(
°dout
, "sbrkÅest\n");

1422 
ﬁdbrk
 = 
	`sbrk
(0);

1425 
a
 = 
	`sbrk
(0);

1426 
i
;

1427 
i
 = 0; i < 5000; i++){

1428 
b
 = 
	`sbrk
(1);

1429 if(
b
 !
a
){

1430 
	`¥ötf
(
°dout
, "sbrkÅe° faûed %d %x %x\n", 
i
, 
a
, 
b
);

1431 
	`exô
();

1433 *
b
 = 1;

1434 
a
 = 
b
 + 1;

1436 
pid
 = 
	`f‹k
();

1437 if(
pid
 < 0){

1438 
	`¥ötf
(
°dout
, "sbrkÅest fork failed\n");

1439 
	`exô
();

1441 
c
 = 
	`sbrk
(1);

1442 
c
 = 
	`sbrk
(1);

1443 if(
c
 !
a
 + 1){

1444 
	`¥ötf
(
°dout
, "sbrkÅest failedÖost-fork\n");

1445 
	`exô
();

1447 if(
pid
 == 0)

1448 
	`exô
();

1449 
	`waô
();

1452 
	#BIG
 (100*1024*1024)

	)

1453 
a
 = 
	`sbrk
(0);

1454 
amt
 = (
BIG
Ë- (
uöt
)
a
;

1455 
p
 = 
	`sbrk
(
amt
);

1456 i‡(
p
 !
a
) {

1457 
	`¥ötf
(
°dout
, "sbrkÅest failedÅo grow bigáddress space;ÉnoughÖhys mem?\n");

1458 
	`exô
();

1460 
œ°addr
 = (*Ë(
BIG
-1);

1461 *
œ°addr
 = 99;

1464 
a
 = 
	`sbrk
(0);

1465 
c
 = 
	`sbrk
(-4096);

1466 if(
c
 == (*)0xffffffff){

1467 
	`¥ötf
(
°dout
, "sbrk couldÇot deallocate\n");

1468 
	`exô
();

1470 
c
 = 
	`sbrk
(0);

1471 if(
c
 !
a
 - 4096){

1472 
	`¥ötf
(
°dout
, "sbrk dóŒoˇti⁄Örodu˚d wr⁄gáddªss,á %x c %x\n", 
a
, 
c
);

1473 
	`exô
();

1477 
a
 = 
	`sbrk
(0);

1478 
c
 = 
	`sbrk
(4096);

1479 if(
c
 !
a
 || 
	`sbrk
(0) !=á + 4096){

1480 
	`¥ötf
(
°dout
, "sbrkÑe-Æloˇti⁄ faûed,á %x c %x\n", 
a
, 
c
);

1481 
	`exô
();

1483 if(*
œ°addr
 == 99){

1485 
	`¥ötf
(
°dout
, "sbrk de-allocation didn'tÑeally deallocate\n");

1486 
	`exô
();

1489 
a
 = 
	`sbrk
(0);

1490 
c
 = 
	`sbrk
(-(sbrk(0Ë- 
ﬁdbrk
));

1491 if(
c
 !
a
){

1492 
	`¥ötf
(
°dout
, "sbrk downsizêÁûed,á %x c %x\n", 
a
, 
c
);

1493 
	`exô
();

1497 
a
 = (*)(
KERNBASE
);á < (*) (KERNBASE+2000000);á += 50000){

1498 
µid
 = 
	`gëpid
();

1499 
pid
 = 
	`f‹k
();

1500 if(
pid
 < 0){

1501 
	`¥ötf
(
°dout
, "fork failed\n");

1502 
	`exô
();

1504 if(
pid
 == 0){

1505 
	`¥ötf
(
°dout
, "o›†couldÑód %x = %x\n", 
a
, *a);

1506 
	`kûl
(
µid
);

1507 
	`exô
();

1509 
	`waô
();

1514 if(
	`pùe
(
fds
) != 0){

1515 
	`¥ötf
(1, "pipe() failed\n");

1516 
	`exô
();

1518 
i
 = 0; i < (
pids
)/(pids[0]); i++){

1519 if((
pids
[
i
] = 
	`f‹k
()) == 0){

1521 
	`sbrk
(
BIG
 - (
uöt
)sbrk(0));

1522 
	`wrôe
(
fds
[1], "x", 1);

1524 ;;Ë
	`¶ìp
(1000);

1526 if(
pids
[
i
] != -1)

1527 
	`ªad
(
fds
[0], &
s¸©ch
, 1);

1531 
c
 = 
	`sbrk
(4096);

1532 
i
 = 0; i < (
pids
)/(pids[0]); i++){

1533 if(
pids
[
i
] == -1)

1535 
	`kûl
(
pids
[
i
]);

1536 
	`waô
();

1538 if(
c
 == (*)0xffffffff){

1539 
	`¥ötf
(
°dout
, "failed sbrkÜeaked memory\n");

1540 
	`exô
();

1543 if(
	`sbrk
(0Ë> 
ﬁdbrk
)

1544 
	`sbrk
(-(sbrk(0Ë- 
ﬁdbrk
));

1546 
	`¥ötf
(
°dout
, "sbrkÅest OK\n");

1547 
	}
}

1550 
	$vÆid©eöt
(*
p
)

1552 
ªs
;

1553 
	`asm
("mov %%esp, %%ebx\n\t"

1557 "˜" (
ªs
) :

1558 "a" (
SYS_¶ìp
), "n" (
T_SYSCALL
), "c" (
p
) :

1560 
	}
}

1563 
	$vÆid©ëe°
()

1565 
hi
, 
pid
;

1566 
uöt
 
p
;

1568 
	`¥ötf
(
°dout
, "validateÅest\n");

1569 
hi
 = 1100*1024;

1571 
p
 = 0;Ö <(
uöt
)
hi
;Ö += 4096){

1572 if((
pid
 = 
	`f‹k
()) == 0){

1574 
	`vÆid©eöt
((*)
p
);

1575 
	`exô
();

1577 
	`¶ìp
(0);

1578 
	`¶ìp
(0);

1579 
	`kûl
(
pid
);

1580 
	`waô
();

1583 if(
	`lök
("nosuchfûe", (*)
p
) != -1){

1584 
	`¥ötf
(
°dout
, "link shouldÇot succeed\n");

1585 
	`exô
();

1589 
	`¥ötf
(
°dout
, "validate ok\n");

1590 
	}
}

1593 
	gunöô
[10000];

1595 
	$bs°e°
()

1597 
i
;

1599 
	`¥ötf
(
°dout
, "bssÅest\n");

1600 
i
 = 0; i < (
unöô
); i++){

1601 if(
unöô
[
i
] != '\0'){

1602 
	`¥ötf
(
°dout
, "bssÅest failed\n");

1603 
	`exô
();

1606 
	`¥ötf
(
°dout
, "bssÅest ok\n");

1607 
	}
}

1613 
	$big¨gã°
()

1615 
pid
, 
fd
;

1617 
	`u∆ök
("bigarg-ok");

1618 
pid
 = 
	`f‹k
();

1619 if(
pid
 == 0){

1620 *
¨gs
[
MAXARG
];

1621 
i
;

1622 
i
 = 0; i < 
MAXARG
-1; i++)

1623 
¨gs
[
i
] = "bigargsÅest: failed\n ";

1624 
¨gs
[
MAXARG
-1] = 0;

1625 
	`¥ötf
(
°dout
, "bigargÅest\n");

1626 
	`exec
("echo", 
¨gs
);

1627 
	`¥ötf
(
°dout
, "bigargÅest ok\n");

1628 
fd
 = 
	`›í
("big¨g-ok", 
O_CREATE
);

1629 
	`˛o£
(
fd
);

1630 
	`exô
();

1631 } if(
pid
 < 0){

1632 
	`¥ötf
(
°dout
, "bigargtest: fork failed\n");

1633 
	`exô
();

1635 
	`waô
();

1636 
fd
 = 
	`›í
("bigarg-ok", 0);

1637 if(
fd
 < 0){

1638 
	`¥ötf
(
°dout
, "bigargÅest failed!\n");

1639 
	`exô
();

1641 
	`˛o£
(
fd
);

1642 
	`u∆ök
("bigarg-ok");

1643 
	}
}

1648 
	$fsfuŒ
()

1650 
nfûes
;

1651 
fsblocks
 = 0;

1653 
	`¥ötf
(1, "fsfullÅest\n");

1655 
nfûes
 = 0; ;Çfiles++){

1656 
«me
[64];

1657 
«me
[0] = 'f';

1658 
«me
[1] = '0' + 
nfûes
 / 1000;

1659 
«me
[2] = '0' + (
nfûes
 % 1000) / 100;

1660 
«me
[3] = '0' + (
nfûes
 % 100) / 10;

1661 
«me
[4] = '0' + (
nfûes
 % 10);

1662 
«me
[5] = '\0';

1663 
	`¥ötf
(1, "wrôög %s\n", 
«me
);

1664 
fd
 = 
	`›í
(
«me
, 
O_CREATE
|
O_RDWR
);

1665 if(
fd
 < 0){

1666 
	`¥ötf
(1, "›í %†Áûed\n", 
«me
);

1669 
tŸÆ
 = 0;

1671 
cc
 = 
	`wrôe
(
fd
, 
buf
, 512);

1672 if(
cc
 < 512)

1674 
tŸÆ
 +
cc
;

1675 
fsblocks
++;

1677 
	`¥ötf
(1, "wrŸê%d byãs\n", 
tŸÆ
);

1678 
	`˛o£
(
fd
);

1679 if(
tŸÆ
 == 0)

1683 
nfûes
 >= 0){

1684 
«me
[64];

1685 
«me
[0] = 'f';

1686 
«me
[1] = '0' + 
nfûes
 / 1000;

1687 
«me
[2] = '0' + (
nfûes
 % 1000) / 100;

1688 
«me
[3] = '0' + (
nfûes
 % 100) / 10;

1689 
«me
[4] = '0' + (
nfûes
 % 10);

1690 
«me
[5] = '\0';

1691 
	`u∆ök
(
«me
);

1692 
nfûes
--;

1695 
	`¥ötf
(1, "fsfullÅest finished\n");

1696 
	}
}

1699 
	$uio
()

1701 
	#RTC_ADDR
 0x70

	)

1702 
	#RTC_DATA
 0x71

	)

1704 
ush‹t
 
p‹t
 = 0;

1705 
uch¨
 
vÆ
 = 0;

1706 
pid
;

1708 
	`¥ötf
(1, "uioÅest\n");

1709 
pid
 = 
	`f‹k
();

1710 if(
pid
 == 0){

1711 
p‹t
 = 
RTC_ADDR
;

1712 
vÆ
 = 0x09;

1714 
asm
 vﬁ©ûe("outb %0,%1"::"a"(
vÆ
), "d" (
p‹t
));

1715 
p‹t
 = 
RTC_DATA
;

1716 
asm
 vﬁ©ûe("öb %1,%0" : "˜" (
vÆ
Ë: "d" (
p‹t
));

1717 
	`¥ötf
(1, "uio: uio succeeded;Åest FAILED\n");

1718 
	`exô
();

1719 } if(
pid
 < 0){

1720 
	`¥ötf
 (1, "fork failed\n");

1721 
	`exô
();

1723 
	`waô
();

1724 
	`¥ötf
(1, "uioÅest done\n");

1725 
	}
}

1727 
	$¨g±e°
()

1729 
fd
;

1730 
fd
 = 
	`›í
("öô", 
O_RDONLY
);

1731 i‡(
fd
 < 0) {

1732 
	`¥ötf
(2, "open failed\n");

1733 
	`exô
();

1735 
	`ªad
(
fd
, 
	`sbrk
(0) - 1, -1);

1736 
	`˛o£
(
fd
);

1737 
	`¥ötf
(1, "argÅestÖassed\n");

1738 
	}
}

1740 
	gønd°©e
 = 1;

1742 
	$ønd
()

1744 
ønd°©e
 =Ñandstate * 1664525 + 1013904223;

1745  
ønd°©e
;

1746 
	}
}

1749 
	$maö
(
¨gc
, *
¨gv
[])

1751 
	`¥ötf
(1, "usertests starting\n");

1753 if(
	`›í
("usertests.ran", 0) >= 0){

1754 
	`¥ötf
(1, "alreadyÑan userÅests --Ñebuild fs.img\n");

1755 
	`exô
();

1757 
	`˛o£
(
	`›í
("u£πe°s.øn", 
O_CREATE
));

1759 
	`¨g±e°
();

1760 
	`¸óãdñëe
();

1761 
	`löku∆ök
();

1762 
	`c⁄¸óã
();

1763 
	`fourfûes
();

1764 
	`sh¨edfd
();

1766 
	`big¨gã°
();

1767 
	`bigwrôe
();

1768 
	`big¨gã°
();

1769 
	`bs°e°
();

1770 
	`sbrkã°
();

1771 
	`vÆid©ëe°
();

1773 
	`›íã°
();

1774 
	`wrôëe°
();

1775 
	`wrôëe°1
();

1776 
	`¸óãã°
();

1778 
	`›íùuâe°
();

1779 
	`exôùuâe°
();

1780 
	`ùuâe°
();

1782 
	`mem
();

1783 
	`pùe1
();

1784 
	`¥ìm±
();

1785 
	`exôwaô
();

1787 
	`rmdŸ
();

1788 
	`fouπìn
();

1789 
	`bigfûe
();

1790 
	`subdú
();

1791 
	`lökã°
();

1792 
	`u∆ökªad
();

1793 
	`dúfûe
();

1794 
	`úef
();

1795 
	`f‹kã°
();

1796 
	`bigdú
();

1798 
	`uio
();

1800 
	`exe˘e°
();

1802 
	`exô
();

1803 
	}
}

	@usys.S

1 
	~"sysˇŒ.h
"

2 
	~"å≠s.h
"

4 
	#SYSCALL
(
«me
) \

5 .
globl
 
«me
; \

6 
«me
: \

7 
movl
 
$SYS_
 ## 
«me
, %
óx
; \

8 
$T_SYSCALL
; \

9 
ªt


	)

11 
	$SYSCALL
(
f‹k
)

12 
	$SYSCALL
(
exô
)

13 
	$SYSCALL
(
waô
)

14 
	$SYSCALL
(
pùe
)

15 
	$SYSCALL
(
ªad
)

16 
	$SYSCALL
(
wrôe
)

17 
	$SYSCALL
(
˛o£
)

18 
	$SYSCALL
(
kûl
)

19 
	$SYSCALL
(
exec
)

20 
	$SYSCALL
(
›í
)

21 
	$SYSCALL
(
mknod
)

22 
	$SYSCALL
(
u∆ök
)

23 
	$SYSCALL
(
f°©
)

24 
	$SYSCALL
(
lök
)

25 
	$SYSCALL
(
mkdú
)

26 
	$SYSCALL
(
chdú
)

27 
	$SYSCALL
(
dup
)

28 
	$SYSCALL
(
gëpid
)

29 
	$SYSCALL
(
sbrk
)

30 
	$SYSCALL
(
¶ìp
)

31 
	$SYSCALL
(
u±ime
)

32 
	$SYSCALL
(
my_sysˇŒ
)

33 
	$SYSCALL
(
gëµid
)

34 
	$SYSCALL
(
yõld
)

35 
	$SYSCALL
(
gëÀv
)

36 
	`SYSCALL
(
£t_˝u_sh¨e
)

	@vectors.S

1 #gíî©ed 
by
 
ve˘‹s
.
∂
 - dÿ
nŸ
 
edô


3 .
globl
 
	gÆ…øps


4 .
globl
 
ve˘‹0


5 
	gve˘‹0
:

6 
pushl
 
$0


7 
pushl
 
$0


8 
jmp
 
Æ…øps


9 .
globl
 
ve˘‹1


10 
ve˘‹1
:

11 
pushl
 
$0


12 
pushl
 
$1


13 
jmp
 
Æ…øps


14 .
globl
 
ve˘‹2


15 
ve˘‹2
:

16 
pushl
 
$0


17 
pushl
 
$2


18 
jmp
 
Æ…øps


19 .
globl
 
ve˘‹3


20 
ve˘‹3
:

21 
pushl
 
$0


22 
pushl
 
$3


23 
jmp
 
Æ…øps


24 .
globl
 
ve˘‹4


25 
ve˘‹4
:

26 
pushl
 
$0


27 
pushl
 
$4


28 
jmp
 
Æ…øps


29 .
globl
 
ve˘‹5


30 
ve˘‹5
:

31 
pushl
 
$0


32 
pushl
 
$5


33 
jmp
 
Æ…øps


34 .
globl
 
ve˘‹6


35 
ve˘‹6
:

36 
pushl
 
$0


37 
pushl
 
$6


38 
jmp
 
Æ…øps


39 .
globl
 
ve˘‹7


40 
ve˘‹7
:

41 
pushl
 
$0


42 
pushl
 
$7


43 
jmp
 
Æ…øps


44 .
globl
 
ve˘‹8


45 
ve˘‹8
:

46 
pushl
 
$8


47 
jmp
 
Æ…øps


48 .
globl
 
ve˘‹9


49 
ve˘‹9
:

50 
pushl
 
$0


51 
pushl
 
$9


52 
jmp
 
Æ…øps


53 .
globl
 
ve˘‹10


54 
ve˘‹10
:

55 
pushl
 
$10


56 
jmp
 
Æ…øps


57 .
globl
 
ve˘‹11


58 
ve˘‹11
:

59 
pushl
 
$11


60 
jmp
 
Æ…øps


61 .
globl
 
ve˘‹12


62 
ve˘‹12
:

63 
pushl
 
$12


64 
jmp
 
Æ…øps


65 .
globl
 
ve˘‹13


66 
ve˘‹13
:

67 
pushl
 
$13


68 
jmp
 
Æ…øps


69 .
globl
 
ve˘‹14


70 
ve˘‹14
:

71 
pushl
 
$14


72 
jmp
 
Æ…øps


73 .
globl
 
ve˘‹15


74 
ve˘‹15
:

75 
pushl
 
$0


76 
pushl
 
$15


77 
jmp
 
Æ…øps


78 .
globl
 
ve˘‹16


79 
ve˘‹16
:

80 
pushl
 
$0


81 
pushl
 
$16


82 
jmp
 
Æ…øps


83 .
globl
 
ve˘‹17


84 
ve˘‹17
:

85 
pushl
 
$17


86 
jmp
 
Æ…øps


87 .
globl
 
ve˘‹18


88 
ve˘‹18
:

89 
pushl
 
$0


90 
pushl
 
$18


91 
jmp
 
Æ…øps


92 .
globl
 
ve˘‹19


93 
ve˘‹19
:

94 
pushl
 
$0


95 
pushl
 
$19


96 
jmp
 
Æ…øps


97 .
globl
 
ve˘‹20


98 
ve˘‹20
:

99 
pushl
 
$0


100 
pushl
 
$20


101 
jmp
 
Æ…øps


102 .
globl
 
ve˘‹21


103 
ve˘‹21
:

104 
pushl
 
$0


105 
pushl
 
$21


106 
jmp
 
Æ…øps


107 .
globl
 
ve˘‹22


108 
ve˘‹22
:

109 
pushl
 
$0


110 
pushl
 
$22


111 
jmp
 
Æ…øps


112 .
globl
 
ve˘‹23


113 
ve˘‹23
:

114 
pushl
 
$0


115 
pushl
 
$23


116 
jmp
 
Æ…øps


117 .
globl
 
ve˘‹24


118 
ve˘‹24
:

119 
pushl
 
$0


120 
pushl
 
$24


121 
jmp
 
Æ…øps


122 .
globl
 
ve˘‹25


123 
ve˘‹25
:

124 
pushl
 
$0


125 
pushl
 
$25


126 
jmp
 
Æ…øps


127 .
globl
 
ve˘‹26


128 
ve˘‹26
:

129 
pushl
 
$0


130 
pushl
 
$26


131 
jmp
 
Æ…øps


132 .
globl
 
ve˘‹27


133 
ve˘‹27
:

134 
pushl
 
$0


135 
pushl
 
$27


136 
jmp
 
Æ…øps


137 .
globl
 
ve˘‹28


138 
ve˘‹28
:

139 
pushl
 
$0


140 
pushl
 
$28


141 
jmp
 
Æ…øps


142 .
globl
 
ve˘‹29


143 
ve˘‹29
:

144 
pushl
 
$0


145 
pushl
 
$29


146 
jmp
 
Æ…øps


147 .
globl
 
ve˘‹30


148 
ve˘‹30
:

149 
pushl
 
$0


150 
pushl
 
$30


151 
jmp
 
Æ…øps


152 .
globl
 
ve˘‹31


153 
ve˘‹31
:

154 
pushl
 
$0


155 
pushl
 
$31


156 
jmp
 
Æ…øps


157 .
globl
 
ve˘‹32


158 
ve˘‹32
:

159 
pushl
 
$0


160 
pushl
 
$32


161 
jmp
 
Æ…øps


162 .
globl
 
ve˘‹33


163 
ve˘‹33
:

164 
pushl
 
$0


165 
pushl
 
$33


166 
jmp
 
Æ…øps


167 .
globl
 
ve˘‹34


168 
ve˘‹34
:

169 
pushl
 
$0


170 
pushl
 
$34


171 
jmp
 
Æ…øps


172 .
globl
 
ve˘‹35


173 
ve˘‹35
:

174 
pushl
 
$0


175 
pushl
 
$35


176 
jmp
 
Æ…øps


177 .
globl
 
ve˘‹36


178 
ve˘‹36
:

179 
pushl
 
$0


180 
pushl
 
$36


181 
jmp
 
Æ…øps


182 .
globl
 
ve˘‹37


183 
ve˘‹37
:

184 
pushl
 
$0


185 
pushl
 
$37


186 
jmp
 
Æ…øps


187 .
globl
 
ve˘‹38


188 
ve˘‹38
:

189 
pushl
 
$0


190 
pushl
 
$38


191 
jmp
 
Æ…øps


192 .
globl
 
ve˘‹39


193 
ve˘‹39
:

194 
pushl
 
$0


195 
pushl
 
$39


196 
jmp
 
Æ…øps


197 .
globl
 
ve˘‹40


198 
ve˘‹40
:

199 
pushl
 
$0


200 
pushl
 
$40


201 
jmp
 
Æ…øps


202 .
globl
 
ve˘‹41


203 
ve˘‹41
:

204 
pushl
 
$0


205 
pushl
 
$41


206 
jmp
 
Æ…øps


207 .
globl
 
ve˘‹42


208 
ve˘‹42
:

209 
pushl
 
$0


210 
pushl
 
$42


211 
jmp
 
Æ…øps


212 .
globl
 
ve˘‹43


213 
ve˘‹43
:

214 
pushl
 
$0


215 
pushl
 
$43


216 
jmp
 
Æ…øps


217 .
globl
 
ve˘‹44


218 
ve˘‹44
:

219 
pushl
 
$0


220 
pushl
 
$44


221 
jmp
 
Æ…øps


222 .
globl
 
ve˘‹45


223 
ve˘‹45
:

224 
pushl
 
$0


225 
pushl
 
$45


226 
jmp
 
Æ…øps


227 .
globl
 
ve˘‹46


228 
ve˘‹46
:

229 
pushl
 
$0


230 
pushl
 
$46


231 
jmp
 
Æ…øps


232 .
globl
 
ve˘‹47


233 
ve˘‹47
:

234 
pushl
 
$0


235 
pushl
 
$47


236 
jmp
 
Æ…øps


237 .
globl
 
ve˘‹48


238 
ve˘‹48
:

239 
pushl
 
$0


240 
pushl
 
$48


241 
jmp
 
Æ…øps


242 .
globl
 
ve˘‹49


243 
ve˘‹49
:

244 
pushl
 
$0


245 
pushl
 
$49


246 
jmp
 
Æ…øps


247 .
globl
 
ve˘‹50


248 
ve˘‹50
:

249 
pushl
 
$0


250 
pushl
 
$50


251 
jmp
 
Æ…øps


252 .
globl
 
ve˘‹51


253 
ve˘‹51
:

254 
pushl
 
$0


255 
pushl
 
$51


256 
jmp
 
Æ…øps


257 .
globl
 
ve˘‹52


258 
ve˘‹52
:

259 
pushl
 
$0


260 
pushl
 
$52


261 
jmp
 
Æ…øps


262 .
globl
 
ve˘‹53


263 
ve˘‹53
:

264 
pushl
 
$0


265 
pushl
 
$53


266 
jmp
 
Æ…øps


267 .
globl
 
ve˘‹54


268 
ve˘‹54
:

269 
pushl
 
$0


270 
pushl
 
$54


271 
jmp
 
Æ…øps


272 .
globl
 
ve˘‹55


273 
ve˘‹55
:

274 
pushl
 
$0


275 
pushl
 
$55


276 
jmp
 
Æ…øps


277 .
globl
 
ve˘‹56


278 
ve˘‹56
:

279 
pushl
 
$0


280 
pushl
 
$56


281 
jmp
 
Æ…øps


282 .
globl
 
ve˘‹57


283 
ve˘‹57
:

284 
pushl
 
$0


285 
pushl
 
$57


286 
jmp
 
Æ…øps


287 .
globl
 
ve˘‹58


288 
ve˘‹58
:

289 
pushl
 
$0


290 
pushl
 
$58


291 
jmp
 
Æ…øps


292 .
globl
 
ve˘‹59


293 
ve˘‹59
:

294 
pushl
 
$0


295 
pushl
 
$59


296 
jmp
 
Æ…øps


297 .
globl
 
ve˘‹60


298 
ve˘‹60
:

299 
pushl
 
$0


300 
pushl
 
$60


301 
jmp
 
Æ…øps


302 .
globl
 
ve˘‹61


303 
ve˘‹61
:

304 
pushl
 
$0


305 
pushl
 
$61


306 
jmp
 
Æ…øps


307 .
globl
 
ve˘‹62


308 
ve˘‹62
:

309 
pushl
 
$0


310 
pushl
 
$62


311 
jmp
 
Æ…øps


312 .
globl
 
ve˘‹63


313 
ve˘‹63
:

314 
pushl
 
$0


315 
pushl
 
$63


316 
jmp
 
Æ…øps


317 .
globl
 
ve˘‹64


318 
ve˘‹64
:

319 
pushl
 
$0


320 
pushl
 
$64


321 
jmp
 
Æ…øps


322 .
globl
 
ve˘‹65


323 
ve˘‹65
:

324 
pushl
 
$0


325 
pushl
 
$65


326 
jmp
 
Æ…øps


327 .
globl
 
ve˘‹66


328 
ve˘‹66
:

329 
pushl
 
$0


330 
pushl
 
$66


331 
jmp
 
Æ…øps


332 .
globl
 
ve˘‹67


333 
ve˘‹67
:

334 
pushl
 
$0


335 
pushl
 
$67


336 
jmp
 
Æ…øps


337 .
globl
 
ve˘‹68


338 
ve˘‹68
:

339 
pushl
 
$0


340 
pushl
 
$68


341 
jmp
 
Æ…øps


342 .
globl
 
ve˘‹69


343 
ve˘‹69
:

344 
pushl
 
$0


345 
pushl
 
$69


346 
jmp
 
Æ…øps


347 .
globl
 
ve˘‹70


348 
ve˘‹70
:

349 
pushl
 
$0


350 
pushl
 
$70


351 
jmp
 
Æ…øps


352 .
globl
 
ve˘‹71


353 
ve˘‹71
:

354 
pushl
 
$0


355 
pushl
 
$71


356 
jmp
 
Æ…øps


357 .
globl
 
ve˘‹72


358 
ve˘‹72
:

359 
pushl
 
$0


360 
pushl
 
$72


361 
jmp
 
Æ…øps


362 .
globl
 
ve˘‹73


363 
ve˘‹73
:

364 
pushl
 
$0


365 
pushl
 
$73


366 
jmp
 
Æ…øps


367 .
globl
 
ve˘‹74


368 
ve˘‹74
:

369 
pushl
 
$0


370 
pushl
 
$74


371 
jmp
 
Æ…øps


372 .
globl
 
ve˘‹75


373 
ve˘‹75
:

374 
pushl
 
$0


375 
pushl
 
$75


376 
jmp
 
Æ…øps


377 .
globl
 
ve˘‹76


378 
ve˘‹76
:

379 
pushl
 
$0


380 
pushl
 
$76


381 
jmp
 
Æ…øps


382 .
globl
 
ve˘‹77


383 
ve˘‹77
:

384 
pushl
 
$0


385 
pushl
 
$77


386 
jmp
 
Æ…øps


387 .
globl
 
ve˘‹78


388 
ve˘‹78
:

389 
pushl
 
$0


390 
pushl
 
$78


391 
jmp
 
Æ…øps


392 .
globl
 
ve˘‹79


393 
ve˘‹79
:

394 
pushl
 
$0


395 
pushl
 
$79


396 
jmp
 
Æ…øps


397 .
globl
 
ve˘‹80


398 
ve˘‹80
:

399 
pushl
 
$0


400 
pushl
 
$80


401 
jmp
 
Æ…øps


402 .
globl
 
ve˘‹81


403 
ve˘‹81
:

404 
pushl
 
$0


405 
pushl
 
$81


406 
jmp
 
Æ…øps


407 .
globl
 
ve˘‹82


408 
ve˘‹82
:

409 
pushl
 
$0


410 
pushl
 
$82


411 
jmp
 
Æ…øps


412 .
globl
 
ve˘‹83


413 
ve˘‹83
:

414 
pushl
 
$0


415 
pushl
 
$83


416 
jmp
 
Æ…øps


417 .
globl
 
ve˘‹84


418 
ve˘‹84
:

419 
pushl
 
$0


420 
pushl
 
$84


421 
jmp
 
Æ…øps


422 .
globl
 
ve˘‹85


423 
ve˘‹85
:

424 
pushl
 
$0


425 
pushl
 
$85


426 
jmp
 
Æ…øps


427 .
globl
 
ve˘‹86


428 
ve˘‹86
:

429 
pushl
 
$0


430 
pushl
 
$86


431 
jmp
 
Æ…øps


432 .
globl
 
ve˘‹87


433 
ve˘‹87
:

434 
pushl
 
$0


435 
pushl
 
$87


436 
jmp
 
Æ…øps


437 .
globl
 
ve˘‹88


438 
ve˘‹88
:

439 
pushl
 
$0


440 
pushl
 
$88


441 
jmp
 
Æ…øps


442 .
globl
 
ve˘‹89


443 
ve˘‹89
:

444 
pushl
 
$0


445 
pushl
 
$89


446 
jmp
 
Æ…øps


447 .
globl
 
ve˘‹90


448 
ve˘‹90
:

449 
pushl
 
$0


450 
pushl
 
$90


451 
jmp
 
Æ…øps


452 .
globl
 
ve˘‹91


453 
ve˘‹91
:

454 
pushl
 
$0


455 
pushl
 
$91


456 
jmp
 
Æ…øps


457 .
globl
 
ve˘‹92


458 
ve˘‹92
:

459 
pushl
 
$0


460 
pushl
 
$92


461 
jmp
 
Æ…øps


462 .
globl
 
ve˘‹93


463 
ve˘‹93
:

464 
pushl
 
$0


465 
pushl
 
$93


466 
jmp
 
Æ…øps


467 .
globl
 
ve˘‹94


468 
ve˘‹94
:

469 
pushl
 
$0


470 
pushl
 
$94


471 
jmp
 
Æ…øps


472 .
globl
 
ve˘‹95


473 
ve˘‹95
:

474 
pushl
 
$0


475 
pushl
 
$95


476 
jmp
 
Æ…øps


477 .
globl
 
ve˘‹96


478 
ve˘‹96
:

479 
pushl
 
$0


480 
pushl
 
$96


481 
jmp
 
Æ…øps


482 .
globl
 
ve˘‹97


483 
ve˘‹97
:

484 
pushl
 
$0


485 
pushl
 
$97


486 
jmp
 
Æ…øps


487 .
globl
 
ve˘‹98


488 
ve˘‹98
:

489 
pushl
 
$0


490 
pushl
 
$98


491 
jmp
 
Æ…øps


492 .
globl
 
ve˘‹99


493 
ve˘‹99
:

494 
pushl
 
$0


495 
pushl
 
$99


496 
jmp
 
Æ…øps


497 .
globl
 
ve˘‹100


498 
ve˘‹100
:

499 
pushl
 
$0


500 
pushl
 
$100


501 
jmp
 
Æ…øps


502 .
globl
 
ve˘‹101


503 
ve˘‹101
:

504 
pushl
 
$0


505 
pushl
 
$101


506 
jmp
 
Æ…øps


507 .
globl
 
ve˘‹102


508 
ve˘‹102
:

509 
pushl
 
$0


510 
pushl
 
$102


511 
jmp
 
Æ…øps


512 .
globl
 
ve˘‹103


513 
ve˘‹103
:

514 
pushl
 
$0


515 
pushl
 
$103


516 
jmp
 
Æ…øps


517 .
globl
 
ve˘‹104


518 
ve˘‹104
:

519 
pushl
 
$0


520 
pushl
 
$104


521 
jmp
 
Æ…øps


522 .
globl
 
ve˘‹105


523 
ve˘‹105
:

524 
pushl
 
$0


525 
pushl
 
$105


526 
jmp
 
Æ…øps


527 .
globl
 
ve˘‹106


528 
ve˘‹106
:

529 
pushl
 
$0


530 
pushl
 
$106


531 
jmp
 
Æ…øps


532 .
globl
 
ve˘‹107


533 
ve˘‹107
:

534 
pushl
 
$0


535 
pushl
 
$107


536 
jmp
 
Æ…øps


537 .
globl
 
ve˘‹108


538 
ve˘‹108
:

539 
pushl
 
$0


540 
pushl
 
$108


541 
jmp
 
Æ…øps


542 .
globl
 
ve˘‹109


543 
ve˘‹109
:

544 
pushl
 
$0


545 
pushl
 
$109


546 
jmp
 
Æ…øps


547 .
globl
 
ve˘‹110


548 
ve˘‹110
:

549 
pushl
 
$0


550 
pushl
 
$110


551 
jmp
 
Æ…øps


552 .
globl
 
ve˘‹111


553 
ve˘‹111
:

554 
pushl
 
$0


555 
pushl
 
$111


556 
jmp
 
Æ…øps


557 .
globl
 
ve˘‹112


558 
ve˘‹112
:

559 
pushl
 
$0


560 
pushl
 
$112


561 
jmp
 
Æ…øps


562 .
globl
 
ve˘‹113


563 
ve˘‹113
:

564 
pushl
 
$0


565 
pushl
 
$113


566 
jmp
 
Æ…øps


567 .
globl
 
ve˘‹114


568 
ve˘‹114
:

569 
pushl
 
$0


570 
pushl
 
$114


571 
jmp
 
Æ…øps


572 .
globl
 
ve˘‹115


573 
ve˘‹115
:

574 
pushl
 
$0


575 
pushl
 
$115


576 
jmp
 
Æ…øps


577 .
globl
 
ve˘‹116


578 
ve˘‹116
:

579 
pushl
 
$0


580 
pushl
 
$116


581 
jmp
 
Æ…øps


582 .
globl
 
ve˘‹117


583 
ve˘‹117
:

584 
pushl
 
$0


585 
pushl
 
$117


586 
jmp
 
Æ…øps


587 .
globl
 
ve˘‹118


588 
ve˘‹118
:

589 
pushl
 
$0


590 
pushl
 
$118


591 
jmp
 
Æ…øps


592 .
globl
 
ve˘‹119


593 
ve˘‹119
:

594 
pushl
 
$0


595 
pushl
 
$119


596 
jmp
 
Æ…øps


597 .
globl
 
ve˘‹120


598 
ve˘‹120
:

599 
pushl
 
$0


600 
pushl
 
$120


601 
jmp
 
Æ…øps


602 .
globl
 
ve˘‹121


603 
ve˘‹121
:

604 
pushl
 
$0


605 
pushl
 
$121


606 
jmp
 
Æ…øps


607 .
globl
 
ve˘‹122


608 
ve˘‹122
:

609 
pushl
 
$0


610 
pushl
 
$122


611 
jmp
 
Æ…øps


612 .
globl
 
ve˘‹123


613 
ve˘‹123
:

614 
pushl
 
$0


615 
pushl
 
$123


616 
jmp
 
Æ…øps


617 .
globl
 
ve˘‹124


618 
ve˘‹124
:

619 
pushl
 
$0


620 
pushl
 
$124


621 
jmp
 
Æ…øps


622 .
globl
 
ve˘‹125


623 
ve˘‹125
:

624 
pushl
 
$0


625 
pushl
 
$125


626 
jmp
 
Æ…øps


627 .
globl
 
ve˘‹126


628 
ve˘‹126
:

629 
pushl
 
$0


630 
pushl
 
$126


631 
jmp
 
Æ…øps


632 .
globl
 
ve˘‹127


633 
ve˘‹127
:

634 
pushl
 
$0


635 
pushl
 
$127


636 
jmp
 
Æ…øps


637 .
globl
 
ve˘‹128


638 
ve˘‹128
:

639 
pushl
 
$0


640 
pushl
 
$128


641 
jmp
 
Æ…øps


642 .
globl
 
ve˘‹129


643 
ve˘‹129
:

644 
pushl
 
$0


645 
pushl
 
$129


646 
jmp
 
Æ…øps


647 .
globl
 
ve˘‹130


648 
ve˘‹130
:

649 
pushl
 
$0


650 
pushl
 
$130


651 
jmp
 
Æ…øps


652 .
globl
 
ve˘‹131


653 
ve˘‹131
:

654 
pushl
 
$0


655 
pushl
 
$131


656 
jmp
 
Æ…øps


657 .
globl
 
ve˘‹132


658 
ve˘‹132
:

659 
pushl
 
$0


660 
pushl
 
$132


661 
jmp
 
Æ…øps


662 .
globl
 
ve˘‹133


663 
ve˘‹133
:

664 
pushl
 
$0


665 
pushl
 
$133


666 
jmp
 
Æ…øps


667 .
globl
 
ve˘‹134


668 
ve˘‹134
:

669 
pushl
 
$0


670 
pushl
 
$134


671 
jmp
 
Æ…øps


672 .
globl
 
ve˘‹135


673 
ve˘‹135
:

674 
pushl
 
$0


675 
pushl
 
$135


676 
jmp
 
Æ…øps


677 .
globl
 
ve˘‹136


678 
ve˘‹136
:

679 
pushl
 
$0


680 
pushl
 
$136


681 
jmp
 
Æ…øps


682 .
globl
 
ve˘‹137


683 
ve˘‹137
:

684 
pushl
 
$0


685 
pushl
 
$137


686 
jmp
 
Æ…øps


687 .
globl
 
ve˘‹138


688 
ve˘‹138
:

689 
pushl
 
$0


690 
pushl
 
$138


691 
jmp
 
Æ…øps


692 .
globl
 
ve˘‹139


693 
ve˘‹139
:

694 
pushl
 
$0


695 
pushl
 
$139


696 
jmp
 
Æ…øps


697 .
globl
 
ve˘‹140


698 
ve˘‹140
:

699 
pushl
 
$0


700 
pushl
 
$140


701 
jmp
 
Æ…øps


702 .
globl
 
ve˘‹141


703 
ve˘‹141
:

704 
pushl
 
$0


705 
pushl
 
$141


706 
jmp
 
Æ…øps


707 .
globl
 
ve˘‹142


708 
ve˘‹142
:

709 
pushl
 
$0


710 
pushl
 
$142


711 
jmp
 
Æ…øps


712 .
globl
 
ve˘‹143


713 
ve˘‹143
:

714 
pushl
 
$0


715 
pushl
 
$143


716 
jmp
 
Æ…øps


717 .
globl
 
ve˘‹144


718 
ve˘‹144
:

719 
pushl
 
$0


720 
pushl
 
$144


721 
jmp
 
Æ…øps


722 .
globl
 
ve˘‹145


723 
ve˘‹145
:

724 
pushl
 
$0


725 
pushl
 
$145


726 
jmp
 
Æ…øps


727 .
globl
 
ve˘‹146


728 
ve˘‹146
:

729 
pushl
 
$0


730 
pushl
 
$146


731 
jmp
 
Æ…øps


732 .
globl
 
ve˘‹147


733 
ve˘‹147
:

734 
pushl
 
$0


735 
pushl
 
$147


736 
jmp
 
Æ…øps


737 .
globl
 
ve˘‹148


738 
ve˘‹148
:

739 
pushl
 
$0


740 
pushl
 
$148


741 
jmp
 
Æ…øps


742 .
globl
 
ve˘‹149


743 
ve˘‹149
:

744 
pushl
 
$0


745 
pushl
 
$149


746 
jmp
 
Æ…øps


747 .
globl
 
ve˘‹150


748 
ve˘‹150
:

749 
pushl
 
$0


750 
pushl
 
$150


751 
jmp
 
Æ…øps


752 .
globl
 
ve˘‹151


753 
ve˘‹151
:

754 
pushl
 
$0


755 
pushl
 
$151


756 
jmp
 
Æ…øps


757 .
globl
 
ve˘‹152


758 
ve˘‹152
:

759 
pushl
 
$0


760 
pushl
 
$152


761 
jmp
 
Æ…øps


762 .
globl
 
ve˘‹153


763 
ve˘‹153
:

764 
pushl
 
$0


765 
pushl
 
$153


766 
jmp
 
Æ…øps


767 .
globl
 
ve˘‹154


768 
ve˘‹154
:

769 
pushl
 
$0


770 
pushl
 
$154


771 
jmp
 
Æ…øps


772 .
globl
 
ve˘‹155


773 
ve˘‹155
:

774 
pushl
 
$0


775 
pushl
 
$155


776 
jmp
 
Æ…øps


777 .
globl
 
ve˘‹156


778 
ve˘‹156
:

779 
pushl
 
$0


780 
pushl
 
$156


781 
jmp
 
Æ…øps


782 .
globl
 
ve˘‹157


783 
ve˘‹157
:

784 
pushl
 
$0


785 
pushl
 
$157


786 
jmp
 
Æ…øps


787 .
globl
 
ve˘‹158


788 
ve˘‹158
:

789 
pushl
 
$0


790 
pushl
 
$158


791 
jmp
 
Æ…øps


792 .
globl
 
ve˘‹159


793 
ve˘‹159
:

794 
pushl
 
$0


795 
pushl
 
$159


796 
jmp
 
Æ…øps


797 .
globl
 
ve˘‹160


798 
ve˘‹160
:

799 
pushl
 
$0


800 
pushl
 
$160


801 
jmp
 
Æ…øps


802 .
globl
 
ve˘‹161


803 
ve˘‹161
:

804 
pushl
 
$0


805 
pushl
 
$161


806 
jmp
 
Æ…øps


807 .
globl
 
ve˘‹162


808 
ve˘‹162
:

809 
pushl
 
$0


810 
pushl
 
$162


811 
jmp
 
Æ…øps


812 .
globl
 
ve˘‹163


813 
ve˘‹163
:

814 
pushl
 
$0


815 
pushl
 
$163


816 
jmp
 
Æ…øps


817 .
globl
 
ve˘‹164


818 
ve˘‹164
:

819 
pushl
 
$0


820 
pushl
 
$164


821 
jmp
 
Æ…øps


822 .
globl
 
ve˘‹165


823 
ve˘‹165
:

824 
pushl
 
$0


825 
pushl
 
$165


826 
jmp
 
Æ…øps


827 .
globl
 
ve˘‹166


828 
ve˘‹166
:

829 
pushl
 
$0


830 
pushl
 
$166


831 
jmp
 
Æ…øps


832 .
globl
 
ve˘‹167


833 
ve˘‹167
:

834 
pushl
 
$0


835 
pushl
 
$167


836 
jmp
 
Æ…øps


837 .
globl
 
ve˘‹168


838 
ve˘‹168
:

839 
pushl
 
$0


840 
pushl
 
$168


841 
jmp
 
Æ…øps


842 .
globl
 
ve˘‹169


843 
ve˘‹169
:

844 
pushl
 
$0


845 
pushl
 
$169


846 
jmp
 
Æ…øps


847 .
globl
 
ve˘‹170


848 
ve˘‹170
:

849 
pushl
 
$0


850 
pushl
 
$170


851 
jmp
 
Æ…øps


852 .
globl
 
ve˘‹171


853 
ve˘‹171
:

854 
pushl
 
$0


855 
pushl
 
$171


856 
jmp
 
Æ…øps


857 .
globl
 
ve˘‹172


858 
ve˘‹172
:

859 
pushl
 
$0


860 
pushl
 
$172


861 
jmp
 
Æ…øps


862 .
globl
 
ve˘‹173


863 
ve˘‹173
:

864 
pushl
 
$0


865 
pushl
 
$173


866 
jmp
 
Æ…øps


867 .
globl
 
ve˘‹174


868 
ve˘‹174
:

869 
pushl
 
$0


870 
pushl
 
$174


871 
jmp
 
Æ…øps


872 .
globl
 
ve˘‹175


873 
ve˘‹175
:

874 
pushl
 
$0


875 
pushl
 
$175


876 
jmp
 
Æ…øps


877 .
globl
 
ve˘‹176


878 
ve˘‹176
:

879 
pushl
 
$0


880 
pushl
 
$176


881 
jmp
 
Æ…øps


882 .
globl
 
ve˘‹177


883 
ve˘‹177
:

884 
pushl
 
$0


885 
pushl
 
$177


886 
jmp
 
Æ…øps


887 .
globl
 
ve˘‹178


888 
ve˘‹178
:

889 
pushl
 
$0


890 
pushl
 
$178


891 
jmp
 
Æ…øps


892 .
globl
 
ve˘‹179


893 
ve˘‹179
:

894 
pushl
 
$0


895 
pushl
 
$179


896 
jmp
 
Æ…øps


897 .
globl
 
ve˘‹180


898 
ve˘‹180
:

899 
pushl
 
$0


900 
pushl
 
$180


901 
jmp
 
Æ…øps


902 .
globl
 
ve˘‹181


903 
ve˘‹181
:

904 
pushl
 
$0


905 
pushl
 
$181


906 
jmp
 
Æ…øps


907 .
globl
 
ve˘‹182


908 
ve˘‹182
:

909 
pushl
 
$0


910 
pushl
 
$182


911 
jmp
 
Æ…øps


912 .
globl
 
ve˘‹183


913 
ve˘‹183
:

914 
pushl
 
$0


915 
pushl
 
$183


916 
jmp
 
Æ…øps


917 .
globl
 
ve˘‹184


918 
ve˘‹184
:

919 
pushl
 
$0


920 
pushl
 
$184


921 
jmp
 
Æ…øps


922 .
globl
 
ve˘‹185


923 
ve˘‹185
:

924 
pushl
 
$0


925 
pushl
 
$185


926 
jmp
 
Æ…øps


927 .
globl
 
ve˘‹186


928 
ve˘‹186
:

929 
pushl
 
$0


930 
pushl
 
$186


931 
jmp
 
Æ…øps


932 .
globl
 
ve˘‹187


933 
ve˘‹187
:

934 
pushl
 
$0


935 
pushl
 
$187


936 
jmp
 
Æ…øps


937 .
globl
 
ve˘‹188


938 
ve˘‹188
:

939 
pushl
 
$0


940 
pushl
 
$188


941 
jmp
 
Æ…øps


942 .
globl
 
ve˘‹189


943 
ve˘‹189
:

944 
pushl
 
$0


945 
pushl
 
$189


946 
jmp
 
Æ…øps


947 .
globl
 
ve˘‹190


948 
ve˘‹190
:

949 
pushl
 
$0


950 
pushl
 
$190


951 
jmp
 
Æ…øps


952 .
globl
 
ve˘‹191


953 
ve˘‹191
:

954 
pushl
 
$0


955 
pushl
 
$191


956 
jmp
 
Æ…øps


957 .
globl
 
ve˘‹192


958 
ve˘‹192
:

959 
pushl
 
$0


960 
pushl
 
$192


961 
jmp
 
Æ…øps


962 .
globl
 
ve˘‹193


963 
ve˘‹193
:

964 
pushl
 
$0


965 
pushl
 
$193


966 
jmp
 
Æ…øps


967 .
globl
 
ve˘‹194


968 
ve˘‹194
:

969 
pushl
 
$0


970 
pushl
 
$194


971 
jmp
 
Æ…øps


972 .
globl
 
ve˘‹195


973 
ve˘‹195
:

974 
pushl
 
$0


975 
pushl
 
$195


976 
jmp
 
Æ…øps


977 .
globl
 
ve˘‹196


978 
ve˘‹196
:

979 
pushl
 
$0


980 
pushl
 
$196


981 
jmp
 
Æ…øps


982 .
globl
 
ve˘‹197


983 
ve˘‹197
:

984 
pushl
 
$0


985 
pushl
 
$197


986 
jmp
 
Æ…øps


987 .
globl
 
ve˘‹198


988 
ve˘‹198
:

989 
pushl
 
$0


990 
pushl
 
$198


991 
jmp
 
Æ…øps


992 .
globl
 
ve˘‹199


993 
ve˘‹199
:

994 
pushl
 
$0


995 
pushl
 
$199


996 
jmp
 
Æ…øps


997 .
globl
 
ve˘‹200


998 
ve˘‹200
:

999 
pushl
 
$0


1000 
pushl
 
$200


1001 
jmp
 
Æ…øps


1002 .
globl
 
ve˘‹201


1003 
ve˘‹201
:

1004 
pushl
 
$0


1005 
pushl
 
$201


1006 
jmp
 
Æ…øps


1007 .
globl
 
ve˘‹202


1008 
ve˘‹202
:

1009 
pushl
 
$0


1010 
pushl
 
$202


1011 
jmp
 
Æ…øps


1012 .
globl
 
ve˘‹203


1013 
ve˘‹203
:

1014 
pushl
 
$0


1015 
pushl
 
$203


1016 
jmp
 
Æ…øps


1017 .
globl
 
ve˘‹204


1018 
ve˘‹204
:

1019 
pushl
 
$0


1020 
pushl
 
$204


1021 
jmp
 
Æ…øps


1022 .
globl
 
ve˘‹205


1023 
ve˘‹205
:

1024 
pushl
 
$0


1025 
pushl
 
$205


1026 
jmp
 
Æ…øps


1027 .
globl
 
ve˘‹206


1028 
ve˘‹206
:

1029 
pushl
 
$0


1030 
pushl
 
$206


1031 
jmp
 
Æ…øps


1032 .
globl
 
ve˘‹207


1033 
ve˘‹207
:

1034 
pushl
 
$0


1035 
pushl
 
$207


1036 
jmp
 
Æ…øps


1037 .
globl
 
ve˘‹208


1038 
ve˘‹208
:

1039 
pushl
 
$0


1040 
pushl
 
$208


1041 
jmp
 
Æ…øps


1042 .
globl
 
ve˘‹209


1043 
ve˘‹209
:

1044 
pushl
 
$0


1045 
pushl
 
$209


1046 
jmp
 
Æ…øps


1047 .
globl
 
ve˘‹210


1048 
ve˘‹210
:

1049 
pushl
 
$0


1050 
pushl
 
$210


1051 
jmp
 
Æ…øps


1052 .
globl
 
ve˘‹211


1053 
ve˘‹211
:

1054 
pushl
 
$0


1055 
pushl
 
$211


1056 
jmp
 
Æ…øps


1057 .
globl
 
ve˘‹212


1058 
ve˘‹212
:

1059 
pushl
 
$0


1060 
pushl
 
$212


1061 
jmp
 
Æ…øps


1062 .
globl
 
ve˘‹213


1063 
ve˘‹213
:

1064 
pushl
 
$0


1065 
pushl
 
$213


1066 
jmp
 
Æ…øps


1067 .
globl
 
ve˘‹214


1068 
ve˘‹214
:

1069 
pushl
 
$0


1070 
pushl
 
$214


1071 
jmp
 
Æ…øps


1072 .
globl
 
ve˘‹215


1073 
ve˘‹215
:

1074 
pushl
 
$0


1075 
pushl
 
$215


1076 
jmp
 
Æ…øps


1077 .
globl
 
ve˘‹216


1078 
ve˘‹216
:

1079 
pushl
 
$0


1080 
pushl
 
$216


1081 
jmp
 
Æ…øps


1082 .
globl
 
ve˘‹217


1083 
ve˘‹217
:

1084 
pushl
 
$0


1085 
pushl
 
$217


1086 
jmp
 
Æ…øps


1087 .
globl
 
ve˘‹218


1088 
ve˘‹218
:

1089 
pushl
 
$0


1090 
pushl
 
$218


1091 
jmp
 
Æ…øps


1092 .
globl
 
ve˘‹219


1093 
ve˘‹219
:

1094 
pushl
 
$0


1095 
pushl
 
$219


1096 
jmp
 
Æ…øps


1097 .
globl
 
ve˘‹220


1098 
ve˘‹220
:

1099 
pushl
 
$0


1100 
pushl
 
$220


1101 
jmp
 
Æ…øps


1102 .
globl
 
ve˘‹221


1103 
ve˘‹221
:

1104 
pushl
 
$0


1105 
pushl
 
$221


1106 
jmp
 
Æ…øps


1107 .
globl
 
ve˘‹222


1108 
ve˘‹222
:

1109 
pushl
 
$0


1110 
pushl
 
$222


1111 
jmp
 
Æ…øps


1112 .
globl
 
ve˘‹223


1113 
ve˘‹223
:

1114 
pushl
 
$0


1115 
pushl
 
$223


1116 
jmp
 
Æ…øps


1117 .
globl
 
ve˘‹224


1118 
ve˘‹224
:

1119 
pushl
 
$0


1120 
pushl
 
$224


1121 
jmp
 
Æ…øps


1122 .
globl
 
ve˘‹225


1123 
ve˘‹225
:

1124 
pushl
 
$0


1125 
pushl
 
$225


1126 
jmp
 
Æ…øps


1127 .
globl
 
ve˘‹226


1128 
ve˘‹226
:

1129 
pushl
 
$0


1130 
pushl
 
$226


1131 
jmp
 
Æ…øps


1132 .
globl
 
ve˘‹227


1133 
ve˘‹227
:

1134 
pushl
 
$0


1135 
pushl
 
$227


1136 
jmp
 
Æ…øps


1137 .
globl
 
ve˘‹228


1138 
ve˘‹228
:

1139 
pushl
 
$0


1140 
pushl
 
$228


1141 
jmp
 
Æ…øps


1142 .
globl
 
ve˘‹229


1143 
ve˘‹229
:

1144 
pushl
 
$0


1145 
pushl
 
$229


1146 
jmp
 
Æ…øps


1147 .
globl
 
ve˘‹230


1148 
ve˘‹230
:

1149 
pushl
 
$0


1150 
pushl
 
$230


1151 
jmp
 
Æ…øps


1152 .
globl
 
ve˘‹231


1153 
ve˘‹231
:

1154 
pushl
 
$0


1155 
pushl
 
$231


1156 
jmp
 
Æ…øps


1157 .
globl
 
ve˘‹232


1158 
ve˘‹232
:

1159 
pushl
 
$0


1160 
pushl
 
$232


1161 
jmp
 
Æ…øps


1162 .
globl
 
ve˘‹233


1163 
ve˘‹233
:

1164 
pushl
 
$0


1165 
pushl
 
$233


1166 
jmp
 
Æ…øps


1167 .
globl
 
ve˘‹234


1168 
ve˘‹234
:

1169 
pushl
 
$0


1170 
pushl
 
$234


1171 
jmp
 
Æ…øps


1172 .
globl
 
ve˘‹235


1173 
ve˘‹235
:

1174 
pushl
 
$0


1175 
pushl
 
$235


1176 
jmp
 
Æ…øps


1177 .
globl
 
ve˘‹236


1178 
ve˘‹236
:

1179 
pushl
 
$0


1180 
pushl
 
$236


1181 
jmp
 
Æ…øps


1182 .
globl
 
ve˘‹237


1183 
ve˘‹237
:

1184 
pushl
 
$0


1185 
pushl
 
$237


1186 
jmp
 
Æ…øps


1187 .
globl
 
ve˘‹238


1188 
ve˘‹238
:

1189 
pushl
 
$0


1190 
pushl
 
$238


1191 
jmp
 
Æ…øps


1192 .
globl
 
ve˘‹239


1193 
ve˘‹239
:

1194 
pushl
 
$0


1195 
pushl
 
$239


1196 
jmp
 
Æ…øps


1197 .
globl
 
ve˘‹240


1198 
ve˘‹240
:

1199 
pushl
 
$0


1200 
pushl
 
$240


1201 
jmp
 
Æ…øps


1202 .
globl
 
ve˘‹241


1203 
ve˘‹241
:

1204 
pushl
 
$0


1205 
pushl
 
$241


1206 
jmp
 
Æ…øps


1207 .
globl
 
ve˘‹242


1208 
ve˘‹242
:

1209 
pushl
 
$0


1210 
pushl
 
$242


1211 
jmp
 
Æ…øps


1212 .
globl
 
ve˘‹243


1213 
ve˘‹243
:

1214 
pushl
 
$0


1215 
pushl
 
$243


1216 
jmp
 
Æ…øps


1217 .
globl
 
ve˘‹244


1218 
ve˘‹244
:

1219 
pushl
 
$0


1220 
pushl
 
$244


1221 
jmp
 
Æ…øps


1222 .
globl
 
ve˘‹245


1223 
ve˘‹245
:

1224 
pushl
 
$0


1225 
pushl
 
$245


1226 
jmp
 
Æ…øps


1227 .
globl
 
ve˘‹246


1228 
ve˘‹246
:

1229 
pushl
 
$0


1230 
pushl
 
$246


1231 
jmp
 
Æ…øps


1232 .
globl
 
ve˘‹247


1233 
ve˘‹247
:

1234 
pushl
 
$0


1235 
pushl
 
$247


1236 
jmp
 
Æ…øps


1237 .
globl
 
ve˘‹248


1238 
ve˘‹248
:

1239 
pushl
 
$0


1240 
pushl
 
$248


1241 
jmp
 
Æ…øps


1242 .
globl
 
ve˘‹249


1243 
ve˘‹249
:

1244 
pushl
 
$0


1245 
pushl
 
$249


1246 
jmp
 
Æ…øps


1247 .
globl
 
ve˘‹250


1248 
ve˘‹250
:

1249 
pushl
 
$0


1250 
pushl
 
$250


1251 
jmp
 
Æ…øps


1252 .
globl
 
ve˘‹251


1253 
ve˘‹251
:

1254 
pushl
 
$0


1255 
pushl
 
$251


1256 
jmp
 
Æ…øps


1257 .
globl
 
ve˘‹252


1258 
ve˘‹252
:

1259 
pushl
 
$0


1260 
pushl
 
$252


1261 
jmp
 
Æ…øps


1262 .
globl
 
ve˘‹253


1263 
ve˘‹253
:

1264 
pushl
 
$0


1265 
pushl
 
$253


1266 
jmp
 
Æ…øps


1267 .
globl
 
ve˘‹254


1268 
ve˘‹254
:

1269 
pushl
 
$0


1270 
pushl
 
$254


1271 
jmp
 
Æ…øps


1272 .
globl
 
ve˘‹255


1273 
ve˘‹255
:

1274 
pushl
 
$0


1275 
pushl
 
$255


1276 
jmp
 
Æ…øps


1278 #ve˘‹ 
èbÀ


1279 .
d©a


1280 .
globl
 
ve˘‹s


1281 
ve˘‹s
:

1282 .
ve˘‹0


1283 .
ve˘‹1


1284 .
ve˘‹2


1285 .
ve˘‹3


1286 .
ve˘‹4


1287 .
ve˘‹5


1288 .
ve˘‹6


1289 .
ve˘‹7


1290 .
ve˘‹8


1291 .
ve˘‹9


1292 .
ve˘‹10


1293 .
ve˘‹11


1294 .
ve˘‹12


1295 .
ve˘‹13


1296 .
ve˘‹14


1297 .
ve˘‹15


1298 .
ve˘‹16


1299 .
ve˘‹17


1300 .
ve˘‹18


1301 .
ve˘‹19


1302 .
ve˘‹20


1303 .
ve˘‹21


1304 .
ve˘‹22


1305 .
ve˘‹23


1306 .
ve˘‹24


1307 .
ve˘‹25


1308 .
ve˘‹26


1309 .
ve˘‹27


1310 .
ve˘‹28


1311 .
ve˘‹29


1312 .
ve˘‹30


1313 .
ve˘‹31


1314 .
ve˘‹32


1315 .
ve˘‹33


1316 .
ve˘‹34


1317 .
ve˘‹35


1318 .
ve˘‹36


1319 .
ve˘‹37


1320 .
ve˘‹38


1321 .
ve˘‹39


1322 .
ve˘‹40


1323 .
ve˘‹41


1324 .
ve˘‹42


1325 .
ve˘‹43


1326 .
ve˘‹44


1327 .
ve˘‹45


1328 .
ve˘‹46


1329 .
ve˘‹47


1330 .
ve˘‹48


1331 .
ve˘‹49


1332 .
ve˘‹50


1333 .
ve˘‹51


1334 .
ve˘‹52


1335 .
ve˘‹53


1336 .
ve˘‹54


1337 .
ve˘‹55


1338 .
ve˘‹56


1339 .
ve˘‹57


1340 .
ve˘‹58


1341 .
ve˘‹59


1342 .
ve˘‹60


1343 .
ve˘‹61


1344 .
ve˘‹62


1345 .
ve˘‹63


1346 .
ve˘‹64


1347 .
ve˘‹65


1348 .
ve˘‹66


1349 .
ve˘‹67


1350 .
ve˘‹68


1351 .
ve˘‹69


1352 .
ve˘‹70


1353 .
ve˘‹71


1354 .
ve˘‹72


1355 .
ve˘‹73


1356 .
ve˘‹74


1357 .
ve˘‹75


1358 .
ve˘‹76


1359 .
ve˘‹77


1360 .
ve˘‹78


1361 .
ve˘‹79


1362 .
ve˘‹80


1363 .
ve˘‹81


1364 .
ve˘‹82


1365 .
ve˘‹83


1366 .
ve˘‹84


1367 .
ve˘‹85


1368 .
ve˘‹86


1369 .
ve˘‹87


1370 .
ve˘‹88


1371 .
ve˘‹89


1372 .
ve˘‹90


1373 .
ve˘‹91


1374 .
ve˘‹92


1375 .
ve˘‹93


1376 .
ve˘‹94


1377 .
ve˘‹95


1378 .
ve˘‹96


1379 .
ve˘‹97


1380 .
ve˘‹98


1381 .
ve˘‹99


1382 .
ve˘‹100


1383 .
ve˘‹101


1384 .
ve˘‹102


1385 .
ve˘‹103


1386 .
ve˘‹104


1387 .
ve˘‹105


1388 .
ve˘‹106


1389 .
ve˘‹107


1390 .
ve˘‹108


1391 .
ve˘‹109


1392 .
ve˘‹110


1393 .
ve˘‹111


1394 .
ve˘‹112


1395 .
ve˘‹113


1396 .
ve˘‹114


1397 .
ve˘‹115


1398 .
ve˘‹116


1399 .
ve˘‹117


1400 .
ve˘‹118


1401 .
ve˘‹119


1402 .
ve˘‹120


1403 .
ve˘‹121


1404 .
ve˘‹122


1405 .
ve˘‹123


1406 .
ve˘‹124


1407 .
ve˘‹125


1408 .
ve˘‹126


1409 .
ve˘‹127


1410 .
ve˘‹128


1411 .
ve˘‹129


1412 .
ve˘‹130


1413 .
ve˘‹131


1414 .
ve˘‹132


1415 .
ve˘‹133


1416 .
ve˘‹134


1417 .
ve˘‹135


1418 .
ve˘‹136


1419 .
ve˘‹137


1420 .
ve˘‹138


1421 .
ve˘‹139


1422 .
ve˘‹140


1423 .
ve˘‹141


1424 .
ve˘‹142


1425 .
ve˘‹143


1426 .
ve˘‹144


1427 .
ve˘‹145


1428 .
ve˘‹146


1429 .
ve˘‹147


1430 .
ve˘‹148


1431 .
ve˘‹149


1432 .
ve˘‹150


1433 .
ve˘‹151


1434 .
ve˘‹152


1435 .
ve˘‹153


1436 .
ve˘‹154


1437 .
ve˘‹155


1438 .
ve˘‹156


1439 .
ve˘‹157


1440 .
ve˘‹158


1441 .
ve˘‹159


1442 .
ve˘‹160


1443 .
ve˘‹161


1444 .
ve˘‹162


1445 .
ve˘‹163


1446 .
ve˘‹164


1447 .
ve˘‹165


1448 .
ve˘‹166


1449 .
ve˘‹167


1450 .
ve˘‹168


1451 .
ve˘‹169


1452 .
ve˘‹170


1453 .
ve˘‹171


1454 .
ve˘‹172


1455 .
ve˘‹173


1456 .
ve˘‹174


1457 .
ve˘‹175


1458 .
ve˘‹176


1459 .
ve˘‹177


1460 .
ve˘‹178


1461 .
ve˘‹179


1462 .
ve˘‹180


1463 .
ve˘‹181


1464 .
ve˘‹182


1465 .
ve˘‹183


1466 .
ve˘‹184


1467 .
ve˘‹185


1468 .
ve˘‹186


1469 .
ve˘‹187


1470 .
ve˘‹188


1471 .
ve˘‹189


1472 .
ve˘‹190


1473 .
ve˘‹191


1474 .
ve˘‹192


1475 .
ve˘‹193


1476 .
ve˘‹194


1477 .
ve˘‹195


1478 .
ve˘‹196


1479 .
ve˘‹197


1480 .
ve˘‹198


1481 .
ve˘‹199


1482 .
ve˘‹200


1483 .
ve˘‹201


1484 .
ve˘‹202


1485 .
ve˘‹203


1486 .
ve˘‹204


1487 .
ve˘‹205


1488 .
ve˘‹206


1489 .
ve˘‹207


1490 .
ve˘‹208


1491 .
ve˘‹209


1492 .
ve˘‹210


1493 .
ve˘‹211


1494 .
ve˘‹212


1495 .
ve˘‹213


1496 .
ve˘‹214


1497 .
ve˘‹215


1498 .
ve˘‹216


1499 .
ve˘‹217


1500 .
ve˘‹218


1501 .
ve˘‹219


1502 .
ve˘‹220


1503 .
ve˘‹221


1504 .
ve˘‹222


1505 .
ve˘‹223


1506 .
ve˘‹224


1507 .
ve˘‹225


1508 .
ve˘‹226


1509 .
ve˘‹227


1510 .
ve˘‹228


1511 .
ve˘‹229


1512 .
ve˘‹230


1513 .
ve˘‹231


1514 .
ve˘‹232


1515 .
ve˘‹233


1516 .
ve˘‹234


1517 .
ve˘‹235


1518 .
ve˘‹236


1519 .
ve˘‹237


1520 .
ve˘‹238


1521 .
ve˘‹239


1522 .
ve˘‹240


1523 .
ve˘‹241


1524 .
ve˘‹242


1525 .
ve˘‹243


1526 .
ve˘‹244


1527 .
ve˘‹245


1528 .
ve˘‹246


1529 .
ve˘‹247


1530 .
ve˘‹248


1531 .
ve˘‹249


1532 .
ve˘‹250


1533 .
ve˘‹251


1534 .
ve˘‹252


1535 .
ve˘‹253


1536 .
ve˘‹254


1537 .
ve˘‹255


	@vm.c

1 
	~"∑øm.h
"

2 
	~"ty≥s.h
"

3 
	~"defs.h
"

4 
	~"x86.h
"

5 
	~"memœyout.h
"

6 
	~"mmu.h
"

7 
	~"¥oc.h
"

8 
	~"ñf.h
"

10 
d©a
[];

11 
pde_t
 *
	gkpgdú
;

16 
	$£göô
()

18 
˝u
 *
c
;

24 
c
 = &
˝us
[
	`˝unum
()];

25 
c
->
gdt
[
SEG_KCODE
] = 
	`SEG
(
STA_X
|
STA_R
, 0, 0xffffffff, 0);

26 
c
->
gdt
[
SEG_KDATA
] = 
	`SEG
(
STA_W
, 0, 0xffffffff, 0);

27 
c
->
gdt
[
SEG_UCODE
] = 
	`SEG
(
STA_X
|
STA_R
, 0, 0xffffffff, 
DPL_USER
);

28 
c
->
gdt
[
SEG_UDATA
] = 
	`SEG
(
STA_W
, 0, 0xffffffff, 
DPL_USER
);

31 
c
->
gdt
[
SEG_KCPU
] = 
	`SEG
(
STA_W
, &c->
˝u
, 8, 0);

33 
	`lgdt
(
c
->
gdt
, (c->gdt));

34 
	`lﬂdgs
(
SEG_KCPU
 << 3);

37 
˝u
 = 
c
;

38 
¥oc
 = 0;

39 
	}
}

44 
±e_t
 *

45 
	$wÆkpgdú
(
pde_t
 *
pgdú
, c⁄° *
va
, 
Æloc
)

47 
pde_t
 *
pde
;

48 
±e_t
 *
pgèb
;

50 
pde
 = &
pgdú
[
	`PDX
(
va
)];

51 if(*
pde
 & 
PTE_P
){

52 
pgèb
 = (
±e_t
*)
	`P2V
(
	`PTE_ADDR
(*
pde
));

54 if(!
Æloc
 || (
pgèb
 = (
±e_t
*)
	`kÆloc
()) == 0)

57 
	`mem£t
(
pgèb
, 0, 
PGSIZE
);

61 *
pde
 = 
	`V2P
(
pgèb
Ë| 
PTE_P
 | 
PTE_W
 | 
PTE_U
;

63  &
pgèb
[
	`PTX
(
va
)];

64 
	}
}

70 
	$m≠∑ges
(
pde_t
 *
pgdú
, *
va
, 
uöt
 
size
, uöà
∑
, 
≥rm
)

72 *
a
, *
œ°
;

73 
±e_t
 *
±e
;

75 
a
 = (*)
	`PGROUNDDOWN
((
uöt
)
va
);

76 
œ°
 = (*)
	`PGROUNDDOWN
(((
uöt
)
va
Ë+ 
size
 - 1);

78 if((
±e
 = 
	`wÆkpgdú
(
pgdú
, 
a
, 1)) == 0)

80 if(*
±e
 & 
PTE_P
)

81 
	`∑nic
("remap");

82 *
±e
 = 
∑
 | 
≥rm
 | 
PTE_P
;

83 if(
a
 =
œ°
)

85 
a
 +
PGSIZE
;

86 
∑
 +
PGSIZE
;

89 
	}
}

114 
	skm≠
 {

115 *
	mvút
;

116 
uöt
 
	mphys_°¨t
;

117 
uöt
 
	mphys_íd
;

118 
	m≥rm
;

119 } 
	gkm≠
[] = {

120 { (*)
KERNBASE
, 0, 
EXTMEM
, 
PTE_W
},

121 { (*)
KERNLINK
, 
V2P
(KERNLINK), V2P(
d©a
), 0},

122 { (*)
d©a
, 
V2P
(d©a), 
PHYSTOP
, 
PTE_W
},

123 { (*)
DEVSPACE
, DEVSPACE, 0, 
PTE_W
},

127 
pde_t
*

128 
	$£tupkvm
()

130 
pde_t
 *
pgdú
;

131 
km≠
 *
k
;

133 if((
pgdú
 = (
pde_t
*)
	`kÆloc
()) == 0)

135 
	`mem£t
(
pgdú
, 0, 
PGSIZE
);

136 i‡(
	`P2V
(
PHYSTOP
Ë> (*)
DEVSPACE
)

137 
	`∑nic
("PHYSTOPÅoo high");

138 
k
 = 
km≠
; k < &km≠[
	`NELEM
(kmap)]; k++)

139 if(
	`m≠∑ges
(
pgdú
, 
k
->
vút
, k->
phys_íd
 - k->
phys_°¨t
,

140 (
uöt
)
k
->
phys_°¨t
, k->
≥rm
) < 0)

142  
pgdú
;

143 
	}
}

148 
	$kvmÆloc
()

150 
kpgdú
 = 
	`£tupkvm
();

151 
	`swôchkvm
();

152 
	}
}

157 
	$swôchkvm
()

159 
	`l¸3
(
	`V2P
(
kpgdú
));

160 
	}
}

164 
	$swôchuvm
(
¥oc
 *
p
)

166 if(
p
 == 0)

167 
	`∑nic
("switchuvm:ÇoÖrocess");

168 if(
p
->
k°ack
 == 0)

169 
	`∑nic
("switchuvm:Ço kstack");

170 if(
p
->
pgdú
 == 0)

171 
	`∑nic
("switchuvm:ÇoÖgdir");

173 
	`push˛i
();

174 
˝u
->
gdt
[
SEG_TSS
] = 
	`SEG16
(
STS_T32A
, &˝u->
ts
, (cpu->ts)-1, 0);

175 
˝u
->
gdt
[
SEG_TSS
].
s
 = 0;

176 
˝u
->
ts
.
ss0
 = 
SEG_KDATA
 << 3;

177 
˝u
->
ts
.
e•0
 = (
uöt
)
p
->
k°ack
 + 
KSTACKSIZE
;

180 
˝u
->
ts
.
iomb
 = (
ush‹t
) 0xFFFF;

181 
	`…r
(
SEG_TSS
 << 3);

182 
	`l¸3
(
	`V2P
(
p
->
pgdú
));

183 
	`p›˛i
();

184 
	}
}

189 
	$öôuvm
(
pde_t
 *
pgdú
, *
öô
, 
uöt
 
sz
)

191 *
mem
;

193 if(
sz
 >
PGSIZE
)

194 
	`∑nic
("inituvm: moreÅhanáÖage");

195 
mem
 = 
	`kÆloc
();

196 
	`mem£t
(
mem
, 0, 
PGSIZE
);

197 
	`m≠∑ges
(
pgdú
, 0, 
PGSIZE
, 
	`V2P
(
mem
), 
PTE_W
|
PTE_U
);

198 
	`memmove
(
mem
, 
öô
, 
sz
);

199 
	}
}

204 
	$lﬂduvm
(
pde_t
 *
pgdú
, *
addr
, 
öode
 *
ù
, 
uöt
 
off£t
, uöà
sz
)

206 
uöt
 
i
, 
∑
, 
n
;

207 
±e_t
 *
±e
;

209 if((
uöt
Ë
addr
 % 
PGSIZE
 != 0)

210 
	`∑nic
("loaduvm:áddr must beÖageáligned");

211 
i
 = 0; i < 
sz
; i +
PGSIZE
){

212 if((
±e
 = 
	`wÆkpgdú
(
pgdú
, 
addr
+
i
, 0)) == 0)

213 
	`∑nic
("loaduvm:áddress shouldÉxist");

214 
∑
 = 
	`PTE_ADDR
(*
±e
);

215 if(
sz
 - 
i
 < 
PGSIZE
)

216 
n
 = 
sz
 - 
i
;

218 
n
 = 
PGSIZE
;

219 if(
	`ªadi
(
ù
, 
	`P2V
(
∑
), 
off£t
+
i
, 
n
) !=Ç)

223 
	}
}

228 
	$Ælocuvm
(
pde_t
 *
pgdú
, 
uöt
 
ﬁdsz
, uöà
√wsz
)

230 *
mem
;

231 
uöt
 
a
;

233 if(
√wsz
 >
KERNBASE
)

235 if(
√wsz
 < 
ﬁdsz
)

236  
ﬁdsz
;

238 
a
 = 
	`PGROUNDUP
(
ﬁdsz
);

239 ; 
a
 < 
√wsz
;á +
PGSIZE
){

240 
mem
 = 
	`kÆloc
();

241 if(
mem
 == 0){

242 
	`˝rötf
("allocuvm out of memory\n");

243 
	`dóŒocuvm
(
pgdú
, 
√wsz
, 
ﬁdsz
);

246 
	`mem£t
(
mem
, 0, 
PGSIZE
);

247 if(
	`m≠∑ges
(
pgdú
, (*)
a
, 
PGSIZE
, 
	`V2P
(
mem
), 
PTE_W
|
PTE_U
) < 0){

248 
	`˝rötf
("allocuvm out of memory (2)\n");

249 
	`dóŒocuvm
(
pgdú
, 
√wsz
, 
ﬁdsz
);

250 
	`k‰ì
(
mem
);

254  
√wsz
;

255 
	}
}

262 
	$dóŒocuvm
(
pde_t
 *
pgdú
, 
uöt
 
ﬁdsz
, uöà
√wsz
)

264 
±e_t
 *
±e
;

265 
uöt
 
a
, 
∑
;

267 if(
√wsz
 >
ﬁdsz
)

268  
ﬁdsz
;

270 
a
 = 
	`PGROUNDUP
(
√wsz
);

271 ; 
a
 < 
ﬁdsz
;á +
PGSIZE
){

272 
±e
 = 
	`wÆkpgdú
(
pgdú
, (*)
a
, 0);

273 if(!
±e
)

274 
a
 = 
	`PGADDR
(
	`PDX
◊Ë+ 1, 0, 0Ë- 
PGSIZE
;

275 if((*
±e
 & 
PTE_P
) != 0){

276 
∑
 = 
	`PTE_ADDR
(*
±e
);

277 if(
∑
 == 0)

278 
	`∑nic
("kfree");

279 *
v
 = 
	`P2V
(
∑
);

280 
	`k‰ì
(
v
);

281 *
±e
 = 0;

284  
√wsz
;

285 
	}
}

290 
	$‰ìvm
(
pde_t
 *
pgdú
)

292 
uöt
 
i
;

294 if(
pgdú
 == 0)

295 
	`∑nic
("freevm:ÇoÖgdir");

296 
	`dóŒocuvm
(
pgdú
, 
KERNBASE
, 0);

297 
i
 = 0; i < 
NPDENTRIES
; i++){

298 if(
pgdú
[
i
] & 
PTE_P
){

299 * 
v
 = 
	`P2V
(
	`PTE_ADDR
(
pgdú
[
i
]));

300 
	`k‰ì
(
v
);

303 
	`k‰ì
((*)
pgdú
);

304 
	}
}

309 
	$˛óΩãu
(
pde_t
 *
pgdú
, *
uva
)

311 
±e_t
 *
±e
;

313 
±e
 = 
	`wÆkpgdú
(
pgdú
, 
uva
, 0);

314 if(
±e
 == 0)

315 
	`∑nic
("clearpteu");

316 *
±e
 &~
PTE_U
;

317 
	}
}

321 
pde_t
*

322 
	$c›yuvm
(
pde_t
 *
pgdú
, 
uöt
 
sz
)

324 
pde_t
 *
d
;

325 
±e_t
 *
±e
;

326 
uöt
 
∑
, 
i
, 
Êags
;

327 *
mem
;

329 if((
d
 = 
	`£tupkvm
()) == 0)

331 
i
 = 0; i < 
sz
; i +
PGSIZE
){

332 if((
±e
 = 
	`wÆkpgdú
(
pgdú
, (*Ë
i
, 0)) == 0)

333 
	`∑nic
("copyuvm:Öte shouldÉxist");

334 if(!(*
±e
 & 
PTE_P
))

335 
	`∑nic
("copyuvm:ÖageÇotÖresent");

336 
∑
 = 
	`PTE_ADDR
(*
±e
);

337 
Êags
 = 
	`PTE_FLAGS
(*
±e
);

338 if((
mem
 = 
	`kÆloc
()) == 0)

339 
bad
;

340 
	`memmove
(
mem
, (*)
	`P2V
(
∑
), 
PGSIZE
);

341 if(
	`m≠∑ges
(
d
, (*)
i
, 
PGSIZE
, 
	`V2P
(
mem
), 
Êags
) < 0)

342 
bad
;

344  
d
;

346 
bad
:

347 
	`‰ìvm
(
d
);

349 
	}
}

354 
	$uva2ka
(
pde_t
 *
pgdú
, *
uva
)

356 
±e_t
 *
±e
;

358 
±e
 = 
	`wÆkpgdú
(
pgdú
, 
uva
, 0);

359 if((*
±e
 & 
PTE_P
) == 0)

361 if((*
±e
 & 
PTE_U
) == 0)

363  (*)
	`P2V
(
	`PTE_ADDR
(*
±e
));

364 
	}
}

370 
	$c›yout
(
pde_t
 *
pgdú
, 
uöt
 
va
, *
p
, uöà
Àn
)

372 *
buf
, *
∑0
;

373 
uöt
 
n
, 
va0
;

375 
buf
 = (*)
p
;

376 
Àn
 > 0){

377 
va0
 = (
uöt
)
	`PGROUNDDOWN
(
va
);

378 
∑0
 = 
	`uva2ka
(
pgdú
, (*)
va0
);

379 if(
∑0
 == 0)

381 
n
 = 
PGSIZE
 - (
va
 - 
va0
);

382 if(
n
 > 
Àn
)

383 
n
 = 
Àn
;

384 
	`memmove
(
∑0
 + (
va
 - 
va0
), 
buf
, 
n
);

385 
Àn
 -
n
;

386 
buf
 +
n
;

387 
va
 = 
va0
 + 
PGSIZE
;

390 
	}
}

	@wc.c

1 
	~"ty≥s.h
"

2 
	~"°©.h
"

3 
	~"u£r.h
"

5 
	gbuf
[512];

8 
	$wc
(
fd
, *
«me
)

10 
i
, 
n
;

11 
l
, 
w
, 
c
, 
öw‹d
;

13 
l
 = 
w
 = 
c
 = 0;

14 
öw‹d
 = 0;

15 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0){

16 
i
=0; i<
n
; i++){

17 
c
++;

18 if(
buf
[
i
] == '\n')

19 
l
++;

20 if(
	`°rchr
(" \r\t\n\v", 
buf
[
i
]))

21 
öw‹d
 = 0;

22 if(!
öw‹d
){

23 
w
++;

24 
öw‹d
 = 1;

28 if(
n
 < 0){

29 
	`¥ötf
(1, "wc:ÑeadÉrror\n");

30 
	`exô
();

32 
	`¥ötf
(1, "%d %d %d %s\n", 
l
, 
w
, 
c
, 
«me
);

33 
	}
}

36 
	$maö
(
¨gc
, *
¨gv
[])

38 
fd
, 
i
;

40 if(
¨gc
 <= 1){

41 
	`wc
(0, "");

42 
	`exô
();

45 
i
 = 1; i < 
¨gc
; i++){

46 if((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0){

47 
	`¥ötf
(1, "wc: c™nŸ o≥¿%s\n", 
¨gv
[
i
]);

48 
	`exô
();

50 
	`wc
(
fd
, 
¨gv
[
i
]);

51 
	`˛o£
(
fd
);

53 
	`exô
();

54 
	}
}

	@x86.h

3 
ölöe
 
uch¨


4 
	$öb
(
ush‹t
 
p‹t
)

6 
uch¨
 
d©a
;

8 
asm
 vﬁ©ûe("ö %1,%0" : "˜" (
d©a
Ë: "d" (
p‹t
));

9  
d©a
;

10 
	}
}

12 
ölöe
 

13 
	$ö¶
(
p‹t
, *
addr
, 
˙t
)

15 
asm
 volatile("cld;Ñep insl" :

16 "=D" (
addr
), "=c" (
˙t
) :

17 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

19 
	}
}

21 
ölöe
 

22 
	$outb
(
ush‹t
 
p‹t
, 
uch¨
 
d©a
)

24 
asm
 vﬁ©ûe("ouà%0,%1" : : "a" (
d©a
), "d" (
p‹t
));

25 
	}
}

27 
ölöe
 

28 
	$outw
(
ush‹t
 
p‹t
, ush‹à
d©a
)

30 
asm
 vﬁ©ûe("ouà%0,%1" : : "a" (
d©a
), "d" (
p‹t
));

31 
	}
}

33 
ölöe
 

34 
	$out¶
(
p‹t
, c⁄° *
addr
, 
˙t
)

36 
asm
 volatile("cld;Ñep outsl" :

37 "=S" (
addr
), "=c" (
˙t
) :

38 "d" (
p‹t
), "0" (
addr
), "1" (
˙t
) :

40 
	}
}

42 
ölöe
 

43 
	$°osb
(*
addr
, 
d©a
, 
˙t
)

45 
asm
 volatile("cld;Ñep stosb" :

46 "=D" (
addr
), "=c" (
˙t
) :

47 "0" (
addr
), "1" (
˙t
), "a" (
d©a
) :

49 
	}
}

51 
ölöe
 

52 
	$°o¶
(*
addr
, 
d©a
, 
˙t
)

54 
asm
 volatile("cld;Ñep stosl" :

55 "=D" (
addr
), "=c" (
˙t
) :

56 "0" (
addr
), "1" (
˙t
), "a" (
d©a
) :

58 
	}
}

60 
	g£gdesc
;

62 
ölöe
 

63 
	$lgdt
(
£gdesc
 *
p
, 
size
)

65 vﬁ©ûê
ush‹t
 
pd
[3];

67 
pd
[0] = 
size
-1;

68 
pd
[1] = (
uöt
)
p
;

69 
pd
[2] = (
uöt
)
p
 >> 16;

71 
asm
 vﬁ©ûe("lgdà(%0)" : : "r" (
pd
));

72 
	}
}

74 
	gg©edesc
;

76 
ölöe
 

77 
	$lidt
(
g©edesc
 *
p
, 
size
)

79 vﬁ©ûê
ush‹t
 
pd
[3];

81 
pd
[0] = 
size
-1;

82 
pd
[1] = (
uöt
)
p
;

83 
pd
[2] = (
uöt
)
p
 >> 16;

85 
asm
 vﬁ©ûe("lidà(%0)" : : "r" (
pd
));

86 
	}
}

88 
ölöe
 

89 
	$…r
(
ush‹t
 
£l
)

91 
asm
 vﬁ©ûe("…∏%0" : : "r" (
£l
));

92 
	}
}

94 
ölöe
 
uöt


95 
	$ªadeÊags
()

97 
uöt
 
eÊags
;

98 
asm
 vﬁ©ûe("pushÊ;Ö›»%0" : "Ù" (
eÊags
));

99  
eÊags
;

100 
	}
}

102 
ölöe
 

103 
	$lﬂdgs
(
ush‹t
 
v
)

105 
asm
 vﬁ©ûe("movw %0, %%gs" : : "r" (
v
));

106 
	}
}

108 
ölöe
 

109 
	$˛i
()

111 
asm
 volatile("cli");

112 
	}
}

114 
ölöe
 

115 
	$°i
()

117 
asm
 volatile("sti");

118 
	}
}

120 
ölöe
 
uöt


121 
	$xchg
(vﬁ©ûê
uöt
 *
addr
, uöà
√wvÆ
)

123 
uöt
 
ªsu…
;

126 
asm
 volatile("lock; xchgl %0, %1" :

127 "+m" (*
addr
), "˜" (
ªsu…
) :

128 "1" (
√wvÆ
) :

130  
ªsu…
;

131 
	}
}

133 
ölöe
 
uöt


134 
	$r¸2
()

136 
uöt
 
vÆ
;

137 
asm
 vﬁ©ûe("mov»%%¸2,%0" : "Ù" (
vÆ
));

138  
vÆ
;

139 
	}
}

141 
ölöe
 

142 
	$l¸3
(
uöt
 
vÆ
)

144 
asm
 vﬁ©ûe("mov»%0,%%¸3" : : "r" (
vÆ
));

145 
	}
}

150 
	så≠‰ame
 {

152 
uöt
 
	medi
;

153 
uöt
 
	mesi
;

154 
uöt
 
	mebp
;

155 
uöt
 
	m€•
;

156 
uöt
 
	mebx
;

157 
uöt
 
	medx
;

158 
uöt
 
	mecx
;

159 
uöt
 
	móx
;

162 
ush‹t
 
	mgs
;

163 
ush‹t
 
	m∑ddög1
;

164 
ush‹t
 
	mfs
;

165 
ush‹t
 
	m∑ddög2
;

166 
ush‹t
 
	mes
;

167 
ush‹t
 
	m∑ddög3
;

168 
ush‹t
 
	mds
;

169 
ush‹t
 
	m∑ddög4
;

170 
uöt
 
	må≠no
;

173 
uöt
 
	mîr
;

174 
uöt
 
	meù
;

175 
ush‹t
 
	mcs
;

176 
ush‹t
 
	m∑ddög5
;

177 
uöt
 
	meÊags
;

180 
uöt
 
	me•
;

181 
ush‹t
 
	mss
;

182 
ush‹t
 
	m∑ddög6
;

	@zombie.c

4 
	~"ty≥s.h
"

5 
	~"°©.h
"

6 
	~"u£r.h
"

9 
	$maö
()

11 if(
	`f‹k
() > 0)

12 
	`¶ìp
(5);

13 
	`exô
();

14 
	}
}

	@
1
.
0
93
818
asm.h
bio.c
bootasm.S
bootmain.c
buf.h
cat.c
console.c
date.h
defs.h
echo.c
elf.h
entry.S
entryother.S
exec.c
fcntl.h
file.c
file.h
forktest.c
fs.c
fs.h
grep.c
ide.c
init.c
initcode.S
ioapic.c
kalloc.c
kbd.c
kbd.h
kill.c
lapic.c
ln.c
log.c
ls.c
main.c
memide.c
memlayout.h
mkdir.c
mkfs.c
mmu.h
mp.c
mp.h
my_userapp.c
param.h
picirq.c
pipe.c
prac_getlev.c
prac_getppid.c
prac_syscall.c
printf.c
proc.c
proc.h
proc_temp.c
rm.c
sh.c
sleeplock.c
sleeplock.h
spinlock.c
spinlock.h
stat.h
stressfs.c
string.c
swtch.S
syscall.c
syscall.h
sysfile.c
sysproc.c
test.c
test_master.c
test_master_mj.c
test_mlfq.c
test_mlfq_mj.c
test_stride.c
test_stride_mj.c
test_t.c
test_t2.c
test_yield.c
threadtest.c
timer.c
trap.c
trapasm.S
traps.h
types.h
uart.c
ulib.c
umalloc.c
user.h
usertests.c
usys.S
vectors.S
vm.c
wc.c
x86.h
zombie.c
